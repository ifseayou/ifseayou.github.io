<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hive åŠç›¸å…³ SQLç¬”è®°</title>
    <url>/2023/10/01/Hive/</url>
    <content><![CDATA[<p>æœ¬ç¯‡æ–‡ç« è®°å½•äº†ï¼Œè‡ªå·±åœ¨å®é™…å·¥ä½œå’Œå­¦ä¹ ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œç®—æ˜¯SQLç›¸å…³çš„æ€»ç»“</p>
<p>æ›´å¤šæ–‡ç« æ¬¢è¿å…³æ³¨å…¬ä¼—å·ï¼šstackoverflow</p>
<p>ä¸‹é¢æ˜¯å…³äºSQLåœ¨å¼•æ“å†…éƒ¨æ‰§è¡Œçš„é¡ºåºçš„ç®€æ˜“ç‰ˆ/å¿…è®°ç‰ˆï¼š</p>
<blockquote>
<p>from æŸè¡¨ï¼Œgroup by æŸå­—æ®µï¼Œå¼€çª— ï¼Œèšåˆå‡½æ•°ï¼Œhavingï¼Œdistinct , order by , limit ï¼Œå°¤å…¶æ³¨æ„å½“group by å’Œ å¼€çª—ç›¸é‡æ—¶ï¼Œä¸€å®šæ˜¯åˆ†ç»„<sub>groupBy</sub>ä¼˜å…ˆ</p>
</blockquote>
<h2 id="hiveçš„æ¶æ„">hiveçš„æ¶æ„</h2>
<p>å¦‚ä¸‹å›¾æ˜¯Hiveçš„æ¶æ„å›¾ï¼Œå³è§£æå™¨-ç¼–è¯‘å™¨-ä¼˜åŒ–å™¨-æ‰§è¡Œå™¨ï¼ŒåŒºåˆ«äºMySQLçš„ï¼Œè¿æ¥å™¨-åˆ†æå™¨-ä¼˜åŒ–å™¨-æ‰§è¡Œå™¨</p>
<span id="more"></span>
<p align="center">
  <img src="/2023/10/01/Hive/1.jpg" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> Hiveæ¶æ„ VS Mysqlæ¶æ„ </span>
</p>
<p>Metastroreæ˜¯å­˜å‚¨å…ƒæ•°æ®çš„æ•°æ®åº“ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯derbyï¼Œå¯ä»¥æ›´æ”¹ä¸º<em><strong>MySQL</strong></em>ï¼Œå…ƒæ•°æ®æŒ‡çš„æ˜¯å°†ç»“æ„åŒ–æ•°æ®æ˜ å°„æˆä¸€å¼ è¡¨çš„è¡¨åï¼Œè¡¨æ‰€å±çš„æ•°æ®åº“(é»˜è®¤ä¸ºdefault)ï¼Œè¡¨çš„æ‹¥æœ‰è€…ï¼Œè¡¨çš„åˆ—ï¼Œåˆ†åŒºå­—æ®µï¼Œè¡¨çš„ç±»å‹(æ˜¯å¦ä¸ºå¤–éƒ¨è¡¨)è¡¨æ‰€åœ¨çš„ç›®å½•ç­‰ã€‚Hiveåªæ˜¯å’ŒRDBåªæ˜¯åœ¨SQLè¯­å¥ä¸Šæœ‰ç€ç±»ä¼¼ä¹‹å¤„</p>
<h2 id="ç¬¬ä¸€éƒ¨åˆ†">ç¬¬ä¸€éƒ¨åˆ†</h2>
<h3 id="collect-x">collect_x</h3>
<p>åœ¨ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œéœ€è¦è®¾ç½®<code>set hive.map.aggr = false;</code> å¦åˆ™å¯èƒ½ä¼šå‘ç”Ÿ<code>IllegalArgumentException Size requested for unknown type: java.util.Collection</code>çš„å¼‚å¸¸<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> collect_set(col_a)  <span class="keyword">as</span>          set_a</span><br><span class="line">     , collect_list(col_a) <span class="keyword">as</span>          list_a</span><br><span class="line">     , sort_array(collect_list(col_a)) sort_list_a  <span class="comment">-- sort_array å¯å¯¹åºåˆ—æ’åº</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">         <span class="keyword">select</span> <span class="string">'a'</span> col_a</span><br><span class="line">         <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">         <span class="keyword">select</span> <span class="string">'b'</span> col_a</span><br><span class="line">         <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">         <span class="keyword">select</span> <span class="string">'a'</span> col_a</span><br><span class="line">         <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">         <span class="keyword">select</span> <span class="string">'a'</span> col_a</span><br><span class="line">     ) t</span><br></pre></td></tr></tbody></table></figure>
<p align="center">
  <img src="/2023/10/01/Hive/12.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> collect_listå‡½æ•°å’Œ collect_setå‡½æ•°çš„ç”¨æ³• </span>
</p>
<blockquote></blockquote>
<h3 id="æ—¥æœŸ">æ—¥æœŸ</h3>
<p>ä»¥ä¸‹æ˜¯ hive è¯­æ³•</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> date_format(<span class="string">'2019-02-10'</span>,<span class="string">'yyyy-MM'</span>);  </span><br><span class="line"><span class="number">2019</span><span class="number">-02</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> date_add(<span class="string">'2019-02-10'</span>,<span class="number">-1</span>),date_add(<span class="string">'2019-02-10'</span>,<span class="number">1</span>);</span><br><span class="line"><span class="number">2019</span><span class="number">-02</span><span class="number">-09</span>  <span class="number">2019</span><span class="number">-02</span><span class="number">-11</span></span><br><span class="line"><span class="comment">-- (1)å–å½“å‰å¤©çš„ä¸‹ä¸€ä¸ªå‘¨ä¸€</span></span><br><span class="line"><span class="keyword">select</span> next_day(<span class="string">'2019-02-12'</span>,<span class="string">'MO'</span>)</span><br><span class="line"><span class="number">2019</span><span class="number">-02</span><span class="number">-18</span></span><br><span class="line"><span class="comment">-- è¯´æ˜ï¼šæ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸæ—¥çš„è‹±æ–‡(Mondayï¼ŒTuesdayã€Wednesdayã€Thursdayã€Fridayã€Saturdayã€Sunday)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- (2)å–å½“å‰å‘¨çš„å‘¨ä¸€   </span></span><br><span class="line"><span class="keyword">select</span> date_add(next_day(<span class="string">'2019-02-12'</span>,<span class="string">'MO'</span>),<span class="number">-7</span>);</span><br><span class="line"><span class="number">2019</span><span class="number">-02</span><span class="number">-11</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- (3)å–å½“å‰å‘¨çš„å‘¨æ—¥   </span></span><br><span class="line"><span class="keyword">select</span> date_add(next_day(<span class="string">'2019-06-09'</span>,<span class="string">'mo'</span>),<span class="number">-1</span>);</span><br><span class="line"><span class="number">2019</span><span class="number">-06</span><span class="number">-09</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- (4)æ±‚å½“æœˆæœ€åä¸€å¤©æ—¥æœŸ</span></span><br><span class="line"><span class="keyword">select</span> last_day(<span class="string">'2019-02-10'</span>);</span><br><span class="line"><span class="number">2019</span><span class="number">-02</span><span class="number">-28</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ±‚ä¸Šä¸ªæœˆ</span></span><br><span class="line"><span class="keyword">select</span> substr(add_months(<span class="built_in">current_date</span>(),<span class="number">-1</span>),<span class="number">1</span>,<span class="number">7</span>) method_one</span><br><span class="line">, substr(date_sub(from_unixtime(unix_timestamp()), dayofmonth(from_unixtime(unix_timestamp()))), <span class="number">1</span>, <span class="number">7</span>) <span class="keyword">as</span> method_two</span><br></pre></td></tr></tbody></table></figure>
<h3 id="æ—¶åŒº">æ—¶åŒº</h3>
<p>æ ¼æ—å¨æ²»æ—¶é—´ï¼ˆGreenwich Mean Timeï¼Œç®€ç§°GMTï¼‰æ˜¯ä¸–ç•Œä¸Šæœ€å¸¸ç”¨çš„æ—¶é—´æ ‡å‡†ä¹‹ä¸€ã€‚å®ƒä»¥è‹±å›½ä¼¦æ•¦çš„æ ¼æ—å¨æ²»çš‡å®¶å¤©æ–‡å°ä¸ºå‚è€ƒç‚¹ï¼Œç”¨äºæ ‡å®šå…¨çƒçš„æ—¶é—´ã€‚æ ¼æ—å¨æ²»æ—¶é—´é€šå¸¸ç”¨ä½œåè°ƒä¸–ç•Œæ—¶ï¼ˆCoordinated Universal Timeï¼Œç®€ç§°UTCï¼‰çš„åŸºå‡†ï¼Œå› æ­¤è¿™ä¸¤ä¸ªæœ¯è¯­é€šå¸¸æ˜¯äº’æ¢ä½¿ç”¨çš„</p>
<p><strong>UTCçš„æ—¶é—´æˆ³ï¼Œåœ¨å…¨çƒä»»ä½•ä¸€ä¸ªåœ°ç‚¹ï¼Œéƒ½æ˜¯ä¸€ä¸ªå€¼ï¼Œæ˜¯ä¸€ä¸ª13ä½çš„æ•°å­—</strong>ï¼Œå°æ˜åœ¨çº½çº¦ï¼Œå°çº¢åœ¨ä¸Šæµ·ï¼Œå°è“åœ¨æ ¼æ—å¨æ²»å¤©æ–‡å°ï¼Œä»–ä»¬ä¸‰ä¸ªåœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œå¾—åˆ°çš„æ—¶é—´æˆ³æ˜¯ä¸€è‡´çš„ã€‚åªæ˜¯åœ¨å„è‡ªåœ¨ä¸åŒçš„æ—¶åŒºï¼Œæ¢ç®—å½“åœ°çš„æ—¶åŒºçš„æ—¶é—´è¡¨ç°å½¢å¼ä¸ä¸€è‡´ï¼Œå¦‚ä¸‹çš„è¿™ä¸ªä¾‹å­ä¸­</p>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line">æ—¶é—´æˆ³: 1694682379271</span><br><span class="line">çº½çº¦æ—¶é—´: 2023-09-14 05:06:19</span><br><span class="line">GMT<span class="built_in">&amp;</span>UTCæ—¶é—´: 2023-09-14 09:06:19</span><br><span class="line">åŒ—äº¬æ—¶é—´: 2023-09-14 17:06:19</span><br></pre></td></tr></tbody></table></figure>
<p>ä»¥ä¸‹çš„hiveï¼Œimpalaè¯­æ³•</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- ç”¨äºå°†ã€æŒ‡å®šæ—¶åŒºçš„æ—¶é—´ã€‘è½¬æ¢ä¸º ã€UTCï¼ˆåè°ƒä¸–ç•Œæ—¶ï¼‰æ—¶é—´ã€‘ã€‚è¿™ä¸ªå‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šã€è¦è½¬æ¢çš„æ—¶é—´ã€‘å’Œã€æºæ—¶åŒºã€‘</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> to_utc_timestamp(<span class="string">'2023-09-14 17:06:19'</span>, <span class="string">'Asia/Shanghai'</span>)  <span class="keyword">as</span>  `å°†è¾“å…¥æ—¶åŒºå¯¹åº”çš„æ—¶é—´è½¬ä¸ºGMTæ—¶é—´`;</span><br><span class="line"><span class="number">2023</span><span class="number">-09</span><span class="number">-14</span> <span class="number">09</span>:<span class="number">06</span>:<span class="number">19</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç”¨äºå°†ã€UTCæ—¶åŒºçš„æ—¶é—´ã€‘è½¬æ¢ä¸ºã€ç›®æ ‡æ—¶åŒºçš„æ—¶é—´ã€‘ã€‚è¿™ä¸ªå‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šã€UTCæ—¶åŒºçš„æ—¶é—´ã€‘å’Œã€ç›®æ ‡æ—¶åŒºã€‘</span></span><br><span class="line"><span class="keyword">SELECT</span> from_utc_timestamp(<span class="string">'2023-09-14 09:06:19'</span>, <span class="string">'Asia/Shanghai'</span>)  <span class="keyword">as</span>  `å°†UTCæ—¶åŒºå¯¹åº”çš„æ—¶é—´è½¬ä¸ºç›®æ ‡æ—¶åŒº`;</span><br><span class="line"><span class="number">2023</span><span class="number">-09</span><span class="number">-14</span> <span class="number">17</span>:<span class="number">06</span>:<span class="number">19</span></span><br><span class="line"><span class="keyword">SELECT</span> from_unixtime(unix_timestamp()) <span class="keyword">as</span> `UTCæ—¶é—´<span class="operator">&amp;</span>GMTæ—¶é—´`</span><br><span class="line">     , <span class="built_in">current_timestamp</span>()             <span class="keyword">as</span> `è¿”å›ä¸œå…«åŒº`</span><br><span class="line">     , unix_timestamp()                <span class="keyword">as</span> `è¿”å›æ—¶é—´æˆ³`</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸‹å›¾å¯ä»¥å‘ç° <code>hive 3</code>  ä¸­ <code>from_unixtime</code> å‡½æ•°å¹¶æ²¡æœ‰æ ¹æ®æœ¬åœ°çš„æ—¶åŒºè¿›è¡Œæ—¶é—´çš„è½¬åŒ–ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨UTCçš„æ—¶åŒºï¼Œè€Œ <code>impala</code> å¯¹æ—¶åŒºåšäº†è½¬æ¢</p>
<p align="center">
  <img src="/2023/10/01/Hive/27.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> impalaå’Œhive3æ—¶åŒºå¯¹æ¯” </span>
</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- å°†åŒ—äº¬æ—¶é—´è½¬ä¸ºå·´è¥¿æ—¶é—´</span></span><br><span class="line"><span class="keyword">select</span> from_utc_timestamp(to_utc_timestamp("2021-05-09 22:14:30",<span class="string">'GMT+8'</span>),"GMT-3")</span><br><span class="line"><span class="number">2021</span><span class="number">-05</span><span class="number">-09</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">30.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> date_format(from_utc_timestamp(to_utc_timestamp("2021-05-09 22:14:30",<span class="string">'GMT+8'</span>),"GMT-3"),<span class="string">'yyyy-MM-dd HH:mm:ss'</span>)</span><br><span class="line"><span class="number">2021</span><span class="number">-05</span><span class="number">-09</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">30</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="å­—ç¬¦ä¸²å¤„ç†">å­—ç¬¦ä¸²å¤„ç†</h3>
<p><code>substr</code>ï¼Œ<code>replace</code>ç­‰å°±ä¸èµ˜è¿°äº†</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- 1)</span></span><br><span class="line"><span class="keyword">select</span> regexp_extract(<span class="string">'http://a.m.taobao.com/i41915173660.html'</span>, <span class="string">'i([0-9]+)'</span>, <span class="number">0</span>)</span><br><span class="line">     , regexp_extract(<span class="string">'http://a.m.taobao.com/i41915173660.html'</span>, <span class="string">'i([0-9]+)'</span>, <span class="number">1</span>)</span><br><span class="line"><span class="comment">-- i41915173660    ,   41915173660</span></span><br><span class="line"><span class="comment">-- 0æ˜¯æ˜¾ç¤ºä¸ä¹‹åŒ¹é…çš„æ•´ä¸ªå­—ç¬¦ä¸²ï¼› 1æ˜¯æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ‹¬å·é‡Œé¢çš„</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2)</span></span><br><span class="line"><span class="keyword">select</span>  regexp_replace(<span class="string">'a1b2c3d4'</span>, <span class="string">'[0-9]'</span>, <span class="string">'-'</span>);</span><br><span class="line"><span class="comment">-- a-b-c-d-</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3)</span></span><br><span class="line"><span class="comment">-- æŸå­—ç¬¦ä¸²æ˜¯å¦å¤–ä¸€ä¸ªå­—ç¬¦ä¸²çš„å­ä¸²</span></span><br><span class="line">instr(string string, string substring)</span><br><span class="line"><span class="comment">-- è¿”å›æŸ¥æ‰¾å­—ç¬¦ä¸²stringä¸­å­å­—ç¬¦ä¸²substringå‡ºç°çš„ä½ç½®ï¼Œå¦‚æœæŸ¥æ‰¾å¤±è´¥å°†è¿”å›0ï¼Œå¦‚æœä»»ä¸€å‚æ•°ä¸ºNullå°†è¿”å›nullï¼Œä½ç½®ä¸ºä»1å¼€å§‹ã€‚</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="é™¤æ•°ä¸º0å¤„ç†">é™¤æ•°ä¸º0å¤„ç†</h3>
<p>è¿™é‡Œæˆ‘ä»¬å°†æ¯”è¾ƒä¸åŒçš„å¼•æ“æ˜¯å¦‚ä½•å¤„ç†<strong>é™¤æ•°ä¸º0</strong>çš„é—®é¢˜çš„ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p align="center">
  <img src="/2023/10/01/Hive/13.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> ä¸åŒå¼•æ“é™¤0çš„ç»“æœæ¯”å¯¹ </span>
</p>
<blockquote>
<p>å¯¹äºé™¤æ•°ä¸º0é—®é¢˜ï¼Œä¼˜å…ˆä½¿ç”¨<code>nullif(a,0)</code>å‡½æ•°æ¥è¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯è¯¥å‡½æ•°Hive2.2æ‰æœ‰å¯¹åº”å®ç°ï¼Œ<code>nullif((a,b)</code> çš„è¯­ä¹‰åœ¨äºï¼Œå¦‚æœå‚æ•° a ç­‰äº å‚æ•° b é‚£ä¹ˆï¼Œè¯¥å‡½æ•°è¿”å› <code>null</code></p>
</blockquote>
<h2 id="ç¬¬äºŒéƒ¨åˆ†">ç¬¬äºŒéƒ¨åˆ†</h2>
<h3 id="sum-over">sum()  + over()</h3>
<p align="center">
  <img src="/2023/10/01/Hive/6.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> ä¸åŒå¼•æ“é™¤0çš„ç»“æœæ¯”å¯¹ </span>
</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p>over() å…¨å±€æ±‚å’Œ</p>
</li>
<li class="lvl-2">
<p>over(order by) å…¨å±€ç´¯ç§¯æ±‚å’Œ</p>
</li>
<li class="lvl-2">
<p>over(partition by ) åˆ†åŒºå†…å…¨å±€æ±‚å’Œ</p>
</li>
<li class="lvl-2">
<p>over(partition by order by) åˆ†åŒºå†…ç´¯ç§¯æ±‚å’Œ</p>
</li>
</ul>
</blockquote>
<p>å†…ç½‘ç¯å¢ƒä¸‹ï¼Œä¸‹é¢çš„è„šæœ¬åˆ†åˆ«åœ¨ impalaï¼Œhiveï¼Œholoï¼Œpg , mysql ,æ‰§è¡Œä»¥ä¸‹ï¼Œçœ‹ä¸‹æ˜¯ä»€ä¹ˆæƒ…å†µ</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'a'</span> <span class="keyword">as</span> a,<span class="number">1</span> <span class="keyword">as</span> b </span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'a'</span> <span class="keyword">as</span> a , <span class="number">2</span> <span class="keyword">as</span> b</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">    <span class="keyword">select</span> <span class="string">'b'</span> <span class="keyword">as</span> b , <span class="number">10</span> <span class="keyword">as</span> b</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> a , </span><br><span class="line">     <span class="built_in">avg</span>(b) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> a <span class="keyword">order</span> <span class="keyword">by</span> b) x ,</span><br><span class="line">     <span class="built_in">sum</span>(b) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> a <span class="keyword">order</span> <span class="keyword">by</span> b) y</span><br><span class="line"><span class="keyword">from</span> tmp1 </span><br><span class="line">;</span><br></pre></td></tr></tbody></table></figure>
<p>å…³äºèšåˆå‡½æ•°+çª—å£å‡½æ•°çš„æè¿°ï¼Œ<a href="https://www.geeksforgeeks.org/window-functions-in-sql/">GreeksforGreeksä¸Šçš„é‚£ä¸ªåšæ–‡æ˜¯é”™çš„</a></p>
<h3 id="ä¾§å†™è§†å›¾-lateral-view">ä¾§å†™è§†å›¾(lateral view)</h3>
<p>ğŸˆ<code>explode(split())</code> åªèƒ½ç”¨æ¥è§£å†³ä¸€è¡Œè½¬å¤šåˆ—çš„å•å­—æ®µé—®é¢˜ï¼Œä¾§å†™è§†å›¾ä¸»è¦ç”¨æ¥å¤„ç†ï¼Œé€šç”¨è¡Œè½¬åˆ—çš„é—®é¢˜</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- hive è¯­æ³•</span></span><br><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span>(</span><br><span class="line"><span class="keyword">select</span> <span class="string">'A;B;C'</span> <span class="keyword">as</span> name , <span class="number">20</span> <span class="keyword">as</span> age</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> explode(split(name,<span class="string">';'</span>))</span><br><span class="line">         , age <span class="comment">-- Only a single expression in the SELECT clause is supported with UDTF's </span></span><br><span class="line">         <span class="comment">-- å¦‚æœæ˜¯å¤šåˆ—ï¼Œä½¿ç”¨æµ‹æ–œè§†å›¾è¯­æ³•</span></span><br><span class="line"><span class="keyword">from</span> tmp1</span><br><span class="line">;</span><br><span class="line"><span class="comment">-- å¦‚ä¸‹ï¼ˆhiveè¯­æ³•ï¼‰</span></span><br><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span>(</span><br><span class="line"><span class="keyword">select</span> <span class="string">'A;B;C'</span> <span class="keyword">as</span> name , <span class="number">20</span> <span class="keyword">as</span> age</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> name </span><br><span class="line">     , age </span><br><span class="line">     , col_x</span><br><span class="line"><span class="keyword">from</span> tmp1 <span class="keyword">lateral</span> <span class="keyword">view</span> explode(split(name,<span class="string">';'</span>)) x <span class="keyword">as</span> col_x</span><br><span class="line">;</span><br></pre></td></tr></tbody></table></figure>
<table>
<thead>
<tr>
<th>name</th>
<th>age</th>
<th>col_x</th>
</tr>
</thead>
<tbody>
<tr>
<td>A;B;C</td>
<td>20</td>
<td>A</td>
</tr>
<tr>
<td>A;B;C</td>
<td>20</td>
<td>B</td>
</tr>
<tr>
<td>A;B;C</td>
<td>20</td>
<td>C</td>
</tr>
</tbody>
</table>
<center>è¯¥è¡¨æ ¼å¯å·¦å³ç§»åŠ¨</center>
<h3 id="lag-overçš„ä½¿ç”¨">lag+overçš„ä½¿ç”¨</h3>
<p>å…¶ä¸­æœ€ä¸ºå¸¸ç”¨çš„æ˜¯ï¼š**æŒ‰ç…§æ—¶é—´æ­£åºæ’åºï¼Œ<code>lag</code>è·å–ä¸Šä¸ªå‘¨æœŸçš„å€¼  **</p>
<p align="center">
  <img src="/2023/10/01/Hive/8.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> lag + over çš„ä½¿ç”¨ </span>
</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>lag ï¼ˆè½åï¼‰æ˜¯è·å–ä¸Šä¸€ä¸ª</p>
</li>
<li class="lvl-2">
<p>lead ï¼ˆé¢†å¯¼ï¼‰æ˜¯è·å–ä¸‹ä¸€ä¸ª</p>
</li>
</ul>
<p align="center">
  <img src="/2023/10/01/Hive/21.png" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> SQLï¼ˆStructuredQueryLanguageï¼‰æ ‡å‡†è®¤ä¸ºå½“å‰è¡Œçš„ä¸Šä¸€ä¸ªè¡Œæ˜¯åé¢ï¼Œä¸‹ä¸€è¡Œæ˜¯å‰é¢ </span>
</p>
<h3 id="ä¸€å‘¨å†…è¿ç»­3å¤©æ´»è·ƒ">ä¸€å‘¨å†…è¿ç»­3å¤©æ´»è·ƒ</h3>
<p align="center">
  <img src="/2023/10/01/Hive/14.jpg" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> ä¸€å‘¨è¿ç»­Xå¤©æ´»è·ƒçš„æœ€ä½³è§£æ³• </span>
</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span> <span class="number">0</span> <span class="keyword">as</span> mid_id,<span class="string">'2020-02-12'</span> <span class="keyword">as</span> dt <span class="keyword">union</span>  <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">0</span> <span class="keyword">as</span> mid_id,<span class="string">'2020-02-16'</span> <span class="keyword">as</span> dt  <span class="keyword">union</span>  <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">0</span> <span class="keyword">as</span> mid_id,<span class="string">'2020-02-17'</span> <span class="keyword">as</span> dt  <span class="keyword">union</span>  <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">0</span> <span class="keyword">as</span> mid_id,<span class="string">'2020-02-18'</span> <span class="keyword">as</span> dt  <span class="keyword">union</span>  <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">as</span> mid_id,<span class="string">'2020-02-11'</span> <span class="keyword">as</span> dt  <span class="keyword">union</span>  <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">as</span> mid_id,<span class="string">'2020-02-13'</span> <span class="keyword">as</span> dt  <span class="keyword">union</span>  <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">as</span> mid_id,<span class="string">'2020-02-14'</span> <span class="keyword">as</span> dt  <span class="keyword">union</span>  <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">as</span> mid_id,<span class="string">'2020-02-17'</span> <span class="keyword">as</span> dt</span><br><span class="line">) ,</span><br><span class="line">tmp2 <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> mid_id</span><br><span class="line">            , dt</span><br><span class="line">            , <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> mid_id <span class="keyword">order</span> <span class="keyword">by</span> dt)               rk</span><br><span class="line">            , date_sub(dt, <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> mid_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) diff</span><br><span class="line">       <span class="keyword">from</span> tmp1</span><br><span class="line">       <span class="keyword">where</span> dt <span class="keyword">between</span> date_sub(<span class="string">'2020-02-18'</span>, <span class="number">7</span>) <span class="keyword">and</span> <span class="string">'2020-02-18'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> mid_id</span><br><span class="line"><span class="keyword">from</span> tmp2</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> mid_id,diff</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&gt;=</span><span class="number">3</span> ;</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹äºç±»ä¼¼çš„è¿ç»­Xå¤©çš„é—®é¢˜ï¼Œæœ€ä¼˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨å¼€çª—å‡½æ•°ï¼Œå¦å¤–çš„ä¸€ç§è§£é¢˜æ€è·¯æ˜¯<strong>è‡ªå…³è”</strong>ï¼Œå…³è”æ—¶ï¼Œä½¿ç”¨ <code>t1.mid_id = t2.mid_id and t1.dt = date_sub(t2.dt,x)</code>çš„æ–¹å¼</p>
<h3 id="left-semi-join">left semi join</h3>
<p>å…³äº<code>left semi join</code> æ³¨æ„2ç‚¹ï¼š</p>
<p>ğŸ…°ï¸<code>left semi join</code> è¦ä¸¥æ ¼åŒºåˆ†äº<code>left outer join(left join)</code></p>
<p>ğŸ…±ï¸ <code>t1 left semi join t2 </code> é€‰åˆ—æ—¶ï¼Œä¸å…è®¸å‡ºç°t2 çš„å­—æ®µ</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> t1.id, t1.fieldA</span><br><span class="line"><span class="keyword">from</span> `table_A` t1</span><br><span class="line"><span class="keyword">where</span> t1.id <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> id</span><br><span class="line">    <span class="keyword">from</span> `table_B`</span><br><span class="line">); <span class="comment">-- A å’Œ Bçš„ äº¤é›†</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¯æ”¹å†™ä¸ºexistsçš„æ–¹å¼</span></span><br><span class="line"><span class="keyword">select</span> t1.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> `table_A` t1</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> t2.id</span><br><span class="line">    <span class="keyword">from</span> `table_B` t2</span><br><span class="line">    <span class="keyword">where</span> t1.id <span class="operator">=</span> t2.id</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¿˜å¯æ”¹å†™ä¸º</span></span><br><span class="line"><span class="keyword">select</span> t1.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> `table_A` t1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> `table_B` t2</span><br><span class="line"><span class="keyword">on</span> t1.id <span class="operator">=</span> t2.id</span><br><span class="line"><span class="keyword">where</span> t2.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="comment">-- A å’Œ B çš„äº¤é›†</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ”¹å†™ä¸º ï¼Œè¿™ç§æ–¹å¼æ›´åŠ é«˜æ•ˆ</span></span><br><span class="line"><span class="keyword">select</span> t1.<span class="operator">*</span> <span class="comment">-- ä¸å…è®¸å‡ºç°t2 çš„å­—æ®µ</span></span><br><span class="line"><span class="keyword">from</span> `table_A` t1</span><br><span class="line"><span class="keyword">left</span> semi <span class="keyword">join</span> `table_B` t2</span><br><span class="line"><span class="keyword">on</span> t1.id <span class="operator">=</span> t2.id;</span><br></pre></td></tr></tbody></table></figure>
<p>åŒç†å¯¹äº<code>not  exist</code></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> t1.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> `table_A` t1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> `table_B` t2</span><br><span class="line"><span class="keyword">on</span> t1.id <span class="operator">=</span> t2.id</span><br><span class="line"><span class="keyword">where</span> t2.id <span class="keyword">is</span>  <span class="keyword">null</span> <span class="comment">-- Aä¸­æœ‰Bä¸­æ²¡æœ‰</span></span><br><span class="line">;</span><br><span class="line"><span class="comment">-- æˆ‘ä»¬æ¢æˆä¸‹é¢çš„å†™æ³•</span></span><br><span class="line"><span class="keyword">select</span> t1.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> `table_A` t1</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> t2.id</span><br><span class="line">    <span class="keyword">from</span> `table_B` t2</span><br><span class="line">    <span class="keyword">where</span> t1.id <span class="operator">=</span> t2.id</span><br><span class="line">) <span class="comment">-- Aä¸­æœ‰Bä¸­æ²¡æœ‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æˆ–è€…æ¢æˆä¸‹é¢çš„å†™æ³•</span></span><br><span class="line"><span class="keyword">select</span> t1.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> `table_A` t1</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> t2.id</span><br><span class="line">    <span class="keyword">from</span> `table_B` t2</span><br><span class="line">    <span class="keyword">where</span> t1.id <span class="operator">=</span> t2.id</span><br><span class="line">) <span class="comment">-- Aä¸­æœ‰Bä¸­æ²¡æœ‰</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="distinct">distinct</h3>
<h4 id="ğŸ…°ï¸-distinct-å’Œ-order-by-çš„ç»“åˆ">ğŸ…°ï¸ distinct å’Œ order by çš„ç»“åˆ</h4>
<p>å…ˆæ‰§è¡Œdistinct ï¼Œåæ‰§è¡Œorder by ï¼Œæœ€ålimit</p>
<p align="center">
  <img src="/2023/10/01/Hive/3.jpg" width="50%" alt="Your image description">
    <br>
  <span style="color:gray"> å…ˆæ‰§è¡Œ distinct ï¼Œåæ‰§è¡Œ order by </span>
</p>
<h4 id="ğŸ…±ï¸-distinct-å¤šä¸ªå­—æ®µ">ğŸ…±ï¸ distinct å¤šä¸ªå­—æ®µ</h4>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">distinct` å¤šä¸ªå­—æ®µå¯¹æ‰€æœ‰å­—æ®µéƒ½èµ·ä½œç”¨ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªï¼›å¦‚ `select distinct field_a,field_b from table;</span><br><span class="line">a1,b1;</span><br><span class="line">a1,b2;</span><br><span class="line">a2,b2;</span><br><span class="line">-- åªè¦æœ‰ä¸åŒå°±ä¼šè¢«é€‰æ‹©å‡ºæ¥</span><br></pre></td></tr></tbody></table></figure>
<h3 id="limit-offset">limit offset</h3>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">limit x offset y` ,$y$æ˜¯$x$çš„å€æ•°å‡ºç°ï¼Œå¯ä»¥æ°å¥½å°†æ•°æ®å–å®Œï¼Œ`limit x offset y` ç­‰æ•ˆäº `limit y,x</span><br></pre></td></tr></tbody></table></figure>
<p align="center">
  <img src="/2023/10/01/Hive/15.jpg" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> limit çš„ç”¨æ³• </span>
</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">3</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">4</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">5</span> a</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">3</span> <span class="keyword">offset</span> <span class="number">3</span>; </span><br></pre></td></tr></tbody></table></figure>
<p>æœ€åä¸€ä¸ªæˆªå›¾çš„SQLè¯­å¥ï¼Œæˆ‘åœ¨Hive2.1.1ä¸­çš„æ‰§è¡Œç»“æœæ˜¯ï¼š</p>
<p align="center">
  <img src="/2023/10/01/Hive/24.png" width="70%" alt="Your image description">
    <br>
  <span style="color:gray">24 </span>
</p>
<p>è¯´æ˜åœ¨Hiveä¸­<code>offset</code>çš„æ’åºæ˜¯ä»1å¼€å§‹çš„ï¼ˆxå–0ç­‰äºx=1ï¼‰</p>
<h3 id="ntile-over">ntile+over</h3>
<p><code>ntile(x)</code>å°†æ•°æ®åˆ’å‡åˆ†ä¸ºxä¸ªæ¡¶ï¼Œå¹¶ä¸”è¿”å›æ¡¶ç¼–å·ï¼Œå¦‚æœæœ‰å¤šçš„å…ƒç´ ï¼Œä¼˜å…ˆè¿›å…¥ç¬¬ä¸€ä¸ªæ¡¶</p>
<p align="center">
  <img src="/2023/10/01/Hive/22.png" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> ä½¿ç”¨nileå°†æ•°æ®å‡åˆ†åˆ°xæ¡¶å†… </span>
</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'a'</span> <span class="keyword">as</span> name , <span class="string">'one'</span> <span class="keyword">as</span> claz, <span class="number">1</span> <span class="keyword">as</span> score <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'b'</span> <span class="keyword">as</span> name , <span class="string">'two'</span> <span class="keyword">as</span> claz, <span class="number">2</span> <span class="keyword">as</span> score <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'c'</span> <span class="keyword">as</span> name , <span class="string">'two'</span> <span class="keyword">as</span> claz, <span class="number">3</span> <span class="keyword">as</span> score <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'d'</span> <span class="keyword">as</span> name , <span class="string">'one'</span> <span class="keyword">as</span> claz, <span class="number">4</span> <span class="keyword">as</span> score <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'e'</span> <span class="keyword">as</span> name , <span class="string">'one'</span> <span class="keyword">as</span> claz, <span class="number">5</span> <span class="keyword">as</span> score <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'f'</span> <span class="keyword">as</span> name , <span class="string">'two'</span> <span class="keyword">as</span> claz, <span class="number">6</span> <span class="keyword">as</span> score <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'g'</span> <span class="keyword">as</span> name , <span class="string">'one'</span> <span class="keyword">as</span> claz, <span class="number">7</span> <span class="keyword">as</span> score <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'h'</span> <span class="keyword">as</span> name , <span class="string">'one'</span> <span class="keyword">as</span> claz, <span class="number">8</span> <span class="keyword">as</span> score <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'i'</span> <span class="keyword">as</span> name , <span class="string">'two'</span> <span class="keyword">as</span> claz, <span class="number">9</span> <span class="keyword">as</span> score <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'j'</span> <span class="keyword">as</span> name , <span class="string">'two'</span> <span class="keyword">as</span> claz, <span class="number">0</span> <span class="keyword">as</span> score</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">     , <span class="built_in">ntile</span>(<span class="number">2</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> claz <span class="keyword">order</span> <span class="keyword">by</span> score) rn</span><br><span class="line"><span class="keyword">from</span> tmp1;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="æ¨¡ç³ŠåŒ¹é…å¤šä¸ªå­—æ®µ">æ¨¡ç³ŠåŒ¹é…å¤šä¸ªå­—æ®µ</h3>
<img src="/2023/10/01/Hive/23-6152215.png" width="100%" height="25%" alt="å›¾ç‰‡åç§°" align="left">
<p>åœ¨hiveæˆ–è€…æ˜¯impalaç§ï¼Œæˆ–è€…ä½¿ç”¨ <code>rlike</code>ï¼šå…¶ä½œç”¨åœ¨äº<strong>æ¨¡ç³ŠåŒ¹é…å¤šä¸ªå€¼</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- hive &amp; impala</span></span><br><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'abcå¤§'</span> <span class="keyword">as</span> a <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'ä¸­abc'</span> <span class="keyword">as</span> a <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'abcå°'</span> <span class="keyword">as</span> a</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tmp1</span><br><span class="line"><span class="comment">-- where a rlike 'å¤§|ä¸­' -- å†™æ³•1</span></span><br><span class="line"><span class="keyword">where</span> a regxp <span class="string">'å¤§|ä¸­'</span>    <span class="comment">-- å†™æ³•2</span></span><br><span class="line"><span class="comment">-- ä¸­abc</span></span><br><span class="line"><span class="comment">-- abcå¤§</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- holo &amp; pg</span></span><br><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'abcå¤§'</span> <span class="keyword">as</span> a <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'ä¸­abc'</span> <span class="keyword">as</span> a <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'abcå°'</span> <span class="keyword">as</span> a</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tmp1</span><br><span class="line"><span class="keyword">where</span> a <span class="operator">~</span> <span class="string">'å¤§|ä¸­'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="çª—å£å‡½æ•°çš„èŒƒå›´é€‰æ‹©">çª—å£å‡½æ•°çš„èŒƒå›´é€‰æ‹©</h3>
<p>æ³¨æ„ <code>range</code> å’Œ<code>rows</code>ä¹‹é—´çš„ä½¿ç”¨åŒºåˆ«ï¼š  <strong>rowsè®¡ç®—çš„æ˜¯è¡Œï¼Œrange è®¡ç®—çš„æ˜¯å€¼</strong>ï¼Œ preceding å¾€ä¸Šï¼Œfollowing å¾€ä¸‹</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">agg_func <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> col_name <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> proceding <span class="keyword">and</span> <span class="number">1</span> following) <span class="comment">-- col_nameçš„å‰å1è¡Œ</span></span><br><span class="line">agg_func <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> col_name <span class="keyword">range</span> <span class="keyword">between</span> <span class="number">1</span> proceding <span class="keyword">and</span> <span class="number">1</span> following) <span class="comment">-- col_nameå€¼çš„(+/- 1) çš„å€¼</span></span><br><span class="line"></span><br><span class="line">agg_func <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> col_name <span class="keyword">rows</span> <span class="keyword">between</span> unbounded preceding <span class="keyword">and</span> unbounded following) <span class="comment">-- å…¨éƒ¨è¡Œ</span></span><br><span class="line">agg_func <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> col_name <span class="keyword">rows</span> <span class="keyword">between</span> unbounded preceding <span class="keyword">and</span> <span class="keyword">current</span> <span class="type">row</span>) <span class="comment">-- å¼€å¤´åˆ°å½“å‰è¡Œ</span></span><br></pre></td></tr></tbody></table></figure>
<p align="center">
  <img src="/2023/10/01/Hive/19.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> çª—å£å‡½æ•°çš„é€‰æ‹©èŒƒå›´ </span>
</p>
<img src="/2023/10/01/Hive/20-6152215.png" width="100%" height="100%" alt="å›¾ç‰‡åç§°" align="left/">
<h2 id="ç¬¬ä¸‰éƒ¨åˆ†">ç¬¬ä¸‰éƒ¨åˆ†</h2>
<h3 id="select-é-group-by-å­—æ®µ">select é group by å­—æ®µ</h3>
<p><strong>MySQLæ”¯æŒ</strong>ï¼ŒHive,Impala,PostgreSQL ä¸æ”¯æŒ</p>
<p>å¯¹äºä¸‹é¢è¿™ä¸€æ®µSQL</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> dept</span><br><span class="line">     , emp</span><br><span class="line">     , <span class="built_in">max</span>(sal) <span class="keyword">as</span> max_sal</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'A'</span> <span class="keyword">as</span> dept, <span class="string">'a1'</span> <span class="keyword">as</span> emp, <span class="number">10</span> <span class="keyword">as</span> sal <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'A'</span> <span class="keyword">as</span> dept, <span class="string">'a2'</span> <span class="keyword">as</span> emp, <span class="number">20</span> <span class="keyword">as</span> sal <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'B'</span> <span class="keyword">as</span> dept, <span class="string">'b2'</span> <span class="keyword">as</span> emp, <span class="number">100</span> <span class="keyword">as</span> sal <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'B'</span> <span class="keyword">as</span> dept, <span class="string">'b1'</span> <span class="keyword">as</span> emp, <span class="number">200</span> <span class="keyword">as</span> sal</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> dept</span><br></pre></td></tr></tbody></table></figure>
<p>1ï¸âƒ£MySQL é€šè¿‡</p>
<p align="center">
  <img src="/2023/10/01/Hive/5.jpg" width="50%" alt="Your image description">
    <br>
  <span style="color:gray"> mysql select é group by çš„å­—æ®µ </span>
</p>
<p>MySQL é€‰æ‹©è®°å½•ä¸­çš„ç¬¬ä¸€ä¸ªè®°å½•(ä»å®éªŒç»“æœæ¥çœ‹ï¼Œæ˜¯è®°å½•çš„ç¬¬ä¸€è¡Œ)</p>
<p>2ï¸âƒ£ postgreSQLï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">[<span class="number">42803</span>] ERROR: <span class="keyword">column</span> "t.emp" must appear <span class="keyword">in</span> the <span class="keyword">GROUP</span> <span class="keyword">BY</span> clause <span class="keyword">or</span> be used <span class="keyword">in</span> an aggregate <span class="keyword">function</span></span><br></pre></td></tr></tbody></table></figure>
<p>3ï¸âƒ£ Hiveï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">Error while compiling statement: FAILED: SemanticException [Error <span class="number">10025</span>]: line <span class="number">2</span>:<span class="number">7</span> Expression <span class="keyword">not</span> <span class="keyword">in</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> key <span class="string">'emp'</span></span><br></pre></td></tr></tbody></table></figure>
<p>4ï¸âƒ£ Impalaï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">AnalysisException: <span class="keyword">select</span> list expression <span class="keyword">not</span> produced <span class="keyword">by</span> aggregation output (missing <span class="keyword">from</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> clause?): emp</span><br></pre></td></tr></tbody></table></figure>
<h3 id="having-è¿‡æ»¤æ˜¯å¦æ”¯æŒåˆ«å">having è¿‡æ»¤æ˜¯å¦æ”¯æŒåˆ«å</h3>
<p>MySQLå’ŒHiveæ˜¯æ”¯æŒçš„ï¼Œ impalaå’ŒpostgreSQLä¸æ”¯æŒï¼ŒğŸˆï¼š<strong>æ¨èæ— è®ºä½•æ—¶éƒ½ä¸ä½¿ç”¨åˆ«åè¿›è¡Œåˆ†ç»„åè¿‡æ»¤</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> a, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">5</span> <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">4</span> <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">4</span> <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">3</span> <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">3</span> <span class="keyword">as</span> a</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a</span><br><span class="line"><span class="keyword">having</span> cnt <span class="operator">&gt;</span> <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸Šè¿°çš„SQLåœ¨MySQL å’Œ hiveä¸­æ‰§è¡Œéƒ½æ˜¯æ²¡é—®é¢˜çš„ï¼Œåœ¨impalaå’ŒpostgreSQLæŠ¥é”™ <code>column "cnt" does not exist</code>,éœ€è¦ä¸‹é¢çš„å†™æ³•</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> a, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">5</span> <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">4</span> <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">4</span> <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">3</span> <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">3</span> <span class="keyword">as</span> a</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="order-by-å­—ç¬¦ä¸²">order by å­—ç¬¦ä¸²</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> a</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span>  <span class="string">'a'</span> <span class="keyword">as</span> a <span class="keyword">union</span> <span class="keyword">all</span>  <span class="comment">-- 97</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">''</span> <span class="keyword">as</span> a <span class="keyword">union</span> <span class="keyword">all</span>    <span class="comment">-- 66</span></span><br><span class="line">    <span class="keyword">select</span>  <span class="string">' '</span> <span class="keyword">as</span> a <span class="keyword">union</span> <span class="keyword">all</span>  <span class="comment">-- 32</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">null</span> <span class="keyword">as</span> a            <span class="comment">-- 0</span></span><br><span class="line">) t</span><br><span class="line"><span class="keyword">order</span>  <span class="keyword">by</span> a <span class="keyword">desc</span> ;</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹äºä»¥ä¸ŠæŸ¥è¯¢å’Œæ’åºï¼ŒHiveå’ŒMySQLè®¤ä¸ºNULLæ˜¯æœ€å°ï¼›Impalaå’ŒPostgresSQLè®¤ä¸ºNULLæœ€å¤§ï¼Œå¦‚æœä½¿ç”¨<code>explain</code>å‘½ä»¤æŸ¥çœ‹SQLçš„æ‰§è¡Œè®¡åˆ’çš„è¯ï¼Œä¼šæ˜æ˜¾çœ‹åˆ°ç¼–è¯‘å™¨ä¼šç»™SQLæ·»åŠ 1ä¸ª<code>null first / null last</code>çš„æ˜äº®ï¼Œè¿™ä¸ªå–å†³äºå…·ä½“çš„å¼•æ“ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±testä¸‹ï¼Œæ¯”å¦‚Hiveä¼šå°†nullè®¾ä¸ºæœ€å°ï¼Œimpalaä¼šå°†nullè®¾ä¸ºæœ€å¤§</p>
<p align="center">
  <img src="/2023/10/01/Hive/10.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> nullï¼Œç©ºä¸²ï¼Œç©ºæ ¼ ä¹‹é—´çš„æ’åºå…³ç³»</span>
</p>
<h3 id="24-5-çš„ç»“æœ">$24/5$çš„ç»“æœ</h3>
<table>
<thead>
<tr>
<th>DB/Program Language</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Java / PostgreSQL</td>
<td>4</td>
</tr>
<tr>
<td>Hive / Impala / MySQL</td>
<td>4.8</td>
</tr>
</tbody>
</table>
<h3 id="çª—å£å‡½æ•°æ˜¯å¦æ”¯æŒdistinct">çª—å£å‡½æ•°æ˜¯å¦æ”¯æŒ<code>distinct</code></h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span>  A, B , <span class="built_in">count</span>( <span class="keyword">distinct</span> A) <span class="keyword">over</span>()</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span> <span class="keyword">as</span> A ,<span class="string">'a'</span> <span class="keyword">as</span> B <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="number">2</span> <span class="keyword">as</span> A ,<span class="string">'b'</span> <span class="keyword">as</span> B <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span> <span class="keyword">as</span> A ,<span class="string">'c'</span> <span class="keyword">as</span> B <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="number">3</span> <span class="keyword">as</span> A ,<span class="string">'d'</span> <span class="keyword">as</span> B</span><br><span class="line">) t</span><br></pre></td></tr></tbody></table></figure>
<p>æ¯”å¦‚ä»¥ä¸Šçš„SQLæŸ¥è¯¢ï¼šHiveæ˜¯æ”¯æŒçš„ï¼ŒImpalaï¼ŒMySQLï¼ŒPostgreSQLæš‚æ—¶æ²¡æœ‰å®ç°</p>
<h3 id="çª—å£åµŒå¥—">çª—å£åµŒå¥—</h3>
<p>çª—å£å‡½æ•°çš„åµŒå¥—ï¼ŒåªHive<sub>2.1.1</sub>ä¸­æ˜¯æ”¯æŒçš„ï¼ŒPostgreSQL(<code>window functions are not allowed in window definitions</code>)ï¼ŒMySQLï¼ŒImpala ä¸­åªèƒ½å¤šåµŒå¥—ä¸€å±‚</p>
<p align="center">
  <img src="/2023/10/01/Hive/17.jpg" width="80%" alt="Your image description">
    <br>
  <span style="color:gray"> ä¸åŒçš„å¼•æ“å¯¹äºçª—å£åµŒå¥—çš„æ”¯æŒ </span>
</p>
<h3 id="å­—ç¬¦ä¸²å†™å…¥æ•°å€¼ç±»å‹">å­—ç¬¦ä¸²å†™å…¥æ•°å€¼ç±»å‹</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span>  business (</span><br><span class="line">    name strng,</span><br><span class="line">    order_date string,</span><br><span class="line">    cost <span class="type">float</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> business <span class="keyword">values</span>(<span class="string">'xioaming'</span>,<span class="string">'2021-08-22'</span>,<span class="string">''</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Hive ä¼šå°†å­—ç¬¦ä¸²è½¬ä¸º<code>null</code>å†™å…¥ï¼›Impalaï¼ŒMySQLï¼ŒPostgreSQLä¼šè¿›è¡Œç±»å‹æ£€æŸ¥å¼‚å¸¸</p>
<h3 id="å­—æ®µæˆªå–">å­—æ®µæˆªå–</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySql</span></span><br><span class="line"><span class="keyword">select</span> substring_index(substring_index(<span class="string">'A/B/C/D/E'</span>, <span class="string">'/'</span>, <span class="number">4</span>), <span class="string">'/'</span>, <span class="number">-1</span>) <span class="keyword">as</span> dept_name0 <span class="comment">-- D</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- hiveï¼Œç´¢å¼•ä»0å¼€å§‹</span></span><br><span class="line"><span class="keyword">select</span> substring_index(substring_index(<span class="string">'A/B/C/D/E'</span>, <span class="string">'/'</span>, <span class="number">4</span>), <span class="string">'/'</span>, <span class="number">-1</span>) <span class="keyword">as</span> dept_name0 <span class="comment">-- D</span></span><br><span class="line">     , split(<span class="string">'A/B/C/D/E'</span>, <span class="string">'/'</span>)[<span class="number">3</span>]                                     <span class="keyword">as</span> dept_name1 <span class="comment">-- D</span></span><br><span class="line">     </span><br><span class="line">    </span><br><span class="line"><span class="comment">-- pg/holo ç´¢å¼•ä»1å¼€å§‹</span></span><br><span class="line"><span class="keyword">select</span> split_part(<span class="string">'A/B/C/D/E'</span>, <span class="string">'/'</span>,<span class="number">4</span>)                                <span class="keyword">as</span> dept_name1 <span class="comment">-- D</span></span><br><span class="line"><span class="comment">-- impala ç´¢å¼•ä»1å¼€å§‹</span></span><br><span class="line"><span class="keyword">select</span> split_part(<span class="string">'A/B/C/D/E'</span>, <span class="string">'/'</span>,<span class="number">4</span>)                                <span class="keyword">as</span> dept_name1 <span class="comment">-- Dã€</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å…¶ä¸­ï¼Œholoå­˜åœ¨ä»¥ä¸‹å‡½æ•°</span></span><br><span class="line"><span class="keyword">select</span> string_to_array(<span class="string">'xx~^~yy~^~zz'</span>, <span class="string">'~^~'</span>)           <span class="comment">-- {xx,yy,zz}</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="column-name-not-in-a-ä¼šè¿‡æ»¤æ‰-null-çš„è®°å½•"><code>column_name not in (a)</code> ä¼šè¿‡æ»¤æ‰ <code>null</code> çš„è®°å½•</h3>
<p><code>column_name not in (a)</code>ï¼š å‡ºäº†ä¼šè¿‡æ»¤æ‰å€¼ä¸º<code>a</code>çš„è®°å½•ï¼Œè¿˜ä¼šè¿‡æ»¤æ‰ <code>column_name</code>ä¸º <code>null</code> çš„è®°å½•</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span> (<span class="comment">-- </span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'a'</span> <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'b'</span> <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'c'</span> <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">null</span> <span class="keyword">as</span> a</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tmp1</span><br><span class="line"><span class="keyword">where</span> a <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'a'</span>)</span><br><span class="line"><span class="comment">-- ç»“æœè¿”å› a,c</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Impala-çš„æ¨¡ç³Šå…³è”ï¼ˆéç­‰å€¼å…³è”ï¼‰"><code>Impala</code> çš„æ¨¡ç³Šå…³è”ï¼ˆéç­‰å€¼å…³è”ï¼‰</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- t2.name æ˜¯ t1.name çš„å­ä¸²çš„æ—¶å€™å³è¿”å› true ï¼Œæ³¨æ„é¡ºåº</span></span><br><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span> ( <span class="comment">--</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'åº·æ©è´/CONBA'</span> <span class="keyword">as</span> name, <span class="string">'2023-01-01'</span> <span class="keyword">as</span> live_date</span><br><span class="line">)</span><br><span class="line">   , tmp2 <span class="keyword">as</span> ( <span class="comment">--</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'CONBA'</span> <span class="keyword">as</span> name, <span class="string">'2023-01-01'</span> <span class="keyword">as</span> live_date</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tmp1      t1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> tmp2 t2</span><br><span class="line">          <span class="keyword">on</span> t1.live_date <span class="operator">=</span> t2.live_date</span><br><span class="line">              <span class="keyword">and</span> t1.name rlike t2.name</span><br></pre></td></tr></tbody></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left">name</th>
<th style="text-align:left">live_date</th>
<th style="text-align:left">name</th>
<th style="text-align:left">live_date</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">åº·æ©è´/CONBA</td>
<td style="text-align:left">2023-01-01</td>
<td style="text-align:left">CONBA</td>
<td style="text-align:left">2023-01-01</td>
</tr>
</tbody>
</table>
<h2 id="ç¬¬å››éƒ¨åˆ†">ç¬¬å››éƒ¨åˆ†</h2>
<h3 id="null-x-å…³è”"><code>null</code>,<code>x</code> å…³è”</h3>
<p align="center">
  <img src="/2023/10/01/Hive/11.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> null å’Œå…¶ä»–å€¼çš„å…³è” </span>
</p>
<p>åœ¨ä»»ä½• <code>SQL(MySQL,PostgreSQL,Hive,Impala) </code>å¼•æ“ä¸­ï¼Œ<strong><code>null</code>å’Œä»»æ„å€¼éƒ½æ— æ³•å…³è”æ— æ³•ç›¸äº’å…³è”ï¼ŒåŒ…æ‹¬å…¶æœ¬èº«</strong></p>
<blockquote>
<p>PostgreSQLä¸­æœ‰ç±»å‹æ¢æµ‹ï¼Œæ‰§è¡Œä»¥ä¸Šå…³è”ä¼šå‘ç”Ÿï¼š<a href="https://stackoverflow.com/questions/18073901/failed-to-find-conversion-function-from-unknown-to-text">Failed to find conversion function from unknown to text</a></p>
</blockquote>
<h3 id="è¿”å›1è¡Œ-è¿”å›0è¡Œ">è¿”å›1è¡Œ&amp;è¿”å›0è¡Œ</h3>
<p><strong>ä½¿ç”¨èšåˆå‡½æ•°ï¼Œè¿”å›çš„è¡Œæ•°ä¸€å®šå¤§äºç­‰äº1</strong></p>
<p align="center">
  <img src="/2023/10/01/Hive/16.png" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> è¿”å›0è¡Œå’Œè¿”å›1è¡Œ </span>
</p>
<h3 id="union-all-çš„ç±»å‹">union all çš„ç±»å‹</h3>
<p><strong>ä»»ä½•å¼•æ“ï¼Œ<code>union all</code>çš„ç±»å‹å¿…é¡»ä¿æŒä¸€è‡´</strong></p>
<h3 id="ç»„åˆä¸»é”®énull">ç»„åˆä¸»é”®é<code>null</code></h3>
<p>å¯¹äº<code>test01</code>è¡¨ï¼Œå­—æ®µ<code>a</code>å’Œå­—æ®µ<code>b</code>åœ¨ä½œä¸ºè”åˆä¸»é”®æ—¶ï¼Œåœ¨å­—æ®µ<code>a</code>ä¸º<code>null</code>ï¼Œå­—æ®µ<code>b</code>é<code>null</code>çš„æ—¶å€™</p>
<p>1ï¸âƒ£<code>kudu</code>å°†ä¸ä¼šå†™å…¥è¯¥è®°å½•ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ï¼Œ<strong>å¯¼è‡´å†™å…¥æ•°æ®å’ŒæŸ¥è¯¢æ•°æ®è®°å½•æ•°ä¸ä¸€è‡´</strong></p>
<p>2ï¸âƒ£<code>MySql</code>æ’å…¥æ—¶æŠ›å‡ºå¼‚å¸¸ ç±»ä¼¼(<code>primary key not null</code>)</p>
<p>3ï¸âƒ£<code>postgresql</code> æ’å…¥æ—¶æŠ›å‡ºå¼‚å¸¸ ç±»ä¼¼(<code>primary key not null</code>)</p>
<h3 id="æ—¶é—´æˆ³">æ—¶é—´æˆ³</h3>
<p>âš ï¸æ—¶é—´æ˜¯äººå¯è¯†åˆ«çš„ï¼Œæ—¶é—´æˆ³åŸºæœ¬æ˜¯æœºå™¨è¯†åˆ«çš„ï¼Œæ¯”å¦‚2022-01-01 00:00:00ï¼ˆ1640966400ï¼‰ï¼Œå‰è€…æ˜¯æ—¶é—´ï¼Œåè€…æ˜¯æ—¶é—´æˆ³ï¼Œå‡ ä¹æ‰€æœ‰çš„å¼•æ“éƒ½å®ç°äº† <code>unix_timestamp</code>æ–¹æ³•ï¼Œæ”¯æŒä¼ å…¥ä¸€ä¸ªæ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰ä¼ å…¥æ—¶é—´å°†ä½¿ç”¨å½“å‰çš„æ—¶åˆ»</p>
<p>1ï¸âƒ£ è·å–æ—¶é—´æˆ³</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--mysql</span></span><br><span class="line"><span class="keyword">select</span> unix_timestamp(<span class="string">'2022-01-01 00:00:00'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- hive </span></span><br><span class="line"><span class="keyword">select</span> unix_timestamp(<span class="string">'2022-01-01 00:00:00'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>2ï¸âƒ£è·å–æ—¶é—´</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- mysql</span></span><br><span class="line"><span class="keyword">select</span> now();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- hive</span></span><br><span class="line"><span class="keyword">select</span> from_unixtime( unix_timestamp());</span><br><span class="line"></span><br><span class="line"><span class="comment">-- impala</span></span><br><span class="line"><span class="keyword">select</span> now(),  utc_timestamp(),<span class="built_in">current_timestamp</span>(),from_unixtime( unix_timestamp());</span><br><span class="line"></span><br><span class="line"><span class="comment">-- pg</span></span><br><span class="line"><span class="keyword">select</span>  now() ,  <span class="built_in">current_timestamp</span>;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="å»æ‰æ–‡æœ¬ä¸­çš„æ¢è¡Œç¬¦-å›è½¦ç¬¦-åˆ¶è¡¨ç¬¦-ç©ºæ ¼ï¼Œæ­£åˆ™æ›¿æ¢">å»æ‰æ–‡æœ¬ä¸­çš„æ¢è¡Œç¬¦/å›è½¦ç¬¦/åˆ¶è¡¨ç¬¦/ç©ºæ ¼ï¼Œæ­£åˆ™æ›¿æ¢</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- \s è¡¨ç¤ºåŒ¹é…ä¸€ä¸ªæˆ–è€…å¤šä¸ªç©ºç™½å­—ç¬¦ï¼ˆåŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ï¼‰ï¼Œ '+' è¡¨ç¤ºåŒ¹é…å‰é¢çš„æ¨¡å¼ï¼ˆå³'\s'ï¼‰ä¸€æ¬¡æˆ–å¤šæ¬¡ </span></span><br><span class="line"><span class="keyword">select</span> regexp_replace(input_content,<span class="string">'\\s+'</span>,<span class="string">''</span>) <span class="keyword">as</span> after_content</span><br><span class="line"><span class="comment">-- hive</span></span><br><span class="line"><span class="keyword">select</span> regexp_replace(video_desc,<span class="string">'\t|\n|\001|\r'</span>,<span class="string">''</span>) <span class="keyword">as</span> video_desc</span><br><span class="line"></span><br><span class="line"><span class="comment">-- mysql5.7ä¸­ä¸æ”¯æŒregexp_replaceï¼Œ8.0ä¸­æ”¯æŒï¼Œæ‰€ä»¥åœ¨5.7ä¸­ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">select</span> replace(replace(video_desc, <span class="type">char</span>(<span class="number">13</span>), <span class="string">''</span>), <span class="type">char</span>(<span class="number">10</span>), <span class="string">''</span>) <span class="keyword">as</span> video_desc</span><br><span class="line"><span class="keyword">select</span> <span class="string">'1\r2\t\3\n4\0015'</span></span><br><span class="line">    ,regexp_replace(<span class="string">'1\r2\t\3\n4'</span>,<span class="string">'\\s+'</span>,<span class="string">''</span>)</span><br><span class="line">    ,regexp_replace(<span class="string">'1     \r2\t\3\n4\0015'</span>,<span class="string">'\\s+'</span>,<span class="string">''</span>)</span><br><span class="line">    ,regexp_replace(<span class="string">'1     \r2\t\3\n4\0015'</span>,<span class="string">'\t|\n|\001|\r'</span>,<span class="string">''</span>)</span><br></pre></td></tr></tbody></table></figure>
<p align="center">
  <img src="/2023/10/01/Hive/18.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> ç”±äºç‰¹æ®Šå­—ç¬¦å¯¼è‡´è¡¨é”™ä½ä¸²è¡Œçš„é—®é¢˜æè¿° </span>
</p>
<h3 id="impala-upsert-Kudu">impala upsert + Kudu</h3>
<p>æœ¬è´¨æ˜¯<code>insert</code>  + <code>update</code> çš„ç»“åˆ</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>ä¸»é”®å­˜åœ¨æ—¶ï¼Œ<strong>å…¨å­—æ®µ</strong>æ›´æ–°</p>
</li>
<li class="lvl-2">
<p>ä¸»é”®ä¸å­˜åœ¨æ—¶ï¼Œæ’å…¥</p>
</li>
</ul>
<h3 id="ä¸ä½¿ç”¨order-by-æ‰¾åˆ°å·¥èµ„ç¬¬äºŒçš„å‘˜å·¥">ä¸ä½¿ç”¨<code>order by</code> æ‰¾åˆ°å·¥èµ„ç¬¬äºŒçš„å‘˜å·¥</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    e.emp_no,</span><br><span class="line">    salary,</span><br><span class="line">    last_name,</span><br><span class="line">    first_name</span><br><span class="line"><span class="keyword">from</span> employees e</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> salaries s</span><br><span class="line"><span class="keyword">on</span> e.emp_no <span class="operator">=</span> s.emp_no</span><br><span class="line"><span class="keyword">where</span> s.to_date <span class="operator">=</span> <span class="string">'9999-01-01'</span> </span><br><span class="line"><span class="keyword">and</span> s.salary <span class="operator">=</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> s1.salary</span><br><span class="line">    <span class="keyword">from</span> salaries s1</span><br><span class="line">    <span class="keyword">inner</span> <span class="keyword">join</span> salaries s2</span><br><span class="line">    <span class="keyword">on</span> s1.salary <span class="operator">&lt;=</span> s2.salary</span><br><span class="line">    <span class="keyword">where</span> s1.to_date <span class="operator">=</span> <span class="string">'9999-01-01'</span> <span class="keyword">and</span> s2.to_date <span class="operator">=</span> <span class="string">'9999-01-01'</span> </span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s1.salary</span><br><span class="line">    <span class="keyword">having</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> s2.salary) <span class="operator">=</span> <span class="number">2</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>æœ€å¤§å€¼åªèƒ½å°äºç­‰äºæœ€å¤§å€¼ï¼ˆå‡ºç°1æ¬¡)ï¼›æ¬¡å¤§å€¼åªèƒ½å°äºç­‰äºæœ€å¤§å€¼å’Œæœ¬èº«ï¼ˆå‡ºç°2æ¬¡ï¼‰</p>
<p align="center">
  <img src="/2023/10/01/Hive/4.jpg" width="30%" alt="Your image description">
    <br>
  <span style="color:gray"> æ±‚è–ªèµ„æ¬¡é«˜çš„å‘˜å·¥ </span>
</p>
<h3 id="from-tmp1-tmp2-çš„æœ¬è´¨">from tmp1 , tmp2 çš„æœ¬è´¨</h3>
<p><strong><code>from tmp1 , tmp2</code> çš„æœ¬è´¨å°±æ˜¯ <code>inner join</code>çš„è¡Œä¸º</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span> (<span class="keyword">select</span> <span class="string">'a'</span> <span class="keyword">as</span> name, <span class="number">10</span> <span class="keyword">as</span> age</span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">              <span class="keyword">select</span> <span class="string">'b'</span> <span class="keyword">as</span> name, <span class="number">11</span> <span class="keyword">as</span> age</span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">              <span class="keyword">select</span> <span class="string">'c'</span> <span class="keyword">as</span> name, <span class="number">12</span> <span class="keyword">as</span> age</span><br><span class="line">)</span><br><span class="line">   , tmp2 <span class="keyword">as</span> (<span class="keyword">select</span> <span class="string">'c'</span> <span class="keyword">as</span> name, <span class="string">'female'</span> <span class="keyword">as</span> sex</span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">              <span class="keyword">select</span> <span class="string">'d'</span> <span class="keyword">as</span> name, <span class="string">'male'</span> <span class="keyword">as</span> sex</span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">              <span class="keyword">select</span> <span class="string">'e'</span> <span class="keyword">as</span> name, <span class="string">'female'</span> <span class="keyword">as</span> sex</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> t1.name</span><br><span class="line">     , t1.age</span><br><span class="line">     , t2.sex</span><br><span class="line"><span class="keyword">from</span> tmp1 t1</span><br><span class="line">   , tmp2 t2</span><br><span class="line"><span class="keyword">where</span> t1.name <span class="operator">=</span> t2.name</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸Šè¿°çš„SQLç­‰åŒäºä¸‹åˆ—SQL</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span> (<span class="keyword">select</span> <span class="string">'a'</span> <span class="keyword">as</span> name, <span class="number">10</span> <span class="keyword">as</span> age</span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">              <span class="keyword">select</span> <span class="string">'b'</span> <span class="keyword">as</span> name, <span class="number">11</span> <span class="keyword">as</span> age</span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">              <span class="keyword">select</span> <span class="string">'c'</span> <span class="keyword">as</span> name, <span class="number">12</span> <span class="keyword">as</span> age</span><br><span class="line">)</span><br><span class="line">   , tmp2 <span class="keyword">as</span> (<span class="keyword">select</span> <span class="string">'c'</span> <span class="keyword">as</span> name, <span class="string">'female'</span> <span class="keyword">as</span> sex</span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">              <span class="keyword">select</span> <span class="string">'d'</span> <span class="keyword">as</span> name, <span class="string">'male'</span> <span class="keyword">as</span> sex</span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">              <span class="keyword">select</span> <span class="string">'e'</span> <span class="keyword">as</span> name, <span class="string">'female'</span> <span class="keyword">as</span> sex</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> t1.name, t1.age, t2.sex</span><br><span class="line"><span class="keyword">from</span> tmp1       t1</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> tmp2 t2</span><br><span class="line">           <span class="keyword">on</span> t1.name <span class="operator">=</span> t2.name</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Hive-ä¸­å¼ºåˆ¶-mapjoin">Hive ä¸­å¼ºåˆ¶ <code>mapjoin</code></h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="comment">/*+ mapjoin(t2)*/</span>  <span class="comment">--å¼ºåˆ¶æŒ‡å®šå…³è”æ–¹å¼</span></span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> t2 </span><br><span class="line"><span class="keyword">on</span> t1.key<span class="operator">=</span> t2.key</span><br></pre></td></tr></tbody></table></figure>
<h2 id="ç¬¬å››éƒ¨åˆ†-2">ç¬¬å››éƒ¨åˆ†</h2>
<p><a href="https://github.com/ifseayou/virgin-sql/blob/master/test_app.fna_compare_zhubo_stat_df.sql">ORCå­˜å‚¨æ ¼å¼ å’Œ RCFileå­˜å‚¨æ ¼å¼çš„ä¸€ä¸ªé—®é¢˜ - å‘ç”Ÿ Unknow Reasoné—®é¢˜</a></p>
<p><a href="https://github.com/ifseayou/virgin-sql/blob/master/test_app.live_goods_category_detail_df.sql">union all  + distint çš„æ—¶å€™éœ€è¦è®¾ç½® <code>set hive.vectorized.execution.enabled=false;</code></a></p>
<p><a href="https://stackoverflow.com/questions/41057311/the-value-of-spark-yarn-executor-memoryoverhead-setting">spark.yarn.executor.memoryOverhead</a> ï¼Œè¯¥å‚æ•°<a href="https://spark.apache.org/docs/2.2.0/running-on-yarn.html">å®˜æ–¹åœ°å€</a>ï¼Œå‡ºç°è¿™ä¸ªé—®é¢˜æå‡è¯¥å‚æ•°çš„é˜ˆå€¼æ˜¯ä¸€æ–¹é¢ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥å¢åŠ  executorçš„æ•°é‡ï¼Œ<code>set spark.dynamicAllocation.maxExecutors=14;</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">return code 3 from org.apache.hadoop.hive.ql.exec.spark.SparkTask. Spark job failed because of out of memory.</span><br><span class="line"></span><br><span class="line">ExecutorLostFailure (executor 10 exited caused by one of the running tasks) Reason: Container killed by YARN for exceeding memory limits. 15.3 GB of 15.3 GB physical memory used. Consider boosting spark.yarn.executor.memoryOverhead</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p><code>spark.yarn.executor.memoryOverhead</code>æ˜¯Yarnåˆ†é…ç»™ <code>executor</code> çš„å †å¤–å†…å­˜</p>
</blockquote>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">Finished Stage<span class="number">-2</span>_0: <span class="number">1098</span>(+<span class="number">1</span>,<span class="number">-35</span>) /<span class="number">1099</span></span><br><span class="line">Finished Stage<span class="number">-2</span>_0: <span class="number">1099</span>(<span class="number">-35</span>)/<span class="number">1099</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- success/total</span></span><br><span class="line"><span class="comment">-- a(x,y)/b</span></span><br><span class="line">hive,sparkçš„è¿è¡Œæ—¥å¿—ï¼Œå¦‚æœaæœ€ç»ˆç­‰äºb,å°±æ˜¯taskæ˜¯æˆåŠŸçš„ï¼›</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¦‚ä½•è·å–æœˆåˆæœˆæœ«">å¦‚ä½•è·å–æœˆåˆæœˆæœ«</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> trunc(date_add(<span class="built_in">current_date</span>,<span class="number">-1</span>),<span class="string">'MM'</span>) <span class="keyword">as</span> month_first_day    <span class="comment">-- hive  æœˆåˆ</span></span><br><span class="line"><span class="keyword">select</span> date_format(<span class="string">'2020-01-02 10:09:08'</span>,<span class="string">'yyyy-MM-01'</span>) <span class="comment">--  hive</span></span><br><span class="line"><span class="keyword">select</span> trunc(<span class="built_in">current_date</span>,<span class="string">'MM'</span>)  <span class="comment">-- spark-sql ,hive</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> last_day(<span class="built_in">current_timestamp</span>()) <span class="comment">-- æœˆæœ«</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¦‚ä½•å¤„ç†åŠ¨æ€åˆ†åŒºå†™å…¥">å¦‚ä½•å¤„ç†åŠ¨æ€åˆ†åŒºå†™å…¥</h3>
<ol>
<li class="lvl-3">
<p>å¼€å¯éä¸¥æ ¼æ¨¡å¼ <code>set hive.exec.dynamic.partition.mode=nonstrict</code></p>
</li>
<li class="lvl-3">
<p>åŠ¨æ€åˆ†åŒºå†™å…¥æ³¨æ„partitionï¼ˆdate_idï¼‰çš„å­—æ®µå’Œselect åçš„å­—æ®µåç§°ä¿æŒä¸€è‡´</p>
</li>
<li class="lvl-3">
<p>åŠ¨æ€åˆ†åŒºå­—æ®µæ”¾åœ¨<code>select</code> çš„æœ€åä¸€è¡Œ</p>
</li>
</ol>
<p>Memory limit exceeded: Could not allocate memory while trying to increase reservation</p>
<blockquote>
<ol>
<li class="lvl-3">
<p>æœ€å¸¸ç”¨çš„æ–¹å¼æ˜¯ï¼šé‡è¯•</p>
</li>
<li class="lvl-3">
<p>é™ä½æŸ¥è¯¢å¹¶å‘åº¦ï¼šå‡å°‘åŒæ—¶æ‰§è¡Œçš„æŸ¥è¯¢æ•°é‡ï¼Œè¿™æ ·å¯ä»¥ä¸ºæ¯ä¸ªæŸ¥è¯¢åˆ†é…æ›´å¤šçš„å†…å­˜</p>
</li>
<li class="lvl-3">
<p>é…ç½®å‡†å…¥æ§åˆ¶ï¼šImpala æ”¯æŒå‡†å…¥æ§åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥é™åˆ¶åŒæ—¶æ‰§è¡Œçš„æŸ¥è¯¢æ•°é‡ï¼Œé¿å…èµ„æºç«äº‰ã€‚ <a href="https://docs.cloudera.com/documentation/enterprise/5-8-x/topics/impala_admission.html">Impala Admission Control æ–‡æ¡£</a></p>
</li>
<li class="lvl-3">
<p>è€ƒè™‘ä¼˜åŒ–æŸ¥è¯¢ä»¥é™ä½å†…å­˜éœ€æ±‚ï¼ˆsql æœ¬èº«ï¼Œ<code>limit</code> ç­‰ï¼‰</p>
</li>
</ol>
</blockquote>
<h3 id="jsonæ•°ç»„å¦‚ä½•è§£æ">jsonæ•°ç»„å¦‚ä½•è§£æ</h3>
<p>å¦‚ä½•è§£æJSON æ•°ç»„ï¼ŸJSONæ•°ç»„å¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ï¼š <code>[{},{}]</code>ï¼Œä»¥ä¸‹æ˜¯è§£ædemo</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> explode(</span><br><span class="line">               split(</span><br><span class="line">                       regexp_replace(</span><br><span class="line">                               regexp_replace(                                      <span class="string">'[{"skuNo":"KU413455571546619913","propertyValue":"é›¾éœ¾è“"},{"skuNo":"KU413455571546619912","propertyValue":"åŒ—æç»¿"},{"skuNo":"KU413455571546619911","propertyValue":"äºšéº»é‡‘"}]'</span>,</span><br><span class="line">                                       <span class="string">'\\[|\\]'</span>, <span class="string">''</span>), <span class="comment">--å°†jsonæ•°ç»„ä¸¤è¾¹çš„ä¸­æ‹¬å·å»æ‰</span></span><br><span class="line">                               <span class="string">'\\}\\,\\{'</span>, <span class="string">'\\}\\;\\{'</span>), <span class="comment">--å°†jsonæ•°ç»„å…ƒç´ ä¹‹é—´çš„é€—å·æ¢æˆåˆ†å·</span></span><br><span class="line">                       <span class="string">'\\;'</span>) <span class="comment">--ä»¥åˆ†å·ä½œä¸ºåˆ†éš”ç¬¦(splitå‡½æ•°ä»¥åˆ†å·ä½œä¸ºåˆ†éš”)</span></span><br><span class="line">           )</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¦‚ä½•æ±‚-å½“å‰æ—¥æœŸè‡³å‰7-30å¤©-çš„èšåˆå€¼ï¼Ÿ">å¦‚ä½•æ±‚ <code>å½“å‰æ—¥æœŸè‡³å‰7/30å¤©</code> çš„èšåˆå€¼ï¼Ÿ</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span> ( <span class="comment">-- æ±‚ï¼šåŒä¸€ä¸ªè´¦å·ï¼ŒåŒä¸€ä¸ªå•†å“ï¼Œåœ¨åŒ…å«ç›´æ’­æ—¥æœŸå†…çš„7å¤©å†…ï¼Œæ’­è¿‡å¤šå°‘æ¬¡ï¼Ÿ</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'1424128656'</span> <span class="keyword">as</span> account_id, <span class="string">'259183220'</span> <span class="keyword">as</span> goods_id, <span class="string">'2022-06-28'</span> live_date</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'1424128656'</span> <span class="keyword">as</span> account_id, <span class="string">'259183220'</span> <span class="keyword">as</span> goods_id, <span class="string">'2022-06-22'</span> live_date</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'1424128656'</span> <span class="keyword">as</span> account_id, <span class="string">'259183220'</span> <span class="keyword">as</span> goods_id, <span class="string">'2022-06-17'</span> live_date</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'1424128656'</span> <span class="keyword">as</span> account_id, <span class="string">'259183220'</span> <span class="keyword">as</span> goods_id, <span class="string">'2022-06-15'</span> live_date</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'1424128656'</span> <span class="keyword">as</span> account_id, <span class="string">'262220152'</span> <span class="keyword">as</span> goods_id, <span class="string">'2021-12-09'</span> live_date</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">     , <span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line">             <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> account_id,goods_id</span><br><span class="line">                 <span class="keyword">order</span> <span class="keyword">by</span> unix_timestamp(live_date, <span class="string">'yyyy-MM-dd'</span>) <span class="keyword">desc</span></span><br><span class="line">                 <span class="keyword">range</span> <span class="keyword">between</span> <span class="number">1</span> following <span class="keyword">and</span> <span class="number">604800</span> following) <span class="operator">+</span> <span class="number">1</span> <span class="keyword">as</span> day_7 <span class="comment">-- è¿‡å»åŒ…å«ä»Šå¤©åœ¨å†…çš„7å¤©å†…å‡ºç°äº†å¤šå°‘æ¬¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tmp1</span><br></pre></td></tr></tbody></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left">account_id</th>
<th style="text-align:left">goods_id</th>
<th style="text-align:left">live_date</th>
<th style="text-align:left">day_</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1424128656</td>
<td style="text-align:left">259183220</td>
<td style="text-align:left">2022-06-28</td>
<td style="text-align:left">2</td>
</tr>
<tr>
<td style="text-align:left">1424128656</td>
<td style="text-align:left">259183220</td>
<td style="text-align:left">2022-06-22</td>
<td style="text-align:left">3</td>
</tr>
<tr>
<td style="text-align:left">1424128656</td>
<td style="text-align:left">259183220</td>
<td style="text-align:left">2022-06-17</td>
<td style="text-align:left">2</td>
</tr>
<tr>
<td style="text-align:left">1424128656</td>
<td style="text-align:left">259183220</td>
<td style="text-align:left">2022-06-15</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">1424128656</td>
<td style="text-align:left">262220152</td>
<td style="text-align:left">2021-12-09</td>
<td style="text-align:left">1</td>
</tr>
</tbody>
</table>
<h3 id="Hiveï¼Œcast-as-int-into-bigint-æ—¶ï¼Œæ•°æ®éƒ½æ˜¯0">Hiveï¼Œcast( as int) into  bigint æ—¶ï¼Œæ•°æ®éƒ½æ˜¯0</h3>
<p>Hiveä¸­</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- table_A ä¸­ Aå­—æ®µçš„ç±»å‹ä¸º bigint</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> table_A</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">cast</span>(a <span class="keyword">as</span> <span class="type">int</span>) <span class="keyword">as</span> A</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æœ€åæŸ¥è¯¢ Açš„æ•°æ®ä¸ºï¼Œå‡ä¸º0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- solutions ï¼š 2è¾¹ç±»å‹ä¿æŒä¸€è‡´å³å¯</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="æ—¶é—´Aåœ¨Bæ—¶é—´å¼€å§‹åçš„ç¬¬å‡ ä¸ªå°æ—¶">æ—¶é—´Aåœ¨Bæ—¶é—´å¼€å§‹åçš„ç¬¬å‡ ä¸ªå°æ—¶</h3>
<p>ç¡®å®šA æ—¶é—´ï¼ˆ <code>on_top_time</code> ï¼‰åœ¨ Bæ—¶é—´ ï¼ˆ<code>start_time</code>ï¼‰ çš„ç¬¬å‡ ä¸ªå°æ—¶å†…ï¼Œç›¸å½“äºæ±‚ç›¸å¯¹ä½ç½®é—®é¢˜ï¼ˆ5ç›¸å¯¹äº1çš„ä½ç½®æ˜¯å¤šå°‘ï¼‰</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span> ( <span class="comment">-- </span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'2023-01-01 12:00:00'</span> <span class="keyword">as</span> on_top_time, <span class="string">'2023-01-01 11:00:00'</span> <span class="keyword">as</span> start_time</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'2023-01-01 12:02:00'</span> <span class="keyword">as</span> on_top_time, <span class="string">'2023-01-01 11:00:00'</span> <span class="keyword">as</span> start_time</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'2023-01-01 12:59:00'</span> <span class="keyword">as</span> on_top_time, <span class="string">'2023-01-01 11:00:00'</span> <span class="keyword">as</span> start_time</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'2023-01-01 16:00:00'</span> <span class="keyword">as</span> on_top_time, <span class="string">'2023-01-01 11:00:00'</span> <span class="keyword">as</span> start_time</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> on_top_time                                          <span class="keyword">as</span> on_top_time</span><br><span class="line">     , start_time                                           <span class="keyword">as</span> start_time</span><br><span class="line">     , <span class="built_in">cast</span>((unix_timestamp(on_top_time) <span class="operator">-</span></span><br><span class="line">             unix_timestamp(start_time)) <span class="operator">/</span> <span class="number">3600</span> <span class="operator">+</span> <span class="number">1</span> <span class="keyword">as</span> <span class="type">int</span>) <span class="keyword">as</span> hours_id</span><br><span class="line"><span class="keyword">from</span> tmp1</span><br></pre></td></tr></tbody></table></figure>
<h3 id="is-not-in-the-vectorization-context-column-map">is not in the vectorization context column map</h3>
<p>åœ¨<a href="https://community.cloudera.com/t5/Support-Questions/hive-vectorization-union-all-problem/td-p/183179">Hive vectorization union all problem </a> ä¸€æ–‡ä¸­ï¼Œæå‡ºäº†ä¸€å®šçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯æ²¡æœ‰å†™å‡ºåŸå› </p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- åœ¨è®¡ç®—æ—¶ä¸ä½¿ç”¨å‘é‡åŒ–è®¡ç®—</span></span><br><span class="line"><span class="keyword">set</span> hive.vectorized.execution.enabled<span class="operator">=</span><span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¦‚ä½•å¤„ç†æ•°æ®å€¾æ–œï¼Ÿ">å¦‚ä½•å¤„ç†æ•°æ®å€¾æ–œï¼Ÿ</h3>
<p>å½“ä½ é‡åˆ°ä¸‹é¢å€¾æ–œçš„é—®é¢˜çš„æ—¶å€™ï¼šå‡è®¾Aè¡¨åœ¨ <code>id = 1</code> æœ‰å¤§é‡çš„æ•°æ®ï¼Œé’ˆå¯¹è¿™ç§å€¾æ–œåœºæ™¯ï¼Œæœ‰2ç§å¤„ç†æ–¹å¼ï¼šæ–¹å¼ ğŸ…°ï¸</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- åŸæœ‰çš„é€»è¾‘æ˜¯ï¼š</span></span><br><span class="line"><span class="keyword">select</span> A.id </span><br><span class="line"><span class="keyword">from</span> A </span><br><span class="line"><span class="keyword">join</span> B </span><br><span class="line"><span class="keyword">on</span> A.id <span class="operator">=</span> B.id </span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ”¹è¿›åçš„é€»è¾‘ï¼Œç¬¬ä¸€éƒ¨åˆ†ï¼Œè¯¥éƒ¨åˆ†æŸ¥è¯¢ä¸ä¼šæœ‰ä»»ä½•å€¾æ–œ</span></span><br><span class="line"><span class="keyword">select</span> A.id </span><br><span class="line"><span class="keyword">from</span> A </span><br><span class="line"><span class="keyword">join</span> B </span><br><span class="line"><span class="keyword">on</span> A.id <span class="operator">=</span> B.id </span><br><span class="line"><span class="keyword">where</span> A.id <span class="operator">&lt;&gt;</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ”¹è¿›åçš„é€»è¾‘ï¼Œç¬¬äºŒéƒ¨åˆ†,B.id=1çš„æ•°æ®é‡å¾ˆå°ï¼Œæˆ‘ä»¬å°†å…¶æ”¾å…¥å†…å­˜å…³è”ï¼Œåœ¨sparkç§å«å¹¿æ’­å…³è”ï¼Œåœ¨hiveä¸­å«åš map-join</span></span><br><span class="line"><span class="keyword">select</span> <span class="comment">/*+ mapjoin(B)*/</span> A.id </span><br><span class="line"><span class="keyword">from</span> A </span><br><span class="line"><span class="keyword">join</span> B </span><br><span class="line"><span class="keyword">on</span> A.id <span class="operator">=</span> B.id </span><br><span class="line"><span class="keyword">where</span> A.id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">and</span> B.id <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ–¹å¼ ğŸ…±ï¸</p>
<p>é€šè¿‡å¢åŠ éšæœºæ•° åˆ—çš„æ–¹å¼ï¼Œå¢åŠ å…³è”é”®,ä¸¾ä¸ªä¾‹å­ï¼šå¯¹äºAè¡¨</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">id</span><br><span class="line">a </span><br><span class="line">a</span><br><span class="line">a</span><br><span class="line">a</span><br><span class="line"><span class="comment">-- å°†å˜æˆ</span></span><br><span class="line">id  rand_column(<span class="number">0</span><span class="operator">~</span><span class="number">2</span>) </span><br><span class="line">a               <span class="number">0</span></span><br><span class="line">a           <span class="number">1</span></span><br><span class="line">a             <span class="number">2</span></span><br><span class="line">a           <span class="number">2</span></span><br><span class="line"></span><br><span class="line">å¯¹äºBè¡¨</span><br><span class="line">```<span class="keyword">sql</span></span><br><span class="line">id</span><br><span class="line">a</span><br><span class="line"><span class="comment">-- å°†å˜æˆ</span></span><br><span class="line">id rand_num</span><br><span class="line">a  <span class="number">0</span></span><br><span class="line">a  <span class="number">1</span></span><br><span class="line">a  <span class="number">2</span></span><br><span class="line"></span><br><span class="line">å‡è®¾ä¹‹å‰çš„å…³è”å…³ç³»æ˜¯ A.id <span class="operator">=</span> B.idï¼Œä¸ºäº†å¤„ç†å€¾æ–œï¼Œæˆ‘ä»¬é—´å…³è”å…³ç³»ä¿®æ”¹ä¸ºï¼š</span><br><span class="line">`A.id <span class="operator">=</span> B.id <span class="keyword">and</span> A.rand_num <span class="operator">=</span> B.rand_num`</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¦‚ä½•ä¸ºHiveè¡¨å¢åŠ ä¸€åˆ—ï¼Ÿ">å¦‚ä½•ä¸ºHiveè¡¨å¢åŠ ä¸€åˆ—ï¼Ÿ</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">`<span class="keyword">alter</span> <span class="keyword">table</span> dw.live_thin_room_order_goods_df  <span class="keyword">add</span> columns (third_party_shop_id string comment <span class="string">'ä¸‰æ–¹åº—é“ºid'</span>)`</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ç”Ÿæˆæ—¥æœŸç»´åº¦åˆ—">ç”Ÿæˆæ—¥æœŸç»´åº¦åˆ—</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- åœ¨hiveä¸­</span></span><br><span class="line"><span class="keyword">select</span> date_add("2023-08-01", a.pos) <span class="keyword">as</span> range_date</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">   <span class="keyword">select</span> posexplode(split(repeat("@", datediff("2023-08-31", "2023-08-01")), "@")) <span class="comment">-- ç¬¬ä¸€ä¸ªæ—¥æœŸç»ˆæ­¢æ—¥æœŸï¼Œç¬¬äºŒä¸ªæ—¥æœŸèµ·å§‹æ—¥æœŸï¼Œ</span></span><br><span class="line">) a</span><br></pre></td></tr></tbody></table></figure>
<p>ç»´è¡¨ç”Ÿæˆï¼Œä½¿ç”¨ <code>date_id = '2023-08-08'</code> çš„æ—¥æœŸç”Ÿæˆ <code>date_id = '2023-08-08'</code> ä¹‹å‰çš„æ—¥æœŸ</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.exec.dynamic.partition.mode<span class="operator">=</span>nonstrict;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> target_table <span class="keyword">partition</span> (date_id)</span><br><span class="line"><span class="keyword">select</span> id   <span class="keyword">as</span> id</span><br><span class="line">     , name <span class="keyword">as</span> name</span><br><span class="line">     , t1.date_id</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> date_add("2023-02-01", a.pos) <span class="keyword">as</span> date_id</span><br><span class="line">      <span class="keyword">from</span> (<span class="keyword">select</span> posexplode(split(repeat("@", datediff("2023-08-08", "2023-02-01")), "@")) <span class="comment">-- ç¬¬ä¸€ä¸ªæ—¥æœŸç»ˆæ­¢æ—¥æœŸï¼Œç¬¬äºŒä¸ªæ—¥æœŸèµ·å§‹æ—¥æœŸï¼Œ</span></span><br><span class="line">      ) a</span><br><span class="line">)            t1</span><br><span class="line"><span class="keyword">cross</span> <span class="keyword">join</span> (<span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">            <span class="keyword">from</span> target_table</span><br><span class="line">            <span class="keyword">where</span> date_id <span class="operator">=</span> <span class="string">'2023-08-09'</span></span><br><span class="line">           ) t2</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¦‚ä½•å°†è¿‡ç¨‹æ•°æ®åˆ’åˆ†åˆ°å°æ—¶">å¦‚ä½•å°†è¿‡ç¨‹æ•°æ®åˆ’åˆ†åˆ°å°æ—¶</h3>
<p>åœºæ™¯æè¿°ï¼šç°åœ¨æœ‰ä¸€ä¸ªç½‘é¡µçš„é¡µé¢ï¼Œçˆ¬è™«è¯»å–æ•°æ®ï¼Œæ¯åˆ†é’Ÿè¯»å–ä¸€æ¬¡ï¼Œå¹¶ä¸”è½åº“ï¼Œéœ€æ±‚æ˜¯å¾—åˆ°æ¯ä¸ªå°æ—¶çš„å¢é‡æ•°æ®</p>
<p align="center">
  <img src="/2023/10/01/Hive/26.png" width="100%" alt="Your image description">
   <br>
   <span style="color:gray"> info about the picture </span>
</p>
<p>ä»¥ä¸Šçš„ä»£ç å¦‚ä¸‹</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span> ( <span class="comment">-- l_c : launch_consume, up_at : updated_at, s_at: start_time ï¼Œ s_diff æ›´æ”¹æ—¶é—´è·ç¦»å¼€å§‹æ—¶é—´å¤šå°‘ç§’</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_01'</span> <span class="keyword">as</span> o_id, <span class="number">10</span> <span class="keyword">as</span> l_c, <span class="string">'2023-08-01 01:00:00'</span> <span class="keyword">as</span> up_at, <span class="string">'2023-08-01 00:30:00'</span> <span class="keyword">as</span> s_at</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_01'</span> <span class="keyword">as</span> o_id, <span class="number">20</span> <span class="keyword">as</span> l_c, <span class="string">'2023-08-01 01:30:00'</span> <span class="keyword">as</span> up_at, <span class="string">'2023-08-01 00:30:00'</span> <span class="keyword">as</span> s_at</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_01'</span> <span class="keyword">as</span> o_id, <span class="number">30</span> <span class="keyword">as</span> l_c, <span class="string">'2023-08-01 01:50:00'</span> <span class="keyword">as</span> up_at, <span class="string">'2023-08-01 00:30:00'</span> <span class="keyword">as</span> s_at</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_01'</span> <span class="keyword">as</span> o_id, <span class="number">25</span> <span class="keyword">as</span> l_c, <span class="string">'2023-08-01 02:00:00'</span> <span class="keyword">as</span> up_at, <span class="string">'2023-08-01 00:30:00'</span> <span class="keyword">as</span> s_at</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_01'</span> <span class="keyword">as</span> o_id, <span class="number">60</span> <span class="keyword">as</span> l_c, <span class="string">'2023-08-01 02:40:00'</span> <span class="keyword">as</span> up_at, <span class="string">'2023-08-01 00:30:00'</span> <span class="keyword">as</span> s_at</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_01'</span> <span class="keyword">as</span> o_id, <span class="number">80</span> <span class="keyword">as</span> l_c, <span class="string">'2023-08-01 03:00:00'</span> <span class="keyword">as</span> up_at, <span class="string">'2023-08-01 00:30:00'</span> <span class="keyword">as</span> s_at</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_01'</span> <span class="keyword">as</span> o_id, <span class="number">180</span> <span class="keyword">as</span> l_c, <span class="string">'2023-08-01 04:00:00'</span> <span class="keyword">as</span> up_at, <span class="string">'2023-08-01 00:30:00'</span> <span class="keyword">as</span> s_at</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_01'</span> <span class="keyword">as</span> o_id, <span class="number">200</span> <span class="keyword">as</span> l_c, <span class="string">'2023-08-01 04:05:00'</span> <span class="keyword">as</span> up_at, <span class="string">'2023-08-01 00:30:00'</span> <span class="keyword">as</span> s_at</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_01'</span> <span class="keyword">as</span> o_id, <span class="number">400</span> <span class="keyword">as</span> l_c, <span class="string">'2023-08-01 04:20:00'</span> <span class="keyword">as</span> up_at, <span class="string">'2023-08-01 00:30:00'</span> <span class="keyword">as</span> s_at</span><br><span class="line">)</span><br><span class="line">   , tmp2 <span class="keyword">as</span> ( <span class="comment">--</span></span><br><span class="line">    <span class="keyword">select</span> o_id                                                         <span class="keyword">as</span> o_id</span><br><span class="line">         , l_c                                                          <span class="keyword">as</span> l_c</span><br><span class="line">         , up_at                                                        <span class="keyword">as</span> up_at</span><br><span class="line">         , s_at                                                         <span class="keyword">as</span> s_at</span><br><span class="line">         , <span class="built_in">lag</span>(l_c, <span class="number">1</span>, <span class="number">0</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> o_id <span class="keyword">order</span> <span class="keyword">by</span> up_at)       <span class="keyword">as</span> l_l_c</span><br><span class="line"></span><br><span class="line">         , l_c <span class="operator">-</span> <span class="built_in">lag</span>(l_c, <span class="number">1</span>, <span class="number">0</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> o_id <span class="keyword">order</span> <span class="keyword">by</span> up_at) <span class="keyword">as</span> l_c_diff</span><br><span class="line">         , (unix_timestamp(up_at) <span class="operator">-</span> unix_timestamp(s_at))               <span class="keyword">as</span> s_diff</span><br><span class="line">         , (unix_timestamp(up_at) <span class="operator">-</span> unix_timestamp(s_at)) <span class="operator">/</span> <span class="number">3600</span>        <span class="keyword">as</span> hour_diff</span><br><span class="line">         , <span class="built_in">cast</span>((unix_timestamp(up_at) <span class="operator">-</span></span><br><span class="line">                 unix_timestamp(s_at)) <span class="operator">/</span> <span class="number">3600</span> <span class="operator">+</span> <span class="number">1</span> <span class="keyword">as</span> <span class="type">int</span>)               <span class="keyword">as</span> real_hours_id</span><br><span class="line">    <span class="keyword">from</span> tmp1</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tmp2</span><br></pre></td></tr></tbody></table></figure>
<h3 id="åŠ¨æ€å‚æ•°">åŠ¨æ€å‚æ•°</h3>
<p>å®ç°æ•ˆæœï¼šå½“æŸä¸€åˆ—æ²¡æœ‰ä¼ å‚æ—¶ï¼Œå°† <code>where</code> å½“å‰åˆ—çš„è¿‡æ»¤é€»è¾‘å»é™¤</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">where</span> <span class="keyword">case</span> <span class="keyword">when</span> ${param} <span class="operator">=</span> <span class="string">'ä½ é¢„è®¾çš„å‚æ•°'</span> <span class="keyword">then</span> ture</span><br><span class="line">        <span class="keyword">else</span> platform_name <span class="operator">=</span> ${param}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¤šå­—æ®µ-full-join">å¤šå­—æ®µ full join</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp1 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_01'</span> <span class="keyword">as</span> o_id, <span class="string">'2023-08-01'</span> <span class="keyword">as</span> data_id, <span class="number">50</span> <span class="keyword">as</span> money</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_03'</span> <span class="keyword">as</span> o_id, <span class="string">'2023-08-02'</span> <span class="keyword">as</span> data_id, <span class="number">50</span> <span class="keyword">as</span> money</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_04'</span> <span class="keyword">as</span> o_id, <span class="string">'2023-08-03'</span> <span class="keyword">as</span> data_id, <span class="number">50</span> <span class="keyword">as</span> money</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">   , tmp2 <span class="keyword">as</span> ( <span class="comment">--</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_01'</span> <span class="keyword">as</span> o_id, <span class="string">'2023-08-01'</span> <span class="keyword">as</span> data_id, <span class="number">60</span> <span class="keyword">as</span> money</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_02'</span> <span class="keyword">as</span> o_id, <span class="string">'2023-08-02'</span> <span class="keyword">as</span> data_id, <span class="number">60</span> <span class="keyword">as</span> money</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="string">'o_05'</span> <span class="keyword">as</span> o_id, <span class="string">'2023-08-03'</span> <span class="keyword">as</span> data_id, <span class="number">60</span> <span class="keyword">as</span> money</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> if(t1.data_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>, t1.o_id, t2.o_id)       <span class="keyword">as</span> o_id</span><br><span class="line">     , if(t1.data_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>, t1.data_id, t2.data_id) <span class="keyword">as</span> date_id</span><br><span class="line">     , <span class="built_in">coalesce</span>(t1.money, t2.money)                       <span class="keyword">as</span> money</span><br><span class="line"><span class="keyword">from</span> tmp1      t1</span><br><span class="line"><span class="keyword">full</span> <span class="keyword">join</span> tmp2 t2</span><br><span class="line">          <span class="keyword">on</span> t1.o_id <span class="operator">=</span> t2.o_id</span><br><span class="line">              <span class="keyword">and</span> t1.data_id <span class="operator">=</span> t2.data_id</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p align="center">
  <img src="/2023/10/01/Hive/28.png" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> ä» select * åˆ° select åˆ¤æ–­é€»è¾‘  </span>
</p>
<h2 id="ç¬¬-X-éƒ¨åˆ†">ç¬¬ X éƒ¨åˆ†</h2>
<p>è¿™é‡Œç»§ç»­æ”¶å½•ä¸€ä¸‹é—®é¢˜æˆ–è€…è§£å†³æ–¹æ¡ˆï¼ŒToDo</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>è®¾ç½®mapçš„èšåˆä¸ºfalse , åœ¨mapç«¯èšåˆè¿˜å¯èƒ½ä¼šå¼•å‘å†…å­˜æº¢å‡ºçš„é—®é¢˜ï¼Œè¯¦æƒ…å¯æŸ¥çœ‹ï¼š<a href="http://dev.bizo.com/2013/02/map-side-aggregations-in-apache-hive.html">http://dev.bizo.com/2013/02/map-side-aggregations-in-apache-hive.html</a> <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>æŠ€æœ¯æ€»ç»“</category>
      </categories>
      <tags>
        <tag>æŠ€æœ¯</tag>
      </tags>
  </entry>
  <entry>
    <title>msyql 45 è®²</title>
    <url>/2023/09/30/mysql/</url>
    <content><![CDATA[<p>MySQLå®æˆ˜45è®²</p>
<p>ğŸ…°ï¸ æœ¬æ–‡å†…å®¹æ¥æºäºæå®¢æ—¶é—´ä¸“æ ï¼š<a href="https://time.geekbang.org/column/intro/100020801">ã€ŠMySQL å®æˆ˜45è®²ã€‹</a></p>
<p>ğŸ…±ï¸ æœ¬æ–‡è„šæ³¨çš„ä½œç”¨æ˜¯å¯¹å‰ä¸€æ®µæè¿°å†…å®¹çš„è§£é‡Šè¯´æ˜ï¼Œå¹¶ä¸”æ”¾åœ¨<strong>å½“å‰</strong>ç« èŠ‚çš„æœ€åï¼Œè€Œä¸æ˜¯æ–‡æœ«ã€‚æ›´å¥½çš„é˜…è¯»ä½“éªŒæ¨ètypora</p>
<span id="more"></span>
<h1>1-åŸºç¡€æ¶æ„ï¼šä¸€æ¡SQLæ˜¯å¦‚ä½•æ‰§è¡Œçš„</h1>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">select * from T where ID=10; </span><br></pre></td></tr></tbody></table></figure>
<h2 id="1-1-MySQL-åŸºç¡€æ¶æ„">1.1-MySQL åŸºç¡€æ¶æ„</h2>
<p><strong>å¦‚ä¸‹å›¾æ‰€ç¤º</strong>ï¼š</p>
<p align="center">
  <img src="/2023/09/30/mysql/01.jpg" width="70%" alt="Your image description">
</p>
<p>å¯¹æ¯”ä¸‹hiveçš„æ¶æ„æ˜¯ï¼šè§£æå™¨-ç¼–è¯‘å™¨-ä¼˜åŒ–å™¨-æ‰§è¡Œå™¨</p>
<h3 id="A-è¿æ¥å™¨">A-è¿æ¥å™¨</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>å®¢æˆ·ç«¯è¿æ¥è¿æ¥å™¨ä½¿ç”¨çš„åè®®æ˜¯ <strong>TCP åè®®</strong></p>
</li>
<li class="lvl-2">
<p>è¿æ¥å®Œæˆåï¼Œå¦‚æœæ²¡æœ‰åç»­åŠ¨ä½œï¼Œè¿™ä¸ªè¿æ¥å°±ä¼šå¤„äº<strong>sleep</strong>çŠ¶æ€ ,ä¹Ÿå°±æ˜¯ç©ºé—²çŠ¶æ€ï¼ˆå¦å¤–ä¸€ä¸ªçŠ¶æ€æ˜¯ Queryï¼‰</p>
</li>
<li class="lvl-2">
<p>å®¢æˆ·ç«¯å¦‚æœ <strong>wait_timeout</strong>ï¼ˆé»˜è®¤æ˜¯8hï¼‰æ—¶é—´å†…æ²¡çš„åŠ¨é™ï¼Œè¿æ¥å°±ä¼šæ–­å¼€</p>
</li>
</ul>
<h4 id="MySQL-é•¿çŸ­è¿æ¥ï¼š">MySQL é•¿çŸ­è¿æ¥ï¼š</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>é•¿è¿æ¥ï¼šè¿æ¥æˆåŠŸåï¼Œä¸€ç›´æŒæœ‰è¿™ä¸ªè¿æ¥ï¼Œå‘ Server å‘èµ·è¯·æ±‚</p>
</li>
<li class="lvl-2">
<p>çŸ­è¿æ¥ï¼šæ‰§è¡Œå®Œå‡ æ¬¡æŸ¥è¯¢ä¹‹åå°±æ–­å¼€è¿æ¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢çš„æ—¶å€™åœ¨é‡æ–°å»ºç«‹ä¸€ä¸ª</p>
</li>
</ul>
<p>ğŸ’â€â™‚ï¸ ç”±äºè¿æ¥çš„è¿‡ç¨‹æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå¼€å‘ä¸­éœ€è¦å°½é‡å‡å°‘è¿æ¥åŠ¨ä½œï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨é•¿è¿æ¥</p>
<p>MySQL åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸´æ—¶ä½¿ç”¨çš„å†…å­˜æ˜¯ç®¡ç†åœ¨è¿æ¥å¯¹è±¡é‡Œé¢çš„ï¼Œè¿™äº›èµ„æºåœ¨è¿æ¥æ–­å¼€çš„æ—¶å€™æ‰é‡Šæ”¾ï¼Œæ‰€ä»¥æœ‰æ—¶MySQLçš„å†…å­˜æ¶¨çš„å¾ˆå¿«ï¼Œè€Œå†…å­˜å ç”¨è¿‡å¤§å¯èƒ½ä¼šå¯¼è‡´è¢« <strong>Kill</strong>æ‰ ï¼Œè¡¨ç°ä¸ºMySQLå¼‚å¸¸é‡å¯ã€‚å¦‚ä½•é¿å…ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å®šæœŸæ–­å¼€é•¿è¿æ¥</p>
</li>
<li class="lvl-2">
<p>MySQL5.7  ä¹‹åçš„ç‰ˆæœ¬ï¼Œåœ¨æ‰§è¡Œä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ“ä½œåï¼Œæ‰§è¡Œ<code>mysql_reset_connection</code>æ¥åˆå§‹åŒ–è¿æ¥(è¯¥æ“ä½œä¸éœ€è¦é‡è¿å’Œé‰´æƒï¼Œå°±æ¢å¤åˆ°åˆšåˆ›å»ºå®Œçš„çŠ¶æ€)</p>
</li>
</ul>
<h3 id="B-æ‰§è¡Œå™¨">B-æ‰§è¡Œå™¨</h3>
<p>æ‰§è¡Œå™¨æ˜¯Serverå’Œå­˜å‚¨å¼•æ“äº¤äº’çš„éƒ¨åˆ†ï¼ŒServerä¼šè°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£ï¼Œå¦‚å¯¹äº</p>
<p><code>select * from T where ID=10;</code> ID å­—æ®µæ²¡æœ‰ç´¢å¼•</p>
<p>1ï¸âƒ£ è°ƒç”¨ InnoDBå¼•æ“æ¥å£å–è¿™ä¸ªè¡¨çš„ç¬¬ä¸€è¡Œï¼Œåˆ¤æ–­ ID å€¼æ˜¯ä¸æ˜¯ 10ï¼Œå¦‚æœä¸æ˜¯åˆ™è·³è¿‡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†è¿™è¡Œå­˜åœ¨ç»“æœé›†ä¸­</p>
<p>2ï¸âƒ£ è°ƒç”¨å¼•æ“æ¥å£å–â€œä¸‹ä¸€è¡Œâ€ï¼Œé‡å¤ç›¸åŒçš„åˆ¤æ–­é€»è¾‘ï¼Œç›´åˆ°å–åˆ°è¿™ä¸ªè¡¨çš„æœ€åä¸€è¡Œ(å–æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€è¡Œå’Œæ»¡è¶³æ¡ä»¶çš„ä¸‹ä¸€è¡Œè¿™ä¸ªé€»è¾‘åœ¨å­˜å‚¨å¼•æ“ä¸­å·²ç»å®ç°)</p>
<p>3ï¸âƒ£ æ‰§è¡Œå™¨å°†ä¸Šè¿°éå†è¿‡ç¨‹ä¸­æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„è¡Œï¼Œç»„æˆç»“æœé›†è¿”å›ç»™å®¢æˆ·ç«¯</p>
<h1>2-æ—¥å¿—ç³»ç»Ÿï¼šä¸€æ¡SQLæ›´æ–°æ˜¯å¦‚ä½•æ‰§è¡Œçš„</h1>
<p>MySQLä¸­æœ‰2ä¸ªé‡è¦çš„æ—¥å¿—ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>redo log é‡åšæ—¥å¿— <strong>å¼•æ“å±‚æ—¥å¿—</strong>(InnoDBå¼•æ“ç‰¹æœ‰)</p>
</li>
<li class="lvl-2">
<p>bin log å½’æ¡£æ—¥å¿— <strong>server å±‚æ—¥å¿—</strong></p>
</li>
</ul>
<table>
<thead>
<tr>
<th>redo log</th>
<th>bin log</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¼•æ“æ¨¡å—ï¼ŒInnoDBå¼•æ“ç‰¹æœ‰</td>
<td>serveræ¨¡å—ï¼Œæ‰€æœ‰å¼•æ“éƒ½å¯ç”¨</td>
</tr>
<tr>
<td>å¾ªç¯å†™</td>
<td>è¿½åŠ å†™</td>
</tr>
<tr>
<td>ç‰©ç†æ—¥å¿—ï¼ˆåœ¨æŸä¸ªé¡µé¢åšäº†ä»€ä¹ˆä¿®æ”¹ï¼‰</td>
<td>é€»è¾‘æ—¥å¿—ï¼ˆè¯­å¥çš„æ›´æ”¹é€»è¾‘ï¼Œå¦‚ç»™<code>id=2</code>è¿™ä¸€è¡Œçš„cå­—æ®µåŠ 1ï¼‰</td>
</tr>
</tbody>
</table>
<h2 id="2-1-redolog">2.1-redolog</h2>
<p>å¯¹äºä¸€ä¸ªæ›´æ–°æ“ä½œæ¥è¯´ï¼Œå¦‚æœæ¯æ¬¡æ›´æ–°éƒ½éœ€è¦ç«‹åˆ»å†™ç£ç›˜ï¼Œåˆ™MySQLçš„å­˜å‚¨å¼•æ“éœ€è¦æ‰¾åˆ°è¢«æ›´æ–°çš„è®°å½•ï¼Œç„¶åæ›´æ–°ã€‚è¿™ä¸ªå…ˆå®šä½å†æ›´æ–°çš„æœºåˆ¶å¿…ç„¶æœ‰ä¸€å®šçš„æˆæœ¬ï¼ˆæŸ¥æ‰¾æˆæœ¬+IOæˆæœ¬<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>ï¼‰ã€‚MySQLå°è¯•ä½¿ç”¨ä¸‹é¢çš„æ€è·¯æ¥æå‡ <strong>æ›´æ–°æ•ˆç‡</strong></p>
<blockquote>
<p>WAL : Write - Ahead Logging ï¼š å…ˆå†™æ—¥å¿—ï¼Œåå†™ç£ç›˜</p>
</blockquote>
<p><strong>å½“æ¶‰åŠæ›´æ–°ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼ŒInnoDBå¼•æ“ä¼šå°†è®°å½•å†™åˆ° redo log é‡Œï¼Œå¹¶ä¸”æ›´æ–°å†…å­˜</strong>ã€‚InnoDBå¼•æ“ä¼šåœ¨é€‚å½“ï¼ˆç³»ç»Ÿæ¯”è¾ƒç©ºï¼‰çš„æ—¶å€™ï¼Œå°†æ“ä½œè®°å½•åˆ·å†™åˆ°ç£ç›˜ã€‚åœ¨ç»†èŠ‚ä¸Šï¼šMySQLäº†ä¼šè®¾ç½®å›ºå®šå¤§å°çš„ redo logï¼Œæ¯”å¦‚é…ç½®ä¸€ç»„4ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶1GB</p>
<p align="center">
  <img src="/2023/09/30/mysql/02.jpg" width="70%" alt="Your image description">
</p>
<p>æœ‰äº†redo logï¼Œ InnoDBå¯ä»¥å®ç° crash-safeï¼ˆä¿è¯åœ¨æ•°æ®åº“å‘ç”Ÿå¼‚å¸¸é‡å¯ä¹‹åï¼Œä¹‹å‰æäº¤çš„è®°å½•ä¸ä¼šä¸¢å¤±ï¼‰ã€‚redo logçš„å†™å…¥ è¢«æ‹†åˆ†ä¸º2ä¸ªæ­¥éª¤ ï¼š prepare + commit ä¹Ÿå°±æ˜¯<strong>ä¸¤é˜¶æ®µæäº¤</strong>ï¼š</p>
<p align="center">
  <img src="/2023/09/30/mysql/03.jpg" width="60%" alt="Your image description">
</p>   
<p><strong>ä¸¤é˜¶æ®µæäº¤å®ç°äº† bin log å’Œ redo  log çš„é€»è¾‘ä¸€è‡´</strong></p>
<p>å¯¹äº <code> update T set c=c+1 where ID=2 ;</code> id æ˜¯ä¸»é”®  , æ›´æ–°çš„ç»†èŠ‚å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ æ‰§è¡Œå™¨å…ˆæ‰¾å¼•æ“å– ID=2 è¿™ä¸€è¡Œã€‚ID æ˜¯ä¸»é”®ï¼Œå¼•æ“ç›´æ¥ç”¨æ ‘æœç´¢æ‰¾åˆ°è¿™ä¸€è¡Œã€‚å¦‚æœ <code>ID=2</code> è¿™ä¸€è¡Œæ‰€åœ¨çš„æ•°æ®é¡µæœ¬æ¥å°±åœ¨å†…å­˜ä¸­ï¼Œå°±ç›´æ¥è¿”å›ç»™æ‰§è¡Œå™¨ï¼›å¦åˆ™ï¼Œéœ€è¦å…ˆä»ç£ç›˜è¯»å…¥å†…å­˜ï¼Œç„¶åå†è¿”å›</p>
<p>2ï¸âƒ£ æ‰§è¡Œå™¨æ‹¿åˆ°å¼•æ“ç»™çš„è¡Œæ•°æ®ï¼ŒæŠŠè¿™ä¸ªå€¼åŠ ä¸Š 1ï¼Œæ¯”å¦‚åŸæ¥æ˜¯ Nï¼Œç°åœ¨å°±æ˜¯ N+1ï¼Œå¾—åˆ°æ–°çš„ä¸€è¡Œæ•°æ®ï¼Œå†è°ƒç”¨å¼•æ“æ¥å£å†™å…¥è¿™è¡Œæ–°æ•°æ®</p>
<p>3ï¸âƒ£ å¼•æ“å°†è¿™è¡Œæ–°æ•°æ®æ›´æ–°åˆ°å†…å­˜ä¸­ï¼ŒåŒæ—¶å°†è¿™ä¸ªæ›´æ–°æ“ä½œè®°å½•åˆ° redo log é‡Œé¢ï¼Œæ­¤æ—¶ redo log å¤„äº prepare çŠ¶æ€ã€‚ç„¶åå‘ŠçŸ¥æ‰§è¡Œå™¨æ‰§è¡Œå®Œæˆäº†ï¼Œéšæ—¶å¯ä»¥æäº¤äº‹åŠ¡</p>
<p>4ï¸âƒ£ æ‰§è¡Œå™¨ç”Ÿæˆè¿™ä¸ªæ“ä½œçš„ binlogï¼Œå¹¶æŠŠ binlog å†™å…¥ç£ç›˜</p>
<p>5ï¸âƒ£ æ‰§è¡Œå™¨è°ƒç”¨å¼•æ“çš„æäº¤äº‹åŠ¡æ¥å£ï¼Œå¼•æ“æŠŠåˆšåˆšå†™å…¥çš„ redo log æ”¹æˆæäº¤ï¼ˆ<code>commit</code>ï¼‰çŠ¶æ€ï¼Œæ›´æ–°å®Œæˆ</p>
<p>å¯ä»¥é€šè¿‡åè¯æ³•çš„æ–¹å¼æ¥è¯æ˜ï¼Œæ— è®ºæ˜¯å…ˆå†™redologå†å†™binlogï¼Œè¿˜æ˜¯å…ˆå†™binlogå†å†™redologéƒ½ä¼šå¯¼è‡´å´©æºƒæ¢å¤åçš„æ•°æ®ä¸ä¸€è‡´ã€‚è€Œä¸¤é˜¶æ®µæäº¤å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§</p>
<h2 id="2-2-bin-log">2.2-bin log</h2>
<p>bin log æ˜¯MySQL serverå±‚ç»´æŠ¤çš„ä¸€ç§äºŒè¿›åˆ¶æ—¥å¿—ï¼Œè®°å½•æ‰€æœ‰çš„DMLå’ŒDDLã€‚ä½œç”¨æœ‰ï¼š</p>
<p>1ï¸âƒ£ å¤åˆ¶ï¼š MySQL Masterç«¯å¼€å¯binlogï¼Œslave å¯ä»¥è·å¾—æ•°æ®å¤‡ä»½ï¼ŒåŒæ ·å¯ä»¥å®ç°æ•°æ®åŒæ­¥ï¼ˆå¦‚æ•°æ®é‡‡é›†ï¼‰</p>
<p>2ï¸âƒ£ æ•°æ®æ¢å¤ï¼šæ ¹æ®binlogæ¥å›æ”¾å†å²æ•°æ®</p>
<p>binlog åŒ…å«ä¸¤ç±»æ–‡ä»¶</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>äºŒè¿›åˆ¶æ—¥å¿—ç´¢å¼•æ–‡ä»¶(.index)ï¼šè®°å½•æ‰€æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶</p>
</li>
<li class="lvl-2">
<p>äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶(.00000*)ï¼šè®°å½•æ‰€æœ‰ DDL å’Œ DML è¯­å¥äº‹ä»¶</p>
</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- æŸ¥çœ‹binlogçš„çŠ¶æ€ï¼šæŸ¥çœ‹å½“å‰äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ˜¾ç¤ºæ­£åœ¨å†™å…¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŠå½“å‰position</span></span><br><span class="line"><span class="keyword">show</span> master status;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥çœ‹äºŒè¿›åˆ¶ç´¢å¼•æ–‡ä»¶å’ŒäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶å­˜å‚¨ä½ç½®</span></span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'%log_bin%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥çœ‹binlogæ–‡ä»¶åˆ—è¡¨</span></span><br><span class="line"><span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è§£æbinlog æ—¥å¿—æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">show</span> binlog events <span class="keyword">in</span>  <span class="string">'mysql-bin.000238'</span>; </span><br></pre></td></tr></tbody></table></figure>
<p><code>show master  status</code> å‘½ä»¤ç»“æœå¦‚ä¸‹ï¼š<img src="/2023/09/30/mysql/09/30/mysql/04.jpg" class=""></p>
<blockquote>
<p>Executed_Gtid_Set : æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œå½“å‰å€¼å°±ä¼šå‘ç”Ÿå˜åŒ–</p>
</blockquote>
<h4 id="binlog-æ—¥å¿—æ ¼å¼">binlog æ—¥å¿—æ ¼å¼</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>Statement æ¨¡å¼ï¼šåŸºäº SQL è¯­å¥çš„å¤åˆ¶(statement-based replication-SBR)ï¼Œæ—¥å¿—é‡å°ï¼Œä¼šäº§ç”Ÿéç¡®å®šæ€§ï¼ˆæ¯”å¦‚ä½¿ç”¨ä¸ç¡®å®šçš„å‡½æ•°<code>now()</code>ï¼‰</p>
</li>
<li class="lvl-2">
<p>Row æ¨¡å¼ï¼šåŸºäºè¡Œçš„å¤åˆ¶(row-based replication-RBR)ï¼Œæ—¥å¿—é‡å¤§ï¼Œå¯ä»¥ä¿è¯ä¸€è‡´æ€§ï¼Œ<strong>è®°å½•äº†è®°å½•ä¿®æ”¹å‰åçš„æ ·å­</strong></p>
</li>
<li class="lvl-2">
<p>Mixed æ¨¡å¼ï¼šæ··åˆæ¨¡å¼å¤åˆ¶(mixed-based replication-MBR)ï¼Œæ ¹æ®SQLè¯­å¥çš„ç±»å‹è‡ªåŠ¨é€‰æ‹©Statementæˆ–Rowæ ¼å¼</p>
</li>
</ul>
<p><a href="https://zhuanlan.zhihu.com/p/33504555">å‚è€ƒ1</a></p>
<p><a href="https://www.cnblogs.com/rickiyang/p/13841811.html">å‚è€ƒ2</a></p>
<h1>3-äº‹åŠ¡éš”ç¦»ï¼š ä¸ºä»€ä¹ˆä½ æ”¹äº†ï¼Œæˆ‘è¿˜çœ‹ä¸è§</h1>
<p>åœ¨ MySQL ä¸­ï¼Œäº‹åŠ¡æ”¯æŒæ˜¯åœ¨å¼•æ“å±‚å®ç°çš„</p>
<h2 id="3-1-éš”ç¦»æ€§å’Œéš”ç¦»çº§åˆ«">3.1-éš”ç¦»æ€§å’Œéš”ç¦»çº§åˆ«</h2>
<p>SQL æ ‡å‡†çš„äº‹åŠ¡éš”ç¦»çº§åˆ«åŒ…æ‹¬ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>è¯»æœªæäº¤ï¼ˆread uncommittedï¼‰</p>
</li>
<li class="lvl-2">
<p>è¯»æäº¤ï¼ˆread committedï¼‰</p>
</li>
<li class="lvl-2">
<p>å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰(MySQL é»˜è®¤çš„éš”ç¦»çº§åˆ«)</p>
</li>
<li class="lvl-2">
<p>ä¸²è¡ŒåŒ–ï¼ˆserializable ï¼‰</p>
</li>
</ul>
<p>ç»“åˆä¸‹å›¾ï¼Œè¯´è¯´ä¸Šé¢å‰3ç§éš”ç¦»çº§åˆ«ä¸‹ï¼Œv1,v2,v3 çš„å€¼</p>
<p align="center">
  <img src="/2023/09/30/mysql/06.jpg" width="50%" alt="Your image description">
</p>
<p>1ï¸âƒ£ è¯»æœªæäº¤ï¼š<code>V1=2,v2=2,v3=2</code></p>
<p>2ï¸âƒ£ è¯»å·²æäº¤ï¼š<code>V1=1,v2=2,v3=2</code></p>
<p>3ï¸âƒ£ å¯é‡å¤è¯»ï¼š<code>V1=1,v2=1,v3=2</code></p>
<p>4ï¸âƒ£ å¯ä¸²è¡ŒåŒ–ï¼šäº‹åŠ¡ B æ‰§è¡Œâ€œå°† 1 æ”¹æˆ 2â€çš„æ—¶å€™ï¼Œä¼šè¢«é”ä½ã€‚ç›´åˆ°äº‹åŠ¡ A æäº¤åï¼Œäº‹åŠ¡ B æ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚æ‰€ä»¥ä» A çš„è§’åº¦çœ‹ <code>V1=1,v2=1,v3=2</code></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- æŸ¥çœ‹ MySQLå½“å‰çš„éš”ç¦»çº§åˆ«è®¾ç½®å€¼ï¼š</span></span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'tx_isolation'</span> </span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'transaction_isolation'</span> <span class="comment">-- mysql5.7ä»¥ä¸Šversion </span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-2-äº‹åŠ¡éš”ç¦»çš„å®ç°">3.2-äº‹åŠ¡éš”ç¦»çš„å®ç°</h2>
<p>åœ¨å®ç°ä¸Šï¼Œæ•°æ®åº“é‡Œé¢ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œè®¿é—®çš„æ—¶å€™ä»¥è§†å›¾çš„é€»è¾‘ç»“æœä¸ºå‡†</p>
<p>1ï¸âƒ£ â€œè¯»æœªæäº¤â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥è¿”å›è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œæ²¡æœ‰è§†å›¾æ¦‚å¿µ</p>
<p>2ï¸âƒ£ åœ¨â€œè¯»æäº¤â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨æ¯ä¸ª SQL è¯­å¥å¼€å§‹æ‰§è¡Œçš„æ—¶å€™åˆ›å»ºçš„</p>
<p>3ï¸âƒ£ åœ¨â€œå¯é‡å¤è¯»â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œæ•´ä¸ªäº‹åŠ¡å­˜åœ¨æœŸé—´éƒ½ç”¨è¿™ä¸ªè§†å›¾</p>
<p>4ï¸âƒ£ â€œä¸²è¡ŒåŒ–â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥ç”¨åŠ é”çš„æ–¹å¼æ¥é¿å…å¹¶è¡Œè®¿é—®</p>
<p>æ‹¿<strong>å¯é‡å¤è¯»</strong>æ¥è¯´ï¼šå‡è®¾ä¸€ä¸ªå€¼ä» 1 è¢«æŒ‰é¡ºåºæ”¹æˆäº† 2ã€3ã€4ï¼Œåœ¨å›æ»šæ—¥å¿—é‡Œé¢å°±ä¼šæœ‰ç±»ä¼¼ä¸‹é¢çš„è®°å½•</p>
<p align="center">
  <img src="/2023/09/30/mysql/07.jpg" width="80%" alt="Your image description">
</p>
<p>å½“å‰å€¼æ˜¯4ï¼Œä¸åŒæ—¶åˆ»å¯åŠ¨çš„äº‹åŠ¡ä¼šæœ‰ä¸åŒçš„ read-viewï¼ˆäº‹åŠ¡è§†å›¾ï¼‰ï¼Œå¯¹äºæ˜¯ä¸‰ä¸ªè§†å›¾è®°å½•çš„å€¼åˆ†åˆ«ä¸åŒï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>read-view A               1</p>
</li>
<li class="lvl-2">
<p>read-view B                 2</p>
</li>
<li class="lvl-2">
<p>read-view C                 4</p>
</li>
</ul>
<blockquote>
<p><strong>MVCCï¼ˆ Multi-Version Concurrency Controlï¼‰ : åŒä¸€æ¡è®°å½•åœ¨ç³»ç»Ÿä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªç‰ˆæœ¬ï¼Œè¿™å°±æ˜¯æ•°æ®åº“çš„å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶</strong>ã€‚å…¶ä¸»è¦çš„æ€æƒ³æ˜¯åœ¨è¯»å–æ•°æ®æ—¶åˆ›å»ºæ•°æ®çš„ä¸€ä»½å¿«ç…§ï¼Œå¹¶å¯¹è¯¥å¿«ç…§è¿›è¡Œè¯»å–ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨åŸå§‹æ•°æ®ä¸Šè¿›è¡Œæ“ä½œã€‚è¿™æ ·åšå¯ä»¥å®ç°éé˜»å¡çš„è¯»æ“ä½œï¼Œä»è€Œæé«˜å¹¶å‘æ€§èƒ½</p>
</blockquote>
<p>å¯¹äº read-view Aï¼Œè¦å¾—åˆ° 1ï¼Œå°±å¿…é¡»å°†å½“å‰å€¼ä¾æ¬¡æ‰§è¡Œå›¾ä¸­æ‰€æœ‰çš„å›æ»šæ“ä½œå¾—åˆ°</p>
<p>ğŸ’â€â™‚ï¸  <strong>å»ºè®®å°½é‡ä¸è¦ä½¿ç”¨é•¿äº‹åŠ¡</strong>ï¼š</p>
<p>é•¿äº‹åŠ¡æ„å‘³ç€ç³»ç»Ÿé‡Œé¢ä¼šå­˜åœ¨å¾ˆè€çš„äº‹åŠ¡è§†å›¾ã€‚ç”±äºè¿™äº›äº‹åŠ¡éšæ—¶å¯èƒ½è®¿é—®æ•°æ®åº“é‡Œé¢çš„ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªäº‹åŠ¡æäº¤ä¹‹å‰ï¼Œæ•°æ®åº“é‡Œé¢å®ƒå¯èƒ½ç”¨åˆ°çš„å›æ»šè®°å½•éƒ½å¿…é¡»ä¿ç•™ï¼Œè¿™ä¼šå¤§é‡å ç”¨å­˜å‚¨ç©ºé—´</p>
<h2 id="3-3-äº‹åŠ¡å¯åŠ¨æ–¹å¼">3.3-äº‹åŠ¡å¯åŠ¨æ–¹å¼</h2>
<p>äº‹åŠ¡å¯åŠ¨çš„æ–¹å¼å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ : æ˜¾ç¤ºå¯åŠ¨äº‹åŠ¡è¯­å¥ï¼Œ<code>begin / start transaction</code> å¼€å¯äº‹åŠ¡ï¼Œ<code>commit / rollback</code> ç»“æŸäº‹åŠ¡ï¼ˆæäº¤/å›æ»šï¼‰</p>
<p>2ï¸âƒ£ : <code>set autocommit = 0</code> ,å°†çº¿ç¨‹çš„è‡ªåŠ¨æäº¤off ï¼Œæ„å‘³ç€å¦‚æœä½ åªæ‰§è¡Œä¸€ä¸ª select è¯­å¥ï¼Œè¿™ä¸ªäº‹åŠ¡å°±å¯åŠ¨äº†ï¼Œè€Œä¸”å¹¶ä¸ä¼šè‡ªåŠ¨æäº¤ã€‚è¿™ä¸ªäº‹åŠ¡æŒç»­å­˜åœ¨ç›´åˆ°ä½ ä¸»åŠ¨æ‰§è¡Œ commit æˆ– rollback è¯­å¥ï¼Œæˆ–è€…æ–­å¼€è¿æ¥ï¼Œ <strong>è¿™ä¼šå¯¼è‡´é•¿äº‹åŠ¡</strong>ã€‚</p>
<p>ğŸ’â€â™‚ï¸ <strong>å»ºè®®ï¼šset autocommit = 1ï¼ˆå¼€å¯è‡ªåŠ¨æäº¤ï¼‰</strong>ï¼Œé€šè¿‡æ˜¾å¼è¯­å¥çš„æ–¹å¼æ¥å¯åŠ¨äº‹åŠ¡ã€‚<code>commit work and chain</code>ï¼Œåˆ™æ˜¯æäº¤äº‹åŠ¡å¹¶è‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿™ç§æ–¹å¼å¯ä»¥çœå»äº†å†æ¬¡æ‰§è¡Œ begin è¯­å¥çš„å¼€é”€</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- ä½ å¯ä»¥åœ¨ information_schema åº“çš„ innodb_trx è¿™ä¸ªè¡¨ä¸­æŸ¥è¯¢é•¿äº‹åŠ¡</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_trx <span class="keyword">where</span> TIME_TO_SEC(timediff(now(),trx_started))<span class="operator">&gt;</span><span class="number">60</span></span><br></pre></td></tr></tbody></table></figure>
<h1>4-æ·±å…¥æµ…å‡º ç´¢å¼• (ä¸Š)</h1>
<h2 id="4-1-ç´¢å¼•çš„å¸¸è§æ¨¡å‹">4.1-ç´¢å¼•çš„å¸¸è§æ¨¡å‹</h2>
<ul class="lvl-0">
<li class="lvl-2">
<p>å“ˆå¸Œè¡¨ ï¼š åªæ˜¯é€‚åˆç­‰å€¼æŸ¥è¯¢çš„åœºæ™¯ï¼Œå¯¹èŒƒå›´æŸ¥è¯¢ä¸å‹å¥½ï¼Œä¸¥é‡ä¾èµ–å†…å­˜ï¼ˆsize ç“¶é¢ˆï¼‰</p>
</li>
<li class="lvl-2">
<p>æœ‰åºæ•°ç»„ï¼š ç­‰å€¼æŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢éƒ½å¾ˆå¿«ï¼Œå¯¹æ•°æ®æ›´æ–°ï¼ˆæ’å…¥/åˆ é™¤åæ•°æ®ï¼‰ä¸å‹å¥½</p>
</li>
<li class="lvl-2">
<p>Nå‰æ ‘ï¼šåœ¨è¯»å†™ä¸Šæœ‰æ€§èƒ½æœ‰ç‚¹ï¼Œé€‚é…ç£ç›˜çš„è®¿é—®æ¨¡å¼</p>
</li>
<li class="lvl-2">
<p>è·³è¡¨ ï¼š  å¯ä»¥è¯´æ˜¯æœ‰åºçš„å¸¦å±‚æ¬¡çš„(åœ¨æ•°æ®çš„åŸºç¡€ä¸Šä¸€å±‚å±‚åŠ ç´¢å¼•)é“¾è¡¨</p>
</li>
</ul>
<p>å•çº¯ä»å­˜å‚¨ä¸Šæ¥è¯´ï¼ŒLSMï¼ˆlog structure mergeï¼‰æ ‘(æ—¥å¿—ç»“æ„åˆå¹¶æ ‘) è¿™ç§æ–°çš„å­˜å‚¨å¼•æ“ä¹Ÿå…·å¤‡ä¸€å®šçš„ä¼˜åŠ¿ï¼Œå…³äºLSMè¿™ç§ç»“æ„å¯ä»¥å‚è€ƒã€Šdesign data intensive applicationã€‹ è¿™æœ¬ä¹¦çš„ç¬¬ä¸‰ç« èŠ‚ï¼Œä» è¿½åŠ æ—¥å¿—ï¼Œåˆ°SSTable ,åˆ° LSMçš„è¿‡ç¨‹</p>
<h2 id="4-2-InnoDBçš„ç´¢å¼•æ¨¡å‹">4.2-InnoDBçš„ç´¢å¼•æ¨¡å‹</h2>
<p>InnoDB ä½¿ç”¨äº† B+ æ ‘ç´¢å¼•æ¨¡å‹ï¼Œæ‰€ä»¥æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨ B+ æ ‘ä¸­çš„ã€‚æ¯ä¸€ä¸ªç´¢å¼•åœ¨ InnoDB é‡Œé¢å¯¹åº”ä¸€æ£µ B+ æ ‘ã€‚ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- table schema</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> T</span><br><span class="line">(</span><br><span class="line">    id   <span class="type">int</span> <span class="keyword">primary</span> key,</span><br><span class="line">    k    <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">16</span>),</span><br><span class="line">    index (k)</span><br><span class="line">) engine <span class="operator">=</span> InnoDB;</span><br><span class="line"><span class="comment">-- æ’å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> T (id,k)</span><br><span class="line"><span class="keyword">values</span> (<span class="number">100</span>, <span class="number">1</span>),</span><br><span class="line">       (<span class="number">200</span>, <span class="number">2</span>),</span><br><span class="line">       (<span class="number">300</span>, <span class="number">3</span>),</span><br><span class="line">       (<span class="number">500</span>, <span class="number">5</span>),</span><br><span class="line">       (<span class="number">600</span>, <span class="number">6</span>)</span><br><span class="line">;</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹äºä¸Šè¿°çš„ç´¢å¼•å’Œæ•°æ®ï¼Œå½¢æˆ2é¢—ç´¢å¼•æ ‘ï¼š</p>
<p align="center">
  <img src="/2023/09/30/mysql/08.jpg" width="80%" alt="Your image description">
</p>
<p>åŸºäºä¸»é”®ç´¢å¼•çš„æŸ¥è¯¢å’ŒåŸºäºæ™®é€šç´¢å¼•çš„æŸ¥è¯¢çš„åŒºåˆ«ï¼š</p>
<p>ğŸ…°ï¸ <code>select * from T where ID=500</code>ï¼Œå³ä¸»é”®æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™åªéœ€è¦æœç´¢ ID è¿™æ£µ B+ æ ‘</p>
<p>ğŸ…±ï¸ <code>select * from T where k=5</code>ï¼Œå³æ™®é€šç´¢å¼•æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™éœ€è¦å…ˆæœç´¢ k ç´¢å¼•æ ‘ï¼Œå¾—åˆ° ID çš„å€¼ä¸º 500ï¼Œå†åˆ° ID ç´¢å¼•æ ‘æœç´¢ä¸€æ¬¡ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º<strong>å›è¡¨</strong></p>
<p>InnoDBå¼•æ“ä¸­ï¼Œä¸»é”®ç´¢å¼•é»˜è®¤å°±æ˜¯èšç°‡ç´¢å¼•ï¼ˆclustered indexï¼‰</p>
<h2 id="4-3-ç´¢å¼•ç»´æŠ¤">4.3-ç´¢å¼•ç»´æŠ¤</h2>
<p>è¿™é‡Œæˆ‘ä»¬è®¨è®º2ç§æƒ…å†µ</p>
<p>1ï¸âƒ£ æ’å…¥æ–°è¡Œ <code>id = 700</code> ï¼Œåªæ˜¯éœ€è¦åœ¨R5çš„åé¢æ’å…¥æ–°è®°å½•</p>
<p>2ï¸âƒ£ æ’å…¥æ–°è¡Œ <code>id = 400</code> ï¼Œè¿™ç§æƒ…å†µä¸‹åˆåˆ†æˆ2ç§æƒ…å†µï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>R3~R5æ‰€åœ¨çš„æ•°æ®é¡µæ²¡æœ‰æ»¡ï¼Œéœ€è¦ç§»åŠ¨R4,R5çš„æ•°æ®ï¼Œç»™<code>id=400</code>ç©ºå‡ºä½ç½®</p>
</li>
<li class="lvl-2">
<p>R3~R5æ‰€åœ¨çš„æ•°æ®é¡µæ»¡äº†ï¼Œä¼šå‘ç”Ÿé¡µåˆ†è£‚[^10]</p>
<blockquote>
<p>é¡µåˆ†è£‚ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼ŒåŒæ—¶ç©ºé—´åˆ©ç”¨ç‡ä¸‹é™ï¼Œéœ€è¦ç”³è¯·æ–°çš„æ•°æ®é¡µ,å°†R4ï¼ŒR5ç§»åŠ¨åˆ°æ–°çš„åˆ†é¡µï¼ŒåŒæ—¶å¦‚æœç›¸é‚»çš„2ä¸ªé¡µç”±äºæ•°æ®åˆ é™¤ï¼Œæ•°æ®é¡µä¼šè¿›è¡Œåˆå¹¶</p>
</blockquote>
</li>
</ul>
<p>å»ºè¡¨æ—¶ç»´æŠ¤è‡ªå¢ä¸»é”®çš„ä¼˜åŠ¿ï¼š</p>
<p>1ï¸âƒ£ ä¸ä¼šå‘ç”Ÿé¡µåˆ†è£‚</p>
<p>2ï¸âƒ£ è‡ªå¢ä¸»é”®ä¸€èˆ¬å ç”¨çš„ç©ºé—´æ¯”è¾ƒå°ï¼ŒäºŒçº§ç´¢å¼•å­˜å‚¨ä¸»é”®æ—¶ï¼Œå ç”¨å­˜å‚¨ä¹Ÿæ¯”è¾ƒå°</p>
<p>ğŸ’â€â™‚ï¸ æ— è®ºæ˜¯åˆ é™¤ä¸»é”®ç´¢å¼•è¿˜æ˜¯åˆ›å»ºä¸»é”®ç´¢å¼•ï¼Œéƒ½ä¼šå¯¼è‡´è¡¨é‡å»ºï¼Œè€Œé‡å»ºæ™®é€šç´¢å¼•å¯ä»¥è¾¾åˆ°èŠ‚çœç©ºé—´çš„ç›®çš„ï¼Œå¦‚æœä½ æœ‰é‡å»ºä¸»é”®ç´¢å¼•çš„éœ€æ±‚ï¼š<code>alter table T engine=InnoDB</code> ä¼šè§¦å‘MySQLé‡å»ºè¡¨ï¼Œå¹¶è¿›è¡Œç¢ç‰‡å¤„ç†ï¼Œè¾¾åˆ°èŠ‚çœç©ºé—´çš„ç›®çš„</p>
<h1>5-æ·±å…¥æµ…å‡º ç´¢å¼• (ä¸‹)</h1>
<p>å¯¹äºä¸Šé¢çš„è¡¨æ’å…¥å¦‚ä¸‹æ•°æ®ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> T(id,k,name)</span><br><span class="line"><span class="keyword">values</span> (<span class="number">100</span>, <span class="number">1</span>, <span class="string">'aa'</span>),</span><br><span class="line">       (<span class="number">200</span>, <span class="number">2</span>, <span class="string">'bb'</span>),</span><br><span class="line">       (<span class="number">300</span>, <span class="number">3</span>, <span class="string">'cc'</span>),</span><br><span class="line">       (<span class="number">500</span>, <span class="number">5</span>, <span class="string">'ee'</span>),</span><br><span class="line">       (<span class="number">600</span>, <span class="number">6</span>, <span class="string">'ff'</span>),</span><br><span class="line">       (<span class="number">700</span>, <span class="number">7</span>, <span class="string">'gg'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ•°æ®æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T <span class="keyword">where</span> k <span class="keyword">between</span> <span class="number">3</span> <span class="keyword">and</span> <span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>é—®æ‰§è¡Œä¸Šè¿°çš„æŸ¥è¯¢ï¼Œéœ€è¦æ‰§è¡Œå‡ æ¬¡æ ‘çš„æœç´¢æ“ä½œï¼Œä¼šæ‰«æå¤šå°‘è¡Œï¼ŸSQL çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ åœ¨ k ç´¢å¼•æ ‘ä¸Šæ‰¾åˆ° k=3 çš„è®°å½•ï¼Œå–å¾— ID = 300ï¼›</p>
<p>2ï¸âƒ£å†åˆ° ID ç´¢å¼•æ ‘æŸ¥åˆ° ID=300 å¯¹åº”çš„ R3ï¼›</p>
<p>3ï¸âƒ£ åœ¨ k ç´¢å¼•æ ‘å–ä¸‹ä¸€ä¸ªå€¼ k=5ï¼Œå–å¾— ID=500ï¼›</p>
<p>4ï¸âƒ£ å†å›åˆ° ID ç´¢å¼•æ ‘æŸ¥åˆ° ID=500 å¯¹åº”çš„ R4ï¼›</p>
<p>5ï¸âƒ£åœ¨ k ç´¢å¼•æ ‘å–ä¸‹ä¸€ä¸ªå€¼ k=6ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼Œå¾ªç¯ç»“æŸã€‚</p>
<p>ä¸Šé¢çš„æŸ¥è¯¢è¿‡ç¨‹è¯»äº†Kç´¢å¼•çš„3æ¡è®°å½•ï¼Œï¼ˆæ­¥éª¤1|3|5ï¼‰å›è¡¨äº†2æ¬¡ï¼ˆæ­¥éª¤2|4ï¼‰ã€‚å›è¡¨çš„è¿‡ç¨‹ä¼šå½±å“æ•°æ®å“åº”æ—¶é—´ï¼Œæ‰€ä»¥æŸ¥è¯¢åº”è¯¥å°½å¯èƒ½çš„é¿å…å›è¡¨ï¼Œ<strong>ç´¢å¼•è¦†ç›–</strong>ä¼šè§£å†³è¿™ä¸ªé—®é¢˜</p>
<p>å›è¡¨ï¼šä»æ™®é€šç´¢å¼•æ ‘æœç´¢å›åˆ°ä¸»é”®ç´¢å¼•é”æœç´¢çš„è¿‡ç¨‹ï¼Œå°±å«åšå›è¡¨</p>
<h2 id="5-1-ç´¢å¼•è¦†ç›–">5.1-ç´¢å¼•è¦†ç›–</h2>
<p><code>select ID from T where k between 3 and 5</code>  æŸ¥è¯¢ï¼Œåªéœ€è¦æŸ¥è¯¢ç´¢å¼•Kå°±å¯ä»¥å¾—åˆ°æŸ¥è¯¢ç»“æœï¼Œä¸éœ€è¦å›è¡¨ï¼Œè¿™å°±æ˜¯ç´¢å¼•è¦†ç›–ã€‚å…¶ä¸­</p>
<p>ğŸ…°ï¸ å¯¹å¼•æ“æ¥è¯´ï¼šåœ¨å¼•æ“å†…éƒ¨ä½¿ç”¨è¦†ç›–ç´¢å¼•åœ¨ç´¢å¼• k ä¸Šå…¶å®è¯»äº†ä¸‰ä¸ªè®°å½•ï¼ŒR3~R5ï¼ˆå¯¹åº”çš„ç´¢å¼• k ä¸Šçš„è®°å½•é¡¹ï¼‰</p>
<p>ğŸ…±ï¸ MySQL çš„ Server å±‚æ¥è¯´ï¼Œå®ƒå°±æ˜¯æ‰¾å¼•æ“æ‹¿åˆ°äº†ä¸¤æ¡è®°å½•ï¼Œå› æ­¤ MySQL è®¤ä¸ºæ‰«æè¡Œæ•°æ˜¯ 2</p>
<h2 id="5-2-æœ€å·¦å‰ç¼€åŸåˆ™">5.2-æœ€å·¦å‰ç¼€åŸåˆ™</h2>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `tuser` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  `id_card` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">  `ismale` tinyint(<span class="number">1</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  key `id_card` (`id_card`),</span><br><span class="line">  key `name_age` (`name`,`age`)</span><br><span class="line">) engine<span class="operator">=</span>innodb</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p><strong>æœ€å·¦å‰ç¼€å¯ä»¥æ˜¯è”åˆç´¢å¼•çš„æœ€å·¦ N ä¸ªå­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²ç´¢å¼•çš„æœ€å·¦ M ä¸ªå­—ç¬¦</strong></p>
</blockquote>
<p>ğŸ…°ï¸ <code>where name like 'å¼ %' </code></p>
<p>ğŸ…±ï¸ <code>where name  = 'å¼ ä¸‰'</code></p>
<p>ä»¥ä¸Šä¸¤ç§æŸ¥è¯¢éƒ½å¯ä»¥ç”¨åˆ° name_age è¿™ä¸ªç´¢å¼•</p>
<h2 id="5-3-ç´¢å¼•ä¸‹æ¨">5.3-ç´¢å¼•ä¸‹æ¨</h2>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">select * from tuser where name like 'å¼ %' and age=10 and ismale=1;</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹äºä¸Šé¢çš„æŸ¥è¯¢æŸ¥è¯¢è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ ä½¿ç”¨æ™®é€šç´¢å¼•(name_age)æ ‘,æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„è®°å½•ID3</p>
<p>2ï¸âƒ£  æŒ‰ç…§ç‰ˆæœ¬åˆ†</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>MySQL 5.6å‰ ï¼š åªèƒ½ä» ID3 å¼€å§‹ä¸€ä¸ªä¸ªå›è¡¨ã€‚åˆ°ä¸»é”®ç´¢å¼•ä¸Šæ‰¾å‡ºæ•°æ®è¡Œï¼Œå†å¯¹æ¯”å­—æ®µå€¼</p>
</li>
<li class="lvl-2">
<p>MySQL 5.6å ï¼šå¯ä»¥åœ¨ç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°</p>
</li>
</ul>
<p>ä¸‹å›¾æ˜¯äºŒè€…çš„åŒºåˆ«ï¼š å·¦è¡¨å›è¡¨4æ¬¡ï¼Œå³è¡¨å›è¡¨2æ¬¡</p>
<p align="center">
  <img src="/2023/09/30/mysql/09.jpg" width="90%" alt="Your image description">
</p>
<h1>6-å…¨å±€é”å’Œè¡¨é” ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆæœ‰è¿™ä¹ˆå¤šé˜»ç¢ï¼Ÿ</h1>
<p>æ•°æ®åº“é”è®¾è®¡çš„åˆè¡·æ˜¯ä¸ºäº†å¤„ç†å¹¶å‘ï¼ˆå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªèµ„æºï¼‰é—®é¢˜ï¼ŒæŒ‰ç…§é”çš„èŒƒå›´åˆ†ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å…¨å±€é”</p>
</li>
<li class="lvl-2">
<p>è¡¨é”</p>
</li>
<li class="lvl-2">
<p>è¡Œé”</p>
</li>
</ul>
<h2 id="6-1-å…¨å±€é”">6.1-å…¨å±€é”</h2>
<p>MySQLé€šè¿‡FTWRLï¼ˆFlush tables with read lockï¼‰,æ¥åŠ å…¨å±€é”ï¼ŒåŠ ä¸Šå…¨å±€é”ä¹‹åï¼Œæ‰€æœ‰çš„æ•°æ®æ›´æ–°è¯­å¥å’ŒDMLè¯­å¥éƒ½ä¼šè¢«é˜»å¡ã€‚å…¨å±€é”çš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ï¼š<strong>åšå…¨åº“çš„é€»è¾‘å¤‡ä»½</strong>ã€‚é€šè¿‡FTWRLçš„æ–¹å¼æ¥æ·»åŠ å…¨å±€é”ï¼Œå¯ä»¥æœ‰æ•ˆçš„çªç ´çš„å­˜å‚¨å¼•æ“å¸¦æ¥çš„é™åˆ¶ï¼ˆMyISAMæ˜¯ä¸æ”¯æŒäº‹åŠ¡çš„ï¼Œå¦‚æœæ˜¯InnoDBå¼•æ“ï¼Œåœ¨RRçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å®ç°é€»è¾‘å¤‡ä»½å¹¶ä¸”å¤‡ä»½çš„æ—¶æ˜¯æ”¯æŒæ›´æ–°çš„ï¼‰</p>
<p><a href="https://time.geekbang.org/column/article/69862">å…³äºä½¿ç”¨FTWRL è¿˜æ˜¯ä½¿ç”¨ set global readonly=true</a></p>
<h2 id="6-2-è¡¨çº§é”">6.2-è¡¨çº§é”</h2>
<p>MySQL çš„è¡¨çº§é”æœ‰2ç§</p>
<p>ğŸ…°ï¸ è¡¨é”</p>
<p>ğŸ…±ï¸ DMLé” ï¼ˆMetadata Lockï¼‰</p>
<h3 id="6-2-1-è¡¨é”">6.2.1-è¡¨é”</h3>
<p>ï¼ˆå‡è®¾æ˜¯çº¿ç¨‹Aï¼‰é”è¡¨çš„è¯­æ³•<code>lock table t1 read,t2 write</code> ,ä½¿ç”¨ <code>unlock talbe </code> é‡Šæ”¾é”ï¼Œå¯¹äºè¯¥é”è¡¨è¯­å¥ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>é™¤äº†Aä¹‹å¤–çš„çº¿ç¨‹ å¯¹ t1 å¯è¯»ï¼Œå¯¹ t2 ä¸å¯è¯»å†™</p>
</li>
<li class="lvl-2">
<p>çº¿ç¨‹A åœ¨æ‰§è¡Œ<code>unlock tables</code>ä¹‹å‰ï¼Œåªèƒ½æ‰§è¡Œè¯» t1, è¯»å†™ t2, ä¸èƒ½åœ¨è®¿é—®å…¶ä»–è¡¨ï¼ˆå†™t1éƒ½ä¸è¡Œï¼Œæ›´åˆ«ä»–å…¶ä»–çš„è¡¨äº†ï¼‰</p>
</li>
</ul>
<h3 id="6-2-2-DMLé”">6.2.2-DMLé”</h3>
<p>ğŸ…°ï¸ å¯¹ä¸€ä¸ªè¡¨åšå¢åˆ æ”¹æŸ¥çš„æ“ä½œçš„æ—¶å€™ï¼ˆä¼šç”³è¯·è¯»é”ï¼‰ï¼ŒåŠ DML è¯»é”ï¼Œ<strong>è¯»é”ä¹‹é—´ä¸äº’æ–¥</strong></p>
<p>ğŸ…±ï¸ å¯¹è¡¨åšDML å˜æ›´çš„æ—¶å€™ï¼ŒåŠ DMLå†™é”ï¼Œ<strong>è¯»å†™é”ã€å†™å†™é”ä¹‹é—´äº’æ–¥</strong></p>
<p>å¦‚ä¸‹ä¾‹å­ä¸­ï¼Œç»™è¡¨Tå¢åŠ å­—æ®µï¼Œè¡¨Tå˜çš„å®Œå…¨ ä¸å¯è¯»å†™</p>
<p align="center">
  <img src="/2023/09/30/mysql/10.jpg" width="80%" alt="Your image description">
</p>
<p>å¤„ç†ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å°½é‡é¿å…é•¿äº‹åŠ¡ï¼ˆsession Aä½ç½® åŠæ—¶ commitï¼‰ï¼Œä¸‹é¢çš„è¯­å¥åœ¨ alter table è¯­å¥é‡Œé¢è®¾å®šç­‰å¾…æ—¶é—´ï¼Œå¦‚æœåœ¨è¿™ä¸ªæŒ‡å®šçš„ç­‰å¾…æ—¶é—´é‡Œé¢èƒ½å¤Ÿæ‹¿åˆ° MDL å†™é”æœ€å¥½ï¼Œæ‹¿ä¸åˆ°ä¹Ÿä¸è¦é˜»å¡åé¢çš„ä¸šåŠ¡è¯­å¥ï¼Œå…ˆæ”¾å¼ƒï¼Œ<strong>é˜»å¡ä¼šå¼•å‘åé¢çš„é˜»å¡</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tbl_name nowait <span class="keyword">add</span> <span class="keyword">column</span> ...</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tbl_name wait n <span class="keyword">add</span> <span class="keyword">column</span> ... </span><br></pre></td></tr></tbody></table></figure>
<h1>7-è¡Œé”åŠŸè¿‡ï¼šæ€ä¹ˆå‡å°‘è¡Œé”å¯¹æ€§èƒ½çš„å½±å“</h1>
<p>MySQL çš„è¡Œé”æ˜¯åœ¨å¼•æ“å±‚é¢å®ç°çš„ï¼ŒInnoDBæ”¯æŒè¡Œé”ï¼ŒMyISAMä¸æ”¯æŒè¡Œé”</p>
<h2 id="7-1-ä¸¤é˜¶æ®µé”">7.1-ä¸¤é˜¶æ®µé”</h2>
<p>ä¸¤é˜¶æ®µé”åè®®ï¼ˆTwo-Phase Locking Protocolï¼‰ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œé¿å…æ•°æ®çš„ä¸ä¸€è‡´æ€§ï¼Œåœ¨ä¸¤é˜¶æ®µé”åè®®ä¸­ï¼Œäº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹è¢«åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šè·å–é”é˜¶æ®µï¼ˆGrowing Phaseï¼‰å’Œé‡Šæ”¾é”é˜¶æ®µï¼ˆShrinking Phaseï¼‰</p>
<p>ğŸ…°ï¸ è·å–é”é˜¶æ®µï¼šåœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼Œäº‹åŠ¡å¯ä»¥è·å–éœ€è¦çš„é”ï¼Œä½†ä¸èƒ½é‡Šæ”¾ä»»ä½•é”</p>
<p>ğŸ…±ï¸ é‡Šæ”¾é”é˜¶æ®µï¼šåœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼Œäº‹åŠ¡å¯ä»¥é‡Šæ”¾é”ï¼Œä½†ä¸èƒ½å†è·å–æ–°çš„é”ï¼ˆäº‹åŠ¡ç»“æŸçš„æ—¶å€™é‡Šæ”¾é”ï¼‰</p>
<p>å³å›¾äº‹åŠ¡Béœ€ç­‰Aé‡Šæ”¾é”æ‰èƒ½è·å¾—<code>id=1</code>çš„é”</p>
 <p align="center">
  <img src="/2023/09/30/mysql/11.jpg" width="80%" alt="Your image description">
</p>
<p>åœ¨InnoDBäº‹åŠ¡ä¸­ï¼Œ<strong>è¡Œé”æ»¡è¶³ä¸¤é˜¶æ®µé”åè®®</strong>ã€‚è¿™ä¸ªåè®®å¯¹æˆ‘ä»¬çš„å¸®åŠ©å°±æ˜¯ï¼š <strong>å¦‚æœä½ çš„äº‹åŠ¡ä¸­éœ€è¦é”å¤šä¸ªè¡Œï¼Œè¦æŠŠæœ€å¯èƒ½é€ æˆé”å†²çªã€æœ€å¯èƒ½å½±å“å¹¶å‘åº¦çš„é”å°½é‡å¾€åæ”¾ã€‚</strong> æ¯”å¦‚åœ¨ä¸€ä¸ªç®€æ˜“çš„å½±ç¥¨äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œå¦‚é¡¾å®¢Aè¦åœ¨å½±é™¢B è´­ä¹°ç”µå½±ç¥¨ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ ä»é¡¾å®¢Aè´¦æˆ·ä½™é¢ä¸­æ‰£é™¤ç”µå½±ç¥¨ä»· update</p>
<p>2ï¸âƒ£ ç»™å½±é™¢Bçš„è´¦æˆ·ä½™é¢å¢åŠ è¿™å¼ ç”µå½±ç¥¨ä»· updateï¼ˆåŒæ—¶å¯èƒ½æœ‰å¦å¤–ä¸€ä¸ªé¡¾å®¢Cåœ¨å½±é™¢Bè´­ç¥¨ï¼Œæ­¤å¤„å¯èƒ½æ˜¯æœ€å®¹æ˜“é€ æˆé”å†²çªçš„åœ°æ–¹ï¼‰</p>
<p>3ï¸âƒ£ è®°å½•ä¸€æ¡äº¤æ˜“æ—¥å¿— insert</p>
<p>1,2,3åº”åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæ ¹æ®ä¸¤é˜¶æ®µé”åè®®ï¼Œæˆ‘ä»¬çš„äº‹åŠ¡åº”è¯¥å°†2 å®‰æ’åœ¨æœ€åã€‚<strong>èƒ½å¤Ÿæœ€å¤§é™åº¦çš„å‡å°‘äº‹åŠ¡ä¹‹é—´çš„é”ç­‰å¾…</strong></p>
<p>ä¸¤é˜¶æ®µé”åè®®ç¡®ä¿äº†åœ¨äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–äº‹åŠ¡ä¸èƒ½è®¿é—®æ­£åœ¨å¤„ç†çš„æ•°æ®ã€‚ç„¶è€Œï¼Œå®ƒä¹Ÿå¯èƒ½ä¼šå¯¼è‡´æ­»é”ï¼Œå› ä¸ºå¯èƒ½ä¼šå‡ºç°ä¸¤ä¸ªæˆ–æ›´å¤šçš„äº‹åŠ¡ï¼Œäº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”çš„æƒ…å†µã€‚å› æ­¤ï¼Œå®é™…çš„æ•°æ®åº“ç³»ç»Ÿéœ€è¦é¢å¤–çš„æœºåˆ¶æ¥æ£€æµ‹å’Œè§£å†³æ­»é”</p>
<h2 id="7-2-æ­»é”å’Œæ­»é”æ£€æµ‹">7.2-æ­»é”å’Œæ­»é”æ£€æµ‹</h2>
<p align="center">
  <img src="/2023/09/30/mysql/12.jpg" width="80%" alt="Your image description">
</p>
<p>å³å›¾ä¾‹å­ä¸ºï¼Œè¡Œé”ä¸­çš„æ­»é”ï¼ˆå½“å¹¶å‘ç³»ç»Ÿä¸­ä¸åŒçº¿ç¨‹å‡ºç°ï¼Œå¾ªç¯èµ„æºä¾èµ–ï¼Œæ¶‰åŠçš„çº¿ç¨‹éƒ½åœ¨ç­‰å¾…åˆ«çš„çº¿ç¨‹é‡Šæ”¾èµ„æºæ—¶ï¼Œå°±ä¼šå¯¼è‡´è¿™å‡ ä¸ªçº¿ç¨‹éƒ½è¿›å…¥æ— é™ç­‰å¾…çš„çŠ¶æ€ï¼Œç§°ä¸ºæ­»é”ï¼‰</p>
<p>å‡ºç°æ­»é”åï¼Œæœ‰2ç§ç­–ç•¥ï¼š</p>
<p>1ï¸âƒ£ è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è¶…æ—¶ï¼ˆ<code>MySQL innodb</code> è¶…æ—¶æ—¶é—´ ç”±<code>innodb_lock_wait_timeout</code> æŒ‡å®šï¼Œé»˜è®¤50sï¼‰, ç”±äºè¶…æ—¶æ—¶é—´é˜ˆå€¼è®¾ç½®è¿‡å°å¯èƒ½ä¼šå¯¼è‡´å‡é˜´æ€§ï¼ˆè¯¯æ€ï¼Œå°†æ­£å¸¸çš„ç­‰å¾…åˆ¤æ–­ä¸ºæ­»é”ï¼‰ï¼Œé€šå¸¸ä¸ä¼šé‡‡ç”¨æ­¤æ–¹æ¡ˆ</p>
<p>2ï¸âƒ£ å‘èµ·æ­»é”æ£€æµ‹ï¼ˆ<code>innodb_deadlock_detect</code> è®¾ç½®ä¸º <code>on</code>ï¼‰ , å‘ç°æ­»é”åï¼Œä¸»åŠ¨å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡ï¼Œè®©å…¶ä»–äº‹åŠ¡ç»§ç»­æ‰§è¡Œã€‚æ­»é”æ£€æµ‹æœ‰é¢å¤–çš„è´Ÿæ‹…ï¼ˆæ­»é”æ£€æµ‹æ˜¯$O(N^2)$çš„æ—¶é—´å¤æ‚åº¦ï¼‰</p>
<p><strong>å‡å°‘æ­»é”çš„ä¸»è¦æ–¹å‘ï¼Œå°±æ˜¯æ§åˆ¶è®¿é—®ç›¸åŒèµ„æºçš„å¹¶å‘äº‹åŠ¡é‡</strong>ï¼Œå³é™ä½$N$å€¼</p>
<p>ä¸ºä»€ä¹ˆæ­»é”æ£€æµ‹æ˜¯$O(N^2)$çš„æ—¶é—´å¤æ‚åº¦</p>
<blockquote>
<p>å¹¶å‘æ›´æ–°åŒä¸€è¡Œçš„1000ä¸ªçº¿ç¨‹ï¼Œæ•´ä½“è€—è´¹çš„æ­»é”æ£€æµ‹æ“ä½œä¸º$1000\times1000=100$ä¸‡ã€‚ ä¸ºä»€ä¹ˆæ˜¯ä¸ªä¹˜æ³•â€”â€”å¹¶å‘æ›´æ–°æ­¤è¡ŒR1çš„æŸå•ä¸ªçº¿ç¨‹Txï¼Œå…¶æ‰€ä½œçš„æ­»é”æ£€æµ‹å·¥ä½œä¸ºï¼ŒTxä¼šæœ‰æŸ¥çœ‹é”æŒæœ‰æƒ…å†µï¼Œè€—è´¹1000æ­¤æ“ä½œâ€”â€”a.æŸ¥çœ‹è‡ªèº«æŒæœ‰çš„è¡Œé”; b.éå†å…¶ä»–999ä¸ªçº¿ç¨‹æ‰€æŒæœ‰çš„è¡Œé”ï¼Œæ€»å…±ä¸º$1 + 999=1000$æ¬¡ã€‚ ä¸ºä»€ä¹ˆä¼šéå†å…¶ä»–999ä¸ªçº¿ç¨‹ï¼Œè€Œä¸æ˜¯ä»…çœ‹å½“å‰æŒæœ‰R1è¡Œé”çš„è¿™ä¸ªçº¿ç¨‹å°±è¡Œäº†ï¼Ÿâ€”â€” å› ä¸ºè¡Œé”æ’é˜Ÿã€‚æŸçº¿ç¨‹Tmæ’é˜Ÿè·å–R1è¡Œé”ï¼Œæ’åœ¨Txå‰ã€‚å¦‚æœTxå½“å‰æŒæœ‰è¡Œé”R2ï¼Œè¿‡ä¼šTmå…ˆäºTxè·æŒR1åï¼Œä¼šå˜æˆâ€”â€”TmæŒæœ‰R1ï¼Œç­‰å¾…R2 &amp;&amp; TxæŒæœ‰R2ï¼Œç­‰å¾…R1â€”â€”Tmå’ŒTxæˆç¯æ­»é”ã€‚ å› æ­¤å¹¶å‘æ›´æ–°åŒä¸€è¡Œçš„æœ‰Nä¸ªçº¿ç¨‹ï¼Œå¯¹åº”çš„æ­»é”æ£€æµ‹è€—è´¹ä»£ä»·ä¸º$O(N^2)$ ! æ­»é”æ£€æµ‹ä¸å¯é¿å…ï¼Œä¸ºé˜²æ­¢æ­»é”æ£€æµ‹ä»£ä»·è¿‡é«˜å¼•èµ·æ€§èƒ½é—®é¢˜â€”â€”æƒ³åŠæ³•å‡å°‘åŒæ—¶å¯¹åŒä¸€è¡Œçš„æ›´æ–°çš„å¹¶å‘å¹¶å‘åº¦ã€‚å³é™ä½Nå€¼</p>
</blockquote>
<p>ä¸ºäº†é¿å…æ­»é”æ£€æµ‹å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä¹Ÿå¯ä»¥ä»ä¸šåŠ¡é€»è¾‘çš„è§’åº¦å‡ºå‘å»è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚åœ¨è´­ä¹°å½±ç¥¨çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€è¡Œæ”¹ä¸ºï¼Œ<strong>é€»è¾‘ä¸Šçš„å¤šè¡Œ</strong>æ¥å‡å°‘é”å†²çª:</p>
<blockquote>
<p>å¯ä»¥è€ƒè™‘æ”¾åœ¨å¤šæ¡è®°å½•ä¸Šï¼Œæ¯”å¦‚ 10 ä¸ªè®°å½•ï¼Œå½±é™¢çš„è´¦æˆ·æ€»é¢ç­‰äºè¿™ 10 ä¸ªè®°å½•çš„å€¼çš„æ€»å’Œã€‚è¿™æ ·æ¯æ¬¡è¦ç»™å½±é™¢è´¦æˆ·åŠ é‡‘é¢çš„æ—¶å€™ï¼Œéšæœºé€‰å…¶ä¸­ä¸€æ¡è®°å½•æ¥åŠ ã€‚è¿™æ ·æ¯æ¬¡å†²çªæ¦‚ç‡å˜æˆåŸæ¥çš„ 1/10ï¼Œå¯ä»¥å‡å°‘é”ç­‰å¾…ä¸ªæ•°ï¼Œä¹Ÿå°±å‡å°‘äº†æ­»é”æ£€æµ‹çš„ CPU æ¶ˆè€—,å¦‚æœè´¦æˆ·ä½™é¢å¯èƒ½ä¼šå‡å°‘ï¼Œæ¯”å¦‚é€€ç¥¨é€»è¾‘ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±éœ€è¦è€ƒè™‘å½“ä¸€éƒ¨åˆ†è¡Œè®°å½•å˜æˆ 0 çš„æ—¶å€™ï¼Œä»£ç è¦æœ‰ç‰¹æ®Šå¤„ç†</p>
</blockquote>
<h1>8-äº‹åŠ¡åˆ°åº•æ˜¯éš”ç¦»çš„è¿˜æ˜¯ä¸éš”ç¦»çš„ï¼Ÿ</h1>
<p>å½“å‰è®¨è®ºçš„éš”ç¦»çº§åˆ«ï¼š<mark>RR</mark>ï¼Œid = 1 çš„åŸå§‹å€¼ä¸º1ï¼Œå¦‚ä¸‹å›¾é¡ºåºè¿›è¡ŒæŸ¥è¯¢ï¼š</p>
<p align="center">
  <img src="/2023/09/30/mysql/13.jpg" width="80%" alt="Your image description">
</p> 
<p>ğŸ…°ï¸ Aäº‹åŠ¡æŸ¥åˆ°çš„  k = 1</p>
<p>ğŸ…±ï¸ Bäº‹åŠ¡æŸ¥åˆ°çš„  k = 3</p>
<h2 id="8-1-MVCCæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ">8.1-MVCCæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</h2>
<p><strong>transaction id</strong> ï¼š æ¯ä¸ªäº‹åŠ¡çš„å”¯ä¸€ idå·ï¼ˆå¯¹è±¡æ˜¯æŸä¸€ä¸ªåŠ¨ä½œï¼‰ã€‚InnoDBä¸­æ¯ä¸ªäº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡IDï¼Œè®°ä¸º transaction id ,è¯¥ id æ˜¯äº‹åŠ¡å¼€å¯çš„æ—¶å€™å‘InnoDBçš„äº‹åŠ¡ç³»ç»Ÿç”³è¯·çš„ï¼Œè¯¥ id æŒ‰ç…§ç”³è¯·é¡ºåºä¸¥æ ¼é€’å¢</p>
<p><strong>row  trx_id</strong>ï¼š è®°å½•å½“å‰æ•°æ®æ˜¯è¢«å“ªä¸ªtransaction_id æ”¹ä¸ºå½“å‰å€¼çš„ ï¼ˆå¯¹è±¡æ˜¯æŸä¸€ä¸ªæ•°æ®ï¼‰ã€‚æ¯æ¬¡äº‹åŠ¡æ›´æ–°æ•°æ®æ—¶ï¼Œä¼šç”Ÿæˆæ–°çš„æ•°æ®ç‰ˆæœ¬ï¼Œrow trx_id è®°å½•å½“å‰çš„æ•°æ®ç‰ˆæœ¬æ˜¯è¢«å“ªä¸ªäº‹åŠ¡æ”¹ä¸ºå½“å‰å€¼çš„</p>
<p>å¦‚ä¸‹å›¾ï¼šä¸€ä¸ªè®°å½•è¢«å¤šä¸ªäº‹åŠ¡è¿ç»­æ›´æ–°åçš„çŠ¶æ€ï¼š</p>
<p align="center">
  <img src="/2023/09/30/mysql/14.jpg" width="80%" alt="Your image description">
</p>
<p>å…³äºundo log : è¯­å¥æ›´æ–°ä¼šäº§ç”Ÿ undo log (å›æ»šæ—¥å¿—)ï¼Œä½œç”¨æ˜¯å¯ä»¥ç”¨äºå›æ»šï¼ŒåŒæ—¶å¯ä»¥æä¾›å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ä¸‹çš„è¯»ï¼ˆMVCCï¼‰<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></p>
<p><mark>ä»å¯è¯»æ€§ä¸Šæ¥è¯´</mark>ï¼šä¸€ä¸ªæ•°æ®ç‰ˆæœ¬ï¼Œå¯¹äºä¸€ä¸ªäº‹åŠ¡è§†å›¾æ¥è¯´ï¼Œé™¤äº†è‡ªå·±çš„æ›´æ–°æ€»æ˜¯å¯è§ä»¥å¤–ï¼Œæœ‰ä¸‰ç§æƒ…å†µï¼š</p>
<blockquote>
<p>1ï¸âƒ£ ç‰ˆæœ¬æœªæäº¤ï¼Œä¸å¯è§</p>
<p>2ï¸âƒ£ ç‰ˆæœ¬å·²æäº¤ï¼Œä½†æ˜¯</p>
<ul class="lvl-1">
<li class="lvl-2">
<p>åœ¨è§†å›¾åˆ›å»ºåæäº¤çš„ï¼Œä¸å¯è§</p>
</li>
<li class="lvl-2">
<p>æ˜¯åœ¨è§†å›¾åˆ›å»ºå‰æäº¤çš„ï¼Œå¯è§</p>
</li>
</ul>
</blockquote>
<p>æŒ‰ç…§ä¸Šé¢çš„è§„åˆ™æ¥åˆ¤æ–­äº‹åŠ¡Aï¼Œäº‹åŠ¡Açš„ä¸€è‡´æ€§è§†å›¾æ˜¯åœ¨äº‹åŠ¡Aå¯åŠ¨çš„æ—¶å€™ç”Ÿæˆçš„ï¼Œæ­¤æ—¶ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>äº‹åŠ¡Bçš„ (id=1,k=3) è¿˜æ²¡æœ‰æäº¤ï¼Œä¸å¯è§ ï¼Œå±äºæƒ…å†µ 1</p>
</li>
<li class="lvl-2">
<p>äº‹åŠ¡Cçš„(id=1,k=2) å·²ç»æäº¤ï¼Œä½†æ˜¯æ˜¯åœ¨Açš„ä¸€è‡´æ€§è§†å›¾åˆ›å»º<strong>å</strong>æäº¤çš„ï¼Œä¸å¯è§ï¼Œå±äºæƒ…å†µ2.1</p>
</li>
<li class="lvl-2">
<p>(id=1,k=1) å·²ç»æäº¤ï¼Œè€Œä¸”æ˜¯åœ¨Açš„ä¸€è‡´æ€§è§†å›¾åˆ›å»º<strong>å‰</strong>æäº¤çš„ï¼Œå¯è§ï¼Œå±äºæƒ…å†µ2.2</p>
</li>
</ul>
<p>çœŸå®çš„ç‰©ç†å®ç°ï¼Œæ¶‰åŠåˆ°<strong>é«˜æ°´ä½</strong>ï¼ˆè§†å›¾æ•°ç»„æœ€å¤§å€¼+1ï¼‰ã€<strong>ä½æ°´ä½</strong>ï¼ˆè§†å›¾æ•°ç»„çš„æœ€å°å€¼ï¼‰ã€<strong>è§†å›¾æ•°ç»„</strong>ï¼ˆå·²ç»å¼€å§‹ï¼Œä½†æ²¡æœ‰æäº¤çš„äº‹åŠ¡idæ„æˆçš„æ•°ç»„ï¼‰</p>
<p><a href="https://time.geekbang.org/column/article/70562">å‚è€ƒé€»è¾‘</a></p>
<h2 id="8-2-æ›´æ–°é€»è¾‘">8.2-æ›´æ–°é€»è¾‘</h2>
<p>æˆ‘ä»¬å†æ¥åˆ†æä¸€ä¸‹äº‹åŠ¡Bçš„ <code>update</code> é€»è¾‘ï¼ŒæŒ‰ç…§ä¸Šè¿°çš„ä¸€è‡´æ€§è¯»é€»è¾‘ï¼Œäº‹åŠ¡Bï¼Œæ˜¯ä¸èƒ½è¯»åˆ°äº‹åŠ¡Cçš„(1,2)çš„ï¼Œå› ä¸ºäº‹åŠ¡Cçš„æ˜¯åœ¨äº‹åŠ¡Bçš„ä¸€è‡´æ€§è§†å›¾ç”Ÿæˆåæäº¤çš„ï¼ŒæŒ‰ç†è¯´ä¸å¯è§ï¼›è§†å›¾Båœ¨æ›´æ–°å‰å»æŸ¥è¯¢ä¸€æ¬¡æ•°æ®ï¼Œè¿”å›çš„K=1ï¼Œä½†æ˜¯å½“æ›´æ–°çš„æ—¶å€™ï¼Œå¿…é¡»æ‹¿åˆ°æœ€æ–°çš„å€¼ï¼ˆ1,2ï¼‰ï¼Œå¦åˆ™äº‹åŠ¡Cçš„æ›´æ–°å°±ä¸¢å¤±äº†ï¼Œå› æ­¤æ›´æ–°æ•°æ®æ¶‰åŠåˆ°ä¸€æ¡è§„åˆ™ï¼š</p>
<blockquote>
<p><strong>å½“å‰è¯»ï¼šæ›´æ–°æ•°æ®æ˜¯å…ˆè¯»åå†™çš„ï¼Œè¯»åªèƒ½è¯»å½“å‰å·²æäº¤çš„æœ€æ–°å€¼ï¼Œè¿™ä¸ªè¯» ç§°ä¹‹ä¸ºå½“å‰è¯»</strong></p>
</blockquote>
<p>å› æ­¤ï¼Œäº‹åŠ¡BæŸ¥è¯¢ç»“æœæ˜¯ (id=1,k=3)</p>
<p>æ­¤å¤–ï¼Œ<strong>é™¤äº†update è¯­å¥å¤–ï¼Œselect è¯­å¥å¦‚æœåŠ é”ï¼Œä¹Ÿæ˜¯å½“å‰è¯»</strong>ï¼Œå¦‚æˆ‘ä»¬å°†äº‹åŠ¡Açš„æŸ¥è¯¢æ”¹ä¸ºå¦‚ä¸‹è¯­å¥ï¼Œä¹Ÿå¯ä»¥å¾—åˆ°<code>k=3</code>çš„ç»“æœ</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> k <span class="keyword">from</span> t <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> lock <span class="keyword">in</span> share mode; <span class="comment">-- è¯»é”ï¼ˆS é”ï¼Œå…±äº«é”ï¼‰</span></span><br><span class="line"><span class="keyword">select</span> k <span class="keyword">from</span> t <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span>; <span class="comment">-- å†™é”ï¼ˆX é”ï¼Œæ’ä»–é”)</span></span><br><span class="line"><span class="comment">-- update çš„åŠ é”è¯­ä¹‰å’Œ select â€¦for update æ˜¯ä¸€è‡´çš„</span></span><br></pre></td></tr></tbody></table></figure>
<p>è¿›ä¸€æ­¥å‡è®¾äº‹åŠ¡Cè¿˜æ²¡æœ‰æäº¤ï¼Œäº‹åŠ¡Bå°±æ›´æ–°ï¼Œäº‹åŠ¡Bçš„æ›´æ–°è¯­å¥ä¼šå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p>
<p align="center">
  <img src="/2023/09/30/mysql/15.jpg" width="60%" alt="Your image description">
  <n>
  <span style="color:gray"> info about the picture </span>
</n></p>
<p>ç”±äº<strong>2é˜¶æ®µé”åè®®</strong>ï¼ˆ2PLï¼‰çš„å­˜åœ¨ï¼Œäº‹åŠ¡Câ€™ æ²¡æœ‰æäº¤ï¼Œå³  (1,2) è¿™ä¸ªç‰ˆæœ¬çš„å†™é” è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œè€Œäº‹åŠ¡Bæ˜¯å½“å‰è¯»ï¼Œå¿…é¡»å¾—åˆ°å½“å‰ç‰ˆæœ¬(1,2)ï¼Œè€Œä¸”å¿…é¡»åŠ é”ï¼Œå› æ­¤é˜»å¡äº†ï¼Œå¿…é¡»ç­‰äº‹åŠ¡Câ€™é‡Šæ”¾è¿™ä¸ªé”ï¼Œæ‰èƒ½ç»§ç»­å®ƒçš„å½“å‰è¯»ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p align="center">
  <img src="/2023/09/30/mysql/16.jpg" width="50%" alt="Your image description">
</p>
<p>å¯¹äºå¼€å¤´çš„3ä¸ªäº‹åŠ¡ï¼Œä¸‹é¢æ›´æ”¹éš”ç¦»çº§åˆ«ä¸ºï¼š<mark>RC</mark>ï¼š</p>
<p align="center">
  <img src="/2023/09/30/mysql/17.jpg" width="50%" alt="Your image description">
</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>äº‹åŠ¡A ï¼š k = 2</p>
</li>
<li class="lvl-2">
<p>äº‹åŠ¡B ï¼š k = 3</p>
</li>
</ul>
<h1>9-æ™®é€šç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•ï¼Œåº”è¯¥æ€ä¹ˆé€‰ï¼Ÿ</h1>
<p>å¯¹äºè¡¨T æŸ¥è¯¢ï¼Œè®¨è®ºåœ¨ k ä¸Šå»ºç«‹å”¯ä¸€ç´¢å¼•è¿˜æ˜¯æ™®é€šç´¢å¼•</p>
<p align="center">
  <img src="/2023/09/30/mysql/08.jpg" width="70%" alt="Your image description">
</p>
<h2 id="9-1-æŸ¥è¯¢è¿‡ç¨‹">9.1-æŸ¥è¯¢è¿‡ç¨‹</h2>
<p>å¯¹äº<code>select id from T where k=5</code>æŸ¥è¯¢ï¼Œè¯¥æŸ¥è¯¢åœ¨ç´¢å¼•æ ‘ä¸Šçš„æŸ¥è¯¢è¿‡ç¨‹ï¼Œå…ˆæ˜¯ä» B+ æ ‘çš„ root å¼€å§‹ï¼ŒæŒ‰å±‚æœç´¢åˆ°å¶å­èŠ‚ç‚¹(å³ä¸‹è§’æ•°æ®é¡µï¼Œå¯ä»¥è®¤ä¸ºæ•°æ®é¡µå†…éƒ¨é€šè¿‡äºŒåˆ†æ³•æ¥å®šä½è®°å½•)</p>
<p>1ï¸âƒ£ : å¯¹äºæ™®é€šç´¢å¼•æ¥è¯´ï¼ŒæŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªè®°å½•(5,500)å ,éœ€è¦æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè®°å½•ï¼Œç›´åˆ°ç¢°åˆ°ç¬¬ä¸€ä¸ªä¸æ»¡è¶³k=5æ¡ä»¶çš„è®°å½•</p>
<p>2ï¸âƒ£: å¯¹äºå”¯ä¸€ç´¢å¼•æ¥è¯´ï¼Œç”±äºç´¢å¼•å®šä¹‰äº†å”¯ä¸€æ€§ï¼ŒæŸ¥æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„è®°å½•åï¼Œå°±åœæ­¢æ£€ç´¢</p>
<p>ä½†æ˜¯ä¸¤è€…çš„æ€§èƒ½å·®å¼‚å¾®ä¹å…¶å¾®çš„ï¼Œå› ä¸º<code>InnoDB</code>å¼•æ“æ˜¯ä»¥æ•°æ®é¡µä¸ºå•ä½æ¥è¿›è¡Œæ•°æ®çš„è¯»å†™çš„ï¼Œå½“æ‰¾åˆ° k = 5 çš„è®°å½•çš„æ—¶å€™ï¼Œå®ƒæ‰€åœ¨çš„æ•°æ®é¡µå·²ç»åœ¨å†…å­˜ä¸­äº†ï¼Œæ™®é€šç´¢å¼•éœ€è¦å¤šåšä¸€æ¬¡çš„ <strong>â€˜æŸ¥æ‰¾å’Œåˆ¤æ–­ä¸‹ä¸€æ¡è®°å½•â€™</strong>  åªæ˜¯ä¸€æ¬¡æŒ‡é’ˆå¯»å€å’Œä¸€æ¬¡è®¡ç®—ï¼Œå¦‚æœk=5è®°å½•æ•°æ®é¡µçš„æœ€åä¸€ä¸ªè®°å½•ï¼Œè¿™ç§æƒ…å†µçš„æ¦‚ç‡å¾ˆä½ï¼Œè®¡ç®—å¹³å‡æ€§èƒ½çš„å·®å¼‚å¯¹ç°åœ¨çš„CPUæ¥è¯´å¯ä»¥å¿½ç•¥ä¸è®¡</p>
<blockquote>
<p>ä»¥æ•°æ®é¡µä¸ºå•ä½è¿›è¡Œæ•°æ®è¯»å†™ï¼šå½“éœ€è¦è¯»ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯å°†ç›®æ ‡è®°å½•æœ¬èº«ä»ç£ç›˜ä¸­è¯»å‡ºæ¥ï¼Œè€Œæ˜¯ä»¥é¡µä¸ºå•ä½ï¼Œå°†ç›®æ ‡è®°å½•æ‰€åœ¨çš„é¡µæ•´ä½“è¯»å…¥å†…å­˜ï¼Œæ¯ä¸ªæ•°æ®é¡µå¤§å°é»˜è®¤ä¸º16KB</p>
</blockquote>
<h2 id="9-2-æ›´æ–°è¿‡ç¨‹">9.2-æ›´æ–°è¿‡ç¨‹</h2>
<p>å½“éœ€è¦æ›´æ–°ä¸€ä¸ªæ•°æ®é¡µæ—¶ï¼ŒMySQLä¼šè¿›è¡Œåˆ¤æ–­å½“å‰ä¿®æ”¹çš„æ•°æ®é¡µæ˜¯å¦åœ¨å†…å­˜ä¸­ï¼š</p>
<p>1ï¸âƒ£ : åœ¨å†…å­˜ä¸­ï¼Œç›´æ¥å¯¹æ•°æ®è¿›è¡Œæ›´æ–°</p>
<p>2ï¸âƒ£ : <code>InnoDB</code>å°†æ›´æ–°ç¼“å­˜åœ¨change bufferï¼ˆæ—¢å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä¹Ÿå­˜å‚¨ç£ç›˜ä¸­ï¼š å¯ä»¥ç¼“å­˜æ›´æ–°é€»è¾‘ï¼‰ä¸­ï¼Œåœ¨ä¸‹æ¬¡è®¿é—®è¿™ä¸ªæ•°æ®é¡µçš„æ—¶å€™ï¼Œå°†æ•°æ®è¯»å…¥å†…å­˜ï¼Œæ‰§è¡Œchange buffer ä¸­å’Œè¿™ä¸ªæ•°æ®é¡µæœ‰å…³çš„æ›´æ–°æ“ä½œ</p>
<p>è®¿é—®æ•°æ®é¡µæ—¶ä¼šè§¦å‘mergeï¼ˆå°†change bufferçš„æ“ä½œåº”ç”¨åˆ°æ•°æ®é¡µï¼Œå¾—åˆ°æœ€ç»ˆçš„ç»“æœçš„è¿‡ç¨‹ç§°ä¹‹ä¸º mergeï¼‰ï¼Œç³»ç»Ÿåå°çº¿ç¨‹ä¼šå®šæœŸmergeï¼Œåœ¨æ•°æ®åº“æ­£å¸¸å…³é—­è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šæ‰§è¡Œmergeã€‚æ— ç–‘ï¼Œä½¿ç”¨change buffer  èƒ½å¤Ÿæœ‰æ•ˆçš„æå‡è¯­å¥çš„æ‰§è¡Œæ•ˆç‡ï¼Œè€Œä¸”ç”±äºæ•°æ®é¡µä¸éœ€è¦è¯»å…¥å†…å­˜å ç”¨<strong>buffer pool</strong><sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>,è¿˜å¯ä»¥æé«˜å†…å­˜åˆ©ç”¨ç‡</p>
<p>ä¸ºä»€ä¹ˆå”¯ä¸€ç´¢å¼•ä¸èƒ½ä½¿ç”¨change bufferï¼Ÿæ˜¯å› ä¸ºå”¯ä¸€ç´¢å¼•éœ€è¦æ£€æŸ¥å½“å‰çš„æ’å…¥æ˜¯å¦è¿åäº†å”¯ä¸€çº¦æŸï¼Œè¿™ä¸ªæ£€æŸ¥éœ€è¦å°†æ•°æ®é¡µè¯»å–åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨change bufferã€‚åªæœ‰æ™®é€šç´¢å¼•å¯ä»¥ä½¿ç”¨change bufferï¼Œå¯¹äºä¸€å¼ è¡¨éœ€è¦æ’å…¥æ–°è®°å½• (5,500)ï¼Œ<code>InnoDB</code>çš„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ è¿™ä¸ªè®°å½•åœ¨å†…å­˜ä¸­</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å¦‚æœæ˜¯å”¯ä¸€ç´¢å¼•ï¼šæ‰¾åˆ°3å’Œ5ä¹‹é—´çš„ä½ç½®ï¼Œåˆ¤æ–­åˆ°æ²¡æœ‰å†²çªï¼Œæ’å…¥è¿™ä¸ªå€¼ï¼Œè¯­å¥æ‰§è¡Œç»“æŸ</p>
</li>
<li class="lvl-2">
<p>å¦‚æœæ˜¯æ™®é€šç´¢å¼•ï¼šæ‰¾åˆ°3å’Œ5ä¹‹é—´çš„ä½ç½®ï¼Œæ’å…¥è¿™ä¸ªå€¼ï¼Œè¯­å¥æ‰§è¡Œç»“æŸ</p>
</li>
</ul>
<p>ç›¸æ¯”ä¹‹ä¸‹åªæ˜¯ç›¸å·®ä¸€ä¸ªCPUæ—¶é—´</p>
<p>2ï¸âƒ£ è¿™ä¸ªè®°å½•ä¸åœ¨å†…å­˜ä¸­ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å”¯ä¸€ç´¢å¼•ï¼šå°†æ•°æ®é¡µè¯»å…¥åˆ°å†…å­˜ï¼Œåˆ¤æ–­åˆ°æ²¡æœ‰å†²çªï¼Œæ’å…¥è¿™ä¸ªå€¼ï¼Œè¯­å¥æ‰§è¡Œç»“æŸ</p>
</li>
<li class="lvl-2">
<p>æ™®é€šç´¢å¼•ï¼šå°†æ›´æ–°è®°å½•åœ¨ change bufferï¼Œè¯­å¥æ‰§è¡Œå°±ç»“æŸäº†</p>
</li>
</ul>
<p>ç›¸æ¯”ä¸‹ï¼Œæ™®é€šç´¢å¼•çœæ‰äº†ç£ç›˜è¯»å…¥å†…å­˜æ¶‰åŠéšæœºIOçš„è®¿é—®<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>ï¼Œ ä½¿ç”¨change bufferï¼Œå¯¹äºå†™å¤šè¯»å°‘çš„ç³»ç»Ÿå¾ˆåˆé€‚ï¼Œå¦‚è´¦å•æ—¥å¿—ç±»ç›®è¿™ç§é¡µé¢å†™å®Œä¹‹åè¢«è®¿é—®çš„æ¦‚ç‡å¾ˆä½çš„ç³»ç»Ÿ</p>
<p>ğŸ’â€â™‚ï¸ å…³äºå”¯ä¸€ç´¢å¼•å’Œæ™®é€šç´¢å¼•é€‰å–çš„å»ºè®®ï¼š</p>
<blockquote>
<p><strong>2ç±»ç´¢å¼•åœ¨æŸ¥è¯¢ä¸Šå¯¹æ€§èƒ½æ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Œä¼˜å…ˆå°½é‡ä½¿ç”¨æ™®é€šç´¢å¼•ï¼›å¦‚æœæ‰€æœ‰çš„æ›´æ–°åï¼Œéƒ½ç«‹é©¬ä¼´éšç€è¿™ä¸ªè®°å½•çš„æŸ¥è¯¢ï¼Œåº”è¯¥å…³é—­change buffer</strong></p>
</blockquote>
<h4 id="å¯¹æ¯”redo-log-WAL-å’Œ-Change-buffer">å¯¹æ¯”redo log WAL å’Œ Change buffer</h4>
<p>åœ¨æ€§èƒ½ä¸Š<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>ï¼šredo log ä¸»è¦èŠ‚çœçš„æ˜¯éšæœºå†™ç£ç›˜çš„ IO æ¶ˆè€—ï¼ˆè½¬æˆé¡ºåºå†™ï¼‰ï¼Œè€Œ change buffer ä¸»è¦èŠ‚çœçš„åˆ™æ˜¯éšæœºè¯»ç£ç›˜çš„ IO æ¶ˆè€—</p>
<h1>10-MySQLä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¼šé€‰é”™ç´¢å¼•ï¼Ÿ</h1>
<p>åŒ1è®¾ç½®å¯ä»¥=&gt; æ•°æ®å®‰å…¨ <a href="https://www.cnblogs.com/kevingrace/p/10441086.html">å‚è€ƒlink</a></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> variables  <span class="keyword">like</span> <span class="string">'innodb_flush_log_at_trx_commit'</span>; </span><br><span class="line"><span class="comment">-- innodb_flush_log_at_trx_commit = 1 æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶MySQLéƒ½ä¼šæŠŠ redo log bufferçš„æ•°æ®å†™å…¥log fileï¼Œå¹¶ä¸”flush(åˆ·åˆ°ç£ç›˜)ä¸­å»;</span></span><br><span class="line"><span class="keyword">show</span> variables  <span class="keyword">like</span> <span class="string">'sync_binlog'</span>  </span><br><span class="line"><span class="comment">-- sync_binlog = 1  sync_binlog =N (N&gt;0) ï¼ŒMySQL åœ¨æ¯å†™ Næ¬¡ äºŒè¿›åˆ¶æ—¥å¿—binary logæ—¶ï¼Œä¼šä½¿ç”¨fdatasync()å‡½æ•°å°†å®ƒçš„å†™äºŒè¿›åˆ¶æ—¥å¿—binary logåŒæ­¥åˆ°ç£ç›˜ä¸­å»ã€‚</span></span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹äºæŸä¸ªè¡¨t</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `t` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span> auto_increment,</span><br><span class="line">  `a` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">  `b` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  key `a` (`a`),</span><br><span class="line">  key `b` (`b`)</span><br><span class="line">) engine<span class="operator">=</span>innodb;</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨æ•°æ®åº“ä¸­ï¼Œå½±å“æ‰§è¡Œæ•ˆç‡çš„å› ç´ ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>æ‰«æè¡Œæ•°æ˜¯å½±å“æ‰§è¡Œä»£ä»·çš„å› ç´ ä¹‹ä¸€ï¼Œæ‰«æçš„è¡Œæ•°è¶Šå°‘ï¼Œæ„å‘³ç€è®¿é—®ç£ç›˜æ•°æ®çš„æ¬¡æ•°è¶Šå°‘ï¼Œæ¶ˆè€—çš„CPUèµ„æºè¶Šå°‘</p>
</li>
<li class="lvl-2">
<p>å¦ä½¿ç”¨äº† ä¸´æ—¶è¡¨</p>
</li>
<li class="lvl-2">
<p>æ˜¯å¦æ’åºç­‰å› ç´ </p>
</li>
<li class="lvl-2">
<p>æ‰«ææ™®é€šç´¢å¼•ä¼šè€ƒè™‘åˆ°å›è¡¨çš„ä»£ä»·</p>
</li>
</ul>
<p>ç´¢å¼•åŸºæ•°ï¼ˆç´¢å¼•ä¸Šä¸åŒå€¼çš„ä¸ªæ•°ï¼‰è¶Šå¤§ï¼Œç´¢å¼•çš„åŒºåˆ†åº¦è¶Šå¤§ï¼Œé€šè¿‡ <code>show index from table_name</code> æŸ¥çœ‹ç´¢å¼•åŸºæ•°ã€‚è¯¥å‘½ä»¤å¾—åˆ°çš„æ˜¯ä¸€ä¸ªé‡‡æ ·ä¼°ç®—å€¼<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup></p>
<p>ä¼˜åŒ–å™¨å­˜åœ¨é€‰é”™ç´¢å¼•çš„å¯èƒ½æ€§ã€‚å¯¹äºç”±äºç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®å¯¼è‡´çš„é—®é¢˜ï¼Œä½ å¯ä»¥ç”¨ <code>analyze table</code> æ¥è§£å†³ã€‚è€Œå¯¹äºå…¶ä»–ä¼˜åŒ–å™¨è¯¯åˆ¤çš„æƒ…å†µ</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>ä½ å¯ä»¥åœ¨åº”ç”¨ç«¯ç”¨ force index æ¥å¼ºè¡ŒæŒ‡å®šç´¢å¼•</p>
</li>
<li class="lvl-2">
<p>ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹è¯­å¥æ¥å¼•å¯¼ä¼˜åŒ–å™¨</p>
</li>
<li class="lvl-2">
<p>è¿˜å¯ä»¥é€šè¿‡å¢åŠ æˆ–è€…åˆ é™¤ç´¢å¼•æ¥ç»•è¿‡è¿™ä¸ªé—®é¢˜</p>
</li>
</ul>
<h1>11-æ€ä¹ˆç»™å­—ç¬¦ä¸²å­—æ®µåŠ ç´¢å¼•</h1>
<h2 id="11-1-å‰ç¼€ç´¢å¼•">11.1-å‰ç¼€ç´¢å¼•</h2>
<p>åœ¨åŸå­—æ®µå»ºç«‹ç´¢å¼•å’Œå»ºç«‹å‰ç¼€ç´¢å¼•ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> SUser <span class="keyword">add</span> index index1(email); <span class="comment">-- åœ¨emailä¸Šå»ºç«‹ç´¢å¼•</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> SUser <span class="keyword">add</span> index index2(email(<span class="number">6</span>)); <span class="comment">-- åœ¨ emailçš„å‰6ä¸ªå­—ç¬¦å»ºç«‹ç´¢å¼•</span></span><br></pre></td></tr></tbody></table></figure>
<p align="center">
  <img src="/2023/09/30/mysql/18.jpg" width="80%" alt="Your image description">
</p>
<p>å‰ç¼€ç´¢å¼•çš„ä¼˜åŠ¿ï¼šå ç”¨ç©ºé—´æ›´å°ï¼›å‰ç¼€ç´¢å¼•çš„åŠ£åŠ¿ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>æ— æ³•ä½¿ç”¨è¦†ç›–ç´¢å¼•</p>
</li>
<li class="lvl-2">
<p>ç”±äºé•¿åº¦å®šä¹‰çš„ä¸å¥½(å‰ç¼€ç´¢å¼•è¦é€‰æ‹©åˆé€‚çš„é•¿åº¦)ï¼Œå¯¼è‡´ç´¢å¼•çš„åŸºæ•°å˜å°ï¼Œæœ€ç»ˆå¯¼è‡´å›è¡¨æ‰«æå˜å¤šã€‚å¦‚ä½•é€‰æ‹©å‰ç¼€ç´¢å¼•çš„é•¿åº¦ï¼š</p>
</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email, <span class="number">4</span>)) <span class="keyword">as</span> L4</span><br><span class="line">     , <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email, <span class="number">5</span>)) <span class="keyword">as</span> L5</span><br><span class="line">     , <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email, <span class="number">6</span>)) <span class="keyword">as</span> L6</span><br><span class="line">     , <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email, <span class="number">7</span>)) <span class="keyword">as</span> L7</span><br><span class="line"><span class="keyword">from</span> SUser;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="11-2-å€’åºå­˜å‚¨-hash-å­—æ®µ">11.2-å€’åºå­˜å‚¨ &amp; hash å­—æ®µ</h2>
<p>2ç§æ–¹å¼å¦ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢</p>
<h1>12-ä¸ºä»€ä¹ˆæˆ‘çš„MySQLä¼šâ€œæŠ–â€ä¸€ä¸‹ï¼Ÿ</h1>
<p>ä¸€æ¡ SQL è¯­å¥ï¼Œæ­£å¸¸æ‰§è¡Œçš„æ—¶å€™ç‰¹åˆ«å¿«ï¼Œä½†æ˜¯æœ‰æ—¶ä¹Ÿä¸çŸ¥é“æ€ä¹ˆå›äº‹ï¼Œå®ƒå°±ä¼šå˜å¾—ç‰¹åˆ«æ…¢ï¼Œå¹¶ä¸”è¿™æ ·çš„åœºæ™¯å¾ˆéš¾å¤ç°ï¼Œå®ƒä¸åªéšæœºï¼Œè€Œä¸”æŒç»­æ—¶é—´è¿˜å¾ˆçŸ­ã€‚è¡¨ç°å‡ºæ¥ï¼Œå°±å¥½åƒMySQLæŠ–äº†ä¸€ä¸‹</p>
<h2 id="12-1-SQLä¸ºä»€ä¹ˆå˜æ…¢ï¼Ÿ">12.1-SQLä¸ºä»€ä¹ˆå˜æ…¢ï¼Ÿ</h2>
<p><strong>è„é¡µ</strong> ï¼š å½“å†…å­˜æ•°æ®é¡µè·Ÿç£ç›˜æ•°æ®é¡µå†…å®¹ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªå†…å­˜é¡µä¸ºâ€œè„é¡µâ€œ</p>
<p><strong>å¹²å‡€é¡µ</strong>ï¼šå†…å­˜æ•°æ®å†™å…¥åˆ°ç£ç›˜åï¼Œå†…å­˜å’Œç£ç›˜ä¸Šçš„æ•°æ®é¡µçš„å†…å®¹å°±ä¸€è‡´äº†ï¼Œç§°ä¸ºâ€œå¹²å‡€é¡µâ€</p>
<p><strong>flush</strong> : å°†å†…å­˜æ•°æ®åˆ·å†™åˆ°ç£ç›˜ä¸Šä½¿å¾—ï¼Œå†…å­˜æ•°æ®å’Œç£ç›˜çš„æ•°æ®ä¸€è‡´</p>
<p>ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘æ•°æ®åº“çš„ Flashï¼Ÿ</p>
<p>1ï¸âƒ£ redo log å†™æ»¡ï¼Œéœ€è¦æ¨è¿› checkpointæ—¶</p>
<p>2ï¸âƒ£ å†…å­˜ä¸è¶³ï¼Œéœ€è¦æ·˜æ±°è„é¡µæ—¶</p>
<p>3ï¸âƒ£ MySQLç©ºé—²æ—¶ï¼Œåˆ·è„é¡µ</p>
<p>4ï¸âƒ£ MySQLæ­£å¸¸å…³é—­çš„æ—¶å€™ï¼Œåˆ·å†™è„é¡µ</p>
<p>å…¶ä¸­æƒ…å†µ1å‡ºç°çš„æ—¶å€™ï¼ŒMySQLä¼šé˜»å¡æ‰€æœ‰æ›´æ–°ï¼Œä»ç›‘æ§ä¸Šçœ‹ï¼Œæ›´æ–°æ•°å˜ä¸º0 ï¼›æƒ…å†µ2å‡ºç°çš„æ—¶å€™ï¼ŒMySQLä½¿ç”¨buffer poolæ¥ç®¡ç†å†…å­˜ï¼Œbuffer pool ä¸­çš„å†…å­˜é¡µå­˜åœ¨ä¸‰ç§çŠ¶æ€ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>è¿˜æ²¡æœ‰ä½¿ç”¨çš„</p>
</li>
<li class="lvl-2">
<p>ä½¿ç”¨äº†è€Œä¸”æ˜¯å¹²å‡€é¡µ</p>
</li>
<li class="lvl-2">
<p>ä½¿ç”¨äº†è€Œä¸”æ˜¯è„é¡µ</p>
</li>
</ul>
<p>å½“è¯»å…¥çš„æ•°æ®é¡µæ²¡æœ‰åœ¨å†…å­˜ä¸­æ—¶ï¼Œå¿…é¡»ä» buffer poolä¸­ç”³è¯·æ–°é¡µï¼Œæ·˜æ±°åˆ™ä¼šæ·˜æ±°æœ€ä¹…ä¸ä½¿ç”¨çš„æ•°æ®é¡µï¼Œå¦‚æœæ˜¯å¹²å‡€é¡µç›´æ¥é‡Šæ”¾å‡ºæ¥ä½¿ç”¨ï¼Œå¦‚æœæ˜¯è„é¡µï¼Œå¿…é¡»å°†è„é¡µåˆ·å†™åˆ°ç£ç›˜å˜æˆå¹²å‡€é¡µæ‰èƒ½ä½¿ç”¨ï¼ŒMySQLåˆ·è„é¡µæ˜¯ä¸€ä¸ªå¸¸æ€ï¼Œä½†æ˜¯ä¸€ä¸ªæŸ¥è¯¢è¦æ·˜æ±°çš„è„é¡µä¸ªæ•°å¤ªå¤šæ—¶ï¼Œä¼šå¯¼è‡´æŸ¥è¯¢æ—¶é—´åŠ é•¿ã€‚ä»è€Œå¯¼è‡´MySQLæŠ–åŠ¨äº†ä¸€ä¸‹</p>
<h2 id="12-2-InnoDBåˆ·è„é¡µçš„æ§åˆ¶ç­–ç•¥">12.2-<code>InnoDB</code>åˆ·è„é¡µçš„æ§åˆ¶ç­–ç•¥</h2>
<p>InnoDBä½¿ç”¨<code>innodb_io_capacity</code><sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup>ï¼Œå‘ŠçŸ¥InnoDBæ‰€åœ¨çš„ä¸»æœºçš„IOèƒ½åŠ›ï¼Œè¿™æ ·InnoDBæ‰èƒ½æœ€å¤§å‘æŒ¥ç£ç›˜IOPSçš„èƒ½åŠ›ã€‚å½“å‰çš„è¿™ä¸ªå‚æ•°æ˜¯æœ€å¤§çš„å†™ç£ç›˜çš„èƒ½åŠ›ï¼Œè¿˜éœ€è¦$innodb_io_capacity \times R %$ <sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup>InnoDBçš„åˆ·ç›˜é€Ÿåº¦å®é™…å‚è€ƒ2ä¸ªå› ç´ ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>è„é¡µæ¯”ä¾‹</p>
</li>
<li class="lvl-2">
<p>redo log å†™ç›˜é€Ÿåº¦</p>
</li>
</ul>
<h1>13-ä¸ºä»€ä¹ˆè¡¨æ•°æ®åˆ æ‰ä¸€åŠï¼Œè¡¨æ–‡ä»¶å¤§å°ä¸å˜ï¼Ÿ</h1>
<p>MySQLåœ¨è¿›è¡Œæ•°æ®åˆ é™¤çš„æ—¶å€™ï¼Œä¼šå°†æ•°æ®é¡µæ ‡è®°ä¸ºå¯å¤ç”¨ï¼Œå®é™…ä¸Šå¹¶ä¸ä¼šè¿›è¡Œåˆ é™¤ï¼Œä¼šå½¢æˆç©ºæ´ï¼›å¦‚æœä¸»é”®ä¸æ˜¯ä¾æ¬¡é€’å¢çš„ï¼Œæ’å…¥æ•°æ®ä¼šå¯¼è‡´é¡µåˆ†è£‚ï¼Œä¼šå¯¼è‡´é¡µç©ºæ´ï¼Œæ›´æ–°æ•°æ®å¯ä»¥è®¤ä¸ºæ˜¯å…ˆåˆ é™¤åœ¨æ’å…¥ï¼Œä¹Ÿä¼šå¯¼è‡´é¡µåˆ†è£‚ã€‚å¦‚æœæŠŠè¿™äº›ç©ºæ´å»æ‰ï¼Œå°±å¯ä»¥è¾¾åˆ°æ”¶ç¼©è¡¨ç©ºé—´çš„ç›®çš„ã€‚è€Œé‡å»ºè¡¨ï¼Œå°±å¯ä»¥è¾¾åˆ°è¿™æ ·çš„ç›®çš„</p>
<p>å·¦å›¾ï¼šMySQL5.5 | å³å›¾ï¼š MySQL5.6</p>
<p align="center">
  <img src="/2023/09/30/mysql/19.jpg" width="100%" alt="Your image description">
</p>
<h1>14-count(*)è¿™ä¹ˆæ…¢ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ</h1>
<p>æ™®é€šç´¢å¼•æ ‘æ¯”ä¸»é”®ç´¢å¼•æ ‘å°å¾ˆå¤š<sup class="footnote-ref"><a href="#fn9" id="fnref9">[9]</a></sup>ï¼Œå¯¹äºcount(*) è¿™æ ·çš„æ“ä½œï¼Œéå†å“ªä¸ªç´¢å¼•æ ‘å¾—åˆ°çš„ç»“æœé€»è¾‘ä¸Šæ˜¯ä¸€è‡´çš„ï¼ŒMySQLä¼˜åŒ–å™¨ä¼šæ‰¾åˆ°æœ€å°çš„é‚£æ£µæ ‘æ¥éå†ï¼Œ<strong>åœ¨ä¿è¯é€»è¾‘æ­£ç¡®çš„å‰æä¸‹ï¼Œå°½é‡å‡å°‘æ‰«æçš„æ•°æ®é‡ï¼Œæ˜¯æ•°æ®åº“ç³»ç»Ÿæ¶‰åŠçš„é€šç”¨æ³•åˆ™ä¹‹ä¸€</strong></p>
<p>InnoDB è¡¨ç›´æ¥<code> count(*)</code> ä¼šéå†å…¨è¡¨ï¼Œè™½ç„¶ç»“æœå‡†ç¡®ï¼Œä½†ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜(å…¨è¡¨æ‰«æä¼šå¯¼è‡´æ‰€å¯¼è‡´çš„æ€§èƒ½é—®é¢˜)ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨å¤–éƒ¨å­˜å‚¨çš„æ–¹å¼æ¥å­˜å‚¨<code>count(*)</code>,æ¯”å¦‚redisã€‚ä¸èƒ½å¤Ÿä¿è¯è®¡æ•°å’Œ MySQL è¡¨é‡Œçš„æ•°æ®ç²¾ç¡®ä¸€è‡´çš„åŸå› ï¼Œæ˜¯è¿™ä¸¤ä¸ªä¸åŒçš„å­˜å‚¨æ„æˆçš„ç³»ç»Ÿï¼Œä¸æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæ— æ³•æ‹¿åˆ°ç²¾ç¡®ä¸€è‡´çš„è§†å›¾</p>
<h2 id="14-1-count-çš„ç”¨æ³•">14.1-count(?) çš„ç”¨æ³•</h2>
<p>è‡³äºåˆ†ææ€§èƒ½å·®åˆ«çš„æ—¶å€™ï¼Œä½ å¯ä»¥è®°ä½è¿™ä¹ˆå‡ ä¸ªåŸåˆ™ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>server å±‚è¦ä»€ä¹ˆå°±ç»™ä»€ä¹ˆï¼›</p>
</li>
<li class="lvl-2">
<p>InnoDB åªç»™å¿…è¦çš„å€¼ï¼›</p>
</li>
<li class="lvl-2">
<p>ç°åœ¨çš„ä¼˜åŒ–å™¨åªä¼˜åŒ–äº† count(*) çš„è¯­ä¹‰ä¸ºâ€œå–è¡Œæ•°â€ï¼Œå…¶ä»–â€œæ˜¾è€Œæ˜“è§â€çš„ä¼˜åŒ–å¹¶æ²¡æœ‰åš</p>
</li>
</ul>
<p>1ï¸âƒ£ å¯¹äº count(ä¸»é”® id) æ¥è¯´ï¼ŒInnoDB å¼•æ“ä¼šéå†æ•´å¼ è¡¨ï¼ŒæŠŠæ¯ä¸€è¡Œçš„ id å€¼éƒ½å–å‡ºæ¥ï¼Œè¿”å›ç»™ server å±‚ã€‚server å±‚æ‹¿åˆ° id åï¼Œåˆ¤æ–­æ˜¯ä¸å¯èƒ½ä¸ºç©ºçš„ï¼Œå°±æŒ‰è¡Œç´¯åŠ </p>
<p>2ï¸âƒ£ å¯¹äº count(1) æ¥è¯´ï¼ŒInnoDB å¼•æ“éå†æ•´å¼ è¡¨ï¼Œä½†ä¸å–å€¼ã€‚server å±‚å¯¹äºè¿”å›çš„æ¯ä¸€è¡Œï¼Œæ”¾ä¸€ä¸ªæ•°å­—â€œ1â€è¿›å»ï¼Œåˆ¤æ–­æ˜¯ä¸å¯èƒ½ä¸ºç©ºçš„ï¼ŒæŒ‰è¡Œç´¯åŠ </p>
<p>3ï¸âƒ£ å¯¹äº count(å­—æ®µ) æ¥è¯´ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å¦‚æœè¿™ä¸ªâ€œå­—æ®µâ€æ˜¯å®šä¹‰ä¸º not null çš„è¯ï¼Œä¸€è¡Œè¡Œåœ°ä»è®°å½•é‡Œé¢è¯»å‡ºè¿™ä¸ªå­—æ®µï¼Œåˆ¤æ–­ä¸èƒ½ä¸º nullï¼ŒæŒ‰è¡Œç´¯åŠ ï¼›</p>
</li>
<li class="lvl-2">
<p>å¦‚æœè¿™ä¸ªâ€œå­—æ®µâ€å®šä¹‰å…è®¸ä¸º nullï¼Œé‚£ä¹ˆæ‰§è¡Œçš„æ—¶å€™ï¼Œåˆ¤æ–­åˆ°æœ‰å¯èƒ½æ˜¯ nullï¼Œè¿˜è¦æŠŠå€¼å–å‡ºæ¥å†åˆ¤æ–­ä¸€ä¸‹ï¼Œä¸æ˜¯ null æ‰ç´¯åŠ </p>
</li>
</ul>
<p>4ï¸âƒ£ <code>count(*)</code> æ˜¯ä¾‹å¤–ï¼Œå¹¶ä¸ä¼šæŠŠå…¨éƒ¨å­—æ®µå–å‡ºæ¥ï¼Œè€Œæ˜¯ä¸“é—¨åšäº†ä¼˜åŒ–ï¼Œä¸å–å€¼ã€‚count(*) è‚¯å®šä¸æ˜¯ nullï¼ŒæŒ‰è¡Œç´¯åŠ </p>
<p>æŒ‰ç…§æ•ˆç‡æ’åºçš„è¯ï¼Œ<code>count(å­—æ®µ)</code>&lt;<code>count(ä¸»é”® id)</code>&lt;<code>count(1)</code>â‰ˆ<code>count(*)</code>ï¼Œæ‰€ä»¥æˆ‘å»ºè®®ä½ ï¼Œå°½é‡ä½¿ç”¨ <code>count(*)</code></p>
<h1>15-ç­”ç–‘æ–‡ç« ï¼ˆä¸€ï¼‰ï¼šæ—¥å¿—å’Œç´¢å¼•ç›¸å…³é—®é¢˜</h1>
<p>redo log buffer å°±æ˜¯ä¸€å—å†…å­˜ï¼Œç”¨æ¥å…ˆå­˜ redo æ—¥å¿—çš„ã€‚å¯ä»¥è®¤ä¸ºWALå’Œredo log æ˜¯ä¸€ä¸ªä¸œè¥¿</p>
<h1>16-<code>order by </code>æ˜¯æ€ä¹ˆå·¥ä½œçš„?</h1>
<p>å¯¹äºä¸‹é¢çš„æŸ¥è¯¢ï¼ŒMySQLæ˜¯å¦‚ä½•æ‰§è¡Œçš„å‘¢ï¼Ÿ</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> city</span><br><span class="line">            ,name</span><br><span class="line">            ,age </span><br><span class="line"><span class="keyword">from</span> t </span><br><span class="line"><span class="keyword">where</span> city<span class="operator">=</span><span class="string">'æ­å·'</span> </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> name limit <span class="number">1000</span>  ; <span class="comment">-- idæ˜¯ä¸»é”®ï¼Œ cityä¸Šæœ‰ç´¢å¼•</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="16-1-å…¨å­—æ®µæ’åº">16.1-å…¨å­—æ®µæ’åº</h2>
<p align="center">
  <img src="/2023/09/30/mysql/20.jpg" width="100%" alt="Your image description">
</p>
<p>1ï¸âƒ£ åˆå§‹åŒ– sort buffer<sup class="footnote-ref"><a href="#fn10" id="fnref10">[10]</a></sup>, ç¡®å®šæ”¾å…¥ <code>name,city,age</code> 3ä¸ªå­—æ®µ</p>
<p>2ï¸âƒ£ æ ¹æ® <code>city</code> çš„ç´¢å¼•æ ‘ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³ <code>city = 'æ­å·'</code> çš„ä¸»é”®id</p>
<p>3ï¸âƒ£ å›è¡¨å–å‡ºæ•´è¡Œï¼Œå–<code>name,city , age</code> 3ä¸ªå­—æ®µçš„å€¼ï¼Œå­˜å…¥ sort buffer</p>
<p>4ï¸âƒ£ ä»ç´¢å¼•city å–ä¸‹ä¸€ä¸ªè®°å½•çš„ä¸»é”®id</p>
<p>5ï¸âƒ£ é‡å¤3,4 ç›´åˆ°ä¸æ»¡è¶³æŸ¥è¯¢æ¡ä»¶ä¸ºæ­¢</p>
<p>6ï¸âƒ£ å¯¹ sort buffer ä¸­çš„æ•°æ®æŒ‰ç…§name åš å¿«æ’ã€‚ <code>sort_buffer_size</code>ï¼ˆå½“å‰å‚æ•°çš„å¤§å°å†³å®šæ’åºæ˜¯åŸºäºå†…å­˜çš„å¿«æ’ï¼Œè¿˜æ˜¯å¼€è¾Ÿç£ç›˜ç©ºé—´ï¼Œä½¿ç”¨å½’å¹¶æ’åºï¼‰</p>
<p>7ï¸âƒ£ å–å‰1000è¡Œè¿”å›ç»™å®¢æˆ·ç«¯</p>
<h2 id="16-2-row-id-æ’åº">16.2-row_id æ’åº</h2>
<p align="center">
  <img src="/2023/09/30/mysql/21.jpg" width="100%" alt="Your image description">
</p>
<p>1ï¸âƒ£ åˆå§‹åŒ– sort_buffer<sup class="footnote-ref"><a href="#fn10" id="fnref10:1">[10:1]</a></sup>ï¼Œç¡®å®šæ”¾å…¥ä¸¤ä¸ªå­—æ®µï¼Œå³ name å’Œ id</p>
<p>2ï¸âƒ£ ä»ç´¢å¼• city æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³ <code>city='æ­å·â€™</code> æ¡ä»¶çš„ä¸»é”® idï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„ ID_Xï¼ˆcityç´¢å¼•æ•°çš„å›¾ï¼‰</p>
<p>3ï¸âƒ£ åˆ°ä¸»é”® id ç´¢å¼•å–å‡ºæ•´è¡Œï¼Œå– nameã€id è¿™ä¸¤ä¸ªå­—æ®µï¼Œå­˜å…¥ sort_buffer ä¸­</p>
<p>4ï¸âƒ£ ä»ç´¢å¼• city å–ä¸‹ä¸€ä¸ªè®°å½•çš„ä¸»é”® id</p>
<p>5ï¸âƒ£ é‡å¤æ­¥éª¤ 3ã€4 ç›´åˆ°ä¸æ»¡è¶³ city='æ­å·â€™æ¡ä»¶ä¸ºæ­¢ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„ ID_Yï¼ˆcityç´¢å¼•æ•°çš„å›¾ï¼‰</p>
<p>6ï¸âƒ£ å¯¹ sort_buffer ä¸­çš„æ•°æ®æŒ‰ç…§å­—æ®µ name è¿›è¡Œæ’åº , <code>max_length_for_sort_data</code>ï¼ˆè®¾ç½®è¯¥å‚æ•°ï¼Œå¯¹äºå¤ªé•¿çš„å­—æ®µï¼Œå¯ä»¥å®ç°åªæ˜¯å–æ’åºå­—æ®µ  å’Œä¸»é”® æ’åºï¼Œselectçš„å­—æ®µé€šè¿‡å›è¡¨çš„æ–¹å¼è·å–ï¼‰</p>
<p>7ï¸âƒ£ éå†æ’åºç»“æœï¼Œå–å‰ 1000 è¡Œï¼Œå¹¶æŒ‰ç…§ id çš„å€¼å›åˆ°åŸè¡¨ä¸­å–å‡º cityã€name å’Œ age ä¸‰ä¸ªå­—æ®µè¿”å›ç»™å®¢æˆ·ç«¯</p>
<h2 id="16-3-è”åˆç´¢å¼•">16.3-è”åˆç´¢å¼•</h2>
<p>æ‰§è¡Œå¦‚ä¸‹è¯­å¥ï¼š<code>alter table t add index city_user(city, name);</code></p>
<p align="center">
  <img src="/2023/09/30/mysql/22.jpg" width="100%" alt="Your image description">
</p>
<p>1ï¸âƒ£ ä»ç´¢å¼• (city,name) æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³ city='æ­å·â€™æ¡ä»¶çš„ä¸»é”® id</p>
<p>2ï¸âƒ£ åˆ°ä¸»é”® id ç´¢å¼•å–å‡ºæ•´è¡Œï¼Œå– nameã€cityã€age ä¸‰ä¸ªå­—æ®µçš„å€¼ï¼Œä½œä¸ºç»“æœé›†çš„ä¸€éƒ¨åˆ†ç›´æ¥è¿”å›</p>
<p>3ï¸âƒ£ ä»ç´¢å¼• (city,name) å–ä¸‹ä¸€ä¸ªè®°å½•ä¸»é”® id</p>
<p>4ï¸âƒ£ é‡å¤æ­¥éª¤ 2ã€3ï¼Œç›´åˆ°æŸ¥åˆ°ç¬¬ 1000 æ¡è®°å½•ï¼Œæˆ–è€…æ˜¯ä¸æ»¡è¶³ city='æ­å·â€™æ¡ä»¶æ—¶å¾ªç¯ç»“æŸ</p>
<p>å½“ç„¶æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥åœ¨ <code>city name age</code> 3ä¸ªå­—æ®µä¸Šå»ºç«‹ç´¢å¼•ï¼Œç„¶åå½“å‰çš„æŸ¥è¯¢å°±ä¼šç´¢å¼•è¦†ç›–ï¼Œæ›´å¿«</p>
<h1>17-å¦‚ä½•æ­£ç¡®çš„æ˜¾ç¤ºéšæœºæ¶ˆæ¯</h1>
<p>å¯¹äºéœ€æ±‚ï¼šä»å•è¯è¡¨ä¸­éšæœºé€‰å‡º3ä¸ªå•è¯ï¼Œ<code>select word from words order by rand() limit 3;</code> æµ‹è¯•æ’å…¥10Wæ¡è®°å½•ï¼Œæœ¬ç« ä½¿ç”¨äº†</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å†…å­˜ä¸´æ—¶è¡¨ -&gt; æŒ‰ç…§row id çš„æ–¹å¼è¿›è¡Œæ’åº</p>
</li>
<li class="lvl-2">
<p>ç£ç›˜ä¸´æ—¶è¡¨ -&gt; ä¼˜å…ˆé˜Ÿåˆ—æ’åºç®—æ³•ï¼Œç”Ÿæˆä¸€ä¸ªå¤§æ ¹å †ï¼Œå®Œæˆæ’åº</p>
</li>
</ul>
<p>ç„¶åä»‹ç»äº†ä¸€ç§<em>éšæœº1æ’åº</em>çš„æ–¹æ³•ï¼š</p>
<p>1ï¸âƒ£ å–å¾—è¿™ä¸ªè¡¨çš„ä¸»é”® id çš„æœ€å¤§å€¼ M å’Œæœ€å°å€¼ N</p>
<p>2ï¸âƒ£ ç”¨éšæœºå‡½æ•°ç”Ÿæˆä¸€ä¸ªæœ€å¤§å€¼åˆ°æœ€å°å€¼ä¹‹é—´çš„æ•° $X = (M-N)\times rand() + N$</p>
<p>3ï¸âƒ£ å–ä¸å°äº X çš„ç¬¬ä¸€ä¸ª ID çš„è¡Œ</p>
<p>æœ€ååˆä»‹ç»äº†ä¸€ç§<em>éšæœº2æ’åº</em>æ–¹æ³•ï¼š</p>
<p>1ï¸âƒ£ å–å¾—æ•´ä¸ªè¡¨çš„è¡Œæ•°ï¼Œå¹¶è®°ä¸º C</p>
<p>2ï¸âƒ£ å–å¾— $Y = floor(C * rand())$ã€‚ floor å‡½æ•°åœ¨è¿™é‡Œçš„ä½œç”¨ï¼Œå°±æ˜¯å–æ•´æ•°éƒ¨åˆ†</p>
<p>3ï¸âƒ£ å†ç”¨ limit Y,1 å–å¾—ä¸€è¡Œ</p>
<h1>18-ä¸ºä»€ä¹ˆæˆ‘çš„è¿™äº›SQLè¯­å¥é€»è¾‘ç›¸åŒï¼Œæ€§èƒ½ç¡®å·®å¼‚å·¨å¤§ï¼Ÿ</h1>
<h2 id="18-1-æ¡ä»¶å­—æ®µå‡½æ•°æ“ä½œ">18.1-æ¡ä»¶å­—æ®µå‡½æ•°æ“ä½œ</h2>
<p>å¯¹ç´¢å¼•å­—æ®µåšå‡½æ•°æ“ä½œï¼Œå¯èƒ½ä¼šç ´åç´¢å¼•å€¼çš„æœ‰åºæ€§ï¼Œå› æ­¤ä¼˜åŒ–å™¨å°±å†³å®šæ”¾å¼ƒèµ°æ ‘æœç´¢åŠŸèƒ½ã€‚æ¯”å¦‚ï¼Œä½ åœ¨ <code>t_modified</code> ã€<code>id</code>ä¸Šå»ºç«‹ç´¢å¼•ï¼Œå´äº§ç”Ÿäº†ä¸‹é¢çš„SQLå†™æ³•ï¼š<code>where month(t_modified)  = 7</code> æˆ–è€… <code>where id - 1 = 100</code> ã€‚</p>
<h2 id="18-2-éšå¼ç±»å‹è½¬æ¢">18.2-éšå¼ç±»å‹è½¬æ¢</h2>
<p>é¦–å…ˆï¼Œ<strong>åœ¨MySQLã€PostgreSQLã€ Hive ä¸­ï¼Œå­—ç¬¦ä¸²ç±»å‹å’Œæ•°å­—ç±»å‹æ¯”è¾ƒçš„æ—¶å€™ï¼Œéƒ½æ˜¯å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—æ¯”è¾ƒ</strong>ï¼ŒéªŒè¯æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'10'</span> <span class="operator">&gt;</span> <span class="number">9</span>;</span><br><span class="line"><span class="comment">-- å¦‚æœæ˜¯å­—ç¬¦ç±»å‹è½¬ä¸ºæ•°å­—ç±»å‹ï¼Œè¿”å›ç»“æœåº”è¯¥ä¸º1æˆ–è€…æ˜¯true</span></span><br><span class="line"><span class="comment">-- å¦‚æœæ˜¯æ•°å­—ç±»å‹è½¬ä¸ºå­—ç¬¦ç±»å‹ï¼Œè¿”å›çš„ç»“æœåº”è¯¥æ˜¯0æˆ–è€…æ˜¯false</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ‰€ä»¥å¯¹äºè¡¨ tradelogï¼ˆtradeid ç±»å‹ä¸ºå­—ç¬¦ç±»å‹ï¼‰ï¼Œæ‰§è¡Œå¦‚ä¸‹æŸ¥è¯¢å°†æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tradelog <span class="keyword">where</span> tradeid<span class="operator">=</span><span class="number">110717</span>; </span><br><span class="line"><span class="comment">-- å› ä¸ºå®é™…çš„SQLæ˜¯ï¼š</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tradelog <span class="keyword">where</span>  <span class="built_in">CAST</span>(tradid <span class="keyword">AS</span> signed <span class="type">int</span>) <span class="operator">=</span> <span class="number">110717</span>;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="18-3-éšå¼å­—ç¬¦ç¼–ç è½¬æ¢">18.3-éšå¼å­—ç¬¦ç¼–ç è½¬æ¢</h2>
<p>è¡¨trade_detail å­—ç¬¦é›†ä½¿ç”¨utf8; tradelog è¡¨ä½¿ç”¨ utf8mb4<sup class="footnote-ref"><a href="#fn11" id="fnref11">[11]</a></sup>å­—ç¬¦é›†ï¼Œ2ä¸ªè¡¨åœ¨åšå…³è”Joinçš„æ—¶å€™</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> d.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tradelog l <span class="comment">-- utf8mb4</span></span><br><span class="line">   , trade_detail d <span class="comment">-- utf8</span></span><br><span class="line"><span class="keyword">where</span> d.tradeid <span class="operator">=</span> l.tradeid <span class="comment">-- lè¡¨çš„tradeid æœ‰ç´¢å¼•</span></span><br><span class="line">  <span class="keyword">and</span> l.id <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></tbody></table></figure>
<p align="center">
  <img src="/2023/09/30/mysql/23.jpg" width="100%" alt="Your image description">
</p>
<h1>19-ä¸ºä»€ä¹ˆæˆ‘åªæŸ¥ä¸€è¡Œçš„è¯­å¥ï¼Œä¹Ÿæ‰§è¡Œè¿™ä¹ˆæ…¢ï¼Ÿ</h1>
<p>å¦‚æœMySQLæ•°æ®åº“æœ¬èº«å°±æœ‰å¾ˆå¤§çš„å‹åŠ›ï¼Œå¯¼è‡´æ•°æ®åº“çš„CPUåˆ©ç”¨ç‡å¾ˆé«˜æˆ–è€…æ˜¯ ioutil(IO åˆ©ç”¨ç‡) å¾ˆé«˜ï¼Œè¿™ç§æƒ…å†µä¸‹æ‰€æœ‰çš„è¯­å¥æ‰§è¡Œéƒ½å¯èƒ½å˜æ…¢ã€‚é™¤äº†è¿™ä¸ªåŸå› ä¹‹å¤–ï¼Œè¿˜æœ‰å¦å¤–2ç§æƒ…å†µï¼š</p>
<h2 id="19-1-æŸ¥è¯¢é•¿æ—¶é—´ä¸è¿”å›">19.1-æŸ¥è¯¢é•¿æ—¶é—´ä¸è¿”å›</h2>
<p>è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰2ç§åŸå› å¯¼è‡´ï¼Œé‡åˆ°è¿™ç§æƒ…å†µï¼Œè¯¦ç»†åˆ†æå¯ä»¥å‚è€ƒ <a href="https://time.geekbang.org/column/article/74687">é“¾æ¥</a></p>
<p>1ï¸âƒ£  ç­‰ DMLé”ï¼Œé€šè¿‡ <code>sys.schema_table_lock_waits</code><sup class="footnote-ref"><a href="#fn12" id="fnref12">[12]</a></sup>è¡¨å¯ä»¥å®šä½åˆ°å“ªä¸ª process id é€ æˆäº†é˜»å¡</p>
<p>2ï¸âƒ£  ç­‰flushï¼Œ flush table æ˜¯å¾ˆå¿«çš„ï¼Œå‡ºç° waiting for table flush çŠ¶æ€çš„æƒ…å†µå¯èƒ½æ˜¯,æœ‰ä¸€ä¸ªflush tables  å‘½ä»¤è¢«åˆ«çš„è¯­å¥é˜»å¡äº†ï¼Œç„¶åflush table åˆé˜»å¡äº†æˆ‘ä»¬çš„select è¯­å¥ã€‚</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">flush tables t <span class="keyword">with</span> read lock;  <span class="comment">-- åªå…³é—­è¡¨t</span></span><br><span class="line">flush tables <span class="keyword">with</span> read lock;     <span class="comment">-- å…³é—­ MySQLé‡Œæ‰€æœ‰æ‰“å¼€çš„è¡¨</span></span><br></pre></td></tr></tbody></table></figure>
<p align="center">
  <img src="/2023/09/30/mysql/24.jpg" width="100%" alt="Your image description">
</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'%long_query_time%'</span>; <span class="comment">-- æŸ¥çœ‹æ…¢æŸ¥è¯¢é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">set</span> long_query_time <span class="operator">=</span> <span class="number">1</span>; <span class="comment">-- è®¾ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> mysql.slow_log; <span class="comment">-- è®°å½•æ…¢æŸ¥è¯¢å¯ä»¥è®°å½•åˆ°è¡¨ä¸­ï¼Œä¹Ÿå¯ä»¥è®°å½•åˆ°æ–‡ä»¶ä¸­ï¼Œå¦‚æœè®°å½•åˆ°è¡¨ä¸­ï¼Œå¯ä»¥æŒ‰ç…§å½“å‰çš„æ–¹å¼æŸ¥è¯¢</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="19-2-æŸ¥è¯¢æ…¢">19.2-æŸ¥è¯¢æ…¢</h2>
<p>1ï¸âƒ£ å…¨è¡¨æ‰«æï¼Œ ä»SQLä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬åº”è¯¥é¿å…å…¨è¡¨æ‰«æ</p>
<p>2ï¸âƒ£ æ—¶é—´æ¶ˆè€—åœ¨unlogå›æ»šä¸Š ï¼š</p>
<p>å¯¹äº<code>select * from t where id = 1; -- 10wè®°å½•ï¼Œidæ˜¯ä¸»é”®ï¼Œä»æŸ¥è¯¢è¿”å›æ¥çœ‹è¿”å›ç»“æœå¾ˆæ…¢</code></p>
<p align="center">
  <img src="/2023/09/30/mysql/25.jpg" width="100%" alt="Your image description">
</p>
<p>å½“å‰è¯»å¯ä»¥å¾ˆå¿«çš„è¯»å–åˆ°æ•°æ®ï¼›è€Œä¸€è‡´æ€§è¯»éœ€è¦ç›¸å½“çš„å“åº”æ—¶é—´</p>
<h1>20-å¹»è¯»æ˜¯ä»€ä¹ˆï¼Œå¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h1>
<h2 id="20-1-å¹»è¯»æ˜¯ä»€ä¹ˆï¼Ÿ">20.1-å¹»è¯»æ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `t` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  `c` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">  `d` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  key `c` (`c`)</span><br><span class="line">) engine<span class="operator">=</span>innodb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),(<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>),</span><br><span class="line">(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>),(<span class="number">15</span>,<span class="number">15</span>,<span class="number">15</span>),(<span class="number">20</span>,<span class="number">20</span>,<span class="number">20</span>),(<span class="number">25</span>,<span class="number">25</span>,<span class="number">25</span>);</span><br></pre></td></tr></tbody></table></figure>
<p align="center">
  <img src="/2023/09/30/mysql/26.jpg" width="80%" alt="Your image description">
    <br>
  <span style="color:gray"> info about the picture </span>
</p>
<p>å¹»è¯»è¯´æ˜ï¼šå½“å‰è¯»+æ–°æ’å…¥çš„ æ•°æ®æ‰ä¼šå‡ºç°</p>
<p>1ï¸âƒ£ åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ™®é€šçš„æŸ¥è¯¢æ˜¯å¿«ç…§è¯»ï¼Œæ˜¯ä¸ä¼šçœ‹åˆ°åˆ«çš„äº‹åŠ¡æ’å…¥çš„æ•°æ®çš„ã€‚å› æ­¤ï¼Œ<strong>å¹»è¯»åœ¨â€œå½“å‰è¯»ï¼ˆè¯»åˆ°æ‰€æœ‰å·²æäº¤è®°å½•çš„æœ€æ–°å€¼ï¼‰â€ä¸‹æ‰ä¼šå‡ºç°</strong></p>
<p>2ï¸âƒ£ ä¸Šé¢ session B çš„ä¿®æ”¹ç»“æœï¼Œè¢« session A ä¹‹åçš„ select è¯­å¥ç”¨â€œå½“å‰è¯»â€çœ‹åˆ°ï¼Œä¸èƒ½ç§°ä¸ºå¹»è¯»ã€‚<strong>å¹»è¯»ä»…ä¸“æŒ‡â€œæ–°æ’å…¥çš„è¡Œâ€</strong></p>
<h2 id="20-2-å¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ">20.2-å¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h2>
<p>å¹»è¯»ä¼šå¯¼è‡´ï¼š</p>
<p>ğŸ…°ï¸ ç ´åè¯­ä¹‰ã€‚ å¦‚ä¸Šä¾‹ä¸­ T1è¯­ä¹‰å°±æ˜¯å¯¹æ‰€æœ‰<code>d=5</code>çš„è¡Œéƒ½åŠ ä¸Šé”ï¼ŒSessionBçš„ T2è¯­å¥æ›´æ–°<code>id=0</code>åï¼Œè¿˜å¯ä»¥ä¿®æ”¹<code>id=0</code>çš„å­—æ®µå€¼ï¼Œç ´åäº†SessionAä¸­ T1å®šä¹‰çš„å¯¹æ‰€æœ‰<code>d=5</code>çš„è¡ŒåŠ é”çš„é€»è¾‘</p>
<p>ğŸ…±ï¸ ç ´åæ•°æ®ä¸€è‡´æ€§<sup class="footnote-ref"><a href="#fn13" id="fnref13">[13]</a></sup></p>
<p align="center">
  <img src="/2023/09/30/mysql/45.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> info about the picture </span>
</p>
<p>å¦‚ä¸Šçš„åˆ†æï¼Œéƒ½æ˜¯å»ºç«‹åœ¨å‡è®¾ <code>select * from t where d=5 for update</code> è¿™æ¡è¯­å¥åªç»™ <code>d=5</code> è¿™ä¸€è¡Œï¼Œä¹Ÿå°±æ˜¯ <code>id=5</code> çš„è¿™ä¸€è¡ŒåŠ é”â€å¯¼è‡´çš„ï¼Œæˆ‘ä»¬å°è¯•æŠŠæ‰«æè¿‡ç¨‹ä¸­ç¢°åˆ°çš„è¡Œï¼Œä¹Ÿéƒ½åŠ ä¸Šå†™é”ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<p align="center">
  <img src="/2023/09/30/mysql/46.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> info about the picture </span>
</p>
<p>å¦‚ä¸Šï¼Œå³ä½¿æŠŠæ‰€æœ‰çš„è®°å½•éƒ½åŠ ä¸Šé”ï¼Œè¿˜æ˜¯é˜»æ­¢ä¸äº†æ–°æ’å…¥çš„è®°å½•ï¼Œåœ¨ T3 æ—¶åˆ»ï¼Œæˆ‘ä»¬ç»™æ‰€æœ‰è¡ŒåŠ é”çš„æ—¶å€™ï¼Œ<code>id=1</code> è¿™ä¸€è¡Œè¿˜ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨ä¹Ÿå°±åŠ ä¸ä¸Šé”</p>
<p>è¡Œé”åªèƒ½é”ä½è¡Œï¼Œä½†æ˜¯æ–°æ’å…¥è®°å½•çš„åŠ¨ä½œè¦æ›´æ–°çš„æ˜¯è®°å½•ä¹‹é—´çš„**â€œé—´éš™â€ **ï¼Œ ä¸ºäº†è§£å†³å¹»è¯»é—®é¢˜ï¼ŒMySQLå¼•å…¥äº† <strong>é—´éš™é”</strong>ï¼ˆGap lockï¼‰</p>
<h2 id="20-3-é—´éš™é”">20.3-é—´éš™é”</h2>
<p align="center">
  <img src="/2023/09/30/mysql/27.png" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> info about the picture </span>
  </p>
<p><strong>è·Ÿè¡Œé”æœ‰å†²çªå…³ç³»çš„æ˜¯â€œå¦å¤–ä¸€ä¸ªè¡Œé”â€</strong>ã€‚ä½†æ˜¯é—´éš™é”ä¸ä¸€æ ·ï¼Œ<strong>è·Ÿé—´éš™é”å­˜åœ¨å†²çªå…³ç³»çš„ï¼Œæ˜¯â€œå¾€è¿™ä¸ªé—´éš™ä¸­æ’å…¥ä¸€ä¸ªè®°å½•â€è¿™ä¸ªæ“ä½œ</strong>ã€‚é—´éš™é”ä¹‹é—´éƒ½ä¸å­˜åœ¨å†²çªå…³ç³»</p>
<p align="center">
  <img src="/2023/09/30/mysql/28.jpg" width="80%" alt="Your image description">
</p>
<p>å¦‚æœè¿™é‡Œ <code>begin ; select  * from where c = 5 lock in share mode;</code> æ­¤æ—¶ session Bæ˜¯ä¼šè¢«é˜»å¡çš„</p>
<p>é—´éš™é”å’Œè¡Œé”åˆç§° next-key lockï¼Œ<strong>æ¯ä¸ª next-key lock æ˜¯å‰å¼€åé—­åŒºé—´</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„è¡¨ t åˆå§‹åŒ–ä»¥åï¼Œå¦‚æœç”¨ <code>select * from t for update</code> è¦æŠŠæ•´ä¸ªè¡¨æ‰€æœ‰è®°å½•é”èµ·æ¥ï¼Œå°±å½¢æˆäº† 7 ä¸ª next-key lockï¼Œåˆ†åˆ«æ˜¯<br>
$$<br>
(-\infty,0]ã€(0,5]ã€(5,10]ã€(10,15]ã€(15,20]ã€(20,25],(25,+\infty)<br>
$$<br>
ä¸‹å›¾æ˜¯ä¸€ä¸ªé—´éš™é”å¯¼è‡´çš„æ­»é”ä¾‹å­ï¼š</p>
<p align="center">
  <img src="/2023/09/30/mysql/29.jpg" width="80%" alt="Your image description">
</p>
<ol>
<li class="lvl-3">
<p>session A æ‰§è¡Œ <code>select â€¦ for update</code> è¯­å¥ï¼Œç”±äº <code>id=9</code> è¿™ä¸€è¡Œå¹¶ä¸å­˜åœ¨ï¼Œå› æ­¤ä¼šåŠ ä¸Šé—´éš™é” (5,10)</p>
</li>
<li class="lvl-3">
<p>session B æ‰§è¡Œ <code>select â€¦ for update</code> è¯­å¥ï¼Œä¼šåŠ ä¸Šé—´éš™é” (5,10)ï¼Œé—´éš™é”ä¹‹é—´ä¸ä¼šå†²çªï¼Œè¯¥è¯­å¥æ‰§è¡ŒæˆåŠŸ</p>
</li>
<li class="lvl-3">
<p>session B è¯•å›¾æ’å…¥ä¸€è¡Œ (9,9,9)ï¼Œè¢« session A çš„é—´éš™é”æŒ¡ä½äº†ï¼Œåªå¥½è¿›å…¥ç­‰å¾…ï¼›session A è¯•å›¾æ’å…¥ä¸€è¡Œ (9,9,9)ï¼Œè¢« session B çš„é—´éš™é”æŒ¡ä½äº†</p>
</li>
</ol>
<p>å¯ä»¥å‘ç°é—´éš™é”çš„å¼•å…¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´åŒæ ·çš„è¯­å¥é”ä½æ›´å¤§çš„èŒƒå›´ï¼Œè§£å†³æ‰äº†å¹»è¯»ï¼Œä½†æ˜¯å½±å“äº†å¹¶å‘åº¦çš„ã€‚<strong>åªæœ‰åœ¨å¯é‡å¤è¯»çš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ‰ä¼šæœ‰é—´éš™é”ã€‚è¯»æäº¤çš„éš”ç¦»çº§åˆ«ä¸‹ä¸ä¼šæœ‰é—´éš™é”</strong>ã€‚è¦è§£å†³å¯èƒ½å‡ºç°çš„æ•°æ®å’Œæ—¥å¿—ä¸ä¸€è‡´é—®é¢˜ï¼Œéœ€è¦æŠŠ binlog æ ¼å¼è®¾ç½®ä¸º rowï¼Œè¿™ä¹Ÿæ˜¯ç°åœ¨ä¸å°‘å…¬å¸ä½¿ç”¨çš„é…ç½®ç»„åˆ</p>
<h1>21-ä¸ºä»€ä¹ˆæˆ‘åªæ”¹ä¸€è¡Œçš„è¯­å¥ï¼Œé”è¿™ä¹ˆå¤šï¼Ÿ</h1>
<p>éš”ç¦»çº§åˆ«ï¼š<mark>RR</mark>ï¼›é—´éš™é”å’Œ next-key lockï¼ˆè¡Œé”å’Œé—´éš™é”ç»Ÿä¸€ç§°ä¸º next-key lockï¼‰ çš„åŠ é”è§„åˆ™ï¼š</p>
<p>1ï¸âƒ£ åŸåˆ™ 1ï¼šåŠ é”çš„åŸºæœ¬å•ä½æ˜¯ next-key lockï¼Œnext-key lock æ˜¯å‰å¼€åé—­åŒºé—´</p>
<p>2ï¸âƒ£ åŸåˆ™ 2ï¼šæŸ¥æ‰¾è¿‡ç¨‹ä¸­è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”</p>
<p>3ï¸âƒ£ ä¼˜åŒ– 1ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œç»™å”¯ä¸€ç´¢å¼•åŠ é”çš„æ—¶å€™ï¼Œnext-key lock é€€åŒ–ä¸ºè¡Œé”</p>
<p>4ï¸âƒ£ä¼˜åŒ– 2ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œå‘å³éå†æ—¶ä¸”æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ç­‰å€¼æ¡ä»¶çš„æ—¶å€™ï¼Œnext-key lock é€€åŒ–ä¸ºé—´éš™é”</p>
<p>5ï¸âƒ£ä¸€ä¸ª bugï¼šå”¯ä¸€ç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢</p>
<p>å…·ä½“æ¡ˆä¾‹<a href="https://time.geekbang.org/column/article/75659">ç§»æ­¥</a></p>
<p>é”é€€åŒ–çš„é—®é¢˜ï¼Œ</p>
<h1>22-MySQLæœ‰å“ªäº›â€œé¥®é¸©æ­¢æ¸´â€æé«˜æ€§èƒ½çš„æ–¹æ³•ï¼Ÿ</h1>
<p>ğŸ’¡ ä¸‹é¢è¿™äº›ä¼˜åŒ–çš„æ–¹å¼éƒ½æ˜¯æœ‰æŸçš„</p>
<h2 id="22-1-çŸ­é“¾æ¥é£æš´">22.1-çŸ­é“¾æ¥é£æš´</h2>
<p>è¿æ¥è¿‡ç¨‹æ¶‰åŠTCP+é‰´æƒç­‰ä¼šå ç”¨CPUèµ„æº</p>
<p>1ï¸âƒ£ ç¬¬ä¸€ç§æ–¹æ³•ï¼šå…ˆå¤„ç†æ‰é‚£äº›å ç€è¿æ¥ä½†æ˜¯ä¸å·¥ä½œçš„çº¿ç¨‹ã€‚<code>kill connection + id </code>çš„å‘½ä»¤<sup class="footnote-ref"><a href="#fn14" id="fnref14">[14]</a></sup>ï¼Œ ä¸€ä¸ªå®¢æˆ·ç«¯å¤„äº sleep çŠ¶æ€æ—¶ï¼Œå®ƒçš„è¿æ¥è¢«æœåŠ¡ç«¯ä¸»åŠ¨æ–­å¼€åï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å¹¶ä¸ä¼šé©¬ä¸ŠçŸ¥é“</p>
<p>2ï¸âƒ£ ç¬¬äºŒç§æ–¹æ³•ï¼šå‡å°‘è¿æ¥è¿‡ç¨‹çš„æ¶ˆè€—ã€‚é‡å¯æ•°æ®åº“ï¼Œå¹¶ä½¿ç”¨â€“skip-grant-tables å‚æ•°å¯åŠ¨ã€‚é£é™©å¾ˆé«˜</p>
<h2 id="22-2-æ…¢æŸ¥è¯¢æ€§èƒ½é—®é¢˜">22.2-æ…¢æŸ¥è¯¢æ€§èƒ½é—®é¢˜</h2>
<p>å¼•å‘æ€§èƒ½çš„æƒ…å†µæœ‰ä¸‰ç§ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>ç´¢å¼•æ²¡æœ‰è®¾è®¡å¥½ï¼› å¯ä»¥Online DDL</p>
</li>
<li class="lvl-2">
<p>SQL è¯­å¥æ²¡å†™å¥½ï¼›å‚è§<a href="#18-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E7%9A%84%E8%BF%99%E4%BA%9BSQL%E8%AF%AD%E5%8F%A5%E9%80%BB%E8%BE%91%E7%9B%B8%E5%90%8C%EF%BC%8C%E6%80%A7%E8%83%BD%E7%A1%AE%E5%B7%AE%E5%BC%82%E5%B7%A8%E5%A4%A7%EF%BC%9F">ç« èŠ‚ 18</a> ä¸ºä»€ä¹ˆè¿™äº›SQLè¯­å¥é€»è¾‘ç›¸åŒï¼Œæ€§èƒ½å·®å¼‚ç¡®å·¨å¤§</p>
</li>
<li class="lvl-2">
<p>MySQL é€‰é”™äº†ç´¢å¼•ã€‚åº”æ€¥æ–¹æ¡ˆ force index</p>
</li>
</ul>
<p>å¦‚ä½•é¿å…æƒ…å†µ1å’Œæƒ…å†µ2ï¼Ÿ</p>
<p>1ï¸âƒ£ ä¸Šçº¿å‰ï¼Œåœ¨æµ‹è¯•ç¯å¢ƒï¼ŒæŠŠæ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆslow logï¼‰æ‰“å¼€ï¼Œå¹¶ä¸”æŠŠ long_query_time è®¾ç½®æˆ 0ï¼Œç¡®ä¿æ¯ä¸ªè¯­å¥éƒ½ä¼šè¢«è®°å½•å…¥æ…¢æŸ¥è¯¢æ—¥å¿—</p>
<p>2ï¸âƒ£ åœ¨æµ‹è¯•è¡¨é‡Œæ’å…¥æ¨¡æ‹Ÿçº¿ä¸Šçš„æ•°æ®ï¼Œåšä¸€éå›å½’æµ‹è¯•</p>
<p>3ï¸âƒ£ è§‚å¯Ÿæ…¢æŸ¥è¯¢æ—¥å¿—é‡Œæ¯ç±»è¯­å¥çš„è¾“å‡ºï¼Œç‰¹åˆ«ç•™æ„ Rows_examined å­—æ®µæ˜¯å¦ä¸é¢„æœŸä¸€è‡´</p>
<p>ä¸è¦åå•¬è¿™æ®µèŠ±åœ¨ä¸Šçº¿å‰çš„â€œé¢å¤–â€æ—¶é—´ï¼Œå› ä¸ºè¿™ä¼šå¸®ä½ çœä¸‹å¾ˆå¤šæ•…éšœæ’é™¤çš„æ—¶é—´</p>
<p><strong>æŸ¥è¯¢é‡å†™</strong>ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> query_rewrite.rewrite_rules(<span class="keyword">pattern</span>, replacement, pattern_database) <span class="keyword">values</span> ("select * from t where id + 1 = ?", "select * from t where id = ? - 1", "db1");</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> query_rewrite.flush_rewrite_rules();</span><br></pre></td></tr></tbody></table></figure>
<h2 id="22-3-QPS-çªå¢é—®é¢˜">22.3-QPS çªå¢é—®é¢˜</h2>
<p>æœ‰æ—¶ç”±äºä¸šåŠ¡çªç„¶å‡ºç°é«˜å³°ï¼Œæˆ–è€…åº”ç”¨ç¨‹åº bugï¼Œå¯¼è‡´æŸä¸ªè¯­å¥çš„ QPS çªç„¶æš´æ¶¨ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´ MySQL å‹åŠ›è¿‡å¤§ï¼Œå½±å“æœåŠ¡ã€‚<a href="https://time.geekbang.org/column/article/75746">è¯¦æƒ…ç§»æ­¥</a></p>
<h1>23-MySQLæ˜¯æ€ä¹ˆä¿è¯æ•°æ®ä¸ä¸¢çš„ï¼Ÿ</h1>
<p>å…³äºæ•°æ®å¯é æ€§,ä¹Ÿå³æŒä¹…æ€§çš„</p>
<h2 id="23-1-binlog-å†™å…¥æœºåˆ¶">23.1-binlog å†™å…¥æœºåˆ¶</h2>
<blockquote>
<p>åªè¦redo log å’Œbinlog å†™å…¥äº†ç£ç›˜ï¼Œå°±èƒ½ç¡®ä¿MySQLå¼‚å¸¸é‡å¯åï¼Œæ•°æ®å¯ä»¥æ¢å¤</p>
</blockquote>
<p align="center">
  <img src="/2023/09/30/mysql/30.jpg" width="100%" alt="Your image description">
</p>
<p>1ï¸âƒ£ äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…ˆæŠŠæ—¥å¿—å†™å…¥åˆ°binlog cache ï¼Œäº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå†æŠŠbinlog cacheå†™å…¥åˆ°binlog æ–‡ä»¶ä¸­ï¼Œå¹¶æ¸…ç©ºbinlog cache</p>
<p>2ï¸âƒ£ ç³»ç»Ÿç»™ binlog cache åˆ†é…äº†ä¸€ç‰‡å†…å­˜ï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šæŒ‰ç…§å‚æ•°<strong>binlog_cache_size</strong> çš„å¤§å°è·å–è‡ªå·±äº«æœ‰çš„cacheå¤§å°ï¼Œå¦‚æœä¸å¤Ÿç”¨å°±æš‚å­˜åˆ°ç£ç›˜</p>
<p>write å’Œ fsync çš„æ—¶æœºï¼Œæ˜¯ç”±å‚æ•° sync_binlog æ§åˆ¶çš„ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>sync_binlog=0 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½åª writeï¼Œä¸ fsyncï¼›</p>
</li>
<li class="lvl-2">
<p>sync_binlog=1 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¼šæ‰§è¡Œ fsyncï¼›</p>
</li>
<li class="lvl-2">
<p>sync_binlog=N(N&gt;1) çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ writeï¼Œä½†ç´¯ç§¯ N ä¸ªäº‹åŠ¡åæ‰ fsync<sup class="footnote-ref"><a href="#fn15" id="fnref15">[15]</a></sup></p>
</li>
</ul>
<p>å°† sync_binlog è®¾ç½®æˆä¸€ä¸ªæ¯”è¾ƒå¤§çš„å€¼ï¼Œå¯ä»¥æå‡æ€§èƒ½ã€‚åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæ¯”è¾ƒå¸¸è§çš„æ˜¯å°†å…¶è®¾ç½®ä¸º 100~1000 ä¸­çš„æŸä¸ªæ•°å€¼</p>
<h2 id="23-2-redo-log-çš„å†™å…¥æœºåˆ¶">23.2-redo log çš„å†™å…¥æœºåˆ¶</h2>
<p>redo log 3ç§å­˜å‚¨çŠ¶æ€</p>
<p align="center">
  <img src="/2023/09/30/mysql/31.jpg" width="100%" alt="Your image description">
</p>
<p>InnoDB æä¾›äº† <code>innodb_flush_log_at_trx_commit</code> å‚æ•°æ¥æ§åˆ¶ redo log çš„å†™å…¥ç­–ç•¥ï¼š</p>
<p>1ï¸âƒ£ è®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæ˜¯æŠŠ redo log ç•™åœ¨ redo log buffer ä¸­</p>
<p>2ï¸âƒ£ è®¾ç½®ä¸º 1 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½å°† redo log ç›´æ¥æŒä¹…åŒ–åˆ°ç£ç›˜</p>
<p>3ï¸âƒ£ è®¾ç½®ä¸º 2 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæ˜¯æŠŠ redo log å†™åˆ° page cache</p>
<p>InnoDB æœ‰ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œæ¯éš” 1 ç§’ï¼Œå°±ä¼šæŠŠ redo log buffer ä¸­çš„æ—¥å¿—ï¼Œè°ƒç”¨ write å†™åˆ°æ–‡ä»¶ç³»ç»Ÿçš„ page cacheï¼Œç„¶åè°ƒç”¨ fsync æŒä¹…åŒ–åˆ°ç£ç›˜<sup class="footnote-ref"><a href="#fn16" id="fnref16">[16]</a></sup>ã€‚æ­¤å¤–è¿˜æœ‰2ç§æƒ…å†µä¹Ÿä¼šå†™ç›˜ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>redo log buffer å ç”¨çš„ç©ºé—´å³å°†è¾¾åˆ° <code>innodb_log_buffer_size</code> ä¸€åŠçš„æ—¶å€™ï¼Œåå°çº¿ç¨‹ä¼šä¸»åŠ¨å†™ç›˜(åªæ˜¯write ä¸ fsync)</p>
</li>
<li class="lvl-2">
<p>å¹¶è¡Œäº‹åŠ¡æäº¤æ—¶ï¼Œé¡ºå¸¦å°†è¿™ä¸ªäº‹åŠ¡çš„redo log buffer æŒä¹…åŒ–åˆ°ç£ç›˜</p>
</li>
</ul>
<p><strong>æ—¥å¿—é€»è¾‘åºåˆ—å·<sup class="footnote-ref"><a href="#fn17" id="fnref17">[17]</a></sup></strong> : æ˜¯å•è°ƒé€’å¢çš„ï¼Œç”¨æ¥å¯¹åº” redo log çš„ä¸€ä¸ªä¸ªå†™å…¥ç‚¹ã€‚æ¯æ¬¡å†™å…¥é•¿åº¦ä¸º length çš„ redo logï¼Œ LSN çš„å€¼å°±ä¼šåŠ ä¸Š length</p>
<p><strong><a href="">ç»„æäº¤</a></strong></p>
<p>todo : éƒ¨åˆ†å†…å®¹æ²¡æœ‰åšæ€»ç»“</p>
<h1>24-MySQLæ˜¯æ€ä¹ˆä¿è¯ä¸»å¤‡ä¸€è‡´çš„ï¼Ÿ</h1>
<p><strong>ä¸»å¤‡åº“çš„åŒºåˆ«</strong>ï¼šå¤‡åº“å’Œä»åº“çš„æ¦‚å¿µæ˜¯ä¸åŒçš„ï¼Œè™½ç„¶äºŒè€…éƒ½æ˜¯åªè¯»çš„ï¼Œä½†æ˜¯ä»åº“å¯¹å¤–æä¾›æœåŠ¡ï¼Œè€Œå¤‡åº“åªæ˜¯ä¸ºä¸»åº“æä¾›å¤‡ä»½</p>
<h2 id="24-1-MySQL-ä¸»å¤‡çš„åŸºæœ¬åŸç†">24.1-MySQL ä¸»å¤‡çš„åŸºæœ¬åŸç†</h2>
<p>å·¦å›¾ä¸ºä¸»å¤‡åˆ‡æ¢æµç¨‹(M-Sæ¶æ„)ï¼Œå³å›¾ä¸ºèŠ‚ç‚¹ A åˆ° B è¿™æ¡çº¿çš„å†…éƒ¨æµç¨‹æ˜¯ä»€ä¹ˆæ ·çš„</p>
<p align="center">
  <img src="/2023/09/30/mysql/32.jpg" width="100%" alt="Your image description">
</p>
<p>ä¸€ä¸ªäº‹åŠ¡æ—¥å¿—åŒæ­¥çš„å®Œæ•´è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<p>1ï¸âƒ£ åœ¨å¤‡åº“ B ä¸Šé€šè¿‡ change master å‘½ä»¤ï¼Œè®¾ç½®ä¸»åº“ A çš„ IPã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ï¼Œä»¥åŠè¦ä»å“ªä¸ªä½ç½®å¼€å§‹è¯·æ±‚ binlogï¼Œè¿™ä¸ªä½ç½®åŒ…å«æ–‡ä»¶åå’Œæ—¥å¿—åç§»é‡</p>
<p>2ï¸âƒ£ åœ¨å¤‡åº“ B ä¸Šæ‰§è¡Œ start slave å‘½ä»¤ï¼Œè¿™æ—¶å€™å¤‡åº“ä¼šå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œå°±æ˜¯å›¾ä¸­çš„ io_thread å’Œ sql_threadã€‚å…¶ä¸­ io_thread è´Ÿè´£ä¸ä¸»åº“å»ºç«‹è¿æ¥</p>
<p>3ï¸âƒ£ ä¸»åº“ A æ ¡éªŒå®Œç”¨æˆ·åã€å¯†ç åï¼Œå¼€å§‹æŒ‰ç…§å¤‡åº“ B ä¼ è¿‡æ¥çš„ä½ç½®ï¼Œä»æœ¬åœ°è¯»å– binlogï¼Œå‘ç»™ B</p>
<p>4ï¸âƒ£ å¤‡åº“ B æ‹¿åˆ° binlog åï¼Œå†™åˆ°æœ¬åœ°æ–‡ä»¶ï¼Œç§°ä¸º<strong>ä¸­è½¬æ—¥å¿—</strong>ï¼ˆrelay logï¼‰</p>
<p>5ï¸âƒ£ sql_thread è¯»å–ä¸­è½¬æ—¥å¿—ï¼Œè§£æå‡ºæ—¥å¿—é‡Œçš„å‘½ä»¤ï¼Œå¹¶æ‰§è¡Œ</p>
<h2 id="24-2-binlog-çš„ä¸‰ç§æ ¼å¼å¯¹æ¯”">24.2-binlog çš„ä¸‰ç§æ ¼å¼å¯¹æ¯”</h2>
<ul class="lvl-0">
<li class="lvl-2">
<p>statement</p>
</li>
<li class="lvl-2">
<p>row</p>
</li>
<li class="lvl-2">
<p>mixed</p>
</li>
</ul>
<p>row æ ¼å¼ä½¿ç”¨ mysqlbinlogå·¥å…·è§£æå‡ºæ¥çš„ç»“æœï¼š</p>
<p align="center">
  <img src="/2023/09/30/mysql/33.jpg" width="100%" alt="Your image description">
</p>
<p>è¶Šæ¥è¶Šå¤šçš„åœºæ™¯è¦æ±‚æŠŠ MySQL çš„ binlog æ ¼å¼è®¾ç½®æˆ rowã€‚å…¶ä¸­ä¸€ä¸ªç›´æ¥çœ‹å‡ºæ¥çš„å¥½å¤„ï¼š<strong>æ¢å¤æ•°æ®</strong></p>
<h2 id="24-3-M-Mæ¶æ„">24.3-M-Mæ¶æ„</h2>
<p align="center">
  <img src="/2023/09/30/mysql/34.jpg" width="90%" alt="Your image description">
</p>
<h1>25-MySQLæ˜¯æ€ä¹ˆä¿è¯é«˜å¯ç”¨çš„ï¼Ÿ</h1>
<h2 id="25-1-ä¸»å¤‡å»¶è¿Ÿ">25.1-ä¸»å¤‡å»¶è¿Ÿ</h2>
<p>å’Œæ•°æ®åŒæ­¥æœ‰å…³çš„æ—¶é—´ç‚¹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªï¼š</p>
<p>1ï¸âƒ£ ä¸»åº“ A æ‰§è¡Œå®Œæˆä¸€ä¸ªäº‹åŠ¡ï¼Œå†™å…¥ binlogï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ—¶åˆ»è®°ä¸º T1</p>
<p>2ï¸âƒ£ ä¹‹åä¼ ç»™å¤‡åº“ Bï¼Œæˆ‘ä»¬æŠŠå¤‡åº“ B æ¥æ”¶å®Œè¿™ä¸ª binlog çš„æ—¶åˆ»è®°ä¸º T2</p>
<p>3ï¸âƒ£ å¤‡åº“ B æ‰§è¡Œå®Œæˆè¿™ä¸ªäº‹åŠ¡ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ—¶åˆ»è®°ä¸º T3</p>
<p><strong>ä¸»å¤‡å»¶è¿Ÿï¼Œå°±æ˜¯åŒä¸€ä¸ªäº‹åŠ¡ï¼Œåœ¨å¤‡åº“æ‰§è¡Œå®Œæˆçš„æ—¶é—´å’Œä¸»åº“æ‰§è¡Œå®Œæˆçš„æ—¶é—´ä¹‹é—´çš„å·®å€¼ï¼Œä¹Ÿå°±æ˜¯ $T3-T1$</strong></p>
<h2 id="25-2-é€ æˆä¸»å¤‡å»¶è¿Ÿçš„åŸå› ">25.2-é€ æˆä¸»å¤‡å»¶è¿Ÿçš„åŸå› </h2>
<p>1ï¸âƒ£ å¤‡åº“æ‰€åœ¨æœºå™¨çš„æ€§èƒ½è¦æ¯”ä¸»åº“æ‰€åœ¨çš„æœºå™¨æ€§èƒ½å·®</p>
<p>2ï¸âƒ£ å¤‡åº“çš„å‹åŠ›å¤§</p>
<p>3ï¸âƒ£ å¤§äº‹åŠ¡<sup class="footnote-ref"><a href="#fn18" id="fnref18">[18]</a></sup></p>
<p>4ï¸âƒ£ å¤‡åº“çš„å¹¶è¡Œå¤åˆ¶èƒ½åŠ›</p>
<h2 id="25-3-å¯é æ€§ä¼˜å…ˆç­–ç•¥">25.3-å¯é æ€§ä¼˜å…ˆç­–ç•¥</h2>
<p>æ¨èä½¿ç”¨è¯¥ç­–ç•¥</p>
<h2 id="25-4-å¯ç”¨æ€§ä¼˜å…ˆç­–ç•¥">25.4-å¯ç”¨æ€§ä¼˜å…ˆç­–ç•¥</h2>
<p>ä»‹ç»äº†å¼‚å¸¸åˆ‡æ¢çš„æƒ…å†µ</p>
<h1>26-å¤‡åº“ä¸ºä»€ä¹ˆä¼šå»¶è¿Ÿå¥½å‡ ä¸ªå°æ—¶ï¼Ÿ</h1>
<p>ä¸»è¦ä»‹ç»ï¼šå¤‡åº“å¹¶è¡Œå¤åˆ¶èƒ½åŠ›ã€‚MySQL5.6ä¹‹å‰å¤‡åº“çš„å¤åˆ¶æ—¶å•çº¿ç¨‹çš„ã€‚ä¸ºä»€ä¹ˆè¦æœ‰å¤šçº¿ç¨‹å¤åˆ¶å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºå•çº¿ç¨‹å¤åˆ¶çš„èƒ½åŠ›å…¨é¢ä½äºå¤šçº¿ç¨‹å¤åˆ¶ï¼Œå¯¹äºæ›´æ–°å‹åŠ›è¾ƒå¤§çš„ä¸»åº“ï¼Œå¤‡åº“æ˜¯å¯èƒ½ä¸€ç›´è¿½ä¸ä¸Šä¸»åº“çš„ã€‚ä»è€Œå¯¼è‡´å¤‡åº“ä¸Š seconds_behind_master çš„å€¼è¶Šæ¥è¶Šå¤§</p>
<p align="center">
  <img src="/2023/09/30/mysql/35.png" width="100%" alt="Your image description">
</p>
<p>coordinator åœ¨åˆ†å‘çš„æ—¶å€™ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹è¿™ä¸¤ä¸ªåŸºæœ¬è¦æ±‚ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>ä¸èƒ½é€ æˆæ›´æ–°è¦†ç›–ã€‚è¿™å°±è¦æ±‚æ›´æ–°åŒä¸€è¡Œçš„ä¸¤ä¸ªäº‹åŠ¡ï¼Œå¿…é¡»è¢«åˆ†å‘åˆ°åŒä¸€ä¸ª worker ä¸­</p>
</li>
<li class="lvl-2">
<p>åŒä¸€ä¸ªäº‹åŠ¡ä¸èƒ½è¢«æ‹†å¼€ï¼Œå¿…é¡»æ”¾åˆ°åŒä¸€ä¸ª worker ä¸­</p>
</li>
</ul>
<p>todo:å¾…æ›´</p>
<h1>27-ä¸»åº“å‡ºé—®é¢˜äº†ï¼Œä»åº“æ€ä¹ˆåŠï¼Ÿ</h1>
<p>å¤§å¤šæ•°çš„äº’è”ç½‘åº”ç”¨åœºæ™¯éƒ½æ˜¯è¯»å¤šå†™å°‘ï¼Œåœ¨å‘å±•è¿‡ç¨‹ä¸­å¾ˆå¯èƒ½å…ˆä¼šé‡åˆ°è¯»æ€§èƒ½çš„é—®é¢˜ã€‚è€Œåœ¨æ•°æ®åº“å±‚è§£å†³è¯»æ€§èƒ½é—®é¢˜ï¼Œå°±è¦æ¶‰åŠåˆ°æ¥ä¸‹æ¥ä¸¤ç¯‡æ–‡ç« è¦è®¨è®ºçš„æ¶æ„ï¼Œä¸€ä¸»å¤šä»ã€‚ï¼ˆå‰3ç« æ˜¯ä¸€ä¸»ä¸€å¤‡ï¼‰</p>
<p>1ï¸âƒ£ åŸºäºä½ç‚¹çš„ä¸»å¤‡åˆ‡æ¢(éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªä½ç‚¹å¹¶ä¸å‡†ç¡®)</p>
<p>2ï¸âƒ£ GTIDï¼šGTID](å…¨ç§°æ˜¯ Global Transaction Identifierï¼Œä¹Ÿå°±æ˜¯å…¨å±€äº‹åŠ¡ IDï¼Œæ˜¯ä¸€ä¸ªäº‹åŠ¡åœ¨æäº¤çš„æ—¶å€™ç”Ÿæˆçš„ï¼Œæ˜¯è¿™ä¸ªäº‹åŠ¡çš„å”¯ä¸€æ ‡è¯†æ ¼å¼ï¼š <code>GTID=server_uuid:gno</code></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>server_uuid æ˜¯ä¸€ä¸ªå®ä¾‹ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å€¼</p>
</li>
<li class="lvl-2">
<p>gno æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œåˆå§‹å€¼æ˜¯ 1ï¼Œæ¯æ¬¡æäº¤äº‹åŠ¡çš„æ—¶å€™åˆ†é…ç»™è¿™ä¸ªäº‹åŠ¡ï¼Œå¹¶åŠ  1<sup class="footnote-ref"><a href="#fn19" id="fnref19">[19]</a></sup></p>
</li>
</ul>
<h1>28-è¯»å†™åˆ†ç¦»æœ‰å“ªäº›å‘ï¼Ÿ</h1>
<p>è‡ªå®šä¹‰çš„<a href="%E5%9C%A8%E4%BB%8E%E5%BA%93%E4%B8%8A%E4%BC%9A%E8%AF%BB%E5%88%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%B8%80%E4%B8%AA%E8%BF%87%E6%9C%9F%E7%8A%B6%E6%80%81%E2%80%9D%E7%9A%84%E7%8E%B0%E8%B1%A1%EF%BC%8C%E5%9C%A8%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E9%87%8C%EF%BC%8C%E6%88%91%E4%BB%AC%E6%9A%82%E4%B8%94%E7%A7%B0%E4%B9%8B%E4%B8%BA%E2%80%9C%E8%BF%87%E6%9C%9F%E8%AF%BB%E2%80%9D">è¿‡æœŸè¯»</a> ã€‚ æ¶‰åŠåˆ°çš„å¤„ç†è¿‡æœŸè¯»çš„æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ å¼ºåˆ¶èµ°ä¸»åº“æ–¹æ¡ˆï¼›<a href="%E6%AF%94%E5%A6%82%EF%BC%8C%E5%9C%A8%E4%B8%80%E4%B8%AA%E4%BA%A4%E6%98%93%E5%B9%B3%E5%8F%B0%E4%B8%8A%EF%BC%8C%E5%8D%96%E5%AE%B6%E5%8F%91%E5%B8%83%E5%95%86%E5%93%81%E4%BB%A5%E5%90%8E%EF%BC%8C%E9%A9%AC%E4%B8%8A%E8%A6%81%E8%BF%94%E5%9B%9E%E4%B8%BB%E9%A1%B5%E9%9D%A2%EF%BC%8C%E7%9C%8B%E5%95%86%E5%93%81%E6%98%AF%E5%90%A6%E5%8F%91%E5%B8%83%E6%88%90%E5%8A%9F%E3%80%82%E9%82%A3%E4%B9%88%EF%BC%8C%E8%BF%99%E4%B8%AA%E8%AF%B7%E6%B1%82%E9%9C%80%E8%A6%81%E6%8B%BF%E5%88%B0%E6%9C%80%E6%96%B0%E7%9A%84%E7%BB%93%E6%9E%9C%EF%BC%8C%E5%B0%B1%E5%BF%85%E9%A1%BB%E8%B5%B0%E4%B8%BB%E5%BA%93%E3%80%82%E4%B9%B0%E5%AE%B6%E6%9D%A5%E9%80%9B%E5%95%86%E9%93%BA%E9%A1%B5%E9%9D%A2%EF%BC%8C%E5%B0%B1%E7%AE%97%E6%99%9A%E5%87%A0%E7%A7%92%E7%9C%8B%E5%88%B0%E6%9C%80%E6%96%B0%E5%8F%91%E5%B8%83%E7%9A%84%E5%95%86%E5%93%81%EF%BC%8C%E4%B9%9F%E6%98%AF%E5%8F%AF%E4%BB%A5%E6%8E%A5%E5%8F%97%E7%9A%84">å¯¹äºå¿…é¡»è¦æ‹¿åˆ°æœ€æ–°ç»“æœçš„è¯·æ±‚ï¼Œå¼ºåˆ¶å°†å…¶å‘åˆ°ä¸»åº“ä¸Šã€‚å¯¹äºå¯ä»¥è¯»åˆ°æ—§æ•°æ®çš„è¯·æ±‚ï¼Œæ‰å°†å…¶å‘åˆ°ä»åº“ä¸Š</a></p>
<p>2ï¸âƒ£ sleep æ–¹æ¡ˆ</p>
<p>3ï¸âƒ£ åˆ¤æ–­ä¸»å¤‡æ— å»¶è¿Ÿæ–¹æ¡ˆ</p>
<p>4ï¸âƒ£ é…åˆ semi-sync æ–¹æ¡ˆ</p>
<p>5ï¸âƒ£ ç­‰ä¸»åº“ä½ç‚¹æ–¹æ¡ˆ</p>
<p>6ï¸âƒ£ ç­‰ GTID æ–¹æ¡ˆ</p>
<h1>29-å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªæ•°æ®åº“æ˜¯ä¸æ˜¯å‡ºé—®é¢˜äº†ï¼Ÿ</h1>
<p>ä¸»å¤‡åˆ‡æ¢æœ‰ä¸‹é¢2ç§åœºæ™¯ï¼š</p>
<p>ğŸ…°ï¸ ä¸»åŠ¨åˆ‡æ¢</p>
<p>ğŸ…±ï¸ è¢«åŠ¨åˆ‡æ¢ï¼›å³ç”±HA ç³»ç»Ÿç¡®è®¤ä¸»åº“å‡ºäº†é—®é¢˜ï¼Œç„¶åHAç³»ç»Ÿå‘èµ·åˆ‡æ¢</p>
<h1>30-ç­”ç–‘æ–‡ç« ï¼ˆäºŒï¼‰ï¼šç”¨åŠ¨æ€çš„è§‚ç‚¹çœ‹åŠ é”</h1>
<h1>31-è¯¯åˆ æ•°æ®åé™¤äº†è·‘è·¯ï¼Œè¿˜èƒ½æ€ä¹ˆåŠï¼Ÿ</h1>
<p>è¯¯åˆ æ•°æ®çš„äº‹åå¤„ç†åŠæ³•ï¼Œæ›´é‡è¦æ˜¯è¦åšåˆ°äº‹å‰é¢„é˜²è¯¯åˆ æ•°æ®ï¼Œä¸‹é¢æ˜¯2ä¸ªå»ºè®®ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>[sql_safe_updates å‚æ•°è®¾ç½®ä¸º onã€‚è¿™æ ·ä¸€æ¥ï¼Œå¦‚æœæˆ‘ä»¬å¿˜è®°åœ¨ delete æˆ–è€… update è¯­å¥ä¸­å†™ where æ¡ä»¶ï¼Œæˆ–è€… where æ¡ä»¶é‡Œé¢æ²¡æœ‰åŒ…å«ç´¢å¼•å­—æ®µçš„è¯ï¼Œè¿™æ¡è¯­å¥çš„æ‰§è¡Œå°±ä¼šæŠ¥é”™](å¦‚æœä½ ç¡®å®šè¿™ä¸ªåˆ é™¤æ“ä½œæ²¡é—®é¢˜çš„è¯ï¼Œå¯ä»¥åœ¨ delete è¯­å¥ä¸­åŠ ä¸Š where æ¡ä»¶ï¼Œæ¯”å¦‚ where1=1)</p>
</li>
<li class="lvl-2">
<p>ä»£ç ä¸Šçº¿å‰ï¼Œå¿…é¡»ç»è¿‡ SQL å®¡è®¡</p>
</li>
</ul>
<p>é˜²æ­¢è¯¯åˆ è¡¨ï¼Œè¯¯åˆ åº“çš„å»ºè®®ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>ç¬¬ä¸€æ¡å»ºè®®æ˜¯ï¼Œè´¦å·åˆ†ç¦»</p>
</li>
<li class="lvl-2">
<p>ç¬¬äºŒæ¡å»ºè®®æ˜¯ï¼šåˆ¶å®šæ“ä½œè§„èŒƒã€‚è¿™æ ·åšçš„ç›®çš„ï¼Œæ˜¯é¿å…å†™é”™è¦åˆ é™¤çš„è¡¨å(æ¯”å¦‚ï¼šåœ¨åˆ é™¤æ•°æ®è¡¨ä¹‹å‰ï¼Œå¿…é¡»å…ˆå¯¹è¡¨åšæ”¹åæ“ä½œã€‚ç„¶åï¼Œè§‚å¯Ÿä¸€æ®µæ—¶é—´ï¼Œç¡®ä¿å¯¹ä¸šåŠ¡æ— å½±å“ä»¥åå†åˆ é™¤è¿™å¼ è¡¨ã€‚æ”¹è¡¨åçš„æ—¶å€™ï¼Œè¦æ±‚ç»™è¡¨ååŠ å›ºå®šçš„åç¼€æ¯”å¦‚åŠ  _to_be_deleted ï¼Œç„¶ååˆ é™¤è¡¨çš„åŠ¨ä½œå¿…é¡»é€šè¿‡ç®¡ç†ç³»ç»Ÿæ‰§è¡Œã€‚å¹¶ä¸”ï¼Œç®¡ç†ç³»åˆ é™¤è¡¨çš„æ—¶å€™ï¼Œåªèƒ½åˆ é™¤å›ºå®šåç¼€çš„è¡¨)</p>
</li>
</ul>
<h1>32-ä¸ºä»€ä¹ˆè¿˜æœ‰killä¸æ‰çš„è¯­å¥ï¼Ÿ</h1>
<h1>33-æˆ‘æŸ¥è¿™ä¹ˆå¤šæ•°æ®ï¼Œä¼šä¸ä¼šæŠŠæ•°æ®åº“å†…å­˜æ‰“çˆ†ï¼Ÿ</h1>
<h2 id="å…¨è¡¨æ‰«æå¯¹-serverå±‚çš„å½±å“">å…¨è¡¨æ‰«æå¯¹ serverå±‚çš„å½±å“</h2>
<p>å‡å¦‚ï¼Œç°åœ¨æœ‰ä¸€ä¸ª å¯¹ 200Gçš„<code>InnoDB</code>è¡¨ db1.t è¿›è¡Œå…¨è¡¨æ‰«æï¼Œå¹¶å°†ç»“æœé›†ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„éœ€æ±‚ï¼Œä½ å¯èƒ½ä¼šæœ‰ä¸‹é¢å‘½ä»¤ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">mysql <span class="operator">-</span>h$host <span class="operator">-</span>P$port <span class="operator">-</span>u$<span class="keyword">user</span> <span class="operator">-</span>p$pwd <span class="operator">-</span>e "select * from db1.t" <span class="operator">&gt;</span> $target_file</span><br></pre></td></tr></tbody></table></figure>
<p>é‚£ä¹ˆserverç«¯ å–æ•°æ®å’Œå‘æ•°æ®çš„æµç¨‹æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š</p>
<p>1ï¸âƒ£ è·å–ä¸€è¡Œï¼Œå†™åˆ° net_buffer ä¸­ã€‚è¿™å—å†…å­˜çš„å¤§å°æ˜¯ç”±å‚æ•° net_buffer_length å®šä¹‰çš„ï¼Œé»˜è®¤æ˜¯ 16k</p>
<p>2ï¸âƒ£ é‡å¤è·å–è¡Œï¼Œç›´åˆ° net_buffer å†™æ»¡ï¼Œè°ƒç”¨ç½‘ç»œæ¥å£å‘å‡ºå»</p>
<p>3ï¸âƒ£ å¦‚æœå‘é€æˆåŠŸï¼Œå°±æ¸…ç©º net_bufferï¼Œç„¶åç»§ç»­å–ä¸‹ä¸€è¡Œï¼Œå¹¶å†™å…¥ net_buffer</p>
<p>4ï¸âƒ£ å¦‚æœå‘é€å‡½æ•°è¿”å› EAGAIN æˆ– WSAEWOULDBLOCKï¼Œå°±è¡¨ç¤ºæœ¬åœ°ç½‘ç»œæ ˆï¼ˆsocket send bufferï¼‰å†™æ»¡äº†ï¼Œè¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°ç½‘ç»œæ ˆé‡æ–°å¯å†™ï¼Œå†ç»§ç»­å‘é€</p>
<p>å³ï¼š<strong>è¾¹è¯»è¾¹å‘</strong>ï¼Œæ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</p>
<p align="center">
  <img src="/2023/09/30/mysql/36.jpg" width="80%" alt="Your image description">
</p>
<p>æ‰§è¡Œ <code>show processlist </code> state å¤„äº Sending to client çŠ¶æ€çš„ï¼Œå°±è¡¨ç¤ºæœåŠ¡å™¨ç«¯çš„ç½‘ç»œçº¿ç¨‹å†™æ»¡äº†ã€‚<strong>å¯¹äºæ­£å¸¸çš„çº¿ä¸Šä¸šåŠ¡æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªæŸ¥è¯¢çš„è¿”å›ç»“æœä¸ä¼šå¾ˆå¤šçš„è¯ï¼Œå»ºè®®ä½¿ç”¨ <code>mysql_store_result</code> è¿™ä¸ªæ¥å£ï¼Œç›´æ¥æŠŠæŸ¥è¯¢ç»“æœä¿å­˜åˆ°æœ¬åœ°å†…å­˜</strong></p>
<h2 id="å…¨è¡¨æ‰«æå¯¹InnoDBçš„å½±å“">å…¨è¡¨æ‰«æå¯¹<code>InnoDB</code>çš„å½±å“</h2>
<p><strong>å†…å­˜åˆ©ç”¨ç‡</strong>ï¼š buffer pool (å®é™…æ˜¯ buffer pool ä¸­çš„ change buffer) å¯ä»¥èµ·åˆ°åŠ é€Ÿæ›´æ–°çš„ä½œç”¨ï¼ŒåŒæ—¶ä¹Ÿå…·å¤‡åŠ é€ŸæŸ¥è¯¢çš„ä½œç”¨ï¼Œäº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œç£ç›˜çš„æ•°æ®é¡µæ˜¯æ—§çš„ï¼Œå¦‚æœé©¬ä¸Šæœ‰ä¸€ä¸ªæŸ¥è¯¢æ¥è¯»æ•°æ®é¡µï¼ŒMySQLå¹¶ä¸éœ€è¦å°†redo log åº”ç”¨åˆ°æ•°æ®é¡µï¼Œä¹Ÿæ˜¯ç›´æ¥è¯»å†…å­˜é¡µå°±å¯ä»¥äº†ã€‚Buffer pool å¯¹æŸ¥è¯¢çš„åŠ é€Ÿæ•ˆæœï¼Œä¾èµ–å†…å­˜å‘½ä¸­ç‡ã€‚<code>show engine innodb status</code>  æœç´¢hit å³å¯å®šä½åˆ°ã€‚[å¦‚ä½•è®¾ç½®buffer poolçš„å¤§å°ï¼Ÿ](å…¶ä¸­ buffer pool çš„å¤§å°ï¼Œå¯é€šè¿‡ å‚æ•° <code>innodb_buffer_pool_size</code> è®¾ç½®ï¼Œä¸€èˆ¬è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„ 60%~80%ã€‚)</p>
<p><code>InnoDB</code> å†…å­˜ç®¡ç†ä½¿ç”¨çš„ [LRU](Least Recently Used) è¿™ä¸ªç¼“å­˜æ·˜æ±°ç®—æ³•ï¼Œå¹¶ä¸”æ˜¯åŸºäºé“¾è¡¨å®ç°çš„ç¼“å­˜æ·˜æ±°ç®—æ³•</p>
<p align="center">
  <img src="/2023/09/30/mysql/37.jpg" width="100%" alt="Your image description">
</p>
<p>æ”¹è¿›åçš„ LRU ç®—æ³•æ‰§è¡Œæµç¨‹å˜æˆäº†ä¸‹é¢è¿™æ ·ã€‚</p>
<p>1ï¸âƒ£ å›¾ 7 ä¸­çŠ¶æ€ 1ï¼Œè¦è®¿é—®æ•°æ®é¡µ P3ï¼Œç”±äº P3 åœ¨ young åŒºåŸŸï¼Œå› æ­¤å’Œä¼˜åŒ–å‰çš„ LRU ç®—æ³•ä¸€æ ·ï¼Œå°†å…¶ç§»åˆ°é“¾è¡¨å¤´éƒ¨ï¼Œå˜æˆçŠ¶æ€</p>
<p>2ï¸âƒ£ä¹‹åè¦è®¿é—®ä¸€ä¸ªæ–°çš„ä¸å­˜åœ¨äºå½“å‰é“¾è¡¨çš„æ•°æ®é¡µï¼Œè¿™æ—¶å€™ä¾ç„¶æ˜¯æ·˜æ±°æ‰æ•°æ®é¡µ Pmï¼Œä½†æ˜¯æ–°æ’å…¥çš„æ•°æ®é¡µ Pxï¼Œæ˜¯æ”¾åœ¨ LRU_old å¤„</p>
<p>3ï¸âƒ£ å¤„äº old åŒºåŸŸçš„æ•°æ®é¡µï¼Œæ¯æ¬¡è¢«è®¿é—®çš„æ—¶å€™éƒ½è¦åšä¸‹é¢è¿™ä¸ªåˆ¤æ–­ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>è‹¥è¿™ä¸ªæ•°æ®é¡µåœ¨ LRU é“¾è¡¨ä¸­å­˜åœ¨çš„æ—¶é—´è¶…è¿‡äº† 1 ç§’ï¼Œå°±æŠŠå®ƒç§»åŠ¨åˆ°é“¾è¡¨å¤´éƒ¨</p>
</li>
<li class="lvl-2">
<p>å¦‚æœè¿™ä¸ªæ•°æ®é¡µåœ¨ LRU é“¾è¡¨ä¸­å­˜åœ¨çš„æ—¶é—´çŸ­äº 1 ç§’ï¼Œä½ç½®ä¿æŒä¸å˜ã€‚1 ç§’è¿™ä¸ªæ—¶é—´ï¼Œæ˜¯ç”±å‚æ•° innodb_old_blocks_time æ§åˆ¶çš„ã€‚å…¶é»˜è®¤å€¼æ˜¯ 1000ï¼Œå•ä½æ¯«ç§’</p>
</li>
</ul>
<p>è¿™ä¸ªç­–ç•¥ï¼Œå°±æ˜¯ä¸ºäº†å¤„ç†ç±»ä¼¼å…¨è¡¨æ‰«æçš„æ“ä½œé‡èº«å®šåˆ¶çš„ï¼Œåœ¨æ‰«æè¿™ä¸ªå¤§è¡¨çš„è¿‡ç¨‹ä¸­ï¼Œè™½ç„¶ä¹Ÿç”¨åˆ°äº† Buffer Poolï¼Œä½†æ˜¯å¯¹ young åŒºåŸŸå®Œå…¨æ²¡æœ‰å½±å“ï¼Œä»è€Œä¿è¯äº† Buffer Pool å“åº”æ­£å¸¸ä¸šåŠ¡çš„æŸ¥è¯¢å‘½ä¸­ç‡</p>
<h1>34-åˆ°åº•å¯ä¸å¯ä»¥ä½¿ç”¨joinï¼Ÿ</h1>
<p>ğŸ”¥ é¦–å…ˆï¼Œå¯¹äºæˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥ï¼Œåœ¨ä¸Šçº¿ä¹‹å‰ï¼Œexplainä¸€ä¸‹æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œé‚£ä¹ˆå¯¹äºexplainçš„å‡ ç§ç±»å‹éœ€è¦äº†è§£ï¼š</p>
<p>1ï¸âƒ£ <code>const </code>: æ ¹æ®ä¸»é”® ç­‰å€¼åŒ¹é…ï¼Œå”¯ä¸€ç´¢å¼•(is nullé™¤å¤–) ç­‰å€¼åŒ¹é…</p>
<p>2ï¸âƒ£ index : ç´¢å¼•è¦†ç›–ï¼Œæ— é¡»å›è¡¨</p>
<p>3ï¸âƒ£ ref ï¼š æ™®é€šç´¢å¼•ç­‰å€¼åŒ¹é… ï¼Œæ™®é€šç´¢å¼• is null ï¼Œå”¯ä¸€ç´¢å¼• is null</p>
<p>4ï¸âƒ£ range: ä¸»é”®ç´¢å¼•æˆ–è€…å”¯ä¸€ç´¢å¼•èŒƒå›´æŸ¥è¯¢ï¼Œæˆ–è€…æ™®é€šç´¢å¼•èŒƒå›´æŸ¥è¯¢ ï¼Œ è‹¥èŒƒå›´åœ¨æ€»èŒƒå›´ä¸­å æ¯”å¤§ï¼Œä¼šå˜ä¸º ALL</p>
<p>å…¶ä¸­ï¼Œå„ä¸ªç±»å‹çš„ä¼˜åŠ£å¦‚ä¸‹ï¼š</p>
<blockquote>
<p><code>const </code>&gt; ref &gt; index &gt; range &gt; all</p>
</blockquote>
<p>t1 å’Œ t2çš„è¡¨ç»“æ„å¦‚ä¸‹ï¼šå…¶ä¸­t1ä¸­100æ¡è®°å½•ï¼Œt2ä¸­1000æ¡è®°å½•</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `t2` (`id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">                   `a`  <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">                   `b`  <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">                   <span class="keyword">primary</span> key (`id`),</span><br><span class="line">                   key `a` (`a`)</span><br><span class="line">) engine <span class="operator">=</span> innodb</span><br></pre></td></tr></tbody></table></figure>
<h2 id="34-1-Index-Nested-Loop-Join">34.1-Index Nested-Loop Join</h2>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 straight_join t2 <span class="keyword">on</span> (t1.a <span class="operator">=</span> t2.a);</span><br></pre></td></tr></tbody></table></figure>
<p>å½“å‰è¯­å¥çš„æ‰§è¡Œæµç¨‹ï¼š</p>
<p>1ï¸âƒ£ ä»è¡¨ t1 ä¸­è¯»å…¥ä¸€è¡Œæ•°æ® R</p>
<p>2ï¸âƒ£ ä»æ•°æ®è¡Œ R ä¸­ï¼Œå–å‡º a å­—æ®µåˆ°è¡¨ t2 é‡Œå»æŸ¥æ‰¾</p>
<p>3ï¸âƒ£ å–å‡ºè¡¨ t2 ä¸­æ»¡è¶³æ¡ä»¶çš„è¡Œï¼Œè·Ÿ R ç»„æˆä¸€è¡Œï¼Œä½œä¸ºç»“æœé›†çš„ä¸€éƒ¨åˆ†</p>
<p>4ï¸âƒ£ é‡å¤æ‰§è¡Œæ­¥éª¤ 1 åˆ° 3ï¼Œç›´åˆ°è¡¨ t1 çš„æœ«å°¾å¾ªç¯ç»“æŸ</p>
<p align="center">
  <img src="/2023/09/30/mysql/38.jpg" width="100%" alt="Your image description">
</p>
<p>å¦‚æœt1 = N è¡Œï¼Œt2 M è¡Œï¼Œè¿‘ä¼¼å¤æ‚åº¦å¦‚ä¸‹ï¼š<br>
$$<br>
O(N)= N + N \times2\times\log2 M<br>
$$<br>
å¯ä»¥å‘ç°ï¼ŒN è¶Šå°ï¼Œæ•´ä¸ªå¤æ‚åº¦è¶Šä½ã€‚</p>
<h2 id="34-2-Simple-Nested-Loop-Join">34.2-Simple Nested-Loop Join</h2>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 straight_join t2 <span class="keyword">on</span> (t1.a<span class="operator">=</span>t2.b);</span><br></pre></td></tr></tbody></table></figure>
<p>ç”±äºt2çš„å­—æ®µbä¸Šæ²¡æœ‰ç´¢å¼•ï¼Œæ¯æ¬¡å»t2åŒ¹é…çš„æ—¶å€™ï¼Œå°±éœ€è¦åšä¸€ä¸ªå…¨è¡¨æ‰«æã€‚å…±éœ€è¦æ‰«æ:$100,000 = 100\times1000$</p>
<p>MySQLå¹¶æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªSimple Nested-Loop Join ç®—æ³•ï¼Œ è€Œæ˜¯ Block Nested-Loop Join</p>
<h2 id="34-3-Block-Nested-Loop-Join">34.3-Block Nested-Loop Join</h2>
<p>å¯¹äº æŸ¥è¯¢ï¼Œ<code>select * from t1 straight_join t2 on (t1.a=t2.b);</code> æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ æŠŠè¡¨ t1 çš„æ•°æ®è¯»å…¥çº¿ç¨‹å†…å­˜ join_buffer ä¸­ï¼Œç”±äºæˆ‘ä»¬è¿™ä¸ªè¯­å¥ä¸­å†™çš„æ˜¯ select *ï¼Œå› æ­¤æ˜¯æŠŠæ•´ä¸ªè¡¨ t1 æ”¾å…¥äº†å†…å­˜ï¼›</p>
<p>2ï¸âƒ£ æ‰«æè¡¨ t2ï¼ŒæŠŠè¡¨ t2 ä¸­çš„æ¯ä¸€è¡Œå–å‡ºæ¥ï¼Œè·Ÿ join_buffer ä¸­çš„æ•°æ®åšå¯¹æ¯”ï¼Œæ»¡è¶³ join æ¡ä»¶çš„ï¼Œä½œä¸ºç»“æœé›†çš„ä¸€éƒ¨åˆ†è¿”å›ã€‚</p>
<p>è¿™ä¸ªè¿‡ç¨‹å¯¹ t1å’Œ t2éƒ½åšäº†ä¸€æ¬¡å…¨è¡¨æ‰«æ ï¼Œ æ€»çš„æ‰«æè¡Œæ•°æ˜¯1100ï¼Œå¯¹äºt2çš„æ¯ä¸€è¡Œéƒ½éœ€è¦åœ¨å†…å­˜ä¸­åšåˆ¤æ–­ï¼Œå…±éœ€è¦ 100,000 æ¬¡æ¯”è¾ƒã€‚ä½†æ˜¯è¿™ä¸ªæ¯”è¾ƒæ˜¯åŸºäºå†…å­˜æ“ä½œï¼Œæ¯”Simple Nested-Loop Join å¿«å¾ˆå¤šã€‚</p>
<p>å…¶ä¸­ join_buffer<sup class="footnote-ref"><a href="#fn20" id="fnref20">[20]</a></sup> å¦‚æœæ”¾ä¸ä¸‹é©±åŠ¨è¡¨ï¼Œå°±éœ€è¦åˆ†å—ï¼ˆblockï¼‰æ”¾ç½®ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ æ‰«æè¡¨ t1ï¼Œé¡ºåºè¯»å–æ•°æ®è¡Œæ”¾å…¥ join_buffer ä¸­ï¼Œæ”¾å®Œç¬¬ 88 è¡Œ join_buffer æ»¡äº†ï¼Œç»§ç»­ç¬¬ 2 æ­¥ï¼›</p>
<p>2ï¸âƒ£ æ‰«æè¡¨ t2ï¼ŒæŠŠ t2 ä¸­çš„æ¯ä¸€è¡Œå–å‡ºæ¥ï¼Œè·Ÿ join_buffer ä¸­çš„æ•°æ®åšå¯¹æ¯”ï¼Œæ»¡è¶³ join æ¡ä»¶çš„ï¼Œä½œä¸ºç»“æœé›†çš„ä¸€éƒ¨åˆ†è¿”å›ï¼›</p>
<p>3ï¸âƒ£ æ¸…ç©º join_bufferï¼›</p>
<p>4ï¸âƒ£ ç»§ç»­æ‰«æè¡¨ t1ï¼Œé¡ºåºè¯»å–æœ€åçš„ 12 è¡Œæ•°æ®æ”¾å…¥ join_buffer ä¸­ï¼Œç»§ç»­æ‰§è¡Œç¬¬ 2 æ­¥ã€‚</p>
<p align="center">
  <img src="/2023/09/30/mysql/39.jpg" width="80%" alt="Your image description">
</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>æ‰«æè¡Œæ•° : N+Î» * N * M ï¼ˆÎ» å–å€¼(0,1)ï¼‰</p>
</li>
<li class="lvl-2">
<p>å†…å­˜åˆ¤æ–­ : N * M</p>
</li>
</ul>
<p><strong>åœ¨å†³å®šå“ªä¸ªè¡¨åšé©±åŠ¨è¡¨çš„æ—¶å€™ï¼Œåº”è¯¥æ˜¯ä¸¤ä¸ªè¡¨æŒ‰ç…§å„è‡ªçš„æ¡ä»¶è¿‡æ»¤ï¼Œè¿‡æ»¤å®Œæˆä¹‹åï¼Œè®¡ç®—å‚ä¸ join çš„å„ä¸ªå­—æ®µçš„æ€»æ•°æ®é‡ï¼Œæ•°æ®é‡å°çš„é‚£ä¸ªè¡¨ï¼Œå°±æ˜¯â€œå°è¡¨â€ï¼Œåº”è¯¥ä½œä¸ºé©±åŠ¨è¡¨</strong>ã€‚</p>
<h1>35-joinè¯­å¥æ€ä¹ˆä¼˜åŒ–ï¼Ÿ</h1>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1(id <span class="type">int</span> <span class="keyword">primary</span> key, a <span class="type">int</span>, b <span class="type">int</span>, index(a)); </span><br><span class="line"><span class="comment">-- t1 æ’å…¥1000è¡Œæ•°æ®ï¼Œæ¯è¡Œçš„a = 1001-idï¼Œå³è¡¨t1ä¸­çš„å­—æ®µaæ˜¯é€†åºçš„</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t2 <span class="keyword">like</span> t1;  <span class="comment">-- åœ¨è¡¨t2ä¸­æ’å…¥ 100w æ•°æ®</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="35-1-Multi-Range-Read-ä¼˜åŒ–">35.1-Multi-Range Read ä¼˜åŒ–</h2>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> a<span class="operator">&gt;=</span><span class="number">1</span> <span class="keyword">and</span> a<span class="operator">&lt;=</span><span class="number">100</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚ä¸ŠæŸ¥è¯¢ä¸­ï¼Œä¼šæ¶‰åŠåˆ°å›è¡¨çš„è¿‡ç¨‹ï¼Œå›è¡¨è¿‡ç¨‹æ˜¯ä¸€è¡Œè¡ŒæŸ¥è¯¢æ•°æ®ï¼Œè¿˜æ˜¯æ‰¹é‡çš„æŸ¥è¯¢æ•°æ®å‘¢ï¼Ÿä¸»é”®ç´¢å¼•æ˜¯ä¸€é¢—B+æ ‘ï¼Œæ¯æ¬¡åªèƒ½æ ¹æ®ä¸€ä¸ªä¸»é”®id æŸ¥åˆ°ä¸€è¡Œæ•°æ®ï¼Œå› æ­¤<strong>å›è¡¨ä¸€å®šæ˜¯ä¸€è¡Œè¡Œæœç´¢ä¸»é”®ç´¢å¼•çš„</strong>ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœéšç€açš„å€¼é€’å¢é¡ºåºæŸ¥è¯¢çš„è¯ï¼Œidçš„å€¼å°±å˜æˆéšæœºçš„äº†ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°éšæœºè®¿é—®ç£ç›˜ï¼Œæ€§èƒ½ç›¸å¯¹è¾ƒå·®ã€‚</p>
<blockquote>
<p>å› ä¸ºå¤§å¤šæ•°çš„æ•°æ®éƒ½æ˜¯æŒ‰ç…§ä¸»é”®é€’å¢é¡ºåºæ’å…¥å¾—åˆ°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¤ä¸ºï¼Œå¦‚æœæŒ‰ç…§ä¸»é”®çš„é€’å¢é¡ºåºæŸ¥è¯¢çš„è¯ï¼Œå¯¹ç£ç›˜çš„è¯»æ¯”è¾ƒæ¥è¿‘é¡ºåºè¯»ï¼Œèƒ½å¤Ÿæå‡è¯»æ€§èƒ½ã€‚</p>
</blockquote>
<p>ä»¥ä¸Šï¼Œå°±æ˜¯ MRR ä¼˜åŒ–çš„è®¾è®¡æ€è·¯ã€‚æ­¤æ—¶ï¼Œè¯­å¥çš„æ‰§è¡Œæµç¨‹å˜æˆäº†è¿™æ ·ï¼š</p>
<p>1ï¸âƒ£ æ ¹æ®ç´¢å¼• aï¼Œå®šä½åˆ°æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå°† id å€¼æ”¾å…¥ read_rnd_buffer ä¸­ ; (å¦‚æœread_rnd_buffer æ”¾ç½®æ»¡äº†ï¼Œå°±ä¼šå…ˆæ‰§è¡Œ 2,3æ­¥éª¤)</p>
<p>2ï¸âƒ£ å°† read_rnd_buffer ä¸­çš„ id è¿›è¡Œé€’å¢æ’åºï¼›</p>
<p>3ï¸âƒ£ æ’åºåçš„ id æ•°ç»„ï¼Œä¾æ¬¡åˆ°ä¸»é”® id ç´¢å¼•ä¸­æŸ¥è®°å½•ï¼Œå¹¶ä½œä¸ºç»“æœè¿”å›ã€‚</p>
<p align="center">
  <img src="/2023/09/30/mysql/40.jpg" width="90%" alt="Your image description">
</p>
<p>MRR èƒ½å¤Ÿæå‡æ€§èƒ½çš„æ ¸å¿ƒåœ¨äºï¼Œè¿™æ¡æŸ¥è¯¢è¯­å¥åœ¨ç´¢å¼• a ä¸Šåšçš„æ˜¯ä¸€ä¸ªèŒƒå›´æŸ¥è¯¢ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¤šå€¼æŸ¥è¯¢ï¼‰ï¼Œå¯ä»¥å¾—åˆ°è¶³å¤Ÿå¤šçš„ä¸»é”® idã€‚è¿™æ ·é€šè¿‡æ’åºä»¥åï¼Œå†å»ä¸»é”®ç´¢å¼•æŸ¥æ•°æ®ï¼Œæ‰èƒ½ä½“ç°å‡ºâ€œé¡ºåºæ€§â€çš„ä¼˜åŠ¿ã€‚</p>
<h2 id="35-2-Batched-Key-Access">35.2-Batched Key Access</h2>
<p>Batched Key Accesssï¼ˆBKAï¼‰ç®—æ³•ï¼Œå…¶å®æ˜¯å¯¹ NLJ(Index Nested Loop Join) ç®—æ³•çš„ä¼˜åŒ–ï¼ŒNLJçš„é€»è¾‘æ˜¯ï¼Œä»é©±åŠ¨è¡¨t1ï¼Œä¸€è¡Œè¡Œå–å‡ºaçš„å€¼ï¼Œå†åˆ°è¢«é©±åŠ¨è¡¨t2åšjoinï¼Œå¯¹äºè¡¨ t2 æ¥è¯´ï¼Œæ¯æ¬¡éƒ½æ˜¯åŒ¹é…ä¸€ä¸ªå€¼ã€‚è¿™æ—¶ï¼ŒMRR çš„ä¼˜åŠ¿å°±ç”¨ä¸ä¸Šäº†ï¼Œè€ŒBKAçš„é€»è¾‘æ˜¯ï¼Œå°†è¡¨t1çš„æ•°æ®å–å‡ºæ¥ä¸€éƒ¨åˆ†ï¼Œæ”¾ç½®åˆ°join_bufferä¸­ï¼Œç„¶åä¸€èµ·ä¼ ç»™è¡¨t2ã€‚</p>
<p align="center">
  <img src="/2023/09/30/mysql/41.jpg" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<p>Post Script : BKA ç®—æ³•çš„ä¼˜åŒ–è¦ä¾èµ–äº MRRï¼Œä½¿ç”¨BKAçš„å‰ææ˜¯å¼€å¯äº† MRR</p>
<h1>36-ä¸ºä»€ä¹ˆä¸´æ—¶è¡¨å¯ä»¥é‡åï¼Ÿ</h1>
<h4 id="è¯´è¯´ä¸´æ—¶è¡¨å’Œå†…å­˜è¡¨çš„åŒºåˆ«ï¼Ÿ">è¯´è¯´ä¸´æ—¶è¡¨å’Œå†…å­˜è¡¨çš„åŒºåˆ«ï¼Ÿ</h4>
<p>å†…å­˜è¡¨ï¼ŒæŒ‡çš„æ˜¯ä½¿ç”¨ Memory å¼•æ“çš„è¡¨ï¼Œå»ºè¡¨è¯­æ³•æ˜¯ <code>create table â€¦ engine=memory</code>ã€‚è¿™ç§è¡¨çš„æ•°æ®éƒ½ä¿å­˜åœ¨å†…å­˜é‡Œï¼Œç³»ç»Ÿé‡å¯çš„æ—¶å€™ä¼šè¢«æ¸…ç©ºï¼Œä½†æ˜¯è¡¨ç»“æ„è¿˜åœ¨</p>
<p>ä¸´æ—¶è¡¨ï¼Œå¯ä»¥ä½¿ç”¨å„ç§å¼•æ“ç±»å‹ ã€‚å¦‚æœæ˜¯ä½¿ç”¨ InnoDB å¼•æ“æˆ–è€… MyISAM å¼•æ“çš„ä¸´æ—¶è¡¨ï¼Œå†™æ•°æ®çš„æ—¶å€™æ˜¯å†™åˆ°ç£ç›˜ä¸Šçš„ã€‚å½“ç„¶ï¼Œä¸´æ—¶è¡¨ä¹Ÿå¯ä»¥ä½¿ç”¨ Memory å¼•æ“</p>
<h4 id="ä¸´æ—¶è¡¨æœ‰å“ªäº›ç‰¹æ€§ï¼Ÿ">ä¸´æ—¶è¡¨æœ‰å“ªäº›ç‰¹æ€§ï¼Ÿ</h4>
<p align="center">
  <img src="/2023/09/30/mysql/42.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<ol>
<li class="lvl-3">
<p>å»ºè¡¨è¯­æ³•æ˜¯ <code>create temporary table â€¦</code></p>
</li>
<li class="lvl-3">
<p>ä¸€ä¸ªä¸´æ—¶è¡¨åªèƒ½è¢«åˆ›å»ºå®ƒçš„ session è®¿é—®ï¼Œå¯¹å…¶ä»–çº¿ç¨‹ä¸å¯è§ã€‚æ‰€ä»¥ï¼Œå›¾ä¸­ session A åˆ›å»ºçš„ä¸´æ—¶è¡¨ tï¼Œå¯¹äº session B å°±æ˜¯ä¸å¯è§çš„</p>
</li>
<li class="lvl-3">
<p>ä¸´æ—¶è¡¨å¯ä»¥ä¸æ™®é€šè¡¨åŒå</p>
</li>
<li class="lvl-3">
<p>session A å†…æœ‰åŒåçš„ä¸´æ—¶è¡¨å’Œæ™®é€šè¡¨çš„æ—¶å€™ï¼Œshow create è¯­å¥ï¼Œä»¥åŠå¢åˆ æ”¹æŸ¥è¯­å¥è®¿é—®çš„æ˜¯ä¸´æ—¶è¡¨</p>
</li>
<li class="lvl-3">
<p>show tables å‘½ä»¤ä¸æ˜¾ç¤ºä¸´æ—¶è¡¨</p>
</li>
</ol>
<p>ç”±äºä¸´æ—¶è¡¨åªèƒ½è¢«åˆ›å»ºå®ƒçš„ session è®¿é—®ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ª session ç»“æŸçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åˆ é™¤ä¸´æ—¶è¡¨ã€‚ä¹Ÿæ­£æ˜¯ç”±äºè¿™ä¸ªç‰¹æ€§ï¼Œä¸´æ—¶è¡¨å°±ç‰¹åˆ«é€‚åˆæˆ‘ä»¬æ–‡ç« å¼€å¤´çš„ join ä¼˜åŒ–è¿™ç§åœºæ™¯ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼ŸåŸå› ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š</p>
<ol>
<li class="lvl-3">
<p>ä¸åŒ session çš„ä¸´æ—¶è¡¨æ˜¯å¯ä»¥é‡åçš„ï¼Œå¦‚æœæœ‰å¤šä¸ª session åŒæ—¶æ‰§è¡Œ join ä¼˜åŒ–ï¼Œä¸éœ€è¦æ‹…å¿ƒè¡¨åé‡å¤å¯¼è‡´å»ºè¡¨å¤±è´¥çš„é—®é¢˜</p>
</li>
<li class="lvl-3">
<p>ä¸éœ€è¦æ‹…å¿ƒæ•°æ®åˆ é™¤é—®é¢˜ã€‚å¦‚æœä½¿ç”¨æ™®é€šè¡¨ï¼Œåœ¨æµç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å®¢æˆ·ç«¯å‘ç”Ÿäº†å¼‚å¸¸æ–­å¼€ï¼Œæˆ–è€…æ•°æ®åº“å‘ç”Ÿå¼‚å¸¸é‡å¯ï¼Œè¿˜éœ€è¦ä¸“é—¨æ¥æ¸…ç†ä¸­é—´è¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ•°æ®è¡¨ã€‚è€Œä¸´æ—¶è¡¨ç”±äºä¼šè‡ªåŠ¨å›æ”¶ï¼Œæ‰€ä»¥ä¸éœ€è¦è¿™ä¸ªé¢å¤–çš„æ“ä½œ</p>
</li>
</ol>
<h1>37-ä»€ä¹ˆæ—¶å€™ä¼šä½¿ç”¨å†…éƒ¨ä¸´æ—¶è¡¨ï¼Ÿ</h1>
<h1>38-éƒ½è¯´<code>InnoDB</code>å¥½ï¼Œé‚£è¿˜è¦ä¸è¦ä½¿ç”¨Memoryå¼•æ“ï¼Ÿ</h1>
<p><code>show processlist</code> å‘½ä»¤çš„ä½œç”¨ï¼šå¯ä»¥å¸®åŠ©ç¡®å®šå“ªäº›æŸ¥è¯¢å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå¸¸ç”¨è¯­è°ƒè¯•MySQLæ€§èƒ½æˆ–é”é—®é¢˜ï¼Œå…¶è¾“å‡ºåˆ—çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>Id</strong>ï¼šè¿æ¥çš„å”¯ä¸€æ ‡è¯†ç¬¦</p>
</li>
<li class="lvl-2">
<p><strong>User</strong>ï¼šå»ºç«‹æ­¤è¿æ¥çš„MySQLç”¨æˆ·</p>
</li>
<li class="lvl-2">
<p><strong>Host</strong>ï¼šç”¨æˆ·è¿æ¥åˆ°MySQLæœåŠ¡å™¨çš„æœºå™¨æˆ–IPåœ°å€</p>
</li>
<li class="lvl-2">
<p><strong>db</strong>ï¼šå½“å‰è¿æ¥ä½¿ç”¨çš„æ•°æ®åº“ã€‚å¯èƒ½ä¸ºç©ºï¼Œå¦‚æœæ²¡æœ‰é€‰æ‹©æ•°æ®åº“</p>
</li>
<li class="lvl-2">
<p><strong>Command</strong>ï¼šæ‰§è¡Œçš„å‘½ä»¤ï¼Œå¦‚ Queryï¼ˆæŸ¥è¯¢ï¼‰, Sleepï¼ˆä¼‘çœ ï¼‰, etc.</p>
</li>
<li class="lvl-2">
<p><strong>Time</strong>ï¼šå‘½ä»¤å·²ç»è¿è¡Œçš„ç§’æ•°</p>
</li>
<li class="lvl-2">
<p><strong>State</strong>ï¼šè¿æ¥çš„å½“å‰çŠ¶æ€ï¼Œå¦‚<code>Waiting for table lock</code></p>
</li>
<li class="lvl-2">
<p><strong>Info</strong>ï¼šå…·ä½“æ‰§è¡Œçš„æŸ¥è¯¢æˆ–å‘½ä»¤ã€‚å¯¹äºéæŸ¥è¯¢å‘½ä»¤ï¼Œæ­¤åˆ—å¯èƒ½ä¸ºç©º</p>
</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- t1è¡¨ä½¿ç”¨å†…å­˜è¡¨ï¼ŒMemoryå­˜å‚¨å¼•æ“</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1(id <span class="type">int</span> <span class="keyword">primary</span> key, c <span class="type">int</span>) engine<span class="operator">=</span>Memory;</span><br><span class="line"><span class="comment">-- t2è¡¨ä½¿ç”¨innodbå­˜å‚¨å¼•æ“</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t2(id <span class="type">int</span> <span class="keyword">primary</span> key, c <span class="type">int</span>) engine<span class="operator">=</span>innodb;</span><br><span class="line"><span class="comment">-- å‘ t1å’Œt2æ’å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">3</span>),(<span class="number">4</span>,<span class="number">4</span>),(<span class="number">5</span>,<span class="number">5</span>),(<span class="number">6</span>,<span class="number">6</span>),(<span class="number">7</span>,<span class="number">7</span>),(<span class="number">8</span>,<span class="number">8</span>),(<span class="number">9</span>,<span class="number">9</span>),(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t2 <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">3</span>),(<span class="number">4</span>,<span class="number">4</span>),(<span class="number">5</span>,<span class="number">5</span>),(<span class="number">6</span>,<span class="number">6</span>),(<span class="number">7</span>,<span class="number">7</span>),(<span class="number">8</span>,<span class="number">8</span>),(<span class="number">9</span>,<span class="number">9</span>),(<span class="number">0</span>,<span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>
<h2 id="38-1-å†…å­˜è¡¨çš„æ•°æ®ç»„ç»‡æ–¹å¼">38.1-å†…å­˜è¡¨çš„æ•°æ®ç»„ç»‡æ–¹å¼</h2>
<p align="center">
  <img src="/2023/09/30/mysql/53.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<p align="center">
  <img src="/2023/09/30/mysql/54.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<p>ğŸ…°ï¸ InnoDB å¼•æ“æŠŠæ•°æ®æ”¾åœ¨ä¸»é”®ç´¢å¼•ä¸Šï¼Œå…¶ä»–ç´¢å¼•ä¸Šä¿å­˜çš„æ˜¯ä¸»é”® idã€‚è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºç´¢å¼•ç»„ç»‡è¡¨ï¼ˆIndex Organizied Tableï¼‰</p>
<p>ğŸ…±ï¸ è€Œ Memory å¼•æ“é‡‡ç”¨çš„æ˜¯æŠŠæ•°æ®å•ç‹¬å­˜æ”¾ï¼Œç´¢å¼•ä¸Šä¿å­˜æ•°æ®ä½ç½®çš„æ•°æ®ç»„ç»‡å½¢å¼ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå †ç»„ç»‡è¡¨ï¼ˆHeap Organizied Tableï¼‰</p>
<p>2ç§å¼•æ“æ¯”å¯¹çš„å·®å¼‚å¦‚ä¸‹ï¼š</p>
<ol>
<li class="lvl-3">
<p>InnoDB è¡¨çš„æ•°æ®æ€»æ˜¯æœ‰åºå­˜æ”¾çš„ï¼Œè€Œå†…å­˜è¡¨çš„æ•°æ®å°±æ˜¯æŒ‰ç…§å†™å…¥é¡ºåºå­˜æ”¾çš„</p>
</li>
<li class="lvl-3">
<p>å½“æ•°æ®æ–‡ä»¶æœ‰ç©ºæ´çš„æ—¶å€™ï¼ŒInnoDB è¡¨åœ¨æ’å…¥æ–°æ•°æ®çš„æ—¶å€™ï¼Œä¸ºäº†ä¿è¯æ•°æ®æœ‰åºæ€§ï¼Œåªèƒ½åœ¨å›ºå®šçš„ä½ç½®å†™å…¥æ–°å€¼ï¼Œè€Œå†…å­˜è¡¨æ‰¾åˆ°ç©ºä½å°±å¯ä»¥æ’å…¥æ–°å€¼</p>
</li>
<li class="lvl-3">
<p>æ•°æ®ä½ç½®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼ŒInnoDB è¡¨åªéœ€è¦ä¿®æ”¹ä¸»é”®ç´¢å¼•ï¼Œè€Œå†…å­˜è¡¨éœ€è¦ä¿®æ”¹æ‰€æœ‰ç´¢å¼•</p>
</li>
<li class="lvl-3">
<p>InnoDB è¡¨ç”¨ä¸»é”®ç´¢å¼•æŸ¥è¯¢æ—¶éœ€è¦èµ°ä¸€æ¬¡ç´¢å¼•æŸ¥æ‰¾ï¼Œç”¨æ™®é€šç´¢å¼•æŸ¥è¯¢çš„æ—¶å€™ï¼Œéœ€è¦èµ°ä¸¤æ¬¡ç´¢å¼•æŸ¥æ‰¾ã€‚è€Œå†…å­˜è¡¨æ²¡æœ‰è¿™ä¸ªåŒºåˆ«ï¼Œæ‰€æœ‰ç´¢å¼•çš„â€œåœ°ä½â€éƒ½æ˜¯ç›¸åŒçš„</p>
</li>
<li class="lvl-3">
<p>InnoDB æ”¯æŒå˜é•¿æ•°æ®ç±»å‹ï¼Œä¸åŒè®°å½•çš„é•¿åº¦å¯èƒ½ä¸åŒï¼›å†…å­˜è¡¨ä¸æ”¯æŒ Blob å’Œ Text å­—æ®µï¼Œå¹¶ä¸”å³ä½¿å®šä¹‰äº† varchar(N)ï¼Œå®é™…ä¹Ÿå½“ä½œ char(N)ï¼Œä¹Ÿå°±æ˜¯å›ºå®šé•¿åº¦å­—ç¬¦ä¸²æ¥å­˜å‚¨ï¼Œå› æ­¤å†…å­˜è¡¨çš„æ¯è¡Œæ•°æ®é•¿åº¦ç›¸åŒ</p>
</li>
</ol>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- æœ€å¼€å§‹æ’å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">3</span>),(<span class="number">4</span>,<span class="number">4</span>),(<span class="number">5</span>,<span class="number">5</span>),(<span class="number">6</span>,<span class="number">6</span>),(<span class="number">7</span>,<span class="number">7</span>),(<span class="number">8</span>,<span class="number">8</span>),(<span class="number">9</span>,<span class="number">9</span>),(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="comment">-- æŸ¥è¯¢ç»“æœ</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;</span><br><span class="line"><span class="comment">-- åˆ é™¤id=5çš„æ•°æ®</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> id<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"><span class="comment">-- id=10å¡«å……åŸæœ¬id=5çš„ä½ç½®ï¼Œç”±äºå†…å­˜è¡¨ä¸­æ¯ä¸ªæ•°æ®è¡Œè¢«åˆ é™¤ä»¥åï¼Œç©ºå‡ºçš„è¿™ä¸ªä½ç½®éƒ½å¯ä»¥è¢«æ¥ä¸‹æ¥è¦æ’å…¥çš„æ•°æ®å¤ç”¨</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span>(<span class="number">10</span>,<span class="number">10</span>);</span><br><span class="line"><span class="comment">-- æŸ¥è¯¢ç»“æœ</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="38-2-å†…å­˜è¡¨çš„å“ˆå¸Œç´¢å¼•å’ŒB-Treeç´¢å¼•">38.2-å†…å­˜è¡¨çš„å“ˆå¸Œç´¢å¼•å’ŒB-Treeç´¢å¼•</h2>
<p>t1 çš„è¿™ä¸ªä¸»é”®ç´¢å¼•æ˜¯å“ˆå¸Œç´¢å¼•ï¼Œæ‰§è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œå®é™…èµ°çš„æ˜¯å…¨è¡¨æ‰«æï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥ä½¿å¾—å†…å­˜è¡¨æ”¯æŒB-Treeç´¢å¼•</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- åœ¨ id åˆ—ä¸Šåˆ›å»ºä¸€ä¸ª B-Tree ç´¢å¼•</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t1 <span class="keyword">add</span> index a_btree_index <span class="keyword">using</span> btree (id);</span><br></pre></td></tr></tbody></table></figure>
<p align="center">
  <img src="/2023/09/30/mysql/55.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<p>å†…å­˜è¡¨çš„ä¼˜åŠ¿æ˜¯é€Ÿåº¦å¿«ï¼Œé€Ÿåº¦å¿«çš„2ç‚¹ï¼š</p>
<p>ğŸ…°ï¸  Memory å¼•æ“æ”¯æŒ hash ç´¢å¼•</p>
<p>ğŸ…±ï¸  å†…å­˜è¡¨çš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨å†…å­˜ï¼Œè€Œå†…å­˜çš„è¯»å†™é€Ÿåº¦æ€»æ˜¯æ¯”ç£ç›˜å¿«</p>
<h2 id="38-3-å†…å­˜è¡¨çš„é”">38.3-å†…å­˜è¡¨çš„é”</h2>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"># è®©è¿”å›çš„æ•°æ®ç¡ä¸€ä¼š</span><br><span class="line"><span class="keyword">select</span> sleep(<span class="number">2</span>) <span class="keyword">as</span> sleep_interval , <span class="number">3</span></span><br></pre></td></tr></tbody></table></figure>
<p>å†…å­˜è¡¨ä¸æ”¯æŒè¡Œé”ï¼Œåªæ”¯æŒè¡¨é”ã€‚å› æ­¤ï¼Œä¸€å¼ è¡¨åªè¦æœ‰æ›´æ–°ï¼Œå°±ä¼šå µä½å…¶ä»–æ‰€æœ‰åœ¨è¿™ä¸ªè¡¨ä¸Šçš„è¯»å†™æ“ä½œ</p>
<p align="center">
  <img src="/2023/09/30/mysql/56.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<h2 id="38-4-å†…å­˜è¡¨çš„æŒä¹…æ€§">38.4-å†…å­˜è¡¨çš„æŒä¹…æ€§</h2>
<p align="center">
  <img src="/2023/09/30/mysql/57.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<p align="center">
  <img src="/2023/09/30/mysql/58.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<p>åŸºäºä»¥ä¸Šçš„åˆ†æï¼Œæˆ‘ä»¬å¾—å‡ºç»“è®ºï¼š<strong>å†…å­˜è¡¨å¹¶ä¸é€‚åˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸Šä½œä¸ºæ™®é€šæ•°æ®è¡¨ä½¿ç”¨</strong></p>
<h1>39-è‡ªå¢ä¸»é”®ä¸ºä»€ä¹ˆä¸æ˜¯è¿ç»­çš„ï¼Ÿ</h1>
<p>è‡ªå¢ä¸»é”®æ˜¯é€’å¢çš„ï¼Œä½†æ˜¯ä¸ä¸€å®šè¿ç»­ã€‚ä¸»é”®çš„é€’å¢ç‰¹æ€§é¿å…äº†é¡µåˆ†è£‚</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `t` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span> auto_increment,</span><br><span class="line">  `c` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">  `d` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  <span class="keyword">unique</span> key `c` (`c`)</span><br><span class="line">) engine<span class="operator">=</span>innodb;</span><br></pre></td></tr></tbody></table></figure>
<p>è¡¨çš„ç»“æ„å®šä¹‰å­˜æ”¾åœ¨åç¼€åä¸º<code>.frm</code> çš„æ–‡ä»¶åé¢ï¼Œåœ¨è¿™ä¸ªç©ºè¡¨ t é‡Œé¢æ‰§è¡Œ <code>insert into t values(null, 1, 1);</code> æ’å…¥ä¸€è¡Œæ•°æ®ï¼Œå†æ‰§è¡Œ <code>show create table</code> å‘½ä»¤ï¼Œå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ç»“æœ</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `c` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `d` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `c` (`c`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="comment">-- AUTO_INCREMENT=2ï¼Œè¡¨ç¤ºä¸‹ä¸€æ¬¡æ’å…¥æ•°æ®æ—¶ï¼Œå¦‚æœéœ€è¦è‡ªåŠ¨ç”Ÿæˆè‡ªå¢å€¼ï¼Œä¼šç”Ÿæˆ id=2</span></span><br></pre></td></tr></tbody></table></figure>
<p>InnoDB å¼•æ“çš„è‡ªå¢å€¼ï¼Œå…¶å®æ˜¯ä¿å­˜åœ¨äº†å†…å­˜é‡Œï¼Œå¹¶ä¸”åˆ°äº† MySQL 8.0 ç‰ˆæœ¬åï¼Œæ‰æœ‰äº†â€œè‡ªå¢å€¼æŒä¹…åŒ–â€çš„èƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯æ‰å®ç°äº†â€œå¦‚æœå‘ç”Ÿé‡å¯ï¼Œè¡¨çš„è‡ªå¢å€¼å¯ä»¥æ¢å¤ä¸º MySQL é‡å¯å‰çš„å€¼â€ï¼Œå…·ä½“æƒ…å†µæ˜¯ï¼š</p>
<ol>
<li class="lvl-3">
<p>åœ¨ MySQL 5.7 åŠä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè‡ªå¢å€¼ä¿å­˜åœ¨å†…å­˜é‡Œï¼Œå¹¶æ²¡æœ‰æŒä¹…åŒ–ã€‚æ¯æ¬¡é‡å¯åï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€è¡¨çš„æ—¶å€™ï¼Œéƒ½ä¼šå»æ‰¾è‡ªå¢å€¼çš„æœ€å¤§å€¼ max(id)ï¼Œç„¶åå°† <code>max(id)+1</code> ä½œä¸ºè¿™ä¸ªè¡¨å½“å‰çš„è‡ªå¢å€¼ã€‚ï¿½ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªè¡¨å½“å‰æ•°æ®è¡Œé‡Œæœ€å¤§çš„ id æ˜¯ 10ï¼ŒAUTO_INCREMENT=11ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬åˆ é™¤ id=10 çš„è¡Œï¼ŒAUTO_INCREMENT è¿˜æ˜¯ 11ã€‚ä½†å¦‚æœé©¬ä¸Šé‡å¯å®ä¾‹ï¼Œé‡å¯åè¿™ä¸ªè¡¨çš„ AUTO_INCREMENT å°±ä¼šå˜æˆ 10ã€‚</p>
</li>
<li class="lvl-3">
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒMySQL é‡å¯å¯èƒ½ä¼šä¿®æ”¹ä¸€ä¸ªè¡¨çš„ AUTO_INCREMENT çš„å€¼</p>
</li>
<li class="lvl-3">
<p>åœ¨ MySQL 8.0 ç‰ˆæœ¬ï¼Œå°†è‡ªå¢å€¼çš„å˜æ›´è®°å½•åœ¨äº† redo log ä¸­ï¼Œé‡å¯çš„æ—¶å€™ä¾é  redo log æ¢å¤é‡å¯ä¹‹å‰çš„å€¼</p>
</li>
</ol>
<h2 id="39-1-è‡ªå¢å€¼ä¿®æ”¹æœºåˆ¶">39.1-è‡ªå¢å€¼ä¿®æ”¹æœºåˆ¶</h2>
<p>åœ¨ MySQL é‡Œé¢ï¼Œå¦‚æœå­—æ®µ id è¢«å®šä¹‰ä¸º <code>AUTO_INCREMENT</code>ï¼Œåœ¨æ’å…¥ä¸€è¡Œæ•°æ®çš„æ—¶å€™ï¼Œè‡ªå¢å€¼çš„è¡Œä¸ºå¦‚ä¸‹ï¼š</p>
<ol>
<li class="lvl-3">
<p>å¦‚æœæ’å…¥æ•°æ®æ—¶ id å­—æ®µæŒ‡å®šä¸º 0ã€null æˆ–æœªæŒ‡å®šå€¼ï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸ªè¡¨å½“å‰çš„ <code>AUTO_INCREMENT</code> å€¼å¡«åˆ°è‡ªå¢å­—æ®µ</p>
</li>
<li class="lvl-3">
<p>å¦‚æœæ’å…¥æ•°æ®æ—¶ id å­—æ®µæŒ‡å®šäº†å…·ä½“çš„å€¼ï¼Œå°±ç›´æ¥ä½¿ç”¨è¯­å¥é‡ŒæŒ‡å®šçš„å€¼ï¼Œå¯èƒ½ä¼šæ›´æ–° <code>auto_increment_increment</code> çš„å€¼ï¼Œå‡è®¾æŸæ¬¡è¦æ’å…¥çš„å€¼æ˜¯ Xï¼Œå½“å‰çš„è‡ªå¢å€¼æ˜¯ Y</p>
<ol>
<li class="lvl-6">å¦‚æœ X&lt;  Yï¼Œé‚£ä¹ˆè¿™ä¸ªè¡¨çš„è‡ªå¢å€¼ä¸å˜</li>
<li class="lvl-6">å¦‚æœ Xâ‰¥ Yï¼Œå°±éœ€è¦æŠŠå½“å‰è‡ªå¢å€¼ä¿®æ”¹ä¸ºæ–°çš„è‡ªå¢å€¼ ï¼ˆä» <code>auto_increment_offset</code> å¼€å§‹ï¼Œä»¥ <code>auto_increment_increment </code>ä¸ºæ­¥é•¿(é»˜è®¤è®¾ç½®ä¸º1)ï¼ŒæŒç»­å åŠ ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äº X çš„å€¼ï¼Œä½œä¸ºæ–°çš„è‡ªå¢å€¼ï¼‰</li>
</ol>
</li>
</ol>
<p>å°è¯•æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œè¿›è¡Œæµ‹è¯•</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"># ç¬¬ä¸€æ¬¡æ‰§è¡Œæ’å…¥</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"># è§‚å¯Ÿ AUTO_INCREMENT çš„å€¼</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t;</span><br><span class="line"></span><br><span class="line"># ç¬¬äºŒæ¬¡æ‰§è¡Œæ’å…¥</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line"># è§‚å¯Ÿ AUTO_INCREMENT çš„å€¼</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t;</span><br><span class="line"></span><br><span class="line"># ç¬¬ä¸‰æ¬¡æ‰§è¡Œæ’å…¥</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="number">99</span>, <span class="number">99</span>, <span class="number">99</span>);</span><br><span class="line"># è§‚å¯Ÿ AUTO_INCREMENT çš„å€¼</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä¼šè§‚å¯Ÿåˆ° id ä¸åœ¨è¿ç»­äº†</span></span><br></pre></td></tr></tbody></table></figure>
<p>å½“ <code>auto_increment_offset</code> å’Œ <code>auto_increment_increment</code> éƒ½æ˜¯ 1 çš„æ—¶å€™ï¼Œæ–°çš„è‡ªå¢å€¼ç”Ÿæˆé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯ï¼š</p>
<ol>
<li class="lvl-3">
<p>å¦‚æœå‡†å¤‡æ’å…¥çš„å€¼ &gt;= å½“å‰è‡ªå¢å€¼ï¼Œæ–°çš„è‡ªå¢å€¼å°±æ˜¯â€œå‡†å¤‡æ’å…¥çš„å€¼ +1â€</p>
</li>
<li class="lvl-3">
<p>å¦åˆ™ï¼Œè‡ªå¢å€¼ä¸å˜</p>
</li>
</ol>
<h2 id="39-2-è‡ªå¢å€¼çš„ä¿®æ”¹æ—¶æœº">39.2-è‡ªå¢å€¼çš„ä¿®æ”¹æ—¶æœº</h2>
<p>ç›®å‰ï¼Œå‡è®¾è¡¨ t é‡Œé¢å·²ç»æœ‰äº† (1,1,1) è¿™æ¡è®°å½•ï¼Œè¿™æ—¶æˆ‘å†æ‰§è¡Œä¸€æ¡æ’å…¥æ•°æ®å‘½ä»¤<code>insert into t values(null, 1, 1); </code></p>
<p align="center">
  <img src="/2023/09/30/mysql/51.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<p>äº‹åŠ¡å›æ»šä¹Ÿä¼šå¯¼è‡´é€æ¸ä¸è¿ç»­</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">rollback</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>æ’å…¥çš„è¡Œæ˜¯(<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="è‡ªå¢å€¼ä¸ºä»€ä¹ˆä¸èƒ½å›é€€">è‡ªå¢å€¼ä¸ºä»€ä¹ˆä¸èƒ½å›é€€?</h3>
<p>å‡è®¾æœ‰ä¸¤ä¸ªå¹¶è¡Œæ‰§è¡Œçš„äº‹åŠ¡ï¼Œåœ¨ç”³è¯·è‡ªå¢å€¼çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…ä¸¤ä¸ªäº‹åŠ¡ç”³è¯·åˆ°ç›¸åŒçš„è‡ªå¢ idï¼Œè‚¯å®šè¦åŠ é”ï¼Œç„¶åé¡ºåºç”³è¯·</p>
<ol>
<li class="lvl-3">
<p>å‡è®¾äº‹åŠ¡ A ç”³è¯·åˆ°äº† id=2ï¼Œ äº‹åŠ¡ B ç”³è¯·åˆ° id=3ï¼Œé‚£ä¹ˆè¿™æ—¶å€™è¡¨ t çš„è‡ªå¢å€¼æ˜¯ 4ï¼Œä¹‹åç»§ç»­æ‰§è¡Œ</p>
</li>
<li class="lvl-3">
<p>äº‹åŠ¡ B æ­£ç¡®æäº¤äº†ï¼Œä½†äº‹åŠ¡ A å‡ºç°äº†å”¯ä¸€é”®å†²çª</p>
</li>
<li class="lvl-3">
<p>å¦‚æœå…è®¸äº‹åŠ¡ A æŠŠè‡ªå¢ id å›é€€ï¼Œä¹Ÿå°±æ˜¯æŠŠè¡¨ t çš„å½“å‰è‡ªå¢å€¼æ”¹å› 2ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µï¼šè¡¨é‡Œé¢å·²ç»æœ‰ id=3 çš„è¡Œï¼Œè€Œå½“å‰çš„è‡ªå¢ id å€¼æ˜¯ 2</p>
</li>
<li class="lvl-3">
<p>æ¥ä¸‹æ¥ï¼Œç»§ç»­æ‰§è¡Œçš„å…¶ä»–äº‹åŠ¡å°±ä¼šç”³è¯·åˆ° id=2ï¼Œç„¶åå†ç”³è¯·åˆ° id=3ã€‚è¿™æ—¶ï¼Œå°±ä¼šå‡ºç°æ’å…¥è¯­å¥æŠ¥é”™â€œä¸»é”®å†²çªâ€</p>
</li>
</ol>
<p>è€Œä¸ºäº†è§£å†³è¿™ä¸ªä¸»é”®å†²çªï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<p>ğŸ…°ï¸ æ¯æ¬¡ç”³è¯· id ä¹‹å‰ï¼Œå…ˆåˆ¤æ–­è¡¨é‡Œé¢æ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ª idã€‚å¦‚æœå­˜åœ¨ï¼Œå°±è·³è¿‡è¿™ä¸ª idã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•çš„æˆæœ¬å¾ˆé«˜ã€‚å› ä¸ºï¼Œæœ¬æ¥ç”³è¯· id æ˜¯ä¸€ä¸ªå¾ˆå¿«çš„æ“ä½œï¼Œç°åœ¨è¿˜è¦å†å»ä¸»é”®ç´¢å¼•æ ‘ä¸Šåˆ¤æ–­ id æ˜¯å¦å­˜åœ¨ã€‚</p>
<p>ğŸ…±ï¸ æŠŠè‡ªå¢ id çš„é”èŒƒå›´æ‰©å¤§ï¼Œå¿…é¡»ç­‰åˆ°ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆå¹¶æäº¤ï¼Œä¸‹ä¸€ä¸ªäº‹åŠ¡æ‰èƒ½å†ç”³è¯·è‡ªå¢ idã€‚è¿™ä¸ªæ–¹æ³•çš„é—®é¢˜ï¼Œå°±æ˜¯é”çš„ç²’åº¦å¤ªå¤§ï¼Œç³»ç»Ÿå¹¶å‘èƒ½åŠ›å¤§å¤§ä¸‹é™</p>
<p>è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚é€ æˆè¿™äº›éº»çƒ¦çš„ç½ªé­ç¥¸é¦–ï¼Œå°±æ˜¯æˆ‘ä»¬å‡è®¾çš„è¿™ä¸ªâ€œå…è®¸è‡ªå¢ id å›é€€â€çš„å‰æå¯¼è‡´çš„ã€‚å› æ­¤ï¼ŒInnoDB æ”¾å¼ƒäº†è¿™ä¸ªè®¾è®¡ï¼Œè¯­å¥æ‰§è¡Œå¤±è´¥ä¹Ÿä¸å›é€€è‡ªå¢ idã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™æ ·ï¼Œæ‰€ä»¥æ‰åªä¿è¯äº†è‡ªå¢ id æ˜¯é€’å¢çš„ï¼Œä½†ä¸ä¿è¯æ˜¯è¿ç»­çš„</p>
<h2 id="39-3-è‡ªå¢é”çš„ä¼˜åŒ–">39.3-è‡ªå¢é”çš„ä¼˜åŒ–</h2>
<p>è‡ªå¢ id é”å¹¶ä¸æ˜¯ä¸€ä¸ªäº‹åŠ¡é”ï¼Œè€Œæ˜¯æ¯æ¬¡ç”³è¯·å®Œå°±é©¬ä¸Šé‡Šæ”¾ï¼Œä»¥ä¾¿å…è®¸åˆ«çš„äº‹åŠ¡å†ç”³è¯·</p>
<p>MySQL 5.1.22 ç‰ˆæœ¬å¼•å…¥äº†æ–°å¢å‚æ•° <code>innodb_autoinc_lock_mode</code>ï¼Œé»˜è®¤å€¼æ˜¯ 1ã€‚</p>
<ol>
<li class="lvl-3">
<p>è¿™ä¸ªå‚æ•°çš„å€¼è¢«è®¾ç½®ä¸º 0 æ—¶ï¼Œè¯­å¥æ‰§è¡Œç»“æŸåæ‰é‡Šæ”¾é”</p>
</li>
<li class="lvl-3">
<p>è¿™ä¸ªå‚æ•°çš„å€¼è¢«è®¾ç½®ä¸º 1 æ—¶ï¼šæ™®é€š <code>insert</code> è¯­å¥ï¼Œè‡ªå¢é”åœ¨ç”³è¯·ä¹‹åå°±é©¬ä¸Šé‡Šæ”¾ï¼›ç±»ä¼¼ <code>insert â€¦ select</code> è¿™æ ·çš„æ‰¹é‡æ’å…¥æ•°æ®çš„è¯­å¥ï¼Œè‡ªå¢é”è¿˜æ˜¯è¦ç­‰è¯­å¥ç»“æŸåæ‰è¢«é‡Šæ”¾</p>
</li>
<li class="lvl-3">
<p>è¿™ä¸ªå‚æ•°çš„å€¼è¢«è®¾ç½®ä¸º 2 æ—¶ï¼Œæ‰€æœ‰çš„ç”³è¯·è‡ªå¢ä¸»é”®çš„åŠ¨ä½œéƒ½æ˜¯ç”³è¯·åå°±é‡Šæ”¾é”</p>
</li>
</ol>
<p align="center">
  <img src="/2023/09/30/mysql/52.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<p>å¦‚æœæˆ‘ä»¬ç°åœ¨çš„ <code>binlog_format=statement</code>ï¼Œbinlog ä¼šæ€ä¹ˆè®°å½•å‘¢ï¼Ÿç”±äºä¸¤ä¸ª session æ˜¯åŒæ—¶æ‰§è¡Œæ’å…¥æ•°æ®å‘½ä»¤çš„ï¼Œæ‰€ä»¥ binlog é‡Œé¢å¯¹è¡¨ t2 çš„æ›´æ–°æ—¥å¿—åªæœ‰ä¸¤ç§æƒ…å†µï¼šè¦ä¹ˆå…ˆè®° session A çš„ï¼Œè¦ä¹ˆå…ˆè®° session B çš„ã€‚ä½†ä¸è®ºæ˜¯å“ªä¸€ç§ï¼Œè¿™ä¸ª binlog æ‹¿å»ä»åº“æ‰§è¡Œï¼Œæˆ–è€…ç”¨æ¥æ¢å¤ä¸´æ—¶å®ä¾‹ï¼Œå¤‡åº“å’Œä¸´æ—¶å®ä¾‹é‡Œé¢ï¼Œsession B è¿™ä¸ªè¯­å¥æ‰§è¡Œå‡ºæ¥ï¼Œç”Ÿæˆçš„ç»“æœé‡Œé¢ï¼Œid éƒ½æ˜¯è¿ç»­çš„ã€‚è¿™æ—¶ï¼Œä»åº“å’Œä¸»åº“å°±å‘ç”Ÿäº†æ•°æ®ä¸ä¸€è‡´</p>
<p>é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p>
<ol>
<li class="lvl-3">
<p>ä¸€ç§æ€è·¯æ˜¯ï¼Œè®©åŸåº“çš„æ‰¹é‡æ’å…¥æ•°æ®è¯­å¥ï¼Œå›ºå®šç”Ÿæˆè¿ç»­çš„ id å€¼ã€‚æ‰€ä»¥ï¼Œ<strong>è‡ªå¢é”ç›´åˆ°è¯­å¥æ‰§è¡Œç»“æŸæ‰é‡Šæ”¾</strong>ï¼Œå°±æ˜¯ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„</p>
</li>
<li class="lvl-3">
<p>å¦ä¸€ç§æ€è·¯æ˜¯ï¼Œåœ¨ binlog é‡Œé¢æŠŠæ’å…¥æ•°æ®çš„æ“ä½œéƒ½å¦‚å®è®°å½•è¿›æ¥ï¼Œåˆ°å¤‡åº“æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸å†ä¾èµ–äºè‡ªå¢ä¸»é”®å»ç”Ÿæˆã€‚è¿™ç§æƒ…å†µï¼Œå…¶å®å°±æ˜¯ <code>innodb_autoinc_lock_mode</code> è®¾ç½®ä¸º 2ï¼ŒåŒæ—¶ <code>binlog_format</code> è®¾ç½®ä¸º rowã€‚</p>
</li>
</ol>
<p>åœ¨ç”Ÿäº§ä¸Šï¼Œå°¤å…¶æ˜¯æœ‰ <code>insert â€¦ select </code> å’Œ <code>replace â€¦ select</code> å’Œ<code> load data</code> è¿™ç§æ‰¹é‡æ’å…¥æ•°æ®çš„åœºæ™¯ï¼Œæ¨èç¬¬2ç§æ–¹å¼ï¼Œè¿™æ ·åšï¼Œæ—¢èƒ½æå‡å¹¶å‘æ€§ï¼Œåˆä¸ä¼šå‡ºç°æ•°æ®ä¸€è‡´æ€§é—®é¢˜</p>
<h3 id="æ‰¹é‡æ’å…¥è¯­å¥ï¼Œè‡ªå¢IDçš„ç­–ç•¥">æ‰¹é‡æ’å…¥è¯­å¥ï¼Œè‡ªå¢IDçš„ç­–ç•¥</h3>
<p>å¯¹äºæ‰¹é‡æ’å…¥æ•°æ®çš„è¯­å¥ï¼ŒMySQL æœ‰ä¸€ä¸ªæ‰¹é‡ç”³è¯·è‡ªå¢ id çš„ç­–ç•¥</p>
<ol>
<li class="lvl-3">
<p>è¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¬¬ä¸€æ¬¡ç”³è¯·è‡ªå¢ idï¼Œä¼šåˆ†é… 1 ä¸ªï¼›</p>
</li>
<li class="lvl-3">
<p>1 ä¸ªç”¨å®Œä»¥åï¼Œè¿™ä¸ªè¯­å¥ç¬¬äºŒæ¬¡ç”³è¯·è‡ªå¢ idï¼Œä¼šåˆ†é… 2 ä¸ªï¼›</p>
</li>
<li class="lvl-3">
<p>2 ä¸ªç”¨å®Œä»¥åï¼Œè¿˜æ˜¯è¿™ä¸ªè¯­å¥ï¼Œç¬¬ä¸‰æ¬¡ç”³è¯·è‡ªå¢ idï¼Œä¼šåˆ†é… 4 ä¸ªï¼›</p>
</li>
<li class="lvl-3">
<p>ä¾æ­¤ç±»æ¨ï¼ŒåŒä¸€ä¸ªè¯­å¥å»ç”³è¯·è‡ªå¢ idï¼Œæ¯æ¬¡ç”³è¯·åˆ°çš„è‡ªå¢ id ä¸ªæ•°éƒ½æ˜¯ä¸Šä¸€æ¬¡çš„ä¸¤å€</p>
</li>
</ol>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">3</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">4</span>,<span class="number">4</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t2 <span class="keyword">like</span> t;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç¬¬ä¸€æ¬¡ç”³è¯·äº†id=1ï¼Œç¬¬äºŒæ¬¡ç”³è¯·äº† id in (2,3)ï¼Œç¬¬ä¸‰æ¬¡ç”³è¯·äº† id in (4,5,6,7) ä½†æ˜¯åªç”¨äº†id=4</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t2(c,d) <span class="keyword">select</span> c,d <span class="keyword">from</span> t; </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t2 <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">5</span>,<span class="number">5</span>);  <span class="comment">-- å®é™…æ’å…¥çš„å€¼ä¸ºï¼ˆ8,5,5ï¼‰</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ€»ç»“ä¸€ä¸‹ï¼ŒIDä¸è¿ç»­çš„åŸå› ï¼š</p>
<ol>
<li class="lvl-3">
<p>äººä¸ºçš„æŒ‡å®šäº†idï¼Œè·³è¿‡äº†ä¸€äº›ID</p>
</li>
<li class="lvl-3">
<p>å”¯ä¸€é”®å†²çª</p>
</li>
<li class="lvl-3">
<p>äº‹åŠ¡å›æ»š</p>
</li>
<li class="lvl-3">
<p>æ‰¹é‡æ’å…¥æ•°æ®çš„æ—¶å€™ï¼Œæ‰¹é‡ç”³è¯·ä½†æ˜¯æ²¡æœ‰ç”¨å®Œ</p>
</li>
</ol>
<h1>40-insertè¯­å¥çš„é”ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤šï¼Ÿ</h1>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `c` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `d` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `c` (`c`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">3</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">4</span>,<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t2 <span class="keyword">like</span> t</span><br></pre></td></tr></tbody></table></figure>
<p>æ•°æ®åº“è®¾ç½®çš„éš”ç¦»çº§åˆ«ä¸ºRRï¼›<code>binlog_format=statement</code></p>
<h2 id="40-1-insert-â€¦-select-è¯­å¥">40.1-insert â€¦ select è¯­å¥</h2>
<p align="center">
  <img src="/2023/09/30/mysql/59.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<p>æ‰§è¡Œ <code>insert â€¦ select</code> çš„æ—¶å€™ï¼Œå¯¹ç›®æ ‡è¡¨ä¹Ÿä¸æ˜¯é”å…¨è¡¨ï¼Œè€Œæ˜¯åªé”ä½éœ€è¦è®¿é—®çš„èµ„æº</p>
<h2 id="40-2-insertå¾ªç¯å†™å…¥">40.2-insertå¾ªç¯å†™å…¥</h2>
<h2 id="40-3-insert-å”¯ä¸€é”®å†²çª">40.3-insert å”¯ä¸€é”®å†²çª</h2>
<h1>41-æ€ä¹ˆæœ€å¿«åœ°å¤åˆ¶ä¸€å¼ è¡¨ï¼Ÿ</h1>
<p>å¦‚æœå¯ä»¥æ§åˆ¶å¯¹æºè¡¨çš„æ‰«æè¡Œæ•°å’ŒåŠ é”èŒƒå›´å¾ˆå°çš„è¯ï¼Œæˆ‘ä»¬ç®€å•åœ°ä½¿ç”¨ <code>insert â€¦ select</code> è¯­å¥å³å¯å®ç°ï¼Œåœ¨2ä¸ªè¡¨ä¸­æ‹·è´æ•°æ®ã€‚å½“ç„¶ï¼Œä¸ºäº†é¿å…å¯¹æºè¡¨åŠ è¯»é”ï¼Œæ›´ç¨³å¦¥çš„æ–¹æ¡ˆæ˜¯å…ˆå°†æ•°æ®å†™åˆ°å¤–éƒ¨æ–‡æœ¬æ–‡ä»¶ï¼Œç„¶åå†å†™å›ç›®æ ‡è¡¨ã€‚è¿™æ—¶ï¼Œæœ‰ä¸¤ç§å¸¸ç”¨çš„æ–¹æ³•</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»ºä¸€ä¸ªè¡¨ `db1.t`</span></span><br><span class="line"><span class="keyword">create</span> database db1;</span><br><span class="line">use db1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t(id <span class="type">int</span> <span class="keyword">primary</span> key, a <span class="type">int</span>, b <span class="type">int</span>, index(a))engine<span class="operator">=</span>innodb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¾€ `db1.t` ä¸­ æ’å…¥ 1000 è¡Œæ•°æ®</span></span><br><span class="line">delimiter ;;</span><br><span class="line">  <span class="keyword">create</span> <span class="keyword">procedure</span> idata()</span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> i <span class="type">int</span>;</span><br><span class="line">    <span class="keyword">set</span> i<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">    while(i<span class="operator">&lt;=</span><span class="number">1000</span>)do</span><br><span class="line">      <span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(i,i,i);</span><br><span class="line">      <span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span> while;</span><br><span class="line">  <span class="keyword">end</span>;;</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="keyword">call</span> idata();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºä¸€ä¸ªå’Œ `db1.t` ç›¸åŒç»“æ„çš„è¡¨ db2.t</span></span><br><span class="line"><span class="keyword">create</span> database db2;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŠŠ `db1.t` é‡Œé¢ a&gt;900 çš„æ•°æ®è¡Œå¯¼å‡ºæ¥ï¼Œæ’å…¥åˆ° db2.t ä¸­</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> db2.t <span class="keyword">like</span> db1.t</span><br></pre></td></tr></tbody></table></figure>
<h2 id="41-1-mysqldump-æ–¹æ³•">41.1-mysqldump æ–¹æ³•</h2>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">mysqldump <span class="operator">-</span>h$host <span class="operator">-</span>P$port <span class="operator">-</span>u$<span class="keyword">user</span> <span class="comment">--add-locks=0 --no-create-info --single-transaction  --set-gtid-purged=OFF db1 t --where="a&gt;900" --result-file=/client_tmp/t.sql</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- â€“skip-extended-insert ç”Ÿæˆå•æ¡çš„ insert è¯­å¥</span></span><br></pre></td></tr></tbody></table></figure>
<p>é€šè¿‡ <code>mysqldump</code> å‘½ä»¤ç”Ÿæˆçš„ t.sql æ–‡ä»¶ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š <code>insert into t values(901,901,901),(902,902,902),(903,903,903).....</code> ã€‚å¾—åˆ°è¯¥æ–‡ä»¶åï¼Œï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹çš„å‘½ä»¤ï¼Œå°† insertè¯­å¥æ”¾åˆ°db2ä¸­æ‰§è¡Œ</p>
<p><code>mysql -h127.0.0.1 -P13000  -uroot db2 -e "source /client_tmp/t.sql"</code></p>
<p><code>source</code> å¹¶ä¸æ˜¯ä¸€æ¡ SQL è¯­å¥ï¼Œè€Œæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯å‘½ä»¤ã€‚mysql å®¢æˆ·ç«¯æ‰§è¡Œè¿™ä¸ªå‘½ä»¤çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li class="lvl-3">
<p>æ‰“å¼€æ–‡ä»¶ï¼Œé»˜è®¤ä»¥åˆ†å·ä¸ºç»“å°¾è¯»å–ä¸€æ¡æ¡çš„ SQL è¯­å¥</p>
</li>
<li class="lvl-3">
<p>å°† SQL è¯­å¥å‘é€åˆ°æœåŠ¡ç«¯æ‰§è¡Œ</p>
</li>
</ol>
<h2 id="41-2-å¯¼å‡º-CSV-æ–‡ä»¶">41.2-å¯¼å‡º CSV æ–‡ä»¶</h2>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> db1.t <span class="keyword">where</span> a<span class="operator">&gt;</span><span class="number">900</span> <span class="keyword">into</span> outfile <span class="string">'/server_tmp/t.csv'</span>;</span><br></pre></td></tr></tbody></table></figure>
<ol>
<li class="lvl-3">
<p>è¿™æ¡è¯­å¥ä¼šå°†ç»“æœä¿å­˜åœ¨æœåŠ¡ç«¯</p>
</li>
<li class="lvl-3">
<p>è¿™æ¡å‘½ä»¤ä¸ä¼šå¸®ä½ è¦†ç›–æ–‡ä»¶ï¼Œå› æ­¤ä½ éœ€è¦ç¡®ä¿ <code>/server_tmp/t.csv</code>è¿™ä¸ªæ–‡ä»¶ä¸å­˜åœ¨</p>
</li>
</ol>
<p>å¾—åˆ°<code>.csv</code> å¯¼å‡ºæ–‡ä»¶åï¼Œä½ å°±å¯ä»¥ç”¨<code> load data</code> å‘½ä»¤å°†æ•°æ®å¯¼å…¥åˆ°ç›®æ ‡è¡¨ db2.t ä¸­</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">load data infile <span class="string">'/server_tmp/t.csv'</span> <span class="keyword">into</span> <span class="keyword">table</span> db2.t;</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥è¯­å¥çš„æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li class="lvl-3">
<p>æ‰“å¼€æ–‡ä»¶ <code>/server_tmp/t.csv</code>ï¼Œä»¥åˆ¶è¡¨ç¬¦ <code>(\t)</code> ä½œä¸ºå­—æ®µé—´çš„åˆ†éš”ç¬¦ï¼Œä»¥æ¢è¡Œç¬¦<code>ï¼ˆ\nï¼‰</code>ä½œä¸ºè®°å½•ä¹‹é—´çš„åˆ†éš”ç¬¦ï¼Œè¿›è¡Œæ•°æ®è¯»å–ï¼›</p>
</li>
<li class="lvl-3">
<p>å¯åŠ¨äº‹åŠ¡ã€‚åˆ¤æ–­æ¯ä¸€è¡Œçš„å­—æ®µæ•°ä¸è¡¨ db2.t æ˜¯å¦ç›¸åŒï¼š</p>
<ol>
<li class="lvl-6">è‹¥ä¸ç›¸åŒï¼Œåˆ™ç›´æ¥æŠ¥é”™ï¼Œäº‹åŠ¡å›æ»šï¼›</li>
<li class="lvl-6">è‹¥ç›¸åŒï¼Œåˆ™æ„é€ æˆä¸€è¡Œï¼Œè°ƒç”¨ InnoDB å¼•æ“æ¥å£ï¼Œå†™å…¥åˆ°è¡¨ä¸­ã€‚</li>
</ol>
</li>
<li class="lvl-3">
<p>é‡å¤æ­¥éª¤ 3ï¼Œç›´åˆ° /server_tmp/t.csv æ•´ä¸ªæ–‡ä»¶è¯»å…¥å®Œæˆï¼Œæäº¤äº‹åŠ¡</p>
</li>
</ol>
<p>å¦‚æœ <code>binlog_format=statement</code>ï¼Œç”±äº <code>/server_tmp/t.csv</code> æ–‡ä»¶åªä¿å­˜åœ¨ä¸»åº“æ‰€åœ¨çš„ä¸»æœºä¸Šï¼Œå¦‚æœåªæ˜¯æŠŠè¿™æ¡è¯­å¥åŸæ–‡å†™åˆ° binlog ä¸­ï¼Œåœ¨å¤‡åº“æ‰§è¡Œçš„æ—¶å€™ï¼Œå¤‡åº“çš„æœ¬åœ°æœºå™¨ä¸Šå¹¶æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œå°±ä¼šå¯¼è‡´ä¸»å¤‡åŒæ­¥åœæ­¢ã€‚æ‰€ä»¥ï¼Œè¿™æ¡è¯­å¥æ‰§è¡Œçš„å®Œæ•´æµç¨‹ï¼Œå¦‚ä¸‹</p>
<p align="center">
  <img src="/2023/09/30/mysql/49.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<p>load data å‘½ä»¤æœ‰ä¸¤ç§ç”¨æ³•ï¼š</p>
<ol>
<li class="lvl-3">
<p>ä¸åŠ â€œlocalâ€ï¼Œæ˜¯è¯»å–æœåŠ¡ç«¯çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¿…é¡»åœ¨ <code>secure_file_priv</code> æŒ‡å®šçš„ç›®å½•æˆ–å­ç›®å½•ä¸‹</p>
</li>
<li class="lvl-3">
<p>åŠ ä¸Šâ€œlocalâ€ï¼Œè¯»å–çš„æ˜¯å®¢æˆ·ç«¯çš„æ–‡ä»¶ï¼Œåªè¦ mysql å®¢æˆ·ç«¯æœ‰è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„æƒé™å³å¯ã€‚è¿™æ—¶å€™ï¼ŒMySQL å®¢æˆ·ç«¯ä¼šå…ˆæŠŠæœ¬åœ°æ–‡ä»¶ä¼ ç»™æœåŠ¡ç«¯ï¼Œç„¶åæ‰§è¡Œä¸Šè¿°çš„ <code>load data</code> æµç¨‹</p>
</li>
<li class="lvl-3">
</li>
</ol>
<h2 id="42-3-ç‰©ç†æ‹·è´æ–¹æ³•">42.3-ç‰©ç†æ‹·è´æ–¹æ³•</h2>
<p><code>dump</code>å’Œå¯¼å‡ºCSVæ–¹å¼ï¼Œéƒ½æ˜¯é€»è¾‘å¯¼æ•°çš„æ–¹å¼ï¼Œå³ï¼šå°†æ•°æ®ä»è¡¨ db1.t ä¸­è¯»å‡ºæ¥ï¼Œç”Ÿæˆæ–‡æœ¬ï¼Œç„¶åå†å†™å…¥ç›®æ ‡è¡¨ db2.t ä¸­ã€‚æœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼ï¼šç›´æ¥æŠŠ db1.t è¡¨çš„.frm æ–‡ä»¶å’Œ.ibd æ–‡ä»¶æ‹·è´åˆ° db2 ç›®å½•ä¸‹å‘¢ï¼Ÿ</p>
<p>ä¸€ä¸ª InnoDB è¡¨ï¼Œé™¤äº†åŒ…å«è¿™ä¸¤ä¸ªç‰©ç†æ–‡ä»¶å¤–ï¼Œè¿˜éœ€è¦åœ¨æ•°æ®å­—å…¸ä¸­æ³¨å†Œã€‚ç›´æ¥æ‹·è´è¿™ä¸¤ä¸ªæ–‡ä»¶çš„è¯ï¼Œå› ä¸ºæ•°æ®å­—å…¸ä¸­æ²¡æœ‰ db2.t è¿™ä¸ªè¡¨ï¼Œç³»ç»Ÿæ˜¯ä¸ä¼šè¯†åˆ«å’Œæ¥å—å®ƒä»¬çš„ï¼Œæ‰€ä»¥ç›´æ¥æ‹·è´çš„æ–¹å¼ä¸å¯è¡Œ</p>
<p>MySQL 5.6 ç‰ˆæœ¬å¼•å…¥äº†å¯ä¼ è¾“è¡¨ç©ºé—´(transportable tablespace) çš„æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡å¯¼å‡º + å¯¼å…¥è¡¨ç©ºé—´çš„æ–¹å¼ï¼Œå®ç°ç‰©ç†æ‹·è´è¡¨çš„åŠŸèƒ½ï¼Œæµç¨‹å¦‚ä¸‹ï¼šç°åœ¨çš„ç›®æ ‡æ˜¯åœ¨ db1 åº“ä¸‹ï¼Œå¤åˆ¶ä¸€ä¸ªè·Ÿè¡¨ t ç›¸åŒçš„è¡¨ r</p>
<p align="center">
  <img src="/2023/09/30/mysql/50.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<h1>42-grantä¹‹åè¦è·Ÿç€flush privilegeså—ï¼Ÿ</h1>
<h2 id="42-1-å…¨å±€æƒé™">42.1-å…¨å±€æƒé™</h2>
<h3 id="mysql-å¦‚ä½•åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Ÿ">mysql å¦‚ä½•åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Ÿ</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»ºä¸€ä¸ªç”¨æˆ·</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'ua'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'pa'</span>; <span class="comment">-- åˆ›å»º1ä¸ªç”¨æˆ·ä¸º 'ua'@'%' çš„ç”¨æˆ· ï¼Œ å¯†ç æ˜¯ pa</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥è¯¢æŸä¸ªç”¨æˆ·</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.user <span class="keyword">where</span> <span class="keyword">User</span> <span class="operator">=</span> <span class="string">'ua'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤ä¸€ä¸ªç”¨æˆ·</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> mysql.user <span class="keyword">where</span> <span class="keyword">User</span> <span class="operator">=</span> <span class="string">'ua'</span>; </span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨MySQLä¸­ï¼Œç”¨æˆ·å (user)+ åœ°å€ (host) æ‰è¡¨ç¤ºä¸€ä¸ªç”¨æˆ·ï¼Œå› æ­¤ <code>ua@ip1</code> å’Œ <code>ua@ip2</code> ä»£è¡¨çš„æ˜¯ä¸¤ä¸ªä¸åŒçš„ç”¨æˆ·</p>
<h3 id="å¦‚ä½•ç»™MySQLä¸­æŸä¸ªç”¨æˆ·èµ‹äºˆæœ€é«˜æƒé™ï¼Ÿ">å¦‚ä½•ç»™MySQLä¸­æŸä¸ªç”¨æˆ·èµ‹äºˆæœ€é«˜æƒé™ï¼Ÿ</h3>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">'ua'</span>@<span class="string">'%'</span> <span class="keyword">with</span> <span class="keyword">grant</span> option;</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥å‘½ä»¤æ‰§è¡Œäº†2ä¸ªåŠ¨ä½œï¼š</p>
<ol>
<li class="lvl-3">
<p>ç£ç›˜ä¸Šï¼Œå°† <code> mysql.user</code> è¡¨é‡Œï¼Œç”¨æˆ·<code>â€™uaâ€™@â€™%'</code>è¿™ä¸€è¡Œçš„æ‰€æœ‰è¡¨ç¤ºæƒé™çš„å­—æ®µçš„å€¼éƒ½ä¿®æ”¹ä¸ºâ€˜Yâ€™ï¼›</p>
</li>
<li class="lvl-3">
<p>å†…å­˜é‡Œï¼Œä»æ•°ç»„ <code>acl_users</code> ä¸­æ‰¾åˆ°è¿™ä¸ªç”¨æˆ·å¯¹åº”çš„å¯¹è±¡ï¼Œå°† access å€¼ï¼ˆæƒé™ä½ï¼‰ä¿®æ”¹ä¸ºäºŒè¿›åˆ¶çš„â€œå…¨ 1â€</p>
</li>
</ol>
<p>åœ¨ grant å‘½ä»¤æ‰§è¡Œå®Œäº†ä¹‹åï¼Œå¦‚æœæ–°çš„å®¢æˆ·ç«¯ä½¿ç”¨ uaç”¨æˆ·ç™»å½•ï¼ŒMySQL ä¼šä¸ºæ–°è¿æ¥ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œç„¶åä» <code>acl_users</code> æ•°ç»„é‡ŒæŸ¥åˆ°è¿™ä¸ªç”¨æˆ·çš„æƒé™ï¼Œå¹¶å°†æƒé™å€¼æ‹·è´åˆ°è¿™ä¸ªçº¿ç¨‹å¯¹è±¡ä¸­ã€‚ä¹‹ååœ¨è¿™ä¸ªè¿æ¥ä¸­æ‰€æœ‰å…³äºå…¨å±€æƒé™çš„åˆ¤æ–­ï¼Œéƒ½ç›´æ¥ä½¿ç”¨çº¿ç¨‹å¯¹è±¡å†…éƒ¨ä¿å­˜çš„æƒé™ä½ã€‚</p>
<p><strong>å¯¹äºä¸€ä¸ªå·²ç»å­˜åœ¨çš„è¿æ¥ï¼Œå®ƒçš„å…¨å±€æƒé™ä¸å— grant å‘½ä»¤çš„å½±å“</strong></p>
<h3 id="mysql-å¦‚ä½•å›æ”¶æƒé™ï¼Ÿ">mysql å¦‚ä½•å›æ”¶æƒé™ï¼Ÿ</h3>
<p>å¦‚æœä¸€ä¸ªç”¨æˆ·æœ‰æ‰€æœ‰æƒé™ï¼Œä¸€èˆ¬å°±ä¸åº”è¯¥è®¾ç½®ä¸ºæ‰€æœ‰ IP åœ°å€éƒ½å¯ä»¥è®¿é—®ï¼Œåº”è¯¥æ˜¯é™åˆ¶æ€§çš„IPå¯ä»¥è®¿é—®</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">revoke</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">from</span> <span class="string">'ua'</span>@<span class="string">'%'</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥å‘½ä»¤å¯¹åº”2ä¸ªåŠ¨ä½œï¼š</p>
<ol>
<li class="lvl-3">
<p>ç£ç›˜ä¸Šï¼Œå°† <code>mysql.user</code> è¡¨é‡Œï¼Œç”¨æˆ·<code>â€™uaâ€™@â€™%'</code>è¿™ä¸€è¡Œçš„æ‰€æœ‰è¡¨ç¤ºæƒé™çš„å­—æ®µçš„å€¼éƒ½ä¿®æ”¹ä¸ºâ€œNâ€</p>
</li>
<li class="lvl-3">
<p>å†…å­˜é‡Œï¼Œä»æ•°ç»„ <code>acl_users</code> ä¸­æ‰¾åˆ°è¿™ä¸ªç”¨æˆ·å¯¹åº”çš„å¯¹è±¡ï¼Œå°† access çš„å€¼ä¿®æ”¹ä¸º 0</p>
</li>
</ol>
<h2 id="42-2-DBæƒé™">42.2-DBæƒé™</h2>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> db1.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">'ua'</span>@<span class="string">'%'</span> <span class="keyword">with</span> <span class="keyword">grant</span> option;</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™æ¡ grant å‘½ä»¤åšäº†å¦‚ä¸‹ä¸¤ä¸ªåŠ¨ä½œï¼š</p>
<ol>
<li class="lvl-3">
<p>ç£ç›˜ä¸Šï¼Œå¾€ <code>mysql.db</code> è¡¨ä¸­æ’å…¥äº†ä¸€è¡Œè®°å½•ï¼Œæ‰€æœ‰æƒé™ä½å­—æ®µè®¾ç½®ä¸ºâ€œYâ€</p>
</li>
<li class="lvl-3">
<p>å†…å­˜é‡Œï¼Œå¢åŠ ä¸€ä¸ªå¯¹è±¡åˆ°æ•°ç»„ <code>acl_dbs</code> ä¸­ï¼Œè¿™ä¸ªå¯¹è±¡çš„æƒé™ä½ä¸ºâ€œå…¨ 1â€</p>
</li>
</ol>
<p>åŸºäºåº“çš„æƒé™è®°å½•ä¿å­˜åœ¨ <code>mysql.db è¡¨</code>ä¸­ï¼Œåœ¨å†…å­˜é‡Œåˆ™ä¿å­˜åœ¨æ•°ç»„ acl_dbsï¼ŒæŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„åº“æƒé™æ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.db <span class="keyword">where</span> <span class="keyword">user</span> <span class="operator">=</span> <span class="string">'ua'</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ¯æ¬¡éœ€è¦åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·å¯¹ä¸€ä¸ªæ•°æ®åº“è¯»å†™æƒé™çš„æ—¶å€™ï¼Œéƒ½éœ€è¦éå†ä¸€æ¬¡ <code>acl_dbs</code> æ•°ç»„ï¼Œæ ¹æ® userã€host å’Œ db æ‰¾åˆ°åŒ¹é…çš„å¯¹è±¡ï¼Œç„¶åæ ¹æ®å¯¹è±¡çš„æƒé™ä½æ¥åˆ¤æ–­ï¼ˆå¹¶æ²¡æœ‰æ‹·è´åˆ°è¿æ¥å¯¹è±¡çš„çº¿ç¨‹å¯¹è±¡ä¸­ï¼‰ã€‚<strong>grant ä¿®æ”¹ db æƒé™çš„æ—¶å€™ï¼Œæ˜¯åŒæ—¶å¯¹ç£ç›˜å’Œå†…å­˜ç”Ÿæ•ˆçš„</strong></p>
<p align="center">
  <img src="/2023/09/30/mysql/43.png" width="100%" alt="Your image description">
  <span style="color:gray"> info about the picture </span>
</p>
<h2 id="42-3-è¡¨åˆ—æƒé™">42.3-è¡¨åˆ—æƒé™</h2>
<p>è¡¨æƒé™å®šä¹‰å­˜æ”¾åœ¨è¡¨ <code>mysql.tables_priv</code> ä¸­ï¼Œåˆ—æƒé™å®šä¹‰å­˜æ”¾åœ¨è¡¨ <code>mysql.columns_priv</code> ä¸­ã€‚è¿™ä¸¤ç±»æƒé™ï¼Œç»„åˆèµ·æ¥å­˜æ”¾åœ¨å†…å­˜çš„ hash ç»“æ„ <code>column_priv_hash</code> ä¸­</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> db1.t1(id <span class="type">int</span>, a <span class="type">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å°†`db1.t1` è¡¨çš„æ‰€æœ‰æƒé™æˆæƒç»™ ua ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> db1.t1 <span class="keyword">to</span> <span class="string">'ua'</span>@<span class="string">'%'</span> <span class="keyword">with</span> <span class="keyword">grant</span> option; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- å°†mydb.mytblçš„æŸ¥è¯¢ idåˆ—æƒé™ï¼Œå’Œ (id,a) çš„æ’å…¥æƒé™ æˆæƒç»™ ua ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>(id), <span class="keyword">INSERT</span> (id,a) <span class="keyword">ON</span> mydb.mytbl <span class="keyword">TO</span> <span class="string">'ua'</span>@<span class="string">'%'</span> <span class="keyword">with</span> <span class="keyword">grant</span> option;</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸¤ä¸ªæƒé™æ¯æ¬¡ <code>grant</code> çš„æ—¶å€™éƒ½ä¼šä¿®æ”¹æ•°æ®è¡¨ï¼Œä¹Ÿä¼šåŒæ­¥ä¿®æ”¹å†…å­˜ä¸­çš„ hash ç»“æ„ã€‚å› æ­¤ï¼Œå¯¹è¿™ä¸¤ç±»æƒé™çš„æ“ä½œï¼Œä¹Ÿä¼šé©¬ä¸Šå½±å“åˆ°å·²ç»å­˜åœ¨çš„è¿æ¥</p>
<h2 id="42-4-flush-privileges-çš„ä½œç”¨">42.4- <code>flush privileges</code> çš„ä½œç”¨</h2>
<p><code>flush privileges</code> å‘½ä»¤ä¼šæ¸…ç©º <code>acl_users</code> æ•°ç»„ï¼Œç„¶åä» <code>mysql.user</code> è¡¨ä¸­è¯»å–æ•°æ®é‡æ–°åŠ è½½ï¼Œé‡æ–°æ„é€ ä¸€ä¸ª <code>acl_users</code> æ•°ç»„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»¥æ•°æ®è¡¨ä¸­çš„æ•°æ®ä¸ºå‡†ï¼Œä¼šå°†å…¨å±€æƒé™å†…å­˜æ•°ç»„é‡æ–°åŠ è½½ä¸€éã€‚åŒæ ·åœ°ï¼Œå¯¹äº db æƒé™ã€è¡¨æƒé™å’Œåˆ—æƒé™ï¼ŒMySQL ä¹Ÿåšäº†è¿™æ ·çš„å¤„ç†</p>
<p>é‚£ä¹ˆ <code>flush privileges</code> çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯ï¼šå½“æ•°æ®è¡¨ä¸­çš„æƒé™æ•°æ®è·Ÿå†…å­˜ä¸­çš„æƒé™æ•°æ®ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œflush privileges è¯­å¥å¯ä»¥ç”¨æ¥é‡å»ºå†…å­˜æ•°æ®ï¼Œè¾¾åˆ°ä¸€è‡´çŠ¶æ€</p>
<p align="center">
  <img src="/2023/09/30/mysql/44.png" width="100%" alt="Your image description">
   <br>
   <span style="color:gray"> info about the picture </span>
</p>
<h1>43-è¦ä¸è¦ä½¿ç”¨åˆ†åŒºè¡¨ï¼Ÿ</h1>
<p>åˆ›å»ºä¸€ä¸ªåˆ†åŒºè¡¨</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `t`</span><br><span class="line">(</span><br><span class="line">    `ftime` datetime <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    `c`     <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">    key (`ftime`)</span><br><span class="line">) engine <span class="operator">=</span> innodb</span><br><span class="line">  <span class="keyword">default</span> charset <span class="operator">=</span> latin1</span><br><span class="line">    <span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">range</span> (<span class="keyword">year</span>(ftime))</span><br><span class="line">        (<span class="keyword">partition</span> p_2017 <span class="keyword">values</span> less than (<span class="number">2017</span>) engine <span class="operator">=</span> innodb,</span><br><span class="line">        <span class="keyword">partition</span> p_2018 <span class="keyword">values</span> less than (<span class="number">2018</span>) engine <span class="operator">=</span> innodb,</span><br><span class="line">        <span class="keyword">partition</span> p_2019 <span class="keyword">values</span> less than (<span class="number">2019</span>) engine <span class="operator">=</span> innodb,</span><br><span class="line">        <span class="keyword">partition</span> p_others <span class="keyword">values</span> less than maxvalue engine <span class="operator">=</span> innodb</span><br><span class="line">        )</span><br><span class="line">;</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥è¡¨çš„åˆ›å»ºä¼šå½¢æˆä»¥ä¸‹æ–‡ä»¶</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>t.frm å³ å¯¹äº Server å±‚æ¥è¯´ï¼Œè¿™æ˜¯ 1 ä¸ªè¡¨</p>
</li>
<li class="lvl-2">
<p>t#P#p_2017.ibdï¼Œ t#P#p_2018.ibdï¼Œt#P#p_2019.ibdï¼Œt#P#p_others.ibdï¼Œå³ å¯¹äºå¼•æ“å±‚æ¥è¯´ï¼Œè¿™æ˜¯ 4 ä¸ªè¡¨</p>
</li>
</ul>
<h2 id="43-1-åˆ†åŒºè¡¨çš„å¼•æ“å±‚è¡Œä¸º">43.1-åˆ†åŒºè¡¨çš„å¼•æ“å±‚è¡Œä¸º</h2>
<p>å¯¹äºInnoDB æ¥è¯´ï¼Œè¿™æ˜¯ 4 ä¸ªè¡¨</p>
<p align="center">
  <img src="/2023/09/30/mysql/47.png" width="100%" alt="Your image description">
   <br>
   <span style="color:gray"> info about the picture </span>
</p>
<p>ä½¿ç”¨åˆ†åŒºè¡¨çš„ä¸€ä¸ªé‡è¦åŸå› å°±æ˜¯å•è¡¨è¿‡å¤§ã€‚é‚£ä¹ˆï¼Œå¦‚æœä¸ä½¿ç”¨åˆ†åŒºè¡¨çš„è¯ï¼Œæˆ‘ä»¬å°±æ˜¯è¦ä½¿ç”¨æ‰‹åŠ¨åˆ†è¡¨çš„æ–¹å¼ï¼Œåˆ†åŒºè¡¨å’Œæ‰‹å·¥åˆ†è¡¨ï¼Œåˆ†åŒºè¡¨ç”± server å±‚æ¥å†³å®šä½¿ç”¨å“ªä¸ªåˆ†åŒºï¼Œæ‰‹å·¥åˆ†è¡¨æ˜¯ç”±åº”ç”¨å±‚ä»£ç æ¥å†³å®šä½¿ç”¨å“ªä¸ªåˆ†è¡¨</p>
<h2 id="43-2-åˆ†åŒºç­–ç•¥">43.2-åˆ†åŒºç­–ç•¥</h2>
<p>æ¯å½“ç¬¬ä¸€æ¬¡è®¿é—®ä¸€ä¸ªåˆ†åŒºè¡¨çš„æ—¶å€™ï¼ŒMySQL éœ€è¦æŠŠæ‰€æœ‰çš„åˆ†åŒºéƒ½è®¿é—®ä¸€éã€‚ä¸€ä¸ªå…¸å‹çš„æŠ¥é”™æƒ…å†µæ˜¯è¿™æ ·çš„ï¼šå¦‚æœä¸€ä¸ªåˆ†åŒºè¡¨çš„åˆ†åŒºå¾ˆå¤šï¼Œæ¯”å¦‚è¶…è¿‡äº† 1000 ä¸ªï¼Œè€Œ MySQL å¯åŠ¨çš„æ—¶å€™ï¼Œ<code>open_files_limit</code> å‚æ•°ä½¿ç”¨çš„æ˜¯é»˜è®¤å€¼ 1024ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨è®¿é—®è¿™ä¸ªè¡¨çš„æ—¶å€™ï¼Œä¼šå‘ç”Ÿâ€œæ‰“å¼€è¡¨æ–‡ä»¶çš„ä¸ªæ•°è¶…è¿‡äº†ä¸Šé™â€ çš„æŠ¥é”™</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">Too many <span class="keyword">open</span> files </span><br></pre></td></tr></tbody></table></figure>
<p>MyISAM åˆ†åŒºè¡¨ä½¿ç”¨çš„åˆ†åŒºç­–ç•¥ï¼Œæˆ‘ä»¬ç§°ä¸ºé€šç”¨åˆ†åŒºç­–ç•¥ï¼ˆgeneric partitioningï¼‰ï¼Œæ¯æ¬¡è®¿é—®åˆ†åŒºéƒ½ç”± server å±‚æ§åˆ¶ã€‚é€šç”¨åˆ†åŒºç­–ç•¥ï¼Œæ˜¯ MySQL ä¸€å¼€å§‹æ”¯æŒåˆ†åŒºè¡¨çš„æ—¶å€™å°±å­˜åœ¨çš„ä»£ç ï¼Œåœ¨æ–‡ä»¶ç®¡ç†ã€è¡¨ç®¡ç†çš„å®ç°ä¸Šå¾ˆç²—ç³™ï¼Œå› æ­¤æœ‰æ¯”è¾ƒä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚ä» MySQL 5.7.9 å¼€å§‹ï¼ŒInnoDB å¼•æ“å¼•å…¥äº†æœ¬åœ°åˆ†åŒºç­–ç•¥ï¼ˆnative partitioningï¼‰ï¼Œåœ¨InnoDBå¼•æ“æ‰“å¼€æ–‡ä»¶è¶…è¿‡ <code>innodb_open_files</code> è¿™ä¸ªå€¼çš„æ—¶å€™ï¼Œå°±ä¼šå…³æ‰ä¸€äº›ä¹‹å‰æ‰“å¼€çš„æ–‡ä»¶</p>
<h2 id="43-3-åˆ†åŒºè¡¨çš„Serverå±‚è¡Œä¸º">43.3-åˆ†åŒºè¡¨çš„Serverå±‚è¡Œä¸º</h2>
<p>ä»server å±‚çœ‹çš„è¯ï¼Œä¸€ä¸ªåˆ†åŒºè¡¨å°±åªæ˜¯ä¸€ä¸ªè¡¨</p>
<p align="center">
  <img src="/2023/09/30/mysql/48.png" width="100%" alt="Your image description">
   <br>
   <span style="color:gray"> info about the picture </span>
</p>
<p>è™½ç„¶ session B åªéœ€è¦æ“ä½œ p_2017 è¿™ä¸ªåˆ†åŒºï¼Œä½†æ˜¯ç”±äº session A æŒæœ‰æ•´ä¸ªè¡¨ t çš„ MDL é”ï¼Œå°±å¯¼è‡´äº† session B çš„ alter è¯­å¥è¢«å µä½ã€‚åˆ†åŒºè¡¨ï¼Œåœ¨åš DDL çš„æ—¶å€™ï¼Œå½±å“ä¼šæ›´å¤§</p>
<p>åˆ†åŒºè¡¨çš„ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„ä¼˜åŠ¿æ˜¯å¯¹ä¸šåŠ¡é€æ˜ï¼Œç›¸å¯¹äºç”¨æˆ·åˆ†è¡¨æ¥è¯´ï¼Œä½¿ç”¨åˆ†åŒºè¡¨çš„ä¸šåŠ¡ä»£ç æ›´ç®€æ´ã€‚è¿˜æœ‰ï¼Œåˆ†åŒºè¡¨å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ¸…ç†å†å²æ•°æ®</p>
<h1>44-ç­”ç–‘æ–‡ç« ï¼ˆä¸‰ï¼‰ï¼šè¯´ä¸€è¯´è¿™äº›å¥½é—®é¢˜</h1>
<h1>45-è‡ªå¢idç”¨å®Œæ€ä¹ˆåŠï¼Ÿ</h1>
<h2 id="45-1-è¡¨å®šä¹‰è‡ªå¢ID">45.1- è¡¨å®šä¹‰è‡ªå¢ID</h2>
<p>è¡¨å®šä¹‰çš„è‡ªå¢å€¼è¾¾åˆ°ä¸Šé™åçš„é€»è¾‘æ˜¯ï¼šå†ç”³è¯·ä¸‹ä¸€ä¸ª id æ—¶ï¼Œå¾—åˆ°çš„å€¼ä¿æŒä¸å˜ã€‚å› æ­¤ï¼Œå½“è‡ªå¢ä¸»é”®id ç”¨å®Œæ—¶ï¼Œä»ç„¶ä¼šå¾—åˆ°æœ€åä¸€ä¸ªIDï¼Œå†æœ‰æ’å…¥å°±ä¼šæŠ¥é”™ä¸»é”®å†²çªï¼Œæµ‹è¯•å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t</span><br><span class="line">(</span><br><span class="line">    id <span class="type">int</span> unsigned auto_increment <span class="keyword">primary</span> key</span><br><span class="line">) auto_increment <span class="operator">=</span> <span class="number">4294967295</span>; <span class="comment">-- 2^32 - 1 = 4294967295</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span> (<span class="keyword">null</span>);</span><br><span class="line"># æˆåŠŸæ’å…¥ä¸€è¡Œ <span class="number">4294967295</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t;</span><br><span class="line"><span class="comment">/* CREATE TABLE `t` (</span></span><br><span class="line"><span class="comment">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span></span><br><span class="line"><span class="comment">  PRIMARY KEY (`id`)</span></span><br><span class="line"><span class="comment">) ENGINE=InnoDB AUTO_INCREMENT=4294967295;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t; <span class="comment">-- 4294967295</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span> (<span class="keyword">null</span>);</span><br><span class="line"># Duplicate entry <span class="string">'4294967295'</span> <span class="keyword">for</span> key <span class="string">'PRIMARY'</span></span><br></pre></td></tr></tbody></table></figure>
<p>$2^{32}-1 = 4294967295 $  ä¸æ˜¯ä¸€ä¸ªç‰¹åˆ«å¤§çš„æ•°ï¼Œå¯¹äºä¸€ä¸ªé¢‘ç¹æ’å…¥åˆ é™¤æ•°æ®çš„è¡¨æ¥è¯´ï¼Œæ˜¯å¯èƒ½ä¼šè¢«ç”¨å®Œçš„ã€‚å› æ­¤å¦‚æœä½ çš„è¡¨æ˜¯å¦æœ‰å¯èƒ½è¾¾åˆ°è¿™ä¸ªä¸Šé™ï¼Œå°±åº”è¯¥åˆ›å»ºæˆ 8 ä¸ªå­—èŠ‚çš„ <code>bigint unsigned</code></p>
<h2 id="45-2-InnoDB-ç³»ç»Ÿè‡ªå¢-row-id">45.2- InnoDB ç³»ç»Ÿè‡ªå¢ row_id</h2>
<p>å¦‚æœåˆ›å»ºçš„ InnoDB è¡¨æ²¡æœ‰æŒ‡å®šä¸»é”®ï¼Œé‚£ä¹ˆ InnoDB ä¼šç»™ä½ åˆ›å»ºä¸€ä¸ªä¸å¯è§çš„ï¼Œé•¿åº¦ä¸º 6 ä¸ªå­—èŠ‚ï¼ˆ8ä¸ªå­—èŠ‚çš„å6ä¸ªå­—èŠ‚ï¼‰çš„ <code>row_id</code>ã€‚InnoDB ç»´æŠ¤äº†ä¸€ä¸ªå…¨å±€çš„ <code>dict_sys.row_id</code> å€¼ï¼Œæ‰€æœ‰æ— ä¸»é”®çš„ InnoDB è¡¨ï¼Œæ¯æ’å…¥ä¸€è¡Œæ•°æ®ï¼Œéƒ½å°†å½“å‰çš„ <code>dict_sys.row_id</code> å€¼ä½œä¸ºè¦æ’å…¥æ•°æ®çš„ <code>row_id</code>ï¼Œç„¶åæŠŠ <code>dict_sys.row_id</code> çš„å€¼åŠ  1</p>
<p>å†™å…¥è¡¨çš„ <code>row_id</code> æ˜¯ä» 0 å¼€å§‹åˆ° $2^{48}-1$ã€‚è¾¾åˆ°ä¸Šé™åï¼Œä¸‹ä¸€ä¸ªå€¼å°±æ˜¯ 0ï¼Œç„¶åç»§ç»­å¾ªï¼Œ<strong>å¦‚æœçªç ´è¿™ä¸ªç°å®ï¼Œæ–°å†™å…¥çš„è¡Œå°±ä¼šè¦†ç›–åŸæœ‰çš„è¡Œ</strong></p>
<h2 id="45-3-Xid">45.3- Xid</h2>
<p>Xid åœ¨ MySQL å†…éƒ¨æ˜¯æ€ä¹ˆç”Ÿæˆçš„å‘¢ï¼Ÿ</p>
<p>MySQL å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå…¨å±€å˜é‡ <code>global_query_id</code>ï¼Œæ¯æ¬¡æ‰§è¡Œè¯­å¥çš„æ—¶å€™å°†å®ƒèµ‹å€¼ç»™ <code>Query_id</code>ï¼Œç„¶åè‡ªèº«åŠ  1ã€‚å¦‚æœå½“å‰è¯­å¥æ˜¯æŸä¸ªäº‹åŠ¡æ‰§è¡Œçš„ç¬¬ä¸€æ¡è¯­å¥ï¼Œé‚£ä¹ˆ MySQL è¿˜ä¼šåŒæ—¶æŠŠ <code>Query_id</code> èµ‹å€¼ç»™è¿™ä¸ªäº‹åŠ¡çš„ Xid</p>
<p><code>global_query_id</code> æ˜¯ä¸€ä¸ªçº¯å†…å­˜å˜é‡ï¼Œé‡å¯ä¹‹åå°±æ¸…é›¶äº†ã€‚æ‰€ä»¥ï¼Œåœ¨åŒä¸€ä¸ªæ•°æ®åº“å®ä¾‹ä¸­ï¼Œä¸åŒäº‹åŠ¡çš„ Xid ä¹Ÿæ˜¯æœ‰å¯èƒ½ç›¸åŒçš„ã€‚ä½†æ˜¯ MySQL é‡å¯ä¹‹åä¼šé‡æ–°ç”Ÿæˆæ–°çš„ binlog æ–‡ä»¶ï¼Œè¿™å°±ä¿è¯äº†ï¼ŒåŒä¸€ä¸ª binlog æ–‡ä»¶é‡Œï¼ŒXid ä¸€å®šæ˜¯æƒŸä¸€çš„</p>
<p>MySQL é‡å¯ä¸ä¼šå¯¼è‡´åŒä¸€ä¸ª binlog é‡Œé¢å‡ºç°ä¸¤ä¸ªç›¸åŒçš„ Xidï¼Œä½†æ˜¯å¦‚æœ <code>global_query_id</code> è¾¾åˆ°ä¸Šé™åï¼Œå°±ä¼šç»§ç»­ä» 0 å¼€å§‹è®¡æ•°ã€‚ä»ç†è®ºä¸Šè®²ï¼Œè¿˜æ˜¯å°±ä¼šå‡ºç°åŒä¸€ä¸ª binlog é‡Œé¢å‡ºç°ç›¸åŒ Xid çš„åœºæ™¯ï¼Œè¿™ç§æƒ…å†µéå¸¸æç«¯ï¼Œæ— éœ€è€ƒè™‘</p>
<h2 id="45-4-Innodb-trx-id">45.4- Innodb trx_id</h2>
<h4 id="Xid-åœ¨-trx-id-çš„åŒºåˆ«åœ¨äºä»€ä¹ˆï¼Ÿ">Xid åœ¨  trx_id çš„åŒºåˆ«åœ¨äºä»€ä¹ˆï¼Ÿ</h4>
<p>Xidæ˜¯ç”±serverå±‚ç»´æŠ¤çš„ã€‚ trx_idï¼ˆtransaction idï¼‰æ˜¯InnoDBï¼ˆå¼•æ“å±‚ï¼‰ å¦å¤–ç»´æŠ¤çš„ï¼ŒInnoDB å†…éƒ¨ä½¿ç”¨Xidï¼Œå°±æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨ InnoDB äº‹åŠ¡å’Œ server ä¹‹é—´åšå…³è”</p>
<p>Todo: å¾…æ›´æ–°</p>
<h2 id="45-5-thread-id">45.5- thread_id</h2>
<p>çº¿ç¨‹ id æ˜¯MySQL ä¸­æœ€å¸¸è§çš„ä¸€ç§è‡ªå¢ idï¼Œ<code>show processlist</code> é‡Œé¢çš„ç¬¬ä¸€åˆ—ï¼Œå°±æ˜¯ <code>thread_id</code>ï¼Œç³»ç»Ÿä¿å­˜äº†ä¸€ä¸ªå…¨å±€å˜é‡ <code>thread_id_counter</code>ï¼Œæ¯æ–°å»ºä¸€ä¸ªè¿æ¥ï¼Œå°±å°† <code>thread_id_counter</code> èµ‹å€¼ç»™è¿™ä¸ªæ–°è¿æ¥çš„çº¿ç¨‹å˜é‡ï¼Œå¹¶ä¸”ä¿è¯è¯¥IDåœ¨æ‰€æœ‰çº¿ç¨‹æ•°ç»„ä¸­æ˜¯å”¯ä¸€çš„ã€‚å½“è¿æ¥å…³é—­æ—¶ï¼Œä¼šè°ƒç”¨å‡½æ•° <code>release_thread_id</code>ï¼Œä»<code>thread_ids</code>ç§»é™¤å½“å‰ idå·</p>
<p><code>thread_id_counter</code> å®šä¹‰çš„å¤§å°æ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œå› æ­¤è¾¾åˆ° $2^{32}-1$ åï¼Œå®ƒå°±ä¼šé‡ç½®ä¸º 0ï¼Œç„¶åç»§ç»­å¢åŠ </p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span>  <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_trx; <span class="comment">-- æŸ¥çœ‹å½“å‰çš„äº‹åŠ¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> processlist;  <span class="comment">-- æŸ¥çœ‹å½“å‰çš„è¿æ¥</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>MySQL  çš„ unique key çº¦æŸ  ï¼š å…è®¸å¤šä¸ªnull</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> `unique_key_test`</span><br><span class="line">(</span><br><span class="line">    id <span class="type">bigint</span>,</span><br><span class="line">    id_card <span class="type">varchar</span>(<span class="number">18</span>) ,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">    <span class="keyword">primary</span> key (id),</span><br><span class="line">    <span class="keyword">unique</span> key (id_card)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> unique_key_test <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'411524199710094032'</span>,<span class="string">'z3'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> unique_key_test <span class="keyword">values</span> (<span class="number">2</span>,<span class="keyword">null</span>,<span class="string">'l4'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> unique_key_test <span class="keyword">values</span> (<span class="number">3</span>,<span class="keyword">null</span>,<span class="string">'w5'</span>); <span class="comment">-- æ’å…¥æˆåŠŸ</span></span><br></pre></td></tr></tbody></table></figure>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>IOæˆæœ¬å°±æ˜¯å¯»å€æ—¶é—´å’Œä¸Šä¸‹æ–‡åˆ‡æ¢æ‰€éœ€è¦çš„æ—¶é—´ï¼Œæœ€ä¸»è¦æ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æˆ‘ä»¬çŸ¥é“ç”¨æˆ·æ€æ˜¯æ— æ³•ç›´æ¥è®¿é—®ç£ç›˜ç­‰ç¡¬ä»¶ä¸Šçš„æ•°æ®çš„ï¼Œåªèƒ½é€šè¿‡æ“ä½œç³»ç»Ÿå»è°ƒå†…æ ¸æ€çš„æ¥å£ï¼Œç”¨å†…æ ¸æ€çš„çº¿ç¨‹å»è®¿é—®ã€‚ è¿™é‡Œçš„ä¸Šä¸‹æ–‡åˆ‡æ¢æŒ‡çš„æ˜¯åŒè¿›ç¨‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ‰€è°“ä¸Šä¸‹æ–‡å°±æ˜¯çº¿ç¨‹è¿è¡Œéœ€è¦çš„ç¯å¢ƒä¿¡æ¯ã€‚ 1ï¸âƒ£ é¦–å…ˆï¼Œç”¨æˆ·æ€çº¿ç¨‹éœ€è¦ä¸€äº›ä¸­é—´è®¡ç®—ç»“æœä¿å­˜CPUå¯„å­˜å™¨ï¼Œä¿å­˜CPUæŒ‡ä»¤çš„åœ°å€åˆ°ç¨‹åºè®¡æ•°å™¨ï¼ˆæ‰§è¡Œé¡ºåºä¿è¯ï¼‰ï¼Œè¿˜è¦ä¿å­˜æ ˆçš„ä¿¡æ¯ç­‰ä¸€äº›çº¿ç¨‹ç§æœ‰çš„ä¿¡æ¯ã€‚2ï¸âƒ£  ç„¶ååˆ‡æ¢åˆ°å†…æ ¸æ€çš„çº¿ç¨‹æ‰§è¡Œï¼Œå°±éœ€è¦æŠŠçº¿ç¨‹çš„ç§æœ‰ä¿¡æ¯ä»å¯„å­˜å™¨ï¼Œç¨‹åºè®¡æ•°å™¨é‡Œè¯»å‡ºæ¥ï¼Œç„¶åæ‰§è¡Œè¯»ç£ç›˜ä¸Šçš„æ•°æ®ã€‚è¯»å®Œåè¿”å›ï¼Œåˆè¦æŠŠçº¿ç¨‹çš„ä¿¡æ¯å†™è¿›å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨ã€‚ 3ï¸âƒ£ åˆ‡æ¢åˆ°ç”¨æˆ·æ€åï¼Œç”¨æˆ·æ€çº¿ç¨‹åˆè¦è¯»ä¹‹å‰ä¿å­˜çš„çº¿ç¨‹æ‰§è¡Œçš„ç¯å¢ƒä¿¡æ¯å‡ºæ¥ï¼Œæ¢å¤æ‰§è¡Œã€‚è¿™ä¸ªè¿‡ç¨‹ä¸»è¦æ˜¯æ¶ˆè€—æ—¶é—´èµ„æº <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn2" class="footnote-item"><p>mvcc : <a href="https://cloud.tencent.com/developer/article/1801920">https://cloud.tencent.com/developer/article/1801920</a> <a href="#fnref2" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn3" class="footnote-item"><p>changer buffer ä½¿ç”¨çš„æ˜¯buffer pool çš„å†…å­˜ï¼Œé»˜è®¤å ç”¨50%ï¼Œå¯ä»¥é€šè¿‡<code>innodb_change_buffer_max_size</code>æ¥æŒ‡å®š <a href="#fnref3" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn4" class="footnote-item"><p>è¿™æ˜¯æ•°æ®åº“é‡Œæˆæœ¬æœ€é«˜çš„ <a href="#fnref4" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="https://time.geekbang.org/column/article/70848">https://time.geekbang.org/column/article/70848</a> <a href="#fnref5" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn6" class="footnote-item"><p>InnoDBé€‰å–Nä¸ªé¡µï¼Œè®¡ç®—å¹³å‡ä¸åŒçš„å€¼ï¼Œç„¶åä¹˜ä»¥æ€»é¡µæ•° <a href="#fnref6" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn7" class="footnote-item"><p>å»ºè®®è®¾ç½®ä¸ºç£ç›˜çš„IOPS <a href="#fnref7" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn8" class="footnote-item"><p>R% å¦‚ä½•è®¡ç®—ï¼Œå‚è€ƒï¼š<a href="https://time.geekbang.org/column/article/71806">https://time.geekbang.org/column/article/71806</a> <a href="#fnref8" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn9" class="footnote-item"><p>ä¸»é”®ç´¢å¼•æ ‘çš„å¶å­èŠ‚ç‚¹æ˜¯æ•°æ®ï¼Œè€Œæ™®é€šç´¢å¼•æ ‘çš„å¶å­èŠ‚ç‚¹æ˜¯ä¸»é”®å€¼ <a href="#fnref9" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn10" class="footnote-item"><p>sort_buffer æ˜¯MySQLç”¨äºæ’åºçš„ä¸€ä¸ªç¼“å†² <a href="#fnref10" class="footnote-backref">â†©ï¸</a> <a href="#fnref10:1" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn11" class="footnote-item"><p>utf8mb4æ˜¯æ”¯æŒemojiçš„ï¼Œè€Œutf8ä¸æ”¯æŒã€‚utf8mb4æ˜¯utf8çš„è¶…é›† <a href="#fnref11" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn12" class="footnote-item"><p>select blocking_pid from sys.schema_table_lock_waits <a href="#fnref12" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn13" class="footnote-item"><p>é”çš„è®¾è®¡æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚è€Œè¿™ä¸ªä¸€è‡´æ€§ï¼Œä¸æ­¢æ˜¯æ•°æ®åº“å†…éƒ¨æ•°æ®çŠ¶æ€åœ¨æ­¤åˆ»çš„ä¸€è‡´æ€§ï¼Œè¿˜åŒ…å«äº†æ•°æ®å’Œæ—¥å¿—åœ¨é€»è¾‘ä¸Šçš„ä¸€è‡´æ€§ <a href="#fnref13" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn14" class="footnote-item"><p>select * from information_schema.innodb_trx; æŸ¥æ‰¾å¤„äºäº‹åŠ¡ä¸­çš„id <a href="#fnref14" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn15" class="footnote-item"><p>å¯¹åº”çš„é£é™©æ˜¯ï¼šå¦‚æœä¸»æœºå‘ç”Ÿå¼‚å¸¸é‡å¯ï¼Œä¼šä¸¢å¤±æœ€è¿‘ N ä¸ªäº‹åŠ¡çš„ binlog æ—¥å¿— <a href="#fnref15" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn16" class="footnote-item"><p>ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡äº§ç”Ÿçš„redo log ä¹Ÿæ˜¯ç›´æ¥å†™åˆ° redo  log buffer çš„ï¼Œå³ä¸€ä¸ªæœªè¢«æäº¤çš„äº‹åŠ¡ä¹Ÿæœ‰å¯èƒ½æŒä¹…åŒ–åˆ°ç£ç›˜ <a href="#fnref16" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn17" class="footnote-item"><p>log sequence numberï¼ŒLSN <a href="#fnref17" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn18" class="footnote-item"><p>ä¸€æ¬¡æ€§åœ°ç”¨ delete è¯­å¥åˆ é™¤å¤ªå¤šæ•°æ®ã€‚å…¶å®ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å¤§äº‹åŠ¡åœºæ™¯,å¦ä¸€ç§å…¸å‹çš„å¤§äº‹åŠ¡åœºæ™¯ï¼Œå°±æ˜¯å¤§è¡¨ DDL <a href="#fnref18" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn19" class="footnote-item"><p>åœ¨ MySQL é‡Œé¢æˆ‘ä»¬è¯´ transaction_id å°±æ˜¯æŒ‡äº‹åŠ¡ idï¼Œäº‹åŠ¡ id æ˜¯åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ†é…çš„ï¼Œå¦‚æœè¿™ä¸ªäº‹åŠ¡å›æ»šäº†ï¼Œäº‹åŠ¡ id ä¹Ÿä¼šé€’å¢ï¼Œè€Œ gno æ˜¯åœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™æ‰ä¼šåˆ†é… <a href="#fnref19" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn20" class="footnote-item"><p>join_buffer æ˜¯å¯ä»¥é€šè¿‡ join_buffer_size è¿›è¡Œè®¾å®šçš„,é»˜è®¤256k) <a href="#fnref20" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>è¯»ä¹¦ç¬”è®°</category>
      </categories>
      <tags>
        <tag>æŠ€æœ¯</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨</title>
    <url>/2023/09/21/ddia/</url>
    <content><![CDATA[<p>è¿™æ˜¯ç¬¬äºŒæ¬¡è¯»DDIAï¼Œå…¨åå«åšã€ŠDesign Data-Intensive Applicationã€‹ ç›´è¯‘ä¸ºï¼šè®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨æˆ–æ•°æ®å¯†é›†å‹åº”ç”¨çš„è®¾è®¡ï¼›æ›´å¤šç²¾å½©å†…å®¹ï¼Œæ¬¢è¿å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šstackoverflow</p>
<p>ğŸˆ<strong>ä¸ºä»€ä¹ˆåˆ†äº«è¿™æœ¬ä¹¦</strong>ğŸˆ</p>
<p>æˆ‘ç›¸ä¿¡å„ä½ä¸€å®šå†ç»è¿‡è¿™æ ·çš„åœºæ™¯ï¼šæ˜¥èŠ‚æ¡£æ¡£æœŸä¸€ä¸‹å­ä¸Šæ˜ äº†å¾ˆå¤šåœºç”µå½±ï¼Œä¸€åœºç”µå½±è¦ä¸è¦å»çœ‹å‘¢ï¼Ÿå¯¹äºæˆ‘æ¥è¯´ï¼Œé€šå¸¸éƒ½æ˜¯å…ˆçœ‹ä¸€ä¸‹è±†ç“£è¯„åˆ†ï¼Œå¦‚æœé«˜çš„è¯ï¼Œå°±ä¹°ç¥¨å…¥åœºï¼Œæ‰€ä»¥ä¸ºä»€ä¹ˆé€‰æ‹©åˆ†äº«è¿™æœ¬ä¹¦ï¼Œé‚£å°±ä¸å¾—ä¸è¯´ä¸‹è¿™æœ¬ä¹¦çš„æº¢ç¾ä¹‹è¯</p>
<span id="more"></span>
<h3 id="å…³äºddiaçš„æº¢ç¾ä¹‹è¯">å…³äºddiaçš„æº¢ç¾ä¹‹è¯</h3>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æœ¬ä¹¦çš„è¯„ä»·æƒŠäººçš„é«˜ï¼Œå±…ç„¶è¾¾åˆ°äº† 9.7åˆ†çš„é«˜åˆ†ï¼Œæœ‰çš„åŒå­¦å¯èƒ½è§‰å¾—9.7åˆ†å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆé«˜çš„åˆ†æ•°ï¼Œæ¥çœ‹ä¸‹é¢è¿™éƒ¨æ˜¯ä¸ªç å†œéƒ½çŸ¥é“çš„ä¹¦ã€Šç®—æ³•å¯¼è®ºã€‹ï¼Œè¿™æœ¬ä¹¦çš„è¯„åˆ†æ˜¯å¤šå°‘å‘¢ï¼Ÿ 9.2åˆ†ï¼Œå½“ç„¶è¿™æ˜¯ä¸€ä¸ªå¾ˆé«˜çš„åˆ†æ•°ï¼Œä½†æ˜¯ddia æ¯”è¿™ä¸ªé«˜åº¦è¿˜è¦é«˜ 0.5åˆ†ï¼›æœ‰çš„åŒå­¦å¯èƒ½è¿˜æ˜¯ä¸èƒ½å¾ˆç›´æ¥çš„getåˆ°è¿™æœ¬ä¹¦çš„é­…åŠ›ï¼ŒOKï¼Œæˆ‘ä»¬æ¥å’Œè±†ç“£ç”µå½±è¯„åˆ†ç±»æ¯”ä¸€ä¸‹ï¼Œè¦çŸ¥é“è±†ç“£ä¸­ç”µå½±è¯„åˆ†æœ€é«˜çš„ä¹Ÿå°±æ˜¯9.7åˆ†ï¼Œä¹Ÿå°±æ˜¯å¤§åé¼é¼çš„ï¼Œæˆ‘ç›¸ä¿¡å„ä½åº”è¯¥éƒ½çœ‹è¿‡ã€Šè‚–ç”³å…‹çš„æ•‘èµã€‹</p>
<p align="center">
  <img src="/2023/09/21/ddia/01.jpg" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> è®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨çš„èµç¾ä¹‹è¯ </span>
</p>
<p>ç”šè‡³ByteDance è¿™å®¶å…¬å¸å°†è¿™æœ¬ä¹¦å†™è¿›å…¥interview docã€‚<strong>æ‰€ä»¥ç»“è®ºæ¥äº†ï¼ŒDDIA , ä½ å€¼å¾—æ‹¥æœ‰</strong></p>
<h3 id="å…³äºä½œè€…">å…³äºä½œè€…</h3>
<p><a href="https://martin.kleppmann.com/">Martin Kleppmann</a></p>
<h1>æ•´ä¹¦å¤§çº²</h1>
<p>ä¸‹é¢æ˜¯æ•´ä¹¦çš„ä¸€ä¸ªè„‰ç»œï¼šåˆ†ä¸º<strong>3</strong>ä¸ªéƒ¨åˆ†12ä¸ªç« èŠ‚</p>
<p align="center">
  <img src="/2023/09/21/ddia/37.jpg" width="80%" alt="Your image description">
  <br>
  <span style="color:gray"> ä¹¦ç±ç»“æ„ç›®å½• </span>
</p>
<h2 id="å“ª3éƒ¨åˆ†">å“ª3éƒ¨åˆ†</h2>
<h3 id="1ï¸âƒ£-æ•°æ®ç³»ç»Ÿçš„åŸºçŸ³">1ï¸âƒ£ æ•°æ®ç³»ç»Ÿçš„åŸºçŸ³</h3>
<p>ä¸»è¦è®²è¿°äº†æ•°æ®ç³»ç»Ÿåº•å±‚çš„ä¸€äº›æ¦‚å¿µï¼Œæ— è®ºæ˜¯å•æœºä¸Šçš„å•ç‚¹æ•°æ®ç³»ç»Ÿï¼Œè¿˜æ˜¯åˆ†å¸ƒåœ¨å¤šæœºå™¨ä¸Šçš„åˆ†å¸ƒå¼æ•°æ®ç³»ç»Ÿã€‚è¿™ä¸ªè®¨è®ºçš„èŒƒå›´æ˜¯ <em>å•æœºæˆ–è€…å¤šæœºå™¨ï¼ŒåŒºåˆ«äºç¬¬äºŒéƒ¨åˆ†ä»…è°ˆè®ºå¤šæœºå™¨ä¸Šçš„åˆ†å¸ƒå¼ç³»ç»Ÿ</em></p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>1ï¼šå¯é æ€§ã€å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§</strong>  åœ¨å¼€å‘ä¸€ä¸ªåº”ç”¨çš„æ—¶å€™ï¼Œå¿…é¡»è¦æ»¡è¶³å„ç§åŠŸèƒ½éœ€æ±‚æ‰èƒ½ç§°ä¹‹ä¸ºæœ‰ç”¨ï¼Œé™¤äº†åŠŸèƒ½éœ€æ±‚ï¼ˆä¹Ÿå°±æ˜¯èƒ½å¤Ÿå®ç°ä»€ä¹ˆåŠŸèƒ½ï¼‰è¿˜éœ€è¦ä¸€äº›éåŠŸèƒ½éœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯é€šç”¨å±æ€§ï¼Œæ¯”å¦‚è¯´å¯é æ€§<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>ï¼Œå¯æ‰©å±•æ€§<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>ï¼Œå¯ç»´æŠ¤æ€§<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></p>
<blockquote></blockquote>
<ul class="lvl-2">
<li class="lvl-4">
<p><strong>2ï¼šæ•°æ®æ¨¡å‹ä¸æŸ¥è¯¢è¯­è¨€</strong>  è¿™ä¸ªæ˜¯ä»ä½¿ç”¨è€…çš„è§’åº¦å‡ºå‘ï¼ˆâš ï¸<em>æ³¨æ„è¿™ä¸ªè§†è§’å¾ˆé‡è¦</em>ï¼‰ ã€‚æè¿°æ•°æ®å½•å…¥æ•°æ®ç³»ç»Ÿçš„æ ¼å¼ï¼Œå·²åŠå¦‚ä½•å°†å­˜å…¥çš„æ•°æ®å–å‡ºæ¥ã€‚æ¶‰åŠ<strong>å…³ç³»æ¨¡å‹ï¼Œæ–‡æ¡£æ¨¡å‹ï¼Œå›¾æ¨¡å‹</strong>ã€‚æ¯”å¦‚è¯´å¯¹äºå…³ç³»å‹æ•°æ®åº“æ¥è¯´ï¼Œæ•°æ®æ¨¡å‹ = DML(Data Manipulation Language)ï¼›æŸ¥è¯¢è¯­è¨€ = DQL(Data Query Language ä¸€ç§å£°æ˜å¼çš„æŸ¥è¯¢è¯­å¥) ã€‚é˜è¿°äº†å…³ç³»æ¨¡å‹çš„å„ä¸ªæŒ‘æˆ˜è€…æŒ‘æˆ˜å…³ç³»æ¨¡å‹çš„éœ¸ä¸»åœ°ä½ï¼Œæœ€ç»ˆè½è´¥çš„è¿‡ç¨‹ï¼Œæ•°æ®æ¨¡å‹å‘å±•è‡³ä»Šå…³ç³»æ¨¡å‹ä¾ç„¶ç‹è€…</p>
</li>
</ul>
</li>
<li class="lvl-2">
<p><strong>3ï¼šå­˜å‚¨ä¸æ£€ç´¢</strong>  è¿™ä¸ªæ˜¯<strong>ä»æ•°æ®ç³»ç»Ÿçš„è§’åº¦å‡ºå‘</strong>ï¼Œæè¿°æ•°æ®ç³»ç»Ÿå¦‚ä½•å­˜å‚¨æˆ‘ä»¬å½•å…¥çš„æ•°æ®ï¼Œä»¥åŠåœ¨æˆ‘ä»¬éœ€è¦è¿™éƒ¨åˆ†æ•°æ®ï¼Œå­˜å‚¨ç³»ç»Ÿå¦‚ä½•ç²¾å‡†ã€å¿«é€Ÿçš„å®šä½åˆ°ç›®æ ‡æ•°æ®ã€‚è¿™é‡Œæ³¨æ„åŒºåˆ†<em>2ç« èŠ‚å’Œ3ç« èŠ‚çš„è§’åº¦</em></p>
</li>
<li class="lvl-2">
<p><strong>4ï¼šç¼–ç ä¸æ¼”åŒ–</strong>  éšç€æ—¶é—´æ¨ç§»ï¼Œæ•°æ®ç³»ç»Ÿç”±äºåŠŸèƒ½çš„è¿­ä»£ï¼Œéœ€è¦å¯¹åˆå§‹æ¶‰åŠçš„æ•°æ®æ¨¡å‹(schema)è¿›è¡Œæ›´æ”¹ï¼Œé‚£ä¹ˆå¦‚ä½•å¤„ç†æ•°æ®æ¨¡å‹çš„å‰åå…¼å®¹é—®é¢˜ï¼Œå°±æ˜¯è¿™ä¸ªç« èŠ‚è¦è®¨è®ºçš„é—®é¢˜</p>
</li>
</ul>
<h3 id="2ï¸âƒ£-åˆ†å¸ƒå¼æ•°æ®">2ï¸âƒ£ åˆ†å¸ƒå¼æ•°æ®</h3>
<p>æœ¬ç« ä¸»è¦è®²è¿°åœ¨å¤šæœºå™¨çš„åˆ†å¸ƒå¼æ•°æ®ç³»ç»Ÿä¸­ï¼Œå°†ä¼šæœ‰å¤šå°æœºå™¨å‚ä¸æ•°æ®çš„å­˜å‚¨å’Œæ£€ç´¢ï¼Œæ•°æ®ç³»ç»Ÿæ‰€é¢ä¸´æŒ‘æˆ˜ï¼ŒåŒ…æ‹¬</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>5ï¼šå¤åˆ¶</strong> ï¼š åŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ªæ‹·è´/å‰¯æœ¬ã€‚è¿™å°†ä¸ºç³»ç»Ÿçš„å¯ç”¨æ€§æä¾›æ”¯æ’‘</p>
</li>
<li class="lvl-2">
<p><strong>6ï¼šåˆ†åŒº</strong> ï¼š åŒä¸€ä»½æ•°æ®ï¼Œåˆ†å‰²æˆå¤šå—</p>
</li>
<li class="lvl-2">
<p><strong>7ï¼šäº‹åŠ¡</strong> ï¼š ä¸»è¦ä»‹ç» äº‹åŠ¡ï¼ŒACIDï¼Œéš”ç¦»çº§åˆ«ç­‰å†…å®¹ï¼Œè¿™éƒ¨åˆ†å†…å®¹æ˜¯é‡ç‚¹ä¹Ÿæ˜¯éš¾ç‚¹</p>
</li>
<li class="lvl-2">
<p><strong>8ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿçš„éº»çƒ¦</strong> ï¼š åœ¨æç«¯æƒ…å†µä¸‹ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿé»‘æš—çš„è¯¸å¤šé—®é¢˜ï¼Œçœ‹å®Œè¿™ä¸€ç« èŠ‚ï¼Œä½ ä¼šè§‰å¾—ä½ æ‰€å¤„äºçš„ç¯å¢ƒçœŸçš„æ˜¯å¤ªå¹¸ç¦äº†</p>
</li>
<li class="lvl-2">
<p><strong>9ï¼šä¸€è‡´æ€§ä¸å…±è¯†</strong> ï¼šåˆ†å¸ƒå¼æ•°æ®ç³»ç»Ÿå¦‚ä½•å»å®ç°ä¸€è‡´æ€§å’Œè¾¾æˆå…±è¯†ï¼Œä»è€Œé¿å…ç±»ä¼¼äº brain split  çš„é—®é¢˜ï¼Œè¿™ä¸€ç« èŠ‚ä¼šè®¨è®ºåœ¨æ„å»ºå®¹é”™åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—¶å€™ä½¿ç”¨åˆ°çš„ ç®—æ³•å’Œåè®®(æ¯”å¦‚Raftã€Paxosã€ZAB)</p>
</li>
</ul>
<h3 id="3ï¸âƒ£-æ´¾ç”Ÿæ•°æ®">3ï¸âƒ£ æ´¾ç”Ÿæ•°æ®</h3>
<p>ç¬¬ä¸€/äºŒéƒ¨åˆ†ç³»ç»Ÿçš„è€ƒé‡äº†åˆ†å¸ƒå¼æ•°æ®åº“çš„æ–¹æ–¹é¢é¢ï¼ŒçœŸå®ä¸–ç•Œçš„å¤§å‹åº”ç”¨ç¨‹åºç»å¸¸éœ€è¦ä»¥å¤šç§æ–¹å¼è®¿é—®å’Œå¤„ç†æ•°æ®ï¼Œæ²¡æœ‰ä¸€ä¸ªæ•°æ®åº“å¯ä»¥åŒæ—¶æ»¡è¶³æ‰€æœ‰è¿™äº›ä¸åŒçš„éœ€æ±‚ã€‚å› æ­¤åº”ç”¨ç¨‹åºé€šå¸¸ç»„åˆä½¿ç”¨å¤šç§ç»„ä»¶ï¼šæ•°æ®å­˜å‚¨ï¼Œç´¢å¼•ï¼Œç¼“å­˜ï¼Œåˆ†æç³»ç»Ÿï¼Œç­‰ç­‰ï¼Œå¹¶å®ç°åœ¨è¿™äº›ç»„ä»¶ä¸­ç§»åŠ¨æ•°æ®çš„æœºåˆ¶</p>
<p>è¯¥ä¹¦çš„æœ€åä¸€éƒ¨åˆ†ï¼Œç ”ç©¶å°†å¤šä¸ªä¸åŒæ•°æ®ç³»ç»Ÿï¼ˆå¯èƒ½æœ‰ç€ä¸åŒæ•°æ®æ¨¡å‹ï¼Œå¹¶é’ˆå¯¹ä¸åŒçš„è®¿é—®æ¨¡å¼è¿›è¡Œä¼˜åŒ–ï¼‰é›†æˆä¸ºä¸€ä¸ªåè°ƒä¸€è‡´çš„åº”ç”¨æ¶æ„æ—¶ï¼Œä¼šé‡åˆ°çš„é—®é¢˜</p>
<p>ä¸»è¦è®¨è®ºè¡ç”Ÿ(æ´¾ç”Ÿ)æ•°æ®ï¼šæ‰€è°“<em>è¡ç”Ÿæ•°æ®</em> æ˜¯ä»¥è¾“å…¥æ•°æ®è¾“å‡ºæ–°çš„æ•°æ®ï¼Œè¾“å‡ºæ˜¯è¡ç”Ÿæ•°æ®ï¼ˆderived dataï¼‰çš„ä¸€ç§å½¢å¼ ï¼Œæµå¤„ç†å’Œæ‰¹å¤„ç†éƒ½ä¼šäº§ç”Ÿè¡ç”Ÿæ•°æ®</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>10ï¼šæ‰¹å¤„ç†</strong>  ï¼š æœ‰ç•Œæ•°æ®çš„å¤„ç†</p>
</li>
<li class="lvl-2">
<p><strong>11ï¼šæµå¤„ç†</strong>  ï¼š æ— ç•Œæ•°æ®çš„å¤„ç†</p>
</li>
<li class="lvl-2">
<p><strong>12ï¼šæ•°æ®ç³»ç»Ÿçš„æœªæ¥</strong> ğŸ¤£</p>
</li>
</ul>
<p>ğŸˆ<strong>ä»¥ä¸Šå‘¢</strong>ğŸˆï¼Œå°±æ˜¯æ•´æœ¬ä¹¦çš„ä¸€ä¸ªç®€çŸ­çš„æ¦‚æ‹¬ï¼Œä¸‹é¢çš„å†…å®¹å°±æ˜¯æˆ‘åŸºäºä¹¦ä¸­çš„å†…å®¹åšçš„ä¸€äº›æ€»ç»“ï¼Œå·²åŠè‡ªå·±çš„ä¸€äº›å¯å‘</p>
<h2 id="è®¡ç®—å¯†é›†vsæ•°æ®å¯†é›†">è®¡ç®—å¯†é›†vsæ•°æ®å¯†é›†</h2>
<p>ä¸‹å›¾æ˜¯åº”ç”¨ç¨‹åºçš„ç®€è¦åˆ†ç±»ï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/15.jpg" width="80%" alt="Your image description">
  <br>
  <span style="color:gray"> æ•°æ®å¯†é›†å‹åº”ç”¨å’Œè®¡ç®—å¯†é›†å‹åº”ç”¨çš„åŒºåˆ« </span>
</p>
<p>ğŸ…°ï¸ é¦–å…ˆæ˜¯è®¡ç®—å¯†é›†å‹åº”ç”¨ï¼Œè¿™ç±»åº”ç”¨çš„ç“¶é¢ˆæ˜¯ç®—åŠ›ï¼Œæ¯”å¦‚è¿›è¡Œæ°”è±¡é¢„æµ‹ï¼Œå¯¹äºè¿™ç±»åº”ç”¨æˆ‘ä»¬å¤„ç†çš„æ–¹å¼å°±æ˜¯ä¸æ–­çš„æå‡è®¡ç®—æœºçš„ç®—åŠ›ï¼Œæ¯”å¦‚å¢åŠ CPUçš„æ ¸æ•°ï¼Œå¢åŠ å†…å­˜ç­‰</p>
<p>ğŸ…±ï¸ å†æœ‰å°±æ˜¯æ•°æ®å¯†é›†å‹ï¼Œè¿™ç±»åº”ç”¨çš„ç“¶é¢ˆæ˜¯ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>æ•°æ®é‡ï¼ŒVolume</p>
</li>
<li class="lvl-2">
<p>æ•°æ®çš„å¤æ‚æ€§ï¼ŒVariety</p>
</li>
<li class="lvl-2">
<p>æ•°æ®çš„å˜æ›´é€Ÿåº¦ï¼ŒVelocity</p>
</li>
</ul>
<p>å¯¹äºæ•°æ®å¯†é›†å‹åº”ç”¨ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨æ ‡å‡†çš„ç»„ä»¶æ¥å¤„ç†ï¼š</p>
<p>1ï¸âƒ£ å­˜å‚¨æ•°æ®ï¼Œä»¥ä¾¿è‡ªå·±æˆ–å…¶ä»–åº”ç”¨ç¨‹åºä¹‹åèƒ½å†æ¬¡æ‰¾åˆ°(æ•°æ®åº“ database)</p>
<p>2ï¸âƒ£ è®°ä½å¼€é”€æ˜‚è´µæ“ä½œçš„ç»“æœï¼ŒåŠ å¿«è¯»å–é€Ÿåº¦(ç¼“å­˜ cache)</p>
<p>3ï¸âƒ£ å…è®¸ç”¨æˆ·æŒ‰å…³é”®å­—æœç´¢æ•°æ®ï¼Œæˆ–ä»¥å„ç§æ–¹å¼å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤(æœç´¢ç´¢å¼• search indexes)</p>
<p>4ï¸âƒ£ å‘å…¶ä»–è¿›ç¨‹å‘é€æ¶ˆæ¯ï¼Œè¿›è¡Œå¼‚æ­¥å¤„ç†(æµå¤„ç† stream processing)</p>
<p>5ï¸âƒ£ å®šæœŸå¤„ç†ç´¯ç§¯çš„å¤§æ‰¹é‡æ•°æ®(æ‰¹å¤„ç† batch processing)</p>
<h3 id="å¦‚ä½•æè¿°è´Ÿè½½ï¼Ÿ">å¦‚ä½•æè¿°è´Ÿè½½ï¼Ÿ</h3>
<p>å¯ä»¥ä½¿ç”¨<strong>è´Ÿè½½å‚æ•°ï¼ˆload parametersï¼‰</strong> çš„æ•°å­—æ¥æè¿°è´Ÿè½½ã€‚å‚æ•°å¯èƒ½æ˜¯</p>
<ol>
<li class="lvl-3">
<p>æ¯ç§’å‘WebæœåŠ¡å™¨å‘å‡ºçš„è¯·æ±‚</p>
</li>
<li class="lvl-3">
<p>æ•°æ®åº“ä¸­çš„è¯»å†™æ¯”ç‡</p>
</li>
<li class="lvl-3">
<p>èŠå¤©å®¤ä¸­åŒæ—¶æ´»è·ƒçš„ç”¨æˆ·æ•°é‡</p>
</li>
<li class="lvl-3">
<p>ç¼“å­˜å‘½ä¸­ç‡</p>
</li>
</ol>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œéœ€è¦å…³æ³¨<strong>å¹³å‡æƒ…å†µ</strong>æˆ–è€…<strong>å³°å€¼æƒ…å†µ</strong>ã€‚æœ‰å†™è´Ÿè½½å’Œè¯»è´Ÿè½½ï¼Œå¦‚æœå†™è´Ÿè½½è¿œè¿œä½äºè¯»è´Ÿè½½ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥è®©å†™å…¥æ—¶åšæ›´å¤šçš„å·¥ä½œï¼Œä¾¿äºæˆ‘ä»¬åœ¨è¯»å–çš„æ—¶å€™åšæ›´å°‘çš„å·¥ä½œ</p>
<p>æ¨ç‰¹åœ¨æ¨æ–‡å†™å…¥å’Œæ¨æ–‡è¯»å–æ—¶ï¼Œä½¿ç”¨äº†ä¸¤ç§ä¸åŒçš„ç­–ç•¥</p>
<h3 id="å¦‚ä½•æè¿°æ€§èƒ½ï¼Ÿ">å¦‚ä½•æè¿°æ€§èƒ½ï¼Ÿ</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>æ‰¹å¤„ç†ç³»ç»Ÿï¼Œæ¯ç§’å¯ä»¥å¤„ç†çš„è®°å½•æ•°é‡ï¼Œå³ååé‡ï¼ˆthroughputï¼‰ï¼Œæˆ–è€…åœ¨ç‰¹å®šè§„æ¨¡æ•°æ®é›†ä¸Šè¿è¡Œä½œä¸šçš„æ€»æ—¶é—´</p>
</li>
<li class="lvl-2">
<p>åœ¨çº¿ç³»ç»Ÿï¼Œé€šå¸¸æ›´é‡è¦çš„æ˜¯æœåŠ¡çš„<strong>å“åº”æ—¶é—´ï¼ˆresponse timeï¼‰</strong>ï¼Œå³å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°æ¥æ”¶å“åº”ä¹‹é—´çš„æ—¶é—´</p>
</li>
</ul>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œå°†å“åº”æ—¶é—´è§†ä¸ºä¸€ä¸ªå¯ä»¥æµ‹é‡çš„æ•°å€¼<strong>åˆ†å¸ƒï¼ˆdistributionï¼‰</strong>ï¼Œè€Œä¸æ˜¯å•ä¸ªæ•°å€¼ï¼Œæ¯”å¦‚<strong>100æ¬¡è¯·æ±‚å“åº”æ—¶é—´çš„å‡å€¼ä¸ç™¾åˆ†ä½æ•°</strong>ã€‚ç¬¬95ã€99å’Œ99.9ç™¾åˆ†ä½ç‚¹ï¼ˆç¼©å†™ä¸ºp95ï¼Œp99å’Œp999ï¼‰ï¼Œå¦‚æœç¬¬95ç™¾åˆ†ä½ç‚¹å“åº”æ—¶é—´æ˜¯1.5ç§’ï¼Œåˆ™æ„å‘³ç€100ä¸ªè¯·æ±‚ä¸­çš„95ä¸ªå“åº”æ—¶é—´å¿«äº1.5ç§’ï¼Œè€Œ100ä¸ªè¯·æ±‚ä¸­çš„5ä¸ªå“åº”æ—¶é—´è¶…è¿‡1.5ç§’</p>
<p>ç™¾åˆ†ä½ç‚¹é€šå¸¸ç”¨äº<strong>æœåŠ¡çº§åˆ«ç›®æ ‡ï¼ˆSLO, service level objectivesï¼‰<strong>å’Œ</strong>æœåŠ¡çº§åˆ«åè®®ï¼ˆSLA, service level agreementsï¼‰</strong>ï¼Œå³å®šä¹‰æœåŠ¡é¢„æœŸæ€§èƒ½å’Œå¯ç”¨æ€§çš„åˆåŒï¼Œå¦‚æœæ²¡è¾¾åˆ°æœåŠ¡ç›®æ ‡ï¼Œå®¢æˆ·å¯ä»¥ä¸ä»˜æ¬¾</p>
<p>ä»€ä¹ˆæ˜¯å¤´éƒ¨é˜»å¡ï¼Ÿ</p>
<blockquote>
<p>ç”±äºæœåŠ¡å™¨åªèƒ½å¹¶è¡Œå¤„ç†å°‘é‡çš„äº‹åŠ¡ï¼ˆå¦‚å—å…¶CPUæ ¸æ•°çš„é™åˆ¶ï¼‰ï¼Œæ‰€ä»¥åªè¦æœ‰å°‘é‡ç¼“æ…¢çš„è¯·æ±‚å°±èƒ½é˜»ç¢åç»­è¯·æ±‚çš„å¤„ç†ï¼Œè¿™ç§æ•ˆåº”æœ‰æ—¶è¢«ç§°ä¸º <strong>å¤´éƒ¨é˜»å¡ï¼ˆhead-of-line blockingï¼‰</strong>ï¼Œä¹Ÿå«åš<strong>æ’é˜Ÿå»¶è¿Ÿï¼ˆqueueing delayï¼‰</strong>ï¼Œé€šå¸¸å äº†é«˜ç™¾åˆ†ä½ç‚¹å¤„å“åº”æ—¶é—´çš„å¾ˆå¤§ä¸€éƒ¨åˆ†</p>
<p><strong>å½“ä¸€ä¸ªè¯·æ±‚éœ€è¦å¤šä¸ªåç«¯è¯·æ±‚æ—¶ï¼Œå•ä¸ªåç«¯æ…¢è¯·æ±‚å°±ä¼šæ‹–æ…¢æ•´ä¸ªç»ˆç«¯ç”¨æˆ·çš„è¯·æ±‚</strong>ï¼Œæ•ˆæœç§°ä¸ºå°¾éƒ¨å»¶è¿Ÿæ”¾å¤§</p>
</blockquote>
<p>è´Ÿè½½å‚æ•°å’Œæ€§èƒ½å‚æ•°æ˜¯è®¨è®ºå¯æ‰©å±•æ€§çš„å‰æï¼Œå¯æ‰©å±•æ€§å³ä¸ºå½“è´Ÿè½½å‚æ•°å¢åŠ æ—¶ï¼Œå¦‚ä½•ä¿æŒè‰¯å¥½çš„æ€§èƒ½ï¼Ÿ</p>
<h3 id="ä»€ä¹ˆæ˜¯å¼¹æ€§çš„ï¼Ÿ">ä»€ä¹ˆæ˜¯å¼¹æ€§çš„ï¼Ÿ</h3>
<p>å¦‚æœè¯´ç³»ç»Ÿæ˜¯ <strong>å¼¹æ€§ï¼ˆelasticï¼‰</strong> çš„ï¼Œè¿™æ„å‘³ç€å¯ä»¥åœ¨æ£€æµ‹åˆ°è´Ÿè½½å¢åŠ æ—¶è‡ªåŠ¨å¢åŠ è®¡ç®—èµ„æºï¼Œè€Œå…¶ä»–ç³»ç»Ÿåˆ™æ˜¯æ‰‹åŠ¨æ‰©å±•ï¼ˆäººå·¥åˆ†æå®¹é‡å¹¶å†³å®šå‘ç³»ç»Ÿæ·»åŠ æ›´å¤šçš„æœºå™¨ï¼‰</p>
<h1>ç¬¬2ç« èŠ‚-æ•°æ®æ¨¡å‹ä¸æŸ¥è¯¢è¯­è¨€</h1>
<h2 id="æ–‡æ¡£æ¨¡å‹å’Œå…³ç³»æ¨¡å‹çš„ä¼˜åŠ£åŠ¿ï¼Ÿ">æ–‡æ¡£æ¨¡å‹å’Œå…³ç³»æ¨¡å‹çš„ä¼˜åŠ£åŠ¿ï¼Ÿ</h2>
<p>æ–‡æ¡£æ¨¡å‹å¦‚JSONçš„ä¼˜åŠ¿åœ¨äºç»“æ„çµæ´»ï¼Œä½ å¯ä»¥å°†ä»»æ„çš„é”®å’Œå€¼æ·»åŠ åˆ°æ–‡æ¡£ä¸­ï¼Œè€Œåœ¨å…³ç³»æ¨¡å‹ä¸­ä½ å¿…é¡»æå‰é¢„è®¾è¿™æ ·çš„å­—æ®µæˆ–è€…è¿›è¡Œ <code>alter table</code> æ“ä½œï¼Œæ–‡æ¡£æ¨¡å‹åœ¨è¿æ¥ä¸Šçš„åŠ£åŠ¿ï¼Œå¯¼è‡´æ•°æ®å¦‚æœæœ‰å¤šä»½ï¼Œå¿…é¡»è¦å­˜å‚¨å¤šæ¬¡ï¼Œæœ‰è¾ƒé«˜çš„æ•°æ®ä¸ä¸€è‡´é£é™©ã€‚å¦‚æœæ¯æ¬¡è¯»å–æ–‡æ¡£çš„å…¨éƒ¨æˆ–è€…å¤§éƒ¨åˆ†å†…å®¹ï¼ŒæŸ¥è¯¢å±€éƒ¨æ€§ä¼šæœ‰å¾ˆå¤§ä¼˜åŠ¿ï¼Œè€Œå…³ç³»æ¨¡å‹å°†æ•°æ®åˆ†å‰²å¤šå—çš„è¡Œä¸ºï¼Œä¸å¾—ä¸è¿›è¡Œè¿æ¥</p>
<p>å…³ç³»æ¨¡å‹ä¸€èˆ¬æ˜¯è§„èŒƒåŒ–çš„ï¼Œèƒ½å¤Ÿä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ˆå¤–é”®ï¼‰ï¼Œä½†æ˜¯å…¶ä¸­çš„ç»“æ„å˜åŒ–ï¼Œæ˜¯ä¸€ä¸ªè¾ƒè€—æ—¶çš„æ“ä½œå¦‚æœè¡¨å¾ˆå¤§çš„è¯ï¼Œæ‰§è¡Œ <code>alter table  &amp; update </code> éœ€è¦å¾ˆä¹…ï¼Œæ­¤æ—¶ä¼šæœ‰é”è¡¨è¡Œä¸º</p>
<h2 id="å£°æ˜å¼æŸ¥è¯¢vså‘½ä»¤å¼æŸ¥è¯¢">å£°æ˜å¼æŸ¥è¯¢vså‘½ä»¤å¼æŸ¥è¯¢</h2>
<p>å£°æ˜å¼æŸ¥è¯¢å‘Šè¯‰å­˜å‚¨å¼•æ“ï¼šæˆ‘éœ€è¦<code>Sharks</code>ç±»æ•°æ®ï¼Œè€Œå‘½ä»¤å¼æŸ¥è¯¢ç»™å‡ºæ‰¾åˆ°Aç±»æ•°æ®çš„æ–¹æ³•ï¼Œå­˜å‚¨å¼•æ“æŒ‰ç…§è¿™ä¸ªæ–¹æ³•æ‰§è¡Œå³å¯,è€Œä¼—å¤šç¼–ç¨‹è¯­è¨€å°±æ˜¯å‘½ä»¤å¼çš„</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">function <span class="title function_">getSharks</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">var</span> <span class="variable">sharks</span> <span class="operator">=</span> [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">var</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; animals.length; i++) {</span><br><span class="line">        <span class="keyword">if</span> (animals[i].family === <span class="string">"Sharks"</span>) {</span><br><span class="line">            sharks.push(animals[i]);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> sharks;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>SQLæ˜¯ä¸€ç§å£°æ˜å¼çš„æŸ¥è¯¢è¯­å¥ï¼Œå£°æ˜å¼æŸ¥è¯¢ä¸æä¾›æ–¹æ³•ï¼Œä»…æŒ‡å®šç»“æœçš„æ¨¡å¼ï¼Œæ¥æ”¶å£°æ˜çš„æ•°æ®åº“å¯ä»¥è‡ªè¡Œé€‰æ‹©é«˜æ ¡çš„æ–¹æ³•</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> animals <span class="keyword">WHERE</span> family <span class="operator">=</span><span class="string">'Sharks'</span>;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="MapReduceæ˜¯ä»€ä¹ˆ">MapReduceæ˜¯ä»€ä¹ˆ</h2>
<p>MapReduceæ˜¯ä¸€ä¸ªç”±Googleæ¨å¹¿çš„ç¼–ç¨‹æ¨¡å‹ï¼Œå®ƒåŸºäº<code>map</code>ï¼ˆä¹Ÿç§°ä¸º<code>collect</code>ï¼‰å’Œ<code>reduce</code>ï¼ˆä¹Ÿç§°ä¸º<code>fold</code>æˆ–<code>inject</code>ï¼‰å‡½æ•°ã€‚å®ƒæ—¢ä¸æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„æŸ¥è¯¢è¯­è¨€ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªå®Œå…¨å‘½ä»¤å¼çš„æŸ¥è¯¢APIï¼Œè€Œæ˜¯å¤„äºä¸¤è€…ä¹‹é—´ï¼šæŸ¥è¯¢çš„é€»è¾‘ç”¨ä»£ç ç‰‡æ–­æ¥è¡¨ç¤ºï¼Œè¿™äº›ä»£ç ç‰‡æ®µä¼šè¢«å¤„ç†æ¡†æ¶é‡å¤æ€§è°ƒç”¨</p>
<h2 id="å›¾">å›¾</h2>
<p>å¦‚æœä½ çš„åº”ç”¨ç¨‹åºå¤§å¤šæ•°çš„å…³ç³»æ˜¯ä¸€å¯¹å¤šå…³ç³»ï¼ˆæ ‘çŠ¶ç»“æ„åŒ–æ•°æ®ï¼‰ï¼Œæˆ–è€…å¤§å¤šæ•°è®°å½•ä¹‹é—´ä¸å­˜åœ¨å…³ç³»ï¼Œé‚£ä¹ˆä½¿ç”¨æ–‡æ¡£æ¨¡å‹æ˜¯åˆé€‚çš„ã€‚å…³ç³»æ¨¡å‹å¯ä»¥å¤„ç†å¤šå¯¹å¤šå…³ç³»çš„ç®€å•æƒ…å†µï¼Œä½†æ˜¯éšç€æ•°æ®ä¹‹é—´çš„è¿æ¥å˜å¾—æ›´åŠ å¤æ‚ï¼Œå°†æ•°æ®å»ºæ¨¡ä¸ºå›¾å½¢æ˜¾å¾—æ›´åŠ è‡ªç„¶</p>
<p>ä¸€ä¸ªå›¾ç”±ä¸¤ç§å¯¹è±¡ç»„æˆï¼š<strong>é¡¶ç‚¹ï¼ˆverticesï¼‰</strong> å’Œ <strong>è¾¹ï¼ˆedgesï¼‰</strong>ï¼Œå…¸å‹çš„ä¾‹å­åŒ…æ‹¬ï¼šç¤¾äº¤å›¾è°±,ç½‘ç»œå›¾è°±,å…¬è·¯æˆ–é“è·¯ç½‘ç»œ</p>
<h3 id="A-ä»€ä¹ˆæ˜¯å±æ€§å›¾æ¨¡å‹ï¼Ÿ">A-ä»€ä¹ˆæ˜¯å±æ€§å›¾æ¨¡å‹ï¼Ÿ</h3>
<p>åœ¨å±æ€§å›¾æ¨¡å‹ä¸­ï¼ŒåŒ…å«é¡¶ç‚¹å’Œè¾¹ï¼Œåœ¨å±æ€§å›¾æ¨¡å‹ä¸­ï¼Œé¡¶ç‚¹å’Œè¾¹åˆ†åˆ«åŒ…æ‹¬</p>
<table>
<thead>
<tr>
<th>é¡¶ç‚¹ï¼ˆvertexï¼‰</th>
<th>è¾¹ï¼ˆedgeï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>å”¯ä¸€çš„æ ‡è¯†ç¬¦</td>
<td>å”¯ä¸€çš„æ ‡è¯†ç¬¦</td>
</tr>
<tr>
<td>ä¸€ç»„ <strong>å‡ºè¾¹ï¼ˆoutgoing edgesï¼‰</strong></td>
<td>è¾¹çš„èµ·ç‚¹ï¼ˆtail vertexï¼‰</td>
</tr>
<tr>
<td>ä¸€ç»„ <strong>å…¥è¾¹ï¼ˆingoing edgesï¼‰</strong></td>
<td>è¾¹çš„ç»ˆç‚¹ï¼ˆhead vertexï¼‰</td>
</tr>
<tr>
<td></td>
<td>æè¿°ä¸¤ä¸ªé¡¶ç‚¹ä¹‹é—´å…³ç³»ç±»å‹çš„æ ‡ç­¾</td>
</tr>
<tr>
<td>ä¸€ç»„å±æ€§ï¼ˆé”®å€¼å¯¹ï¼‰</td>
<td>ä¸€ç»„å±æ€§ï¼ˆé”®å€¼å¯¹ï¼‰</td>
</tr>
</tbody>
</table>
<p>å¯ä»¥å°†å›¾å­˜å‚¨çœ‹ä½œç”±ä¸¤ä¸ªå…³ç³»è¡¨ç»„æˆï¼šä¸€ä¸ªå­˜å‚¨é¡¶ç‚¹ï¼Œå¦ä¸€ä¸ªå­˜å‚¨è¾¹</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> vertices (</span><br><span class="line">  vertex_id  <span class="type">INTEGER</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">  properties JSON</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> edges (</span><br><span class="line">  edge_id     <span class="type">INTEGER</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">  tail_vertex <span class="type">INTEGER</span> <span class="keyword">REFERENCES</span> vertices (vertex_id),</span><br><span class="line">  head_vertex <span class="type">INTEGER</span> <span class="keyword">REFERENCES</span> vertices (vertex_id),</span><br><span class="line">  label       TEXT,</span><br><span class="line">  properties  JSON</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç»™å®šä»»ä½•é¡¶ç‚¹ï¼Œå¯ä»¥é«˜æ•ˆåœ°æ‰¾åˆ°å®ƒçš„å…¥è¾¹å’Œå‡ºè¾¹ï¼Œä»è€Œéå†å›¾ï¼Œå³æ²¿ç€ä¸€ç³»åˆ—é¡¶ç‚¹çš„è·¯å¾„å‰åç§»åŠ¨ï¼Œå»ºä»¥ä¸‹ç´¢å¼•</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX edges_tails <span class="keyword">ON</span> edges (tail_vertex);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX edges_heads <span class="keyword">ON</span> edges (head_vertex);</span><br></pre></td></tr></tbody></table></figure>
<h3 id="B-Cypher-å±æ€§å›¾æ¨¡å‹å£°æ˜å¼æŸ¥è¯¢è¯­å¥">B-Cypher å±æ€§å›¾æ¨¡å‹å£°æ˜å¼æŸ¥è¯¢è¯­å¥</h3>
<p>Cypheræ˜¯å±æ€§å›¾çš„å£°æ˜å¼æŸ¥è¯¢è¯­è¨€ï¼Œä¸ºNeo4jå›¾å½¢æ•°æ®åº“è€Œå‘æ˜</p>
<p align="center">
  <img src="/2023/09/21/ddia/57.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> å›¾æ¨¡å‹&amp;å›¾æ•°æ®å†™å…¥&amp;å›¾æ•°æ®æŸ¥è¯¢ </span>
</p>
<h2 id="è¯»æ—¶æ¨¡å¼vså†™æ—¶æ¨¡å¼">è¯»æ—¶æ¨¡å¼vså†™æ—¶æ¨¡å¼</h2>
<p><strong>è¯»æ—¶æ¨¡å¼ï¼ˆschema-on-readï¼‰</strong>ï¼šæ•°æ®çš„ç»“æ„æ˜¯éšå«çš„ï¼Œåªæœ‰åœ¨æ•°æ®è¢«è¯»å–æ—¶æ‰è¢«è§£é‡Šï¼Œæ¯”å¦‚æ–‡æ¡£æ•°æ®åº“</p>
<p><strong>å†™æ—¶æ¨¡å¼ï¼ˆschema-on-writeï¼‰</strong>ï¼šä¼ ç»Ÿçš„å…³ç³»æ•°æ®åº“æ–¹æ³•ä¸­ï¼Œæ¨¡å¼æ˜ç¡®ï¼Œä¸”æ•°æ®åº“ç¡®ä¿æ‰€æœ‰çš„æ•°æ®éƒ½ç¬¦åˆå…¶æ¨¡å¼</p>
<p>è¯»æ—¶æ¨¡å¼ç±»ä¼¼äºç¼–ç¨‹è¯­è¨€ä¸­çš„åŠ¨æ€ï¼ˆè¿è¡Œæ—¶ï¼‰ç±»å‹æ£€æŸ¥ï¼Œè€Œå†™æ—¶æ¨¡å¼ç±»ä¼¼äºé™æ€ï¼ˆç¼–è¯‘æ—¶ï¼‰ç±»å‹æ£€æŸ¥ï¼Œå°±åƒé™æ€å’ŒåŠ¨æ€ç±»å‹æ£€æŸ¥çš„ç›¸å¯¹ä¼˜ç‚¹å…·æœ‰å¾ˆå¤§çš„äº‰è®®æ€§ä¸€æ ·ï¼Œæ•°æ®åº“ä¸­æ¨¡å¼çš„å¼ºåˆ¶æ€§æ˜¯ä¸€ä¸ªå…·æœ‰äº‰è®®çš„è¯é¢˜ï¼Œä¸€èˆ¬æ¥è¯´æ²¡æœ‰æ­£ç¡®æˆ–é”™è¯¯çš„ç­”æ¡ˆ</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>åœ¨å†å²ä¸Šï¼Œæ•°æ®æœ€å¼€å§‹è¢«è¡¨ç¤ºä¸ºä¸€æ£µå¤§æ ‘ï¼ˆå±‚æ¬¡æ•°æ®æ¨¡å‹ï¼‰ï¼Œç”±äºä¸é€‚åˆè¡¨ç¤ºå¤šå¯¹å¤šçš„å…³ç³»ï¼Œå‘æ˜äº†å…³ç³»æ¨¡å‹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åæ¥ï¼Œäººä»¬å‘ç°ä¸€äº›åº”ç”¨ç¨‹åºä¹Ÿä¸é€‚åˆé‡‡ç”¨å…³ç³»æ¨¡å‹ï¼Œäºæ˜¯æ–°çš„éå…³ç³»å‹â€œNoSQLâ€æ•°æ®</p>
<ol>
<li class="lvl-3">
<p>æ–‡æ¡£æ•°æ®åº“çš„åº”ç”¨åœºæ™¯æ˜¯ï¼šæ•°æ®é€šå¸¸æ˜¯è‡ªæˆ‘åŒ…å«çš„ï¼Œè€Œä¸”æ–‡æ¡£ä¹‹é—´çš„å…³ç³»éå¸¸ç¨€å°‘ã€‚</p>
</li>
<li class="lvl-3">
<p>å›¾å½¢æ•°æ®åº“ç”¨äºç›¸åçš„åœºæ™¯ï¼šä»»æ„äº‹ç‰©éƒ½å¯èƒ½ä¸ä»»ä½•äº‹ç‰©ç›¸å…³è”ã€‚</p>
</li>
</ol>
<p>è¿™ä¸‰ç§æ¨¡å‹ï¼ˆæ–‡æ¡£ï¼Œå…³ç³»å’Œå›¾å½¢ï¼‰åœ¨ä»Šå¤©éƒ½è¢«å¹¿æ³›ä½¿ç”¨</p>
<h1>ç¬¬3ç« èŠ‚-å­˜å‚¨ä¸æ£€ç´¢</h1>
<p>å­˜å‚¨ä¸æ£€ç´¢çš„å†…å®¹ï¼Œå³ï¼šæ•°æ®åº“åœ¨æœ€åŸºç¡€çš„å±‚æ¬¡ä¸Šå®Œæˆçš„2ä»¶äº‹æƒ…ï¼š</p>
<p>ğŸ…°ï¸ å½“ä½ æŠŠæ•°æ®äº¤ä»˜ç»™å®ƒçš„æ—¶å€™ï¼Œå®ƒå¦‚ä½•å°†æ•°æ®å­˜å‚¨èµ·æ¥</p>
<p>ğŸ…±ï¸ å½“ä½ å‘æ•°æ®åº“ç´¢è¦æ•°æ®æ—¶ï¼Œå®ƒå¦‚ä½•å°†æ•°æ®è¿”å›ç»™ä½ </p>
<p>ç”±äº<strong>äº‹åŠ¡æ€§è´Ÿè½½</strong>å’Œ<strong>åˆ†ææ€§è´Ÿè½½</strong>çš„å­˜å‚¨å¼•æ“ä¹‹é—´å­˜åœ¨ç€å¾ˆå¤§çš„å·®å¼‚ï¼Œè¿™ä¸¤ç±»çš„å­˜å‚¨å¼•æ“æˆ‘ä»¬åˆ†å¼€æ¥æè¿°</p>
<p><strong>åœ¨äº‹åŠ¡å¤„ç†æ–¹é¢</strong>ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>æ—¥å¿—ç»“æ„å­˜å‚¨å¼•æ“  ï¼›ä»æœ€ç®€å•çš„æ•°æ®åº“å®ç°append-log(æ— ç´¢å¼•æ—¥å¿—)åˆ° LSM(æ—¥å¿—ç»“æ„åˆå¹¶æ ‘) æ ‘çš„æ¼”åŒ–å†ç¨‹</p>
</li>
<li class="lvl-2">
<p>é¢å‘é¡µé¢çš„å­˜å‚¨å¼•æ“ ï¼Œå…¸å‹çš„æ¯”å¦‚B-Tree</p>
</li>
</ul>
<p>åœ¨<strong>åˆ†ææ€§å­˜å‚¨å¼•æ“æ–¹é¢</strong>ï¼Œæˆ‘ä»¬è°ˆè°ˆ</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>æ•°æ®ä»“åº“</p>
</li>
<li class="lvl-2">
<p>æ˜Ÿå‹æ¨¡å‹&amp;é›ªèŠ±æ¨¡å‹</p>
</li>
<li class="lvl-2">
<p>åˆ—å­˜å‚¨</p>
</li>
</ul>
<h2 id="æ— ç´¢å¼•æ—¥å¿—">æ— ç´¢å¼•æ—¥å¿—</h2>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <strong>ä¸–ç•Œä¸Šæœ€ç®€å•çš„æ•°æ®åº“</strong> æ˜¯å¦‚ä½•å®ç°çš„</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>æ’å…¥æ“ä½œï¼ˆ<code>db_set</code>ï¼‰</p>
</li>
<li class="lvl-2">
<p>æ›´æ–°æ“ä½œï¼ˆ<code>db_set</code>ï¼‰</p>
</li>
<li class="lvl-2">
<p>æŸ¥è¯¢æ“ä½œï¼ˆ<code>db_get</code>ï¼‰</p>
</li>
</ul>
<p align="center">
  <img src="/2023/09/21/ddia/16.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> æ— ç´¢å¼•æ—¥å¿— &amp; æœ€ç®€å•çš„æ•°æ®åº“ </span>
</p>
é‚£ä¹ˆè¿™ä¸ªæœ€ç®€å•çš„æ•°æ®åº“åº•å±‚æ˜¯å¦‚ä½•è¿›è¡Œæ•°æ®çš„æ‘†æ”¾çš„å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°`db_set()`å°±æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„è¿½åŠ [^4]ï¼Œè¿™**ç®€ç›´ä¸æ˜¯ç®€å•ï¼Œç”šè‡³å¯ä»¥è¯´æ˜¯ç®€é™‹**ä½†æ­£æ˜¯ç”±äºè¿™ç§è®¾è®¡ä½¿å¾—å†™å…¥å˜çš„éå¸¸çš„é«˜æ•ˆï¼Œä»£ä»·å°±æŸ¥æ‰¾çš„å¼€é”€æ˜¯ $O(n)$ ï¼Œ $O(n)$ çš„å¤æ‚åº¦ï¼Œè¿™æ„å‘³ç€å¦‚æœæ•°æ®é‡å¢åŠ ä¸€å€ï¼ŒæŸ¥è¯¢å“åº”æ—¶é—´å°†ä¼šå¢åŠ ä¸€å€ã€‚ä¹Ÿå°±æ˜¯è¯´æŸ¥è¯¢æ—¶é—´å’Œæ•°æ®é‡ä¹‹é—´çš„å…³ç³»æ˜¯çº¿æ€§ç›¸å…³çš„ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦**æ›´å¿«çš„å¾—åˆ°ç›®æ ‡ç»“æœ**ï¼Œé‚£ä¹ˆå¦‚ä½•å»æå‡æ•°æ®çš„æŸ¥æ‰¾æ•ˆç‡ï¼Ÿ
<blockquote></blockquote>
<h2 id="å¦‚ä½•æå‡æŸ¥æ‰¾æ•ˆç‡ï¼Ÿ">å¦‚ä½•æå‡æŸ¥æ‰¾æ•ˆç‡ï¼Ÿ</h2>
<p align="center">
  <img src="/2023/09/21/ddia/17.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> åº·ç†™å­—æ®µVSæ–°åå­—å…¸ </span>
</p>
<p>å½“æˆ‘ä»¬è¿˜æ˜¯ä¸€ä¸ªå°å­¦ç”Ÿçš„æ—¶å€™ï¼Œå¯èƒ½é¢ä¸´è¿‡ç±»ä¼¼çš„é—®é¢˜ï¼Œå‡è®¾è¯´ç°åœ¨æœ‰2ä¸ªå°å­¦ç”Ÿï¼Œå¿˜è®°äº†<strong>å›§</strong>å­—æ€ä¹ˆå†™ï¼Œæƒ³è¦ç”¨æ–°åå­—å…¸æŸ¥è¯¢ä¸€ä¸‹ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å°æ˜åŒå­¦ä½¿ç”¨çš„æ˜¯ä¸€æœ¬æ²¡æœ‰ç›®å½•çš„å­—å…¸(æ¯”å¦‚è¯´åº·ç†™å­—å…¸)</p>
</li>
<li class="lvl-2">
<p>å°çº¢åŒå­¦ ä½¿ç”¨çš„æ˜¯ä¸€æœ¬æœ‰ç›®å½•çš„å­—å…¸(ç°ä»£æ–°åå­—å…¸)</p>
<p>é‚£ä¹ˆè°æœ€åèƒ½æ›´å¿«çš„è·çŸ¥ <code>jiong</code> å­—çš„å†™æ³•å‘¢ï¼Ÿç›´è§‰å‘Šè¯‰æˆ‘ä»¬å°çº¢åŒå­¦æœ‰è¾ƒå¤§çš„æ¦‚ç‡æœ€å¿«è·å–åˆ° <code>joing</code>å­—çš„å†™æ³•</p>
</li>
</ul>
<p>ç°ä»£å­—å…¸çš„ç‰¹å¾å°±æ˜¯éƒ½ä¼šæœ‰ä¸€ä¸ªç›®å½•ï¼Œè¿™ä¸ªç›®å½•æ˜¯åœ¨<strong>åŸå§‹æ•°æ®ä¹‹å¤–ç»´æŠ¤çš„é¢å¤–çš„æ•°æ®</strong>ï¼Œæ­£æ˜¯ç”±äºç›®å½•çš„å­˜åœ¨ï¼Œä½¿å¾—å°çº¢åŒå­¦èƒ½å¤Ÿæ›´å¿«çš„è·å–åˆ°ç›®æ ‡æ•°æ®ã€‚å…¶å®è¿™ä¸ªç›®å½•ï¼Œå…¶å®å°±ç›¸å½“äºè‹±æ–‡ä¸­çš„ <code>index</code> , è€Œ <code>index</code>è‹±è¯‘å°±æ˜¯ç´¢å¼•ï¼Œè‡³æ­¤æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªç»“è®ºï¼š</p>
<blockquote>
<p>ç´¢å¼• æ˜¯åœ¨åŸå§‹æ•°æ®ä¹‹å¤–ç»´æŠ¤çš„é¢å¤–çš„æ•°æ®ï¼Œç´¢å¼• å¯ä»¥åŠ é€Ÿæ•°æ®è®¿é—®</p>
</blockquote>
<p>ğŸˆ<strong>Post Script</strong>ğŸˆ</p>
<p>ç”±äºéœ€è¦åœ¨åŸå§‹æ•°æ®ä¹‹å¤–é¢å¤–ç»´æŠ¤ä¸€ä»½æ•°æ®ï¼Œè¿™å°±æ— å½¢å¢åŠ äº†ç©ºé—´å¤æ‚åº¦ï¼Œåœ¨è®¡ç®—æœºé¢†åŸŸä¸­ï¼Œæ—¶é—´å’Œç©ºé—´å°±åƒé±¼å’Œç†ŠæŒä¸€æ ·ï¼Œä¸å¯å…¼å¾—ï¼Œé™ä½æ—¶é—´å¤æ‚åº¦çš„æ–¹å¼å°±<strong>ç”¨ç©ºé—´æ¢å–æ—¶é—´</strong>ï¼› å¯ä»¥è¯´è¿™ä¸ªé—®é¢˜åœ¨è®¡ç®—æœºé¢†åŸŸæ˜¯ä¸€ä¸ªç»•ä¸å¼€çš„è¯é¢˜ï¼Œå¦‚ä½•å»æå‡æŸ¥æ‰¾æ•ˆç‡è¿™ä¸ªé—®é¢˜çš„å¦å¤–ä¸€ç§é—®æ³•æ˜¯ï¼š<strong>ç»™æˆ‘ä¸€ä¸ªæ›´ä½çš„æ—¶é—´å¤æ‚åº¦</strong>çš„å®ç°ï¼Œé‚£ä¹ˆå¸¸è§çš„æ¯” $O(n)$  è¿˜ä½çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯ $O(1)$ï¼Œ $O (log_n)$  ä¸¤ä¸ªï¼Œ$O(1)$ çš„æ—¶é—´å¤æ‚åº¦ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±ä¼šæƒ³åˆ°å“ˆå¸Œè¡¨ï¼Œå› ä¸ºå“ˆå¸Œè¡¨çš„æ—¶é—´å¤æ‚åº¦é»˜è®¤æ˜¯ $O(1)$ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•æ„å»ºå“ˆå¸Œç´¢å¼•æ¥æå‡æŸ¥è¯¢æ•ˆç‡</p>
<h2 id="å†…å­˜ä¸­æ„å»ºhashç´¢å¼•">å†…å­˜ä¸­æ„å»ºhashç´¢å¼•</h2>
<p align="center">
  <img src="/2023/09/21/ddia/18.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> ä¸ºæ—¥å¿—æ„å»ºå“ˆå¸Œç´¢å¼• </span>
</p>
<p>é‚£ä¹ˆå¯¹äºå­˜å‚¨äºç£ç›˜ä¸­çš„æ•°æ®ï¼Œæˆ‘ä»¬åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ª<code>HashMap</code>ï¼Œç»´æŠ¤<code>key</code>å’Œ<code>value</code> çš„åç§»é‡ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿè¿…é€Ÿçš„å®šä½åˆ°ç›®æ ‡æ•°æ®ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³è¦æ‰¾åˆ° <code>key = 42</code> çš„æ•°æ®ï¼Œé€šè¿‡æŸ¥è¯¢å†…å­˜ä¸­çš„HashMapè¡¨ï¼Œè·å¾—åç§»é‡64 ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å®šä½åˆ°æ•°æ®ï¼Œè€Œä¸åœ¨éœ€è¦ä»å¤´å¼€å§‹éå†</p>
<p>éšç€æˆ‘ä»¬ä¸æ–­çš„åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ æ–‡ä»¶ï¼Œç£ç›˜ä¸­çš„å•ä¸ªæ–‡ä»¶ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ï¼Œç”šè‡³å•ä¸ªæ–‡ä»¶å¯èƒ½åƒæ‰æ•´ä¸ªç£ç›˜çš„å­˜å‚¨ã€‚æ‰€ä»¥ï¼Œ<strong>å¦‚ä½•ç”¨æœ‰é™çš„å­˜å‚¨å­˜å‚¨æ›´å¤šçš„æ•°æ®ï¼Ÿ</strong> å³ï¼Œå¦‚ä½•é¿å…ç£ç›˜çš„ç©ºé—´çš„æ¶ˆè€—ï¼Ÿ</p>
<h2 id="åˆ†æ®µå­˜å‚¨-å‹ç¼©-åˆ†æ®µåˆå¹¶-hashç´¢å¼•çš„å±€é™æ€§">åˆ†æ®µå­˜å‚¨&amp;å‹ç¼©&amp;åˆ†æ®µåˆå¹¶ &amp; hashç´¢å¼•çš„å±€é™æ€§</h2>
<p align="center">
  <img src="/2023/09/21/ddia/19.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> æ—¥å¿—åˆ†æ®µ &amp; åˆ†æ®µæ—¥å¿—å‹ç¼© </span>
</p>
<p>æˆ‘ä»¬è§£å†³çš„æ–¹æ¡ˆæ˜¯ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>åˆ†æ®µå­˜å‚¨ï¼šä¹Ÿå°±æ˜¯è¯´å½“è¿½åŠ æ–‡ä»¶çš„ <code>size</code>ï¼ˆé€šå¸¸æ˜¯å‡ å…†å­—èŠ‚ï¼‰ è¾¾åˆ°äº†ä¸€å®šçš„é˜ˆå€¼ä¹‹åï¼Œæˆ‘ä»¬é‡æ–°å†™å…¥æ–°çš„æ–‡ä»¶ï¼ˆæ¯ä¸ªæ®µç»´æŠ¤è‡ªå·±çš„ç´¢å¼•ï¼‰</p>
</li>
<li class="lvl-2">
<p>å‹ç¼©ï¼šä¸¢å¼ƒé‡å¤çš„é”®ï¼Œä¿ç•™æ¯ä¸ªé”®çš„æœ€æ–°å€¼</p>
</li>
</ul>
<p>å¦‚ä¸Šå›¾ä¸­åŸæœ¬12ä¸ªé”® å‹ç¼©ä¹‹åä¹‹å3ä¸ªé”®ï¼Œæ•´ä¸ªæ–‡ä»¶çš„<code>size</code>é™ä½ã€‚<strong>å¦‚ä½•è¿›ä¸€æ­¥æ”¹è¿›ï¼Ÿ</strong></p>
<p align="center">
  <img src="/2023/09/21/ddia/20.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> æ—¥å¿—åˆ†æ®µ &amp; åˆ†æ®µæ—¥å¿—å‹ç¼© &amp; å‹ç¼©æ—¥å¿—åˆå¹¶ </span>
</p>
<p>åœ¨æ‰§è¡Œå‹ç¼©çš„åŒæ—¶ï¼Œå¯ä»¥å°†å‹ç¼©ä¹‹åçš„<strong>æ®µåˆå¹¶</strong>ã€‚å¦‚ Data file segment 1 å’Œ Data file Segment 2 åœ¨å‹ç¼©äº†ä¹‹åï¼Œè¿›è¡Œäº†ä¸€ä¸ªåˆå¹¶æ“ä½œï¼Œå¾—åˆ°äº† Merged Segment(æ¯”å¦‚mew è¿™ä¸ªé”®å‹ç¼©åˆå¹¶çš„è¿‡ç¨‹)ã€‚å‹ç¼©å’Œåˆå¹¶å¯¹ç”¨æˆ·æ˜¯æ²¡æœ‰æ„ŸçŸ¥çš„ï¼Œç”±åå°è¿›ç¨‹å®Œæˆï¼Œåœ¨åˆå¹¶çš„æ—¶å€™ç”±æ—§çš„æ®µæ–‡ä»¶æä¾›è¯»å†™è¯·æ±‚ï¼Œåœ¨åˆå¹¶å®Œæˆä¹‹åï¼Œè¯»å†™è¯·æ±‚è½¬åŒ–ä¸ºæ–°çš„åˆå¹¶åçš„æ®µ</p>
<p>é‚£ä¹ˆç”±äºhashè¡¨æœ¬èº«çš„ç‰¹æ€§ï¼Œä¹Ÿä¼šå¯¼è‡´æˆ‘ä»¬æ„å»ºçš„å“ˆå¸Œç´¢å¼•æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œæ¯”å¦‚ï¼š</p>
<p>ğŸ…°ï¸ å“ˆå¸Œè¡¨æ˜¯å­˜åœ¨äºå†…å­˜ä¸­çš„</p>
<p>ğŸ…±ï¸ èŒƒå›´æŸ¥è¯¢æ˜¯è½¯è‚‹</p>
<p>é‚£ä¹ˆå¦‚ä½•çªç ´å“ˆå¸Œè¡¨çš„å±€é™æ€§ï¼Œå¯»æ‰¾æ›´å¥½çš„ç´¢å¼•ç»“æ„ï¼Ÿ</p>
<h2 id="SSTable-æ’åºå­—ç¬¦ä¸²è¡¨">SSTable æ’åºå­—ç¬¦ä¸²è¡¨</h2>
<p>è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯ï¼šæ’åºå­—ç¬¦ä¸²è¡¨ï¼Œä¹Ÿå°±æ˜¯<strong>SSTable<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup></strong>, ä¹Ÿå°±æ˜¯ï¼šåœ¨æ®µæ–‡ä»¶ä¸­ï¼Œå¯¹é”®å€¼å¯¹çš„åºåˆ—æ’åº</p>
<p align="center">
  <img src="/2023/09/21/ddia/21.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> SStable </span>
</p>
<p>æ¯”å¦‚ä¸Šå›¾ä¸­ï¼Œå¯¹äºå·²ç»æ’å¥½åºæ®µæ–‡ä»¶1ï¼Œæ®µæ–‡ä»¶2 ï¼Œæ®µæ–‡ä»¶3 ï¼Œè¿›è¡Œå‹ç¼©å’Œåˆå¹¶ï¼Œè€Œä¸”ï¼Œåœ¨åˆå¹¶ä¹‹åï¼Œä»ç„¶éœ€è¦ä¿è¯åˆå¹¶ä¹‹åçš„æ®µæ–‡ä»¶æœ‰åºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåˆé€‚çš„æ’åºç®—æ³•ï¼š<strong>é‚£ä¹ˆè¿™ä¸ªæ’åºç®—æ³•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</strong> æ˜¯å†¯è¯ºä¾æ›¼å‘æ˜çš„å½’å¹¶æ’åºç®—æ³•ï¼›merge sort çš„ä¼˜åŠ¿å°±åœ¨äºï¼šå†…å­˜åœ¨å°äºè¢«æ’åºæ–‡ä»¶å¤§å°çš„æ—¶å€™ï¼Œä»ç„¶å¯ä»¥å°†æ’åºå®Œæˆ</p>
<blockquote></blockquote>
<p>ä½¿ç”¨SSTableå¯ä»¥æœ‰æ•ˆçš„çªç ´å†…å­˜é™åˆ¶å’Œè§£å†³èŒƒå›´æŸ¥è¯¢çš„é—®é¢˜ã€‚å¦‚ä¸‹å›¾ä¸­æˆ‘ä»¬æŸ¥æ‰¾ï¼Œ<code>handiwork</code> çš„è¿‡ç¨‹ï¼Œå¯ä»¥å‘ç°ä¸æ˜¯åœ¨å†…å­˜ä¸­ä¿å­˜æ‰€æœ‰é”®çš„ç´¢å¼•ï¼Œç”±äºSSTableç»´æŠ¤äº†é¡ºåºå…³ç³»ï¼Œæˆ‘ä»¬çš„ç´¢å¼•ä»¥ç¨€ç–ç´¢å¼•çš„æ–¹å¼å­˜åœ¨äºå†…å­˜ä¸­ã€‚åŒæ—¶ï¼Œå¯ä»¥æ”¯æŒèŒƒå›´æŸ¥è¯¢</p>
<p align="center">
  <img src="/2023/09/21/ddia/22.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> ç¨€ç–ç´¢å¼•ï¼Œæ¯”å¦‚æ¯å‡ åƒä¸ªå­—èŠ‚ä¸€ä¸ªé”® </span>
</p>
<h2 id="LSM-æ—¥å¿—ç»“æ„åˆå¹¶æ ‘">LSM æ—¥å¿—ç»“æ„åˆå¹¶æ ‘</h2>
<p>åœ¨å‰é¢çš„è®²è¿°ä¸­ï¼Œæˆ‘ä»¬é»˜è®¤äº†è½ç›˜æ®µæ–‡ä»¶æ˜¯æœ‰åºçš„ï¼Œåœ¨è½ç›˜å†™å…¥æ®µæ–‡ä»¶ä¹‹å‰ï¼Œ<strong>å¦‚ä½•æŒ‰é”®æ’åº</strong>ï¼Ÿè€ƒè™‘åˆ°æ•ˆç‡é—®é¢˜ï¼Œæœ€åˆçš„çš„å†™å…¥ä¸€å®šæ˜¯åœ¨å†…å­˜ä¸­çš„ï¼Œåˆ°è¾¾ä¸€å®šçš„æ—¶é—´é˜ˆå€¼æˆ–è€…æ˜¯å†…å­˜é˜ˆå€¼çš„æ—¶å€™ï¼Œåœ¨è¿›è¡Œè½ç›˜å½¢æˆ SSTableï¼Œé‚£ä¹ˆå†…å­˜ä¸­<strong>é€‰æ‹©ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„ï¼Ÿ</strong></p>
<p>1ï¸âƒ£ å†…å­˜è¡¨ï¼Œ<strong>ä¸ºä»€ä¹ˆæ˜¯AVL-Tree ï¼Ÿ</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>é¦–å…ˆå¹³è¡¡äºŒå‰æ ‘æœ¬èº«å°±æ˜¯äºŒå‰æœç´¢æ ‘ï¼Œè€ŒäºŒå‰æœç´¢æ ‘ä¸­åºéå†å°±æ˜¯é¡ºåºç»“æ„ï¼Œå¯ä»¥ç›´æ¥è½ç›˜å½¢æˆSSTable</p>
</li>
<li class="lvl-2">
<p>ç”±äºå¹³è¡¡ç‰¹æ€§ï¼Œå¯ä»¥ä¿æŒæ ‘çš„ç»“æ„ï¼Œè€Œä¸æ˜¯é€€åŒ–æˆé“¾è¡¨ï¼Œä½¿å¾—æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ç»´æŒåœ¨ $O(logN)$, è€Œä¸”å¯¹äºæ–°åŠ å…¥çš„æ•°æ®ï¼Œå¹³è¡¡äºŒå‰æ ‘é€šè¿‡å·¦æ—‹ï¼Œæˆ–è€…å³æ—‹çš„æ–¹å¼ä¿æŒå¹³è¡¡æ€§</p>
</li>
</ul>
<p>2ï¸âƒ£ è½ç›˜ï¼Œä¹Ÿå°±æ˜¯å¹³è¡¡äºŒå‰æ ‘çš„ä¸­åºéå†æ–¹å¼è½ç›˜</p>
<p>3ï¸âƒ£ è¯»å–è¯·æ±‚ï¼Œå…ˆè¯·æ±‚å†…å­˜ï¼Œç„¶åæŸ¥è¯¢ç£ç›˜æ®µ</p>
<p>4ï¸âƒ£ å‹ç¼©å’Œåˆå¹¶ï¼š åå°å‹ç¼©åˆå¹¶æ®µæ–‡ä»¶ï¼Œå¹¶ä¸¢å¼ƒè¦†ç›–/åˆ é™¤æ—§å€¼</p>
<p>5ï¸âƒ£ é˜²æ­¢æ•°æ®åº“å´©æºƒï¼ˆä¿å­˜åœ¨AVL-Treeï¼Œä½†æ˜¯æœªè½ç›˜åˆ°SStableï¼‰ï¼šç£ç›˜ä¿ç•™ä¸€ä»½å•ç‹¬çš„æ—¥å¿—ï¼Œæ¯ä¸ªå†™å…¥éƒ½è¿½åŠ åˆ°ç£ç›˜ä¸Šï¼Œé˜²æ­¢æ•°æ®åº“å´©æºƒï¼Œå†…å­˜æ•°æ®ä¸¢å¤±</p>
<p align="center">
  <img src="/2023/09/21/ddia/23.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> é‚£ä¹ˆä½¿ç”¨è¿™ç§LSMç»“æ„çš„ç»„ä»¶æœ‰å“ªäº› </span>
</p>
<p>Cassandra<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>ã€Bigtableã€HBaseã€Elasticsearchã€Solr<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup>ã€Hologres<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup></p>
<blockquote></blockquote>
<p><strong>è¿™ç§å…ˆå†…å­˜æ’åºï¼Œå†è½ç›˜æ’åºçš„ç»“æ„ï¼Œå°±æ˜¯LSM(Log-Structure Merge Tree æ—¥å¿—ç»“æ„åˆå¹¶æ ‘)ç»“æ„</strong>ï¼Œ<strong>LSMç»“æ„å’ŒBÂ±Treeç›¸æ¯”ï¼Œå‡å°‘äº†éšæœºIOï¼Œæå¤§çš„æé«˜çš„å†™æ€§èƒ½</strong></p>
<h2 id="é¢å‘é¡µå­˜å‚¨å¼•æ“">é¢å‘é¡µå­˜å‚¨å¼•æ“</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»å¦å¤–ä¸€ç§å­˜å‚¨å¼•æ“ï¼šé¢å‘é¡µé¢çš„å­˜å‚¨å¼•æ“ï¼Œæ¯”å¦‚B æ ‘ï¼ŒBæ ‘ä¼šå°†æ•°æ®åº“åˆ†è§£ä¸ºå›ºå®šå¤§å°çš„å—æˆ–è€…æ˜¯é¡µé¢<sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup>ï¼Œä¼ ç»Ÿå¤§å°ä¸º4Kè€Œä¸”ä¸€æ¬¡åªèƒ½è¯»å–æˆ–è€…å†™å…¥ä¸€ä¸ªé¡µé¢ï¼Œå’ŒLSMå¯¹æ¯”ä¸€ä¸‹</p>
<p align="center">
  <img src="/2023/09/21/ddia/24.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> Bæ ‘å’ŒLSMæ¯”å¯¹ </span>
</p>
<blockquote></blockquote>
<p>ä¸‹å›¾å±•ç¤ºäº†é¢å‘é¡µé¢çš„å­˜å‚¨å¼•æ“æ˜¯å¦‚ä½•æŸ¥è¯¢æ•°æ®çš„</p>
<p align="center">
  <img src="/2023/09/21/ddia/25.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> é¢å‘é¡µé¢çš„å­˜å‚¨å¼•æ“æ˜¯å¦‚ä½•æŸ¥è¯¢æ•°æ®çš„ </span>
</p>
<p>åˆ†æ”¯å› å­ï¼š<strong>åœ¨Bæ ‘ä¸­ä¸€ä¸ªé¡µé¢ä¸­å¯¹å­é¡µé¢çš„å¼•ç”¨æ•°é‡</strong>ã€‚ä¼´éšç€ä¸Šä¸–çºª70å¹´ä»£å…³ç³»å‹æ•°æ®åº“çš„å‘å±•è‡³ä»Šï¼Œé¢å‘é¡µé¢çš„å­˜å‚¨å¼•æ“å‘å±•è‡³ä»Šå·²ç»éå¸¸æˆç†Ÿäº†</p>
<h2 id="å‘é¡µé¢æ·»åŠ å…ƒç´ ">å‘é¡µé¢æ·»åŠ å…ƒç´ </h2>
<p>å¦‚ä½•å‘Bæ ‘ä¸­å¢åŠ ä¸€ä¸ªæ•°æ®ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/26.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> å¦‚ä½•å‘Bæ ‘ä¸­å¢åŠ ä¸€ä¸ªæ•°æ® </span>
</p>
<blockquote>
<p>WALå³åœ¨æ•°æ®å†™æ•°æ®é¡µä¹‹å‰ï¼Œå…ˆè®°å½•åˆ°"å°é»‘æ¿"<sub>WAL</sub>ä¸Šï¼Œå¯¹äºä¸€ä¸ªæ›´æ–°æ“ä½œæ¥è¯´ï¼Œå¦‚æœæ¯æ¬¡æ›´æ–°éƒ½éœ€è¦ç«‹åˆ»å†™ç£ç›˜ï¼Œå­˜å‚¨å¼•æ“éœ€è¦æ‰¾åˆ°è¢«æ›´æ–°çš„è®°å½•ï¼Œç„¶åæ›´æ–°ï¼Œè¿™ä¸ªå…ˆå®šä½å†æ›´æ–°çš„æœºåˆ¶å¿…ç„¶æœ‰ä¸€å®šçš„æˆæœ¬ï¼ˆæŸ¥æ‰¾æˆæœ¬+IOæˆæœ¬ï¼‰ï¼Œå¦‚æœ<strong>å¼•æ“ä¼šå°†è®°å½•å†™åˆ° æ–‡ä»¶ é‡Œï¼Œå¹¶ä¸”æ›´æ–°å†…å­˜</strong>ï¼Œåœ¨é€‚å½“ï¼ˆç³»ç»Ÿæ¯”è¾ƒç©ºï¼‰çš„æ—¶å€™ï¼Œå°†æ“ä½œè®°å½•åˆ·å†™åˆ°ç£ç›˜ï¼Œ å¦‚æ­¤ä¾¿å¯ä»¥æå‡æ›´æ–°æ•ˆç‡ã€‚äº‹å®ä¸ŠMySQLçš„InnDB å¼•æ“å°±æ˜¯è¿™ä¹ˆåšçš„</p>
</blockquote>
<h2 id="æ¯”å¯¹LSMæ ‘-å’Œ-Bæ ‘">æ¯”å¯¹LSMæ ‘ å’Œ Bæ ‘</h2>
<p>æœ€åæˆ‘ä»¬æ¥ä¸€èµ·å¯¹æ¯”ä¸€ä¸‹LSMæ ‘å’ŒBæ ‘ï¼Œä¹Ÿå³é¢å‘æ—¥å¿—çš„å­˜å‚¨å¼•æ“å’Œé¢å‘Bæ ‘çš„å­˜å‚¨å¼•æ“çš„ä¼˜åŠ£åŠ¿</p>
<p align="center">
  <img src="/2023/09/21/ddia/27.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> æ¯”å¯¹LSMæ ‘ å’Œ Bæ ‘ </span>
</p>
<h2 id="OLTP-OLAP-å’Œ-æ•°æ®ä»“åº“">OLTP&amp;OLAP å’Œ æ•°æ®ä»“åº“</h2>
<p>æ•°æ®åº“åœ¨å†å²ä¸­ä¸»è¦ä¸ºä¸¤ç§ç³»ç»Ÿæä¾›æ”¯æŒ</p>
<p>ğŸ…°ï¸ åœ¨çº¿äº‹åŠ¡å¤„ç†ç³»ç»Ÿï¼Œå³ OLTP</p>
<p>ğŸ…±ï¸ åœ¨çº¿åˆ†æç³»ç»Ÿï¼Œå³ OLAP</p>
<p>ä¸‹è¡¨ä¸­å¯¹æ¯”äº†ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ï¼Œ</p>
<p align="center">
  <img src="/2023/09/21/ddia/28.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> OLTP å¯¹æ¯” OLAP </span>
</p>
<p>èµ·åˆçš„æ•°æ®åº“ï¼Œèƒ½å¤ŸåŒæ—¶åº”å¯¹ä»¥ä¸Šä¸¤ç§æŸ¥è¯¢çš„æƒ…å†µï¼Œæ— è®ºæ˜¯OLTPç±»å‹çš„æŸ¥è¯¢ï¼Œè¿˜æ˜¯OLAPç±»å‹çš„æŸ¥è¯¢ï¼Œå•ä¸€çš„æ•°æ®åº“çš„è¡¨ç°çš„éƒ½å¾ˆå¥½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š<strong><u>ä¹Ÿå°±æ˜¯è¯´ä¸¤è€…æ˜¯ä¸€å®¶çš„</u></strong>ã€‚ OLAPé€šå¸¸ä¼šè¦æ±‚ <strong>é«˜å¯ç”¨</strong>ä¸<strong>ä½å»¶è¿Ÿ</strong>ï¼Œä¸ºäº†ä¿è¯ä¸šåŠ¡ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œï¼Œæ‰€ä»¥DBAä¼šå¯†åˆ‡å…³æ³¨ä»–ä»¬çš„OLTPæ•°æ®åº“ï¼Œä»–ä»¬é€šå¸¸ä¸æ„¿æ„è®©ä¸šåŠ¡åˆ†æäººå‘˜åœ¨OLTPæ•°æ®åº“ä¸Šè¿è¡Œä¸´æ—¶åˆ†ææŸ¥è¯¢ï¼Œå› ä¸ºè¿™äº›æŸ¥è¯¢é€šå¸¸å¼€é”€å·¨å¤§ï¼Œä¼šæ‰«æå¤§éƒ¨åˆ†æ•°æ®é›†ï¼Œè¿™ä¼šæŸå®³åŒæ—¶æ‰§è¡Œçš„äº‹åŠ¡çš„æ€§èƒ½ã€‚å¯ä»¥è§å¾—ï¼ŒOALPå’ŒOLTP è¿™å¯¹äº²å…„å¼Ÿå‘ç”Ÿäº†çŸ›ç›¾ï¼ŒçŸ›ç›¾ä¼šæœ€ä½³è§£å†³æ–¹æ¡ˆå°±æ˜¯åˆ†å®¶</p>
<p>åœ¨20ä¸–çºª80å¹´ä»£æœ«å’Œ90å¹´ä»£åˆæœŸï¼Œæ¸æ¸åœ°å¾ˆå¤šå…¬å¸æœ‰åœæ­¢ä½¿ç”¨OLTPç³»ç»Ÿè¿›è¡Œåˆ†æï¼Œè€Œæ˜¯åœ¨å•ç‹¬çš„æ•°æ®åº“ä¸Šè¿è¡Œåˆ†æã€‚è¿™ä¸ªå•ç‹¬çš„æ•°æ®åº“è¢«ç§°ä¸º<strong>æ•°æ®ä»“åº“(data warehouse)</strong>ã€‚å› ä¸ºæœ€åˆçš„æ•°æ®ä»“åº“æ˜¯ä»å…³ç³»å‹æ•°æ®åº“ä¸­ç‹¬ç«‹å‡ºæ¥ï¼Œåªå­˜å‚¨å…³ç³»æ•°æ®ï¼Œè€Œä¸”æ˜¯é¢å‘æ•°æ®åˆ†æï¼ŒBI(å•†ä¸šæ™ºèƒ½)çš„ï¼Œåªæ˜¯åˆ°äº†åæ¥éšç€å¤§æ•°æ®æ—¶ä»£çš„åˆ°æ¥ï¼Œæ•°æ®ä»“åº“æ‰æ…¢æ…¢å˜çš„è¶Šæ¥è¶Šåƒ<strong>æ•°æ®æ¹–<sup class="footnote-ref"><a href="#fn9" id="fnref9">[9]</a></sup></strong> (å°±æ˜¯å„ç§æ•°æ®éƒ½è·‘å¾€æ•°æ®ä»“åº“é‡Œé¢å¡)</p>
<blockquote>
<p>æ•°æ®æ²¼æ³½ï¼š<strong>æ•°æ®æ²¼æ³½</strong> æ˜¯ä¸€ä¸ªåŠ£åŒ–çš„æ•°æ®æ¹–ï¼Œç”¨æˆ·æ— æ³•è®¿é—®ï¼Œæˆ–æ˜¯æ²¡ä»€ä¹ˆä»·å€¼</p>
</blockquote>
<p>åˆæˆ–è€…è¯´ï¼Œ<strong>æ•°æ®æ¹–æ˜¯ä¸‹ä¸€ä»£æ•°æ®ä»“åº“</strong>ï¼Œä»OLTPæ•°æ®åº“ä¸­æå–æ•°æ®ï¼Œè½¬æ¢æˆé€‚åˆåˆ†æçš„æ¨¡å¼ï¼Œæ¸…ç†å¹¶åŠ è½½åˆ°æ•°æ®ä»“åº“ä¸­ï¼Œå› æ­¤æ•°æ®ä»“åº“åŒ…å«å…¬å¸å„ç§OLTPç³»ç»Ÿä¸­æ‰€æœ‰çš„åªè¯»æ•°æ®å‰¯æœ¬ã€‚ä¸‹å›¾æ˜¯ä¸€ä¸ªç®€è¦çš„ç¤ºæ„å›¾ï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/29.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> ETLè¿‡ç¨‹ </span>
</p>
<h2 id="æ•°æ®ä»“åº“ç³»ç»Ÿç»„ä»¶">æ•°æ®ä»“åº“ç³»ç»Ÿç»„ä»¶</h2>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€äº›æ¯”è¾ƒå‡ºåçš„å•†ä¸šæ•°æ®ä»“åº“ç³»ç»Ÿï¼Œå°½ç®¡ä»–ä»¬æ˜¯å† ä»¥å‡ºåçš„å•†ä¸šæ•°æ®ä»“åº“ç³»ç»Ÿï¼Œä½†æ˜¯å…¶ä¸­"å•†ä¸š"ä¸¤ä¸ªå­—å¯èƒ½æ˜¯å¤ªè´µï¼Œå¯¼è‡´å¤§å¤šæ•°ä»äº‹æ•°æ®ä»“åº“ç›¸å…³å·¥ä½œçš„äººï¼Œå…¶å®å¹¶ä¸çŸ¥é“ï¼š</p>
<img src="/2023/09/21/ddia/30.jpg" width="100%" height="70%" alt="å›¾ç‰‡åç§°" align="center">
<ul class="lvl-0">
<li class="lvl-2">
<p>SQL - Server   ä½¿ç”¨ä¸¤å¥—ä¸åŒçš„å­˜å‚¨å’ŒæŸ¥è¯¢å¼•æ“æ¥åº”å¯¹OALPå’ŒOLTPç¯å¢ƒ</p>
</li>
<li class="lvl-2">
<p>Teradata       å¤©ç¿</p>
</li>
<li class="lvl-2">
<p>Vertica          ç»´è’‚å¡</p>
</li>
<li class="lvl-2">
<p>SAP HANA    SAP  æ±‰é‚£</p>
</li>
<li class="lvl-2">
<p>ParAccel        å¸•åŠ é€Ÿ</p>
</li>
</ul>
<p>ç›¸å¯¹è€Œè¨€ï¼Œæˆ‘ä»¬æ›´å–œæ¬¢å…è´¹çš„å¼€æºäº§å“ï¼Œä¸‹é¢æ˜¯ä¸€äº›SQL-on-Hadoop é¡¹ç›®ï¼š</p>
<p>Hive-SQLã€Spark-SQLã€Flink-SQLã€Prestoã€Druidã€Kylinã€Impala</p>
<h2 id="é›ªèŠ±æ¨¡å‹">é›ªèŠ±æ¨¡å‹</h2>
<p>åœ¨OLTPç³»ç»Ÿä¸­ï¼Œå¯ç”¨çš„æ•°æ®æ¨¡å‹å¾ˆä¸°å¯Œï¼Œæ¯”å¦‚å¤§ç±»ä¸Šåˆ†ä¸º</p>
<p>ğŸ…°ï¸ å…³ç³»æ¨¡å‹</p>
<p>ğŸ…±ï¸ æ–°çš„éå…³ç³»æ¨¡å‹ï¼ŒNo-SQLæ¨¡å‹</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>æ–‡æ¡£æ•°æ®åº“æ¨¡å‹</p>
</li>
<li class="lvl-2">
<p>å›¾å½¢æ•°æ®åº“æ¨¡å‹</p>
</li>
</ul>
<p>ç›¸å¯¹äºOATPç³»ç»Ÿæ¥è¯´ï¼ŒOLAPç³»ç»Ÿçš„æ•°æ®æ¨¡å‹å¤šæ ·æ€§å°±å°‘çš„å¤šï¼Œæ•°æ®ä»“åº“å¤§å¤šä½¿ç”¨ä¸€æ ·çš„å…¬å¼åŒ–æ¨¡å‹ï¼š<strong><u>æ˜Ÿå‹æ¨¡å¼|æ˜Ÿå‹æ¨¡å‹(ä¹Ÿå«ç»´åº¦å»ºæ¨¡)</u></strong> å¦‚ä¸‹å›¾ï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/31.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> æ˜Ÿå‹æ¨¡å¼ç¤ºæ„å›¾ </span>
</p>
<p>1ï¸âƒ£ æ¨¡å¼çš„ä¸­å¿ƒæ˜¯ä¸€ä¸ªæ‰€è°“çš„äº‹å®è¡¨ï¼Œäº‹å®è¡¨çš„æ¯ä¸€è¡Œä»£è¡¨åœ¨ç‰¹å®šæ—¶é—´å‘ç”Ÿçš„äº‹ä»¶(è¿™é‡Œï¼Œæ¯ä¸€è¡Œä»£è¡¨å®¢æˆ·è´­ä¹°çš„äº§å“)</p>
<p>2ï¸âƒ£ äº‹å®è¡¨ä¸­çš„ä¸€äº›åˆ—æ˜¯å±æ€§ï¼Œä¾‹å¦‚äº§å“é”€å”®çš„ä»·æ ¼å’Œä»ä¾›åº”å•†é‚£é‡Œè´­ä¹°çš„æˆæœ¬(å…è®¸è®¡ç®—åˆ©æ¶¦ä½™é¢)ï¼Œé€šå¸¸æ˜¯æ•°å­—ç­‰å¯ç»Ÿè®¡æŒ‡æ ‡</p>
<p>3ï¸âƒ£ äº‹å®è¡¨ä¸­çš„å…¶ä»–åˆ—æ˜¯å¯¹å…¶ä»–è¡¨(ç§°ä¸ºç»´è¡¨)çš„å¤–é”®å¼•ç”¨ï¼Œç”±äºäº‹å®è¡¨ä¸­çš„æ¯ä¸€è¡Œéƒ½è¡¨ç¤ºä¸€ä¸ªäº‹ä»¶ï¼Œå› æ­¤è¿™äº›ç»´åº¦ä»£è¡¨äº‹ä»¶çš„å‘ç”Ÿåœ°ç‚¹ï¼Œæ—¶é—´ï¼Œæ–¹å¼å’ŒåŸå› </p>
<p>4ï¸âƒ£ äº‹å®è¡¨æ ¼æœ‰100åˆ—ä»¥ä¸Šï¼Œæœ‰æ—¶ç”šè‡³æœ‰æ•°ç™¾åˆ—ï¼Œå¿«æ‰‹å®½è¡¨åˆ—é•¿è¾¾1000+åˆ—</p>
<p>5ï¸âƒ£ æ˜Ÿå‹æ¨¡å‹è¿›ä¸€æ­¥çš„æ‰©å±•æ˜¯é›ªèŠ±æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯åŸºäºç»´åº¦è¡¨è¿›ä¸€æ­¥æ‹†åˆ†</p>
<p>å½“è¡¨å…³ç³»å¯è§†åŒ–æ—¶ï¼Œäº‹å®è¡¨åœ¨ä¸­é—´ï¼Œç”±ç»´è¡¨åŒ…å›´ï¼›ä¸è¿™äº›è¡¨çš„è¿æ¥å°±åƒæ˜Ÿæ˜Ÿçš„å…‰èŠ’ï¼Œæ‰€ä»¥è¿™æ¨¡å¼è¢«å‘½åä¸ºï¼šâ€œæ˜Ÿå‹æ¨¡å¼â€</p>
<h2 id="åˆ—å¼å­˜å‚¨">åˆ—å¼å­˜å‚¨</h2>
<p>åœ¨å‰é¢çš„å­˜å‚¨ç»“æ„ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†</p>
<p>ğŸ…°ï¸ åŸºäºæ—¥å¿—çš„å­˜å‚¨ï¼šæ—¥å¿—ç»“æ„å­¦æ´¾</p>
<p>ğŸ…±ï¸ åŸºäºé¡µé¢çš„å­˜å‚¨ï¼šå°±åœ°æ›´æ–°å­¦æ´¾</p>
<p>ç„¶è€Œï¼Œå…¸å‹çš„æ•°æ®ä»“åº“æŸ¥è¯¢ä¸€æ¬¡åªè®¿é—®è¾ƒå°‘çš„åˆ—ï¼Œå¦‚æœä½¿ç”¨è¡Œå­˜å‚¨çš„è¯ï¼Œé¢å‘è¡Œçš„å­˜å‚¨å¼•æ“ä»ç„¶éœ€è¦å°†æ‰€æœ‰è¿™äº›è¡Œ(æ¯ä¸ªåŒ…å«è¶…è¿‡100ä¸ªå±æ€§)ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè§£æå®ƒä»¬ï¼Œå¹¶è¿‡æ»¤æ‰é‚£äº›ä¸ç¬¦åˆè¦æ±‚çš„æ¡ä»¶ã€‚è¿™å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ã€‚é¢å‘åˆ—çš„å­˜å‚¨èƒŒåçš„æƒ³æ³•å¾ˆç®€å•ï¼š<strong>ä¸è¦å°†æ‰€æœ‰æ¥è‡ªä¸€è¡Œçš„å€¼å­˜å‚¨åœ¨ä¸€èµ·ï¼Œè€Œæ˜¯å°†æ¥è‡ªæ¯ä¸€åˆ—çš„æ‰€æœ‰å€¼å­˜å‚¨åœ¨ä¸€èµ·</strong>ã€‚å¦‚ä¸‹å›¾</p>
<p align="center">
  <img src="/2023/09/21/ddia/32.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> åˆ—å¼å­˜å‚¨ç¤ºæ„å›¾ </span>
</p>
<p>å¯ä»¥è§‚å¯Ÿåˆ°çº¢è‰²æ¡†é€‰å‡ºæ¥çš„å€¼åºåˆ—ï¼Œä»–ä»¬æ˜¯é‡å¤æ•°æ®ï¼Œè€Œ<strong>é‡å¤æ•°æ®æ˜¯å‹ç¼©çš„å¥½å…†å¤´</strong>ã€‚æˆ‘ä»¬æ ¹æ®åˆ—ä¸­çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„å‹ç¼©æŠ€æœ¯æ¥è¿›ä¸€æ­¥é™ä½å¯¹ç£ç›˜ååé‡çš„éœ€æ±‚ï¼Œåœ¨æ•°æ®ä»“åº“ä¸­ç‰¹åˆ«æœ‰æ•ˆçš„ä¸€ç§æŠ€æœ¯æ˜¯<em>ä½å›¾ç¼–ç </em>(ç±»ä¼¼å“ˆå¤«æ›¼ç¼–ç )ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/33.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> ä½å›¾ç¼–ç å’Œå‹ç¼© </span>
</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">in</span> () <span class="comment">--  å¯¹åº”ç€ä½å›¾çš„ æˆ–</span></span><br><span class="line"><span class="keyword">and</span>   <span class="comment">--  å¯¹åº”ç€ä½å›¾çš„ ä¸</span></span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>æ¯”å¦‚hiveæ”¯æŒçš„å­˜å‚¨æ ¼å¼åŒ…æ‹¬textfile,parquet, rcfile,orc, å…¶ä¸­orcæ˜¯rcfileçš„ä¼˜åŒ–ç‰ˆ(Optimize Rcfileï¼ŒRcfileåŸºäºLazy Decompression)ï¼Œç›¸è¾ƒäºrcfileæœ‰æ›´å¥½çš„è¡¨ç°ï¼Œåˆ—å­˜å’Œå‹ç¼©é€šå¸¸ä¼šç»“åˆï¼Œå‹ç¼©æ¯”ORC(ZLIBå‹ç¼©) &gt;  Parquet (Uncompresså³é»˜è®¤ä¸å‹ç¼©)&gt;  textFileï¼ˆtextfileä¸å‹ç¼©ï¼‰ï¼Œæ³¨æ„ç‚¹æ˜¯å‹ç¼©åœ¨æœ‰æ•ˆé™ä½IOçš„åŒæ—¶ä¼šæå‡CPUçš„æ¶ˆè€—</p>
</blockquote>
<p>åˆ—å­˜å‚¨ä¸­çš„æ’åˆ—é¡ºåºä¹Ÿéå¸¸æœ‰æ„ä¹‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå³ä½¿æŒ‰åˆ—å­˜å‚¨æ•°æ®ï¼Œä¹Ÿéœ€è¦ä¸€æ¬¡å¯¹æ•´è¡Œè¿›è¡Œæ’åºï¼Œä¸€èˆ¬å¯¹æœ€å¸¸è§çš„æŸ¥è¯¢å­—æ®µåšä¸ºç¬¬ä¸€æ’åºçš„åˆ—ï¼Œç¬¬äºŒåˆ—å¯ä»¥ç¡®å®šç¬¬ä¸€åˆ—ä¸­å…·æœ‰ç›¸åŒå€¼çš„ä»»ä½•è¡Œçš„æ’åºé¡ºåºï¼Œè¿™å°†åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚åŒæ—¶ï¼Œæ’åºé¡ºåºå¯ä»¥å¸®åŠ©å‹ç¼©åˆ—ï¼Œç¬¬ä¸€ä¸ªæ’åºé”®çš„å‹ç¼©æ•ˆæœæœ€å¼ºï¼Œä¸€ä¸ªç®€å•çš„è¿è¡Œé•¿åº¦ç¼–ç ï¼ˆæ¯”å¦‚ä½å›¾ï¼‰å¯ä»¥å°†è¯¥åˆ—å‹ç¼©åˆ°å‡ åƒå­—èŠ‚ â€”â€” å³ä½¿è¡¨ä¸­æœ‰æ•°åäº¿è¡Œï¼ˆä¸åŒçš„å€¼å¾ˆå°‘ï¼ŒåŸºæ•°å°‘ï¼‰</p>
<p>å†™å…¥åˆ—å­˜å‚¨çš„å›°éš¾</p>
<p>å¦‚æœä½ æƒ³åœ¨åˆ—å­˜æ’åºè¡¨çš„ä¸­é—´æ’å…¥ä¸€è¡Œï¼Œä½ å¾ˆå¯èƒ½ä¸å¾—ä¸é‡å†™æ‰€æœ‰çš„åˆ—æ–‡ä»¶ã€‚ç”±äºè¡Œç”±åˆ—ä¸­çš„ä½ç½®æ ‡è¯†ï¼Œå› æ­¤æ’å…¥å¿…é¡»å§‹ç»ˆæ›´æ–°æ‰€æœ‰åˆ—ï¼ˆè¿™å¤§æ¦‚å°±æ˜¯Hiveä»…ä»…æ”¯æŒ <code>overwrite</code>æ“ä½œçš„ç¼˜æ•…ï¼‰</p>
<p>å¦å¤–çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼ŒLSMæ ‘çš„è¿™ç§ç»“æ„ï¼Œæ‰€æœ‰çš„å†™æ“ä½œé¦–å…ˆè¿›å…¥ä¸€ä¸ªå†…å­˜ä¸­çš„å­˜å‚¨ï¼Œåœ¨è¿™é‡Œå®ƒä»¬è¢«æ·»åŠ åˆ°ä¸€ä¸ªå·²æ’åºçš„ç»“æ„ä¸­ï¼Œå¹¶å‡†å¤‡å†™å…¥ç£ç›˜ã€‚å†…å­˜ä¸­çš„å­˜å‚¨æ˜¯é¢å‘è¡Œè¿˜æ˜¯åˆ—çš„ï¼Œè¿™å¹¶ä¸é‡è¦ã€‚å½“å·²ç»ç§¯ç´¯äº†è¶³å¤Ÿçš„å†™å…¥æ•°æ®æ—¶ï¼Œå®ƒä»¬å°†ä¸ç£ç›˜ä¸Šçš„åˆ—æ–‡ä»¶åˆå¹¶ï¼Œå¹¶æ‰¹é‡å†™å…¥æ–°æ–‡ä»¶</p>
<p>ä»€ä¹ˆæ˜¯ç‰©åŒ–è§†å›¾ï¼Ÿ</p>
<p>æ®ä»“åº“æŸ¥è¯¢é€šå¸¸æ¶‰åŠä¸€ä¸ªèšåˆå‡½æ•°ï¼Œå¦‚SQLä¸­çš„COUNTï¼ŒSUMï¼ŒAVGï¼ŒMINæˆ–MAXã€‚å¦‚æœç›¸åŒçš„èšåˆè¢«è®¸å¤šä¸åŒçš„æŸ¥è¯¢ä½¿ç”¨ï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½å¯ä»¥é€šè¿‡åŸå§‹æ•°æ®æ¥å¤„ç†ã€‚ä¸ºä»€ä¹ˆä¸ç¼“å­˜ä¸€äº›æŸ¥è¯¢ä½¿ç”¨æœ€é¢‘ç¹çš„è®¡æ•°æˆ–æ€»å’Œï¼Ÿåˆ›å»ºè¿™ç§ç¼“å­˜çš„ä¸€ç§æ–¹å¼æ˜¯ç‰©åŒ–è§†å›¾ã€‚ç‰©åŒ–è§†å›¾çš„å¸¸è§ç‰¹ä¾‹ç§°ä¸ºæ•°æ®ç«‹æ–¹ä½“æˆ–OLAPç«‹æ–¹</p>
<p>ç‰©åŒ–è§†å›¾ å’Œ è™šæ‹Ÿè§†å›¾çš„åŒºåˆ«ï¼Ÿ</p>
<p>ä¸åŒçš„æ˜¯ï¼Œç‰©åŒ–è§†å›¾æ˜¯æŸ¥è¯¢ç»“æœçš„å®é™…å‰¯æœ¬ï¼Œå†™å…¥ç£ç›˜ï¼Œè€Œè™šæ‹Ÿè§†å›¾åªæ˜¯å†™å…¥æŸ¥è¯¢çš„æ·å¾„ã€‚ä»è™šæ‹Ÿè§†å›¾è¯»å–æ—¶ï¼ŒSQLå¼•æ“ä¼šå°†å…¶å±•å¼€åˆ°è§†å›¾çš„åº•å±‚æŸ¥è¯¢ä¸­ï¼Œç„¶åå¤„ç†å±•å¼€çš„æŸ¥è¯¢</p>
<p align="center">
  <img src="/2023/09/21/ddia/58.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> æ•°æ®ç«‹æ–¹çš„ä¸¤ä¸ªç»´åº¦ï¼Œé€šè¿‡æ±‚å’Œèšåˆ </span>
</p>
<h1>ç¬¬å››ç« èŠ‚-ç¼–ç å’Œæ¼”åŒ–</h1>
<h2 id="ä»€ä¹ˆæ˜¯å¯æ¼”åŒ–æ€§ï¼Ÿ">ä»€ä¹ˆæ˜¯å¯æ¼”åŒ–æ€§ï¼Ÿ</h2>
<p>èƒ½çµæ´»é€‚åº”å˜åŒ–çš„ç³»ç»Ÿï¼Œ ä¿®æ”¹æ•°æ®ç³»ç»Ÿå¹¶ä½¿å…¶é€‚åº”ä¸æ–­å˜åŒ–éœ€æ±‚çš„å®¹æ˜“ç¨‹åº¦ï¼Œæ˜¯ä¸<strong>ç®€å•æ€§</strong>å’Œ<strong>æŠ½è±¡æ€§</strong>å¯†åˆ‡ç›¸å…³çš„ï¼šç®€å•æ˜“æ‡‚çš„ç³»ç»Ÿé€šå¸¸æ¯”å¤æ‚ç³»ç»Ÿæ›´å®¹æ˜“ä¿®æ”¹</p>
<h2 id="å‘åå…¼å®¹ï¼Œå‘å‰å…¼å®¹">å‘åå…¼å®¹ï¼Œå‘å‰å…¼å®¹</h2>
<p>å‘åå…¼å®¹(backward compatibility)ï¼šæ–°ä»£ç å¯ä»¥è¯»æ—§æ•°æ®</p>
<p>å‘å‰å…¼å®¹ï¼ˆforward compatibilityï¼‰ï¼šæ—§ä»£ç å¯ä»¥è¯»æ–°æ•°æ®</p>
<h2 id="ç¼–ç æ•°æ®çš„æ ¼å¼æœ‰å“ªäº›ï¼Ÿ">ç¼–ç æ•°æ®çš„æ ¼å¼æœ‰å“ªäº›ï¼Ÿ</h2>
<ol>
<li class="lvl-3">
<p>åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®ä¿å­˜åœ¨å¯¹è±¡ï¼Œç»“æ„ä½“ï¼Œåˆ—è¡¨ï¼Œæ•°ç»„ï¼Œå“ˆå¸Œè¡¨ï¼Œæ ‘ç­‰ä¸­ã€‚ è¿™äº›æ•°æ®ç»“æ„é’ˆå¯¹CPUçš„é«˜æ•ˆè®¿é—®å’Œæ“ä½œè¿›è¡Œäº†ä¼˜åŒ–ï¼ˆé€šå¸¸ä½¿ç”¨æŒ‡é’ˆï¼‰</p>
</li>
<li class="lvl-3">
<p>å¦‚æœè¦å°†æ•°æ®å†™å…¥æ–‡ä»¶ï¼Œæˆ–é€šè¿‡ç½‘ç»œå‘é€ï¼Œåˆ™å¿…é¡»å°†å…¶ç¼–ç ä¸ºæŸç§è‡ªåŒ…å«çš„å­—èŠ‚åºåˆ—ï¼ˆä¾‹å¦‚ï¼ŒJSONæ–‡æ¡£ï¼‰</p>
<blockquote>
<p>ä»å†…å­˜ä¸­è¡¨ç¤ºåˆ°å­—èŠ‚åºåˆ—çš„è½¬æ¢ç§°ä¸ºç¼–ç ï¼ˆä¹Ÿç§°ä¸ºåºåˆ—åŒ–ï¼ˆserializationï¼‰æˆ–ç¼–ç»„ï¼ˆmarshallingï¼‰ï¼‰ï¼Œåè¿‡æ¥ç§°ä¸ºè§£ç ï¼ˆDecodingï¼‰ï¼ˆè§£æï¼ˆParsingï¼‰ï¼Œååºåˆ—åŒ–ï¼ˆdeserializationï¼‰**ï¼Œ**åç¼–ç»„( unmarshallingï¼‰ï¼‰</p>
<p>ç¼–ç è¿‡ç¨‹ä¹Ÿæˆä¸ºåºåˆ—åŒ–Serializationï¼Œå…¶ä¸­äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ä¸­ä¹Ÿå‡ºç°äº†è¯¥è¯ï¼Œè¯·åŒºåˆ†2è€…</p>
<p>åœ¨ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œéƒ½å†…å»ºäº†å°†å†…å­˜å¯¹è±¡ç¼–ç ä¸ºå­—èŠ‚åºåˆ—çš„æ”¯æŒï¼ŒJavaæœ‰<code>java.io.Serializable</code> ï¼ŒPythonæœ‰<code>pickle</code></p>
</blockquote>
</li>
</ol>
<h2 id="æ–‡æœ¬ç¼–ç å’ŒäºŒè¿›åˆ¶ç¼–ç ">æ–‡æœ¬ç¼–ç å’ŒäºŒè¿›åˆ¶ç¼–ç </h2>
<table>
<thead>
<tr>
<th>æ¯”å¯¹æ–¹é¢</th>
<th>æ–‡æœ¬ç¼–ç </th>
<th>äºŒè¿›åˆ¶ç¼–ç </th>
</tr>
</thead>
<tbody>
<tr>
<td>å¯è¯»æ€§</td>
<td>äººç±»æ˜“è¯»</td>
<td>äººç±»ä¸å¯è¯»</td>
</tr>
<tr>
<td>æ•°æ®ç±»å‹</td>
<td>è¡¨ç¤ºæ–‡æœ¬å­—ç¬¦ï¼Œå¦‚å­—æ¯ã€æ•°å­—ã€ç¬¦å·</td>
<td>è¡¨ç¤ºå„ç§ç±»å‹çš„æ•°æ®ï¼ŒåŒ…æ‹¬æ•´æ•°ã€æµ®ç‚¹æ•°ã€å›¾åƒã€éŸ³é¢‘ã€ç¨‹åºæŒ‡ä»¤ç­‰</td>
</tr>
<tr>
<td>ç¼–ç æ–¹å¼</td>
<td>é‡‡ç”¨å­—ç¬¦é›†ï¼ˆå¦‚ASCIIã€UTF-8ã€ISO-8859-1ç­‰ï¼‰æ¥å°†å­—ç¬¦æ˜ å°„åˆ°æ•°å­—æˆ–äºŒè¿›åˆ¶ï¼Œæ¯ä¸ªå­—ç¬¦éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–ç å€¼</td>
<td>å°†æ•°æ®ç›´æ¥è¡¨ç¤ºä¸ºç”± 0 å’Œ 1 ç»„æˆçš„äºŒè¿›åˆ¶åºåˆ—çš„æ–¹å¼ã€‚å®ƒä¸éœ€è¦å­—ç¬¦é›†</td>
</tr>
<tr>
<td>åº”ç”¨é¢†åŸŸ</td>
<td>å¤„ç†æ–‡æœ¬æ•°æ®ï¼Œå¦‚æ–‡æ¡£ã€ç½‘é¡µã€ç”µå­é‚®ä»¶ç­‰</td>
<td>ç”¨äºè®¡ç®—æœºå†…éƒ¨æ•°æ®è¡¨ç¤ºã€å­˜å‚¨å’Œé€šä¿¡ï¼ŒåŒ…æ‹¬æ•´æ•°ã€æµ®ç‚¹æ•°ã€å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ç­‰ã€‚å®ƒå¤„ç†çš„æ˜¯æ›´åº•å±‚çš„æ•°æ®è¡¨ç¤º</td>
</tr>
</tbody>
</table>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// äºŒè¿›åˆ¶ç¼–ç ç¤ºä¾‹ï¼Œåˆ é™¤äº†ç©ºæ ¼æ¢è¡Œåï¼Œ81ä¸ªå­—èŠ‚</span></span><br><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"userName"</span><span class="punctuation">:</span> <span class="string">"Martin"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"favoriteNumber"</span><span class="punctuation">:</span> <span class="number">1337</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"interests"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"daydreaming"</span><span class="punctuation">,</span> <span class="string">"hacking"</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ä¸åŒçš„äºŒè¿›åˆ¶ç¼–ç ç»„ä»¶/åº“å¯¹ä¸Šè¿°çš„JSONæ–‡æ¡£è¿›è¡Œç¼–ç </p>
<p align="center">
  <img src="/2023/09/21/ddia/59.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> ä½¿ç”¨ä¸åŒçš„äºŒè¿›åˆ¶ç»„ä»¶ç¼–ç åŒä¸€ä¸ªJSONæ–‡æ¡£ </span>
</p>
<p>Avroä¹Ÿä½¿ç”¨æ¨¡å¼æ¥æŒ‡å®šæ­£åœ¨ç¼–ç çš„æ•°æ®çš„ç»“æ„ï¼Œ å®ƒæœ‰ä¸¤ç§æ¨¡å¼è¯­è¨€ï¼šä¸€ç§ï¼ˆAvro IDLï¼‰ç”¨äºäººå·¥ç¼–è¾‘ï¼Œä¸€ç§ï¼ˆåŸºäºJSONï¼‰ï¼Œæ›´æ˜“äºæœºå™¨è¯»å–</p>
<p align="center">
  <img src="/2023/09/21/ddia/61.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> Avro äºŒè¿›åˆ¶ç¼–ç  &amp; Avro Reader è§£å†³è¯»å†™æ¨¡å¼çš„å·®å¼‚ </span>
</p>
<h2 id="æ•°æ®æµçš„ç±»å‹">æ•°æ®æµçš„ç±»å‹</h2>
<p>å¦‚æœè¦å°†æŸäº›æ•°æ®å‘é€åˆ°ä¸å…±äº«å†…å­˜çš„å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä¾‹å¦‚ï¼Œé€šè¿‡ç½‘ç»œå‘é€æ•°æ®æˆ–å°†å…¶å†™å…¥æ–‡ä»¶ï¼Œå°±éœ€è¦å°†å®ƒç¼–ç ä¸ºä¸€ä¸ªå­—èŠ‚åºåˆ—</p>
<p>æ•°æ®åœ¨æµç¨‹ä¹‹é—´æµåŠ¨çš„ä¸€äº›æœ€å¸¸è§çš„æ–¹å¼ï¼š</p>
<ol>
<li class="lvl-3">
<p>é€šè¿‡æ•°æ®åº“ï¼šå†™å…¥ç¼–ç ï¼Œè¯»å–è§£ç </p>
</li>
<li class="lvl-3">
<p>é€šè¿‡æœåŠ¡è°ƒç”¨ï¼šRESTå’ŒRPC</p>
</li>
<li class="lvl-3">
<p>é€šè¿‡å¼‚æ­¥æ¶ˆæ¯ä¼ é€’ï¼šæ¶ˆæ¯é˜Ÿåˆ—</p>
</li>
</ol>
<h3 id="A-WebæœåŠ¡">A-WebæœåŠ¡</h3>
<p>æœ‰ä¸¤ç§æµè¡Œçš„WebæœåŠ¡æ–¹æ³•ï¼šRESTå’ŒSOAP</p>
<p>å°†å¤§å‹åº”ç”¨ç¨‹åºæŒ‰ç…§åŠŸèƒ½åŒºåŸŸåˆ†è§£ä¸ºè¾ƒå°çš„æœåŠ¡ï¼Œä¸€ä¸ªæœåŠ¡è¯·æ±‚å¦å¤–ä¸€ä¸ªæœåŠ¡çš„åŠŸèƒ½æˆ–è€…æ•°æ®ï¼Œè¿™ç§æ„å»ºåº”ç”¨ç¨‹åºçš„æ–¹å¼ä¼ ç»Ÿä¸Šè¢«ç§°ä¸º <strong>é¢å‘æœåŠ¡çš„ä½“ç³»ç»“æ„ï¼ˆservice-oriented architectureï¼ŒSOAï¼‰</strong> ï¼Œä¹Ÿç§°ä¹‹ä¸º <strong>å¾®æœåŠ¡æ¶æ„</strong></p>
<p>RESTæ˜¯ä¸€ä¸ªåŸºäºHTTPåŸåˆ™çš„è®¾è®¡å“²å­¦ã€‚å®ƒå¼ºè°ƒç®€å•çš„æ•°æ®æ ¼å¼ï¼Œä½¿ç”¨URLæ¥æ ‡è¯†èµ„æºï¼Œå¹¶ä½¿ç”¨HTTPåŠŸèƒ½è¿›è¡Œç¼“å­˜æ§åˆ¶ï¼Œèº«ä»½éªŒè¯å’Œå†…å®¹ç±»å‹åå•†ã€‚ä¸SOAPç›¸æ¯”ï¼ŒRESTå·²ç»è¶Šæ¥è¶Šå—æ¬¢è¿ï¼Œè‡³å°‘åœ¨è·¨ç»„ç»‡æœåŠ¡é›†æˆçš„èƒŒæ™¯ä¸‹ã€36ã€‘ï¼Œå¹¶ç»å¸¸ä¸å¾®æœåŠ¡ç›¸å…³[31]ã€‚æ ¹æ®RESTåŸåˆ™è®¾è®¡çš„APIç§°ä¸ºRESTfulã€‚</p>
<h3 id="B-RPC">B-RPC</h3>
<p>RPCæ˜¯ä¸€ç§åè®®æ— å…³çš„é€šä¿¡æ–¹å¼ï¼Œé€šå¸¸ä½¿ç”¨äºŒè¿›åˆ¶åè®®ï¼ˆå¦‚Protobufã€Thriftï¼‰æˆ–æ–‡æœ¬åè®®ï¼ˆå¦‚XML-RPCã€JSON-RPCï¼‰æ¥ä¼ è¾“æ•°æ®ã€‚å®ƒå…è®¸å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„å‡½æ•°ï¼Œå°±åƒæœ¬åœ°å‡½æ•°ä¸€æ ·ã€‚RPCé€šå¸¸æ˜¯æ— çŠ¶æ€çš„ï¼Œé€šå¸¸ä½¿ç”¨äºŒè¿›åˆ¶æ ¼å¼ä»¥æé«˜æ•ˆç‡</p>
<p><strong>RESTful</strong>ï¼šRESTfulæ˜¯åŸºäºHTTPåè®®çš„é€šä¿¡æ–¹å¼ï¼Œä½¿ç”¨HTTPåŠ¨è¯ï¼ˆGETã€POSTã€PUTã€DELETEç­‰ï¼‰æ¥æ‰§è¡Œæ“ä½œï¼Œå¹¶ä½¿ç”¨URLæ¥å®šä½èµ„æºã€‚å®ƒä½¿ç”¨æ ‡å‡†çš„HTTPçŠ¶æ€ç æ¥è¡¨ç¤ºæ“ä½œçš„ç»“æœã€‚RESTfulé€šå¸¸ä½¿ç”¨æ–‡æœ¬æ ¼å¼ï¼Œå¦‚JSONæˆ–XMLï¼Œä»¥ä¾¿æ•°æ®å¯ä»¥è¢«è½»æ¾è§£æå’Œç†è§£</p>
<p>RPCæ¡†æ¶çš„ä¸»è¦é‡ç‚¹åœ¨äºåŒä¸€ç»„ç»‡æ‹¥æœ‰çš„æœåŠ¡ä¹‹é—´çš„è¯·æ±‚ï¼Œé€šå¸¸åœ¨åŒä¸€æ•°æ®ä¸­å¿ƒå†…</p>
<h1>ç¬¬5ç« èŠ‚-å¤åˆ¶</h1>
<p>æ¥ä¸‹æ¥æ˜¯ç¬¬5ç« çš„å†…å®¹ï¼Œè¿™ç« èŠ‚çš„å†…å®¹ä¸»è¦æ˜¯å¤åˆ¶ï¼Œæ‰€è°“å¤åˆ¶å°±æ˜¯<strong>åŒä¸€ä»½æ•°æ®ä¿ç•™å¤šä¸ªå‰¯æœ¬</strong>ã€‚ å¤åˆ¶æ•°æ®çš„åŸå› å‘¢ï¼Ÿ</p>
<p>1ï¸âƒ£ ä½¿å¾—æ•°æ®ä¸ç”¨æˆ·åœ¨åœ°ç†ä¸Šæ¥è¿‘(å‡å°‘å»¶è¿Ÿ)</p>
<p>2ï¸âƒ£ å³ä½¿ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†å‡ºç°æ•…éšœï¼Œç³»ç»Ÿä¹Ÿèƒ½ç»§ç»­å·¥ä½œ(æé«˜å¯ç”¨æ€§)</p>
<p>3ï¸âƒ£ æ‰©å±•å¯ä»¥æ¥å—è¯»è¯·æ±‚çš„æœºå™¨æ•°é‡(æé«˜è¯»å–ååé‡)</p>
<p>æœ¬ç« ä¸»è¦è®¨è®ºä¸‰ç§å˜æ›´<strong>å¤åˆ¶ç®—æ³•</strong>ï¼ˆåŒºåˆ«äºå¤åˆ¶æ–¹æ³•/ç­–ç•¥ï¼‰ï¼šå•ä¸»å¤åˆ¶ã€å¤šä¸»å¤åˆ¶ã€æ— ä¸»å¤åˆ¶ã€‚å½“å­˜åœ¨å¤šä¸ªå‰¯æœ¬æ—¶ï¼Œä¼šä¸å¯é¿å…çš„å‡ºç°ä¸€ä¸ªé—®é¢˜ï¼šå¦‚ä½•ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½è½åœ¨äº†æ‰€æœ‰çš„å‰¯æœ¬ä¸Šï¼Ÿæ‰€ä»¥ï¼Œå¤æœ¬æœºåˆ¶çœŸæ­£çš„éº»çƒ¦åœ¨äºå¦‚ä½•<strong>å¤„ç†å¤åˆ¶æ•°æ®çš„å˜æ›´</strong> ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªéå¸¸æ™®éä¸”å¸¸ç”¨è§£å†³æ–¹æ¡ˆï¼š<strong>å•ä¸»å¤åˆ¶</strong></p>
<h2 id="å•ä¸»å¤åˆ¶">å•ä¸»å¤åˆ¶</h2>
<p>æ¥å…·ä½“çœ‹ä¸€ä¸ªåœºæ™¯ï¼Œæ›´æ¢æ–°çš„ç”¨æˆ·å¤´åƒçš„å®ä¾‹ï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/34.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> å•ä¸»å¤åˆ¶ </span>
</p>
<p>æ€»ç»“ä¸€ä¸‹å•ä¸»å¤åˆ¶ç¬¦åˆä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š</p>
<p>1ï¸âƒ£ å¤šä¸ªå‰¯æœ¬ä¸­åªæœ‰ä¸€ä¸ªè®¾ç½®ä¸ºleader,å…¶ä»–æ˜¯flower</p>
<p>2ï¸âƒ£ leaderæ¥å—è¯»è¯·æ±‚å’Œå†™è¯·æ±‚ï¼Œfolloweråªæ¥å—è¯»è¯·æ±‚</p>
<p>3ï¸âƒ£ followerä»leaderæ‹‰å–æ—¥å¿—ï¼Œæ›´æ–°æœ¬åœ°æ•°æ®åº“å‰¯æœ¬</p>
<p>è¿™ç§å¤åˆ¶æ¨¡å¼æ˜¯å¾ˆå¤šå…³ç³»å‹æ•°æ®åº“å†…ç½®çš„åŠŸèƒ½ï¼Œæ¯”å¦‚PostgreSQL(9.0ä¹‹å)ï¼ŒMySQLï¼ŒSQL Serverï¼Œæ–‡æ¡£å‹æ•°æ®åº“ MongoDBã€‚åŸºäºé¢†å¯¼è€…çš„å¤åˆ¶ä¸å±€é™äºæ•°æ®åº“ï¼Œåƒä¸€äº›é«˜å¯ç”¨çš„åˆ†å¸ƒå¼MQä¹Ÿåœ¨ç”¨ï¼Œæ¯”å¦‚Kafkaã€RabbitMQ</p>
<blockquote>
<p>å…³äºä¸»ä»å’Œä¸»å¤‡ï¼Œä¸»ä»ä¸­ï¼Œâ€œä»â€æ˜¯å‘å¤–æä¾›æœåŠ¡çš„ï¼Œè€Œä¸»å¤‡ä¸­çš„å¤‡ä¸æ˜¯å¯¹å¤–æä¾›çš„ï¼Œå¤‡çš„ä½œç”¨æ˜¯å¾…â€œä¸»â€crashçš„æ—¶å€™æˆä¸ºä¸»</p>
</blockquote>
<p>ğŸˆğŸˆæ¥ä¸‹æ¥å‘¢ï¼Œæˆ‘ä»¬è®¨è®ºå¤åˆ¶ç³»ç»Ÿçš„ä¸€ä¸ªé‡è¦ç»†èŠ‚ï¼ˆå¤åˆ¶ç­–ç•¥ï¼‰ï¼šå¤åˆ¶æ˜¯ <strong>åŒæ­¥(synchronously)</strong> å‘ç”Ÿè¿˜æ˜¯<strong>å¼‚æ­¥(asynchronously)</strong> å‘ç”Ÿ</p>
<h2 id="åŒæ­¥-å¼‚æ­¥">åŒæ­¥/å¼‚æ­¥</h2>
<p>å¦‚ä¸‹å›¾ï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/35.jpg" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> åŒæ­¥ &amp; å¼‚æ­¥ </span>
</p>
<p>1ï¸âƒ£ ç”¨æˆ· $id=1234$ çš„ç”¨æˆ·å‘ä¸»åº“æäº¤æ•°æ®å˜æ›´è¯·æ±‚</p>
<p>2ï¸âƒ£ ä¸»åº“å°†æ•°æ®å˜æ›´åŒæ­¥ç»™ä»åº“1ï¼ˆFollower1ï¼‰ ï¼Œå¹¶ä¸”ç­‰å¾…ä»åº“1ï¼ˆFollower1ï¼‰çš„å“åº”ï¼Œè¿™é‡Œä»åº“1ï¼ˆFollower1ï¼‰å¤åˆ¶çš„æ–¹å¼æ˜¯åŒæ­¥</p>
<p>3ï¸âƒ£ ä¸»åº“å°†æ•°æ®å˜æ›´åŒæ­¥ç»™ä»åº“2ï¼ˆFollowerï¼‰ï¼Œä½†æ˜¯ä¸ç­‰å¾…ä»åº“2ï¼ˆFollower2ï¼‰çš„ç¡®è®¤ï¼Œè¿™é‡Œä»åº“2ï¼ˆFollower2ï¼‰çš„å¤åˆ¶æ–¹å¼æ˜¯å¼‚æ­¥</p>
<p>æ•´ä½“çš„é…ç½®æ–¹å¼ä¹Ÿè¢«ç§°ä½œæ˜¯åŠåŒæ­¥ã€‚æˆ‘ä»¬æ¥ä¸€èµ·çœ‹ä¸‹åŒæ­¥å’Œå¼‚æ­¥å¤åˆ¶çš„ä¼˜åŠ£åŠ¿ï¼š</p>
<p>ğŸ…°ï¸ åŒæ­¥å¤åˆ¶èƒ½å¤Ÿä¿è¯æ•°æ®å¯é æ€§ï¼Œä½†æ˜¯å¦‚æœä»åº“è¿Ÿè¿Ÿä¸èƒ½å“åº”ä¸»åº“ï¼Œä¸»åº“å°±ä¸èƒ½æ¥æ”¶æ–°çš„è¯»å†™è¯·æ±‚</p>
<p>ğŸ…±ï¸ å¼‚æ­¥å¤åˆ¶çš„ä¼˜ç‚¹æ˜¯ï¼Œå³ä¾¿ä»åº“è½åäº†ï¼Œä¸»åº“ä¹Ÿå¯ä»¥ç»§ç»­å¤„ç†å†™å…¥è¯·æ±‚ï¼ŒåŠ£åŠ¿æ˜¯æ— æ³•ä¿è¯æ•°æ®ä¸€è‡´æ€§</p>
<p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹è®¾ç½®æ–°ä»åº“çš„æ­¥éª¤ï¼š</p>
<p>1ï¸âƒ£ è·å–æŸä¸ªæ—¶åˆ»ä¸»åº“çš„ä¸€è‡´æ€§å¿«ç…§</p>
<p>2ï¸âƒ£ å°†å¿«ç…§å¤åˆ¶åˆ°ä»åº“èŠ‚ç‚¹</p>
<p>3ï¸âƒ£ ä»åº“è¿æ¥ä¸»åº“ï¼Œæ‹‰å–å¿«ç…§ä¹‹åå‘ç”Ÿçš„æ•°æ®å˜æ›´ã€‚æ‹‰å–å¿«ç…§ä¹‹åçš„å˜æ›´ï¼Œå¾€å¾€å¿«ç…§å’Œä¸»åº“å¤åˆ¶æ—¥å¿—å…³è”ï¼Œä¸åŒçš„æ•°æ®åº“å¯¹äº<em>è¿™ä¸ªå…³è”å…³ç³»</em>å®ç°æœ‰ç€ä¸åŒçš„åç§°ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>PostgreSQL çš„å«åš<strong>æ—¥å¿—åºåˆ—å·(log sequence number, LSN)</strong></p>
</li>
<li class="lvl-2">
<p>MySQLå°†å…¶ç§°ä¸º <strong>äºŒè¿›åˆ¶æ—¥å¿—åæ ‡(binlog coordinates)</strong></p>
</li>
</ul>
<p>ğŸˆğŸˆ ä»åº“å¤±æ•ˆçš„é—®é¢˜å¾ˆå¥½è§£å†³ï¼Œä»åº“åœ¨é‡æ–°å’Œä¸»åº“å»ºç«‹è¿æ¥ä¹‹åï¼Œå¯ä»¥ä»æ—¥å¿—çŸ¥é“æœ€åä¸€ä¸ªå¤±è´¥çš„äº‹åŠ¡ã€‚ç„¶åå¼€å§‹è¿½èµ¶ä¸»åº“ã€‚å¦‚æœä¸»åº“å¤±æ•ˆäº†ï¼Œè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p>
<h2 id="å¤„ç†æ•…éšœèŠ‚ç‚¹">å¤„ç†æ•…éšœèŠ‚ç‚¹</h2>
<p><strong>ä¸»åº“å¤±æ•ˆå¦‚ä½•å¤„ç†ï¼Ÿ</strong></p>
<p>1ï¸âƒ£ ç¡®è®¤ä¸»åº“å¤±æ•ˆ</p>
<p>2ï¸âƒ£ é€‰æ‹©ä¸€ä¸ªæ–°çš„ä¸»åº“ï¼Œ<strong><u>è®©æ‰€æœ‰çš„å‰¯æœ¬è¾¾æˆä¸€è‡´æ„è§(å…±è¯†<sub>consensus</sub>é—®é¢˜)</u></strong></p>
<p>3ï¸âƒ£ é‡æ–°é…ç½®æ–°çš„ä¸»åº“ï¼Œå¹¶ä¸”å¯ç”¨æ–°çš„ä¸»åº“</p>
<p>ä¸€äº›æŒ‘æˆ˜ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å¦‚æœä½¿ç”¨å¼‚æ­¥å¤åˆ¶ï¼Œå‘ç”Ÿçš„æ•°æ®ä¸¢å¤±é—®é¢˜ï¼ŒGitHubï¼ŒMySQLä»åº“åˆ‡æ¢ä¸ºä¸»åº“äº‹æ•…</p>
</li>
<li class="lvl-2">
<p>è„‘è£‚çš„æƒ…å†µï¼Œè®¾ç½®æ–°çš„ä¸»åº“ä¹‹åï¼Œè€çš„ä¸»åº“åˆä¸€æ¬¡æ´»è¿‡æ¥äº†ï¼Œå¯èƒ½ä¼šå­˜åœ¨ä¸¤ä¸ªä¸»åº“çš„æƒ…å†µï¼ŒåŒæ—¶æ¥å—å†™å…¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®æŸåï¼Œè§£å†³çš„æ–¹æ¡ˆå¯èƒ½æ˜¯ï¼Œå‘é€<code>kill</code> comand å»å¹²æ‰ä¸€ä¸ªä¸»åº“</p>
</li>
<li class="lvl-2">
<p>å®£å‘Šä¸»åº“æ­»äº¡çš„é˜ˆå€¼ï¼Œä¸»åº“åœ¨å®£å‘Šæ­»äº¡å‰ï¼Œè¶…æ—¶æ—¶é—´çš„è®¾ç½®ï¼Œè®¾ç½®å¤ªé•¿æ„å‘³ç€æ¢å¤æ—¶é—´é•¿ï¼Œå¤ªçŸ­å°±ä¼šå‘ç”Ÿä¸å¿…è¦çš„åˆ‡æ¢</p>
</li>
</ul>
<p><strong>åŸºäºä¸»åº“çš„å¤åˆ¶åº•å±‚æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</strong></p>
<p>1ï¸âƒ£ åŸºäºè¯­å¥çš„å¤åˆ¶ï¼Œæœ‰éç¡®å®šæ€§å‡½æ•°ã€è‡ªå¢åˆ—çš„é—®é¢˜</p>
<p>2ï¸âƒ£ ä¼ è¾“ï¼Œé¢„å†™å¼æ—¥å¿—(WALï¼ŒWrite Ahead Log)ï¼Œæ—¥å¿—åŒ…å«æ‰€æœ‰æ•°æ®åº“å†™å…¥çš„ä»…è¿½åŠ å­—èŠ‚åºåˆ—ï¼Œå¯ä»¥å°†å…¶å‘ç»™ä»åº“ï¼Œæ¯”å¦‚è¯´PostgreSQL ã€Oracleã€‚<strong>ç¼ºç‚¹æ˜¯æ•°æ®è¿‡äºåº•å±‚ï¼ŒWALåŒ…å«å“ªäº›ç£ç›˜å—ä¸­çš„å“ªäº›å­—èŠ‚å‘ç”Ÿäº†æ›´æ”¹</strong>ã€‚è¿™ä½¿å¤åˆ¶ä¸å­˜å‚¨å¼•æ“ç´§å¯†è€¦åˆï¼Œå¯¹æ•°æ®åº“ç‰ˆæœ¬ä¸å‹å¥½ï¼Œä¼šå¯¹è¿ç»´å‡çº§æ•°æ®åº“é€ æˆå›°éš¾</p>
<blockquote>
<p>MySQLæ•°æ®åº“ä¸­æœ‰2ç§æ—¥å¿—ï¼šredo log å’Œ binlog ï¼Œå…¶ä¸­çš„redo logçš„å®ç°æ–¹å¼å³ä¸ºWALï¼Œå…ˆå†™æ—¥å¿—ï¼Œåœ¨ç½—ç›˜</p>
</blockquote>
<p>3ï¸âƒ£ é€»è¾‘æ—¥å¿—å¤åˆ¶(åŸºäºè¡Œ)ï¼Œä¹Ÿå³å¤åˆ¶æ—¥å¿—å’Œå­˜å‚¨å¼•æ“å­˜å‚¨çš„æ—¥å¿—é‡‡ç”¨ä¸åŒçš„æ ¼å¼ï¼Œè¿™ç§å¤åˆ¶æ—¥å¿—è¢«ç§°ä¸ºé€»è¾‘æ—¥å¿—ï¼Œé€»è¾‘æ—¥å¿—æœ‰ä¸€ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å¯¹äºæ’å…¥çš„è¡Œï¼Œæ—¥å¿—åŒ…å«æ‰€æœ‰åˆ—çš„æ–°å€¼</p>
</li>
<li class="lvl-2">
<p>å¯¹äºåˆ é™¤çš„è¡Œï¼Œæ—¥å¿—åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯æ¥å”¯ä¸€æ ‡è¯†å·²åˆ é™¤çš„è¡Œã€‚é€šå¸¸æ˜¯ä¸»é”®ï¼Œä½†æ˜¯å¦‚æœè¡¨ä¸Šæ²¡æœ‰ä¸»é”®ï¼Œåˆ™éœ€è¦è®°å½•æ‰€æœ‰åˆ—çš„æ—§å€¼</p>
</li>
<li class="lvl-2">
<p>å¯¹äºæ›´æ–°çš„è¡Œï¼Œæ—¥å¿—åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯æ¥å”¯ä¸€æ ‡è¯†æ›´æ–°çš„è¡Œï¼Œä»¥åŠæ‰€æœ‰åˆ—çš„æ–°å€¼(è‡³å°‘æ‰€æœ‰å·²æ›´æ”¹çš„åˆ—çš„æ–°å€¼)</p>
</li>
</ul>
<blockquote>
<p>é€»è¾‘æ—¥å¿—ï¼Œå¯ä½¿é¢†å¯¼è€…å’Œè·Ÿéšè€…èƒ½å¤Ÿè¿è¡Œä¸åŒç‰ˆæœ¬çš„æ•°æ®åº“è½¯ä»¶ç”šè‡³ä¸åŒçš„å­˜å‚¨å¼•æ“ã€‚MySQLçš„binlogæ—¥å¿—æœ‰ä¸‰ç§æ ¼å¼ï¼Œåˆ†åˆ«æ˜¯statementã€rowã€mixedï¼Œç°é€šå¸¸ä½¿ç”¨rowæ¨¡å¼ï¼Œå³é€»è¾‘æ—¥å¿—çš„å½¢å¼ï¼ŒMySQL binlog ä½¿ç”¨rowæ¨¡å¼å°±æ˜¯å½“å‰æè¿°çš„è¿™ç§æ–¹å¼</p>
<p>æ¨¡å¼ä¸‹æ•°æ®åº“çš„å˜æ›´æµå¯ä»¥åº”ç”¨åœ¨MySQLä»åº“ï¼Œæˆ–è€…Debezium/Cancelè§£æåæ¨é€è‡³ä¸‰æ–¹ç³»ç»Ÿ(æ¶ˆæ¯ä»£ç†Kafkaã€å­˜å‚¨ç³»ç»Ÿ)</p>
</blockquote>
<p>4ï¸âƒ£ åŸºäºè§¦å‘å™¨çš„å¤åˆ¶ï¼Œè§¦å‘å™¨èƒ½å¤Ÿå®ç°ï¼Œåœ¨æ•°æ®åº“ç³»ç»Ÿä¸­å‘ç”Ÿæ•°æ®æ›´æ”¹(å†™å…¥äº‹åŠ¡)æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œçš„è‡ªå®šä¹‰åº”ç”¨ç¨‹åºä»£ç ï¼Œä¸åŒäºæ•°æ®åº“ç³»ç»Ÿå®ç°çš„å¤åˆ¶</p>
<h2 id="å¤åˆ¶å»¶è¿Ÿé—®é¢˜">å¤åˆ¶å»¶è¿Ÿé—®é¢˜</h2>
<h3 id="A-ä»€ä¹ˆæ˜¯æœ€ç»ˆä¸€è‡´æ€§ï¼Ÿ">A-ä»€ä¹ˆæ˜¯æœ€ç»ˆä¸€è‡´æ€§ï¼Ÿ</h3>
<p>ä»åº“æœ‰å¯èƒ½è½åäºä¸»åº“ï¼Œæ­¤æ—¶åŒä¸€ä¸ªæŸ¥è¯¢æ‰“åˆ°ä¸»åº“å’Œä»åº“ï¼Œä¼šå¾—åˆ°ä¸ä¸€æ ·çš„ç»“æœï¼Œè¿™ç§ä¸ä¸€è‡´åªæ˜¯ä¸€ä¸ªæš‚æ—¶çš„çŠ¶æ€ï¼Œå¦‚æœåœæ­¢å†™å…¥æ•°æ®åº“å¹¶ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œä»åº“æœ€ç»ˆä¼šèµ¶ä¸Šå¹¶ä¸ä¸»åº“ä¿æŒä¸€è‡´ã€‚è¿™ç§æ•ˆåº”è¢«ç§°ä¸º <strong>æœ€ç»ˆä¸€è‡´æ€§ï¼ˆeventually consistencyï¼‰</strong></p>
<h3 id="B-ä»€ä¹ˆæ˜¯å†™åè¯»ä¸€è‡´æ€§ï¼Ÿ">B-ä»€ä¹ˆæ˜¯å†™åè¯»ä¸€è‡´æ€§ï¼Ÿ</h3>
<p>åœ¨å¼‚æ­¥å¤åˆ¶ç­–ç•¥ä¸­ï¼Œç”¨æˆ·å‘ä¸»æäº¤äº†æ–°æ•°æ®ï¼Œä½†æ˜¯è¯¥ç”¨æˆ·çš„æŸ¥è¯¢æ‰“åˆ°äº†ä»åº“ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å†™åè¯»ä¸€è‡´æ€§ï¼ˆread-after-write consistencyï¼‰ï¼Œå³ï¼šè‡ªå·±åˆšåˆšæ›´æ–°çš„å†…å®¹ï¼Œå†å»æŸ¥è¯¢çš„æ—¶å€™ï¼Œå¯ä»¥è·å–åˆ°æ›´æ–°</p>
<p>å…·ä½“å®ç°çš„æ–¹å¼æœ‰ï¼š</p>
<ol>
<li class="lvl-3">
<p>è¯»ç”¨æˆ·<strong>å¯èƒ½å·²ç»ä¿®æ”¹è¿‡</strong>çš„å†…å®¹æ—¶ï¼Œéƒ½ä»ä¸»åº“è¯»ã€‚ä¸€ä¸ªç®€å•çš„è§„åˆ™æ˜¯ï¼šä»ä¸»åº“è¯»å–ç”¨æˆ·è‡ªå·±çš„æ¡£æ¡ˆï¼Œåœ¨ä»åº“è¯»å–å…¶ä»–ç”¨æˆ·çš„æ¡£æ¡ˆ</p>
</li>
<li class="lvl-3">
<p>å®¢æˆ·ç«¯è®°ä½æœ€è¿‘ä¸€æ¬¡å†™å…¥çš„æ—¶é—´æˆ³ï¼ˆå¯ä»¥æ˜¯é€»è¾‘æ—¶é—´æˆ³ï¼‰ï¼Œå¦‚æœè¯¥æ—¶é—´æˆ³å·²ç»ä¼ æ’­åˆ°äº†ä»åº“ï¼Œä»ä»åº“è¯»å–æ²¡é—®é¢˜ï¼Œå¦åˆ™ä»ä¸»åº“è¯»</p>
</li>
</ol>
<p align="center">
  <img src="/2023/09/21/ddia/60.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> å†™åè¯»ä¸€è‡´æ€§ä¿è¯ &amp; å•è°ƒè¯»ä¸€è‡´æ€§ä¿è¯ </span>
</p>
<h3 id="C-ä»€ä¹ˆæ˜¯å•è°ƒè¯»ï¼Ÿ">C-ä»€ä¹ˆæ˜¯å•è°ƒè¯»ï¼Ÿ</h3>
<p>ç”¨æˆ·é¦–å…ˆä»æ–°å‰¯æœ¬è¯»å–ï¼Œç„¶åä»æ—§å‰¯æœ¬è¯»å–ã€‚æ—¶å…‰å€’æµï¼Œæˆ‘ä»¬éœ€è¦å•è°ƒè¯»ä¸€è‡´æ€§</p>
<p>å®ç°å•è°ƒè¯»å–çš„ä¸€ç§æ–¹å¼æ˜¯ï¼Œç¡®ä¿æ¯ä¸ªç”¨æˆ·æ€»æ˜¯ä»åŒä¸€ä¸ªå‰¯æœ¬è¿›è¡Œè¯»å–ï¼ˆä¸åŒçš„ç”¨æˆ·å¯ä»¥ä»ä¸åŒçš„å‰¯æœ¬è¯»å–ï¼‰ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥åŸºäºç”¨æˆ·IDçš„æ•£åˆ—æ¥é€‰æ‹©å‰¯æœ¬ï¼Œè€Œä¸æ˜¯éšæœºé€‰æ‹©å‰¯æœ¬ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¯¥å‰¯æœ¬å¤±è´¥ï¼Œç”¨æˆ·çš„æŸ¥è¯¢å°†éœ€è¦é‡æ–°è·¯ç”±åˆ°å¦ä¸€ä¸ªå‰¯æœ¬</p>
<h3 id="D-ä»€ä¹ˆæ˜¯ä¸€è‡´å‰ç¼€è¯»ï¼Ÿ">D-ä»€ä¹ˆæ˜¯ä¸€è‡´å‰ç¼€è¯»ï¼Ÿ</h3>
<p>å¦‚æœæŸäº›åˆ†åŒºçš„å¤åˆ¶é€Ÿåº¦æ…¢äºå…¶ä»–åˆ†åŒºï¼Œé‚£ä¹ˆè§‚å¯Ÿè€…åœ¨çœ‹åˆ°é—®é¢˜ä¹‹å‰å¯èƒ½ä¼šçœ‹åˆ°ç­”æ¡ˆï¼Œæˆ‘ä»¬éœ€è¦æä¾›æŸç§ä¿è¯ï¼Œå¦‚æœä¸€ç³»åˆ—å†™å…¥æŒ‰æŸä¸ªé¡ºåºå‘ç”Ÿï¼Œé‚£ä¹ˆä»»ä½•äººè¯»å–è¿™äº›å†™å…¥æ—¶ï¼Œä¹Ÿä¼šçœ‹è§å®ƒä»¬ä»¥åŒæ ·çš„é¡ºåºå‡ºç°</p>
<p align="center">
  <img src="/2023/09/21/ddia/62.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> ä¸€è‡´å‰ç¼€åº¦ä¿è¯ </span>
</p>
<p>è®¸å¤šåˆ†å¸ƒå¼æ•°æ®åº“ä¸­ï¼Œä¸åŒçš„åˆ†åŒºç‹¬ç«‹è¿è¡Œï¼Œå› æ­¤ä¸å­˜åœ¨<strong>å…¨å±€å†™å…¥é¡ºåº</strong>ï¼šå½“ç”¨æˆ·ä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šçœ‹åˆ°æ•°æ®åº“çš„æŸäº›éƒ¨åˆ†å¤„äºè¾ƒæ—§çš„çŠ¶æ€ï¼Œè€ŒæŸäº›å¤„äºè¾ƒæ–°çš„çŠ¶æ€ã€‚</p>
<p>ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œç¡®ä¿ä»»ä½•å› æœç›¸å…³çš„å†™å…¥éƒ½å†™å…¥ç›¸åŒçš„åˆ†åŒºã€‚å¯¹äºæŸäº›æ— æ³•é«˜æ•ˆå®Œæˆè¿™ç§æ“ä½œçš„åº”ç”¨ï¼Œè¿˜æœ‰ä¸€äº›æ˜¾å¼è·Ÿè¸ªå› æœä¾èµ–å…³ç³»çš„ç®—æ³•ï¼Œæœ¬ä¹¦å°†åœ¨â€œä¸€è‡´æ€§ä¸å…±è¯†â€ä¸€èŠ‚ä¸­å†æ¬¡èŠèŠè¿™ä¸ªé—®é¢˜</p>
<h2 id="å¤šä¸»å¤åˆ¶çš„é—®é¢˜">å¤šä¸»å¤åˆ¶çš„é—®é¢˜</h2>
<p>å¤šé¢†å¯¼è€…å¤åˆ¶çš„æœ€å¤§é—®é¢˜æ˜¯å¯èƒ½å‘ç”Ÿå†™å†²çªï¼Œè¿™æ„å‘³ç€éœ€è¦ <strong>è§£å†³å†²çª</strong></p>
<p align="center">
  <img src="/2023/09/21/ddia/63.png" width="100%" alt="Your image description">
    <br>
  <span style="color:gray"> ä¸¤ä¸ªä¸»åº“åŒæ—¶æ›´æ–°åŒä¸€è®°å½•å¼•èµ·çš„å†™å…¥å†²çª </span>
</p>
<h2 id="æ— ä¸»å¤åˆ¶">æ— ä¸»å¤åˆ¶</h2>
<p>åœ¨æ— ä¸»å¤åˆ¶ï¼Œå®¢æˆ·ç«¯çš„å†™å…¥å’Œè¯»å–ï¼Œéƒ½è¯·æ±‚åˆ°æ‰€æœ‰çš„å‰¯æœ¬ï¼Œå‰¯æœ¬çš„å†™å…¥æœ‰å¯èƒ½å¤±è´¥ï¼Œæœ‰å¯èƒ½æˆåŠŸï¼›è¯»å–æ—¶ï¼Œé€‰æ‹©æŒ‰ç…§æ³•å®šäººæ•°ï¼ˆ5ä¸ªèŠ‚ç‚¹ï¼Œ3ä¸ªèŠ‚ç‚¹è¿”å›æ•°æ®ç›¸åŒï¼‰çš„æ•°æ®å›å†™åˆ°å†™å…¥å¤±è´¥çš„èŠ‚ç‚¹ã€‚åŒæ—¶åå°è¿›ç¨‹è¿½è¸ªèŠ‚ç‚¹ä¹‹é—´çš„å·®å¼‚ï¼Œè¶‹åŠ¿æ•°æ®çš„æ”¶æ•›ï¼ˆå› ä¸ºæœ‰ä¸€äº›é”®æ²¡æœ‰è¯»è¯·æ±‚ï¼‰</p>
<h3 id="A-ä»€ä¹ˆæ˜¯å¹¶å‘ï¼Ÿ">A-ä»€ä¹ˆæ˜¯å¹¶å‘ï¼Ÿ</h3>
<p>ä¸ºäº†å®šä¹‰å¹¶å‘æ€§ï¼Œç¡®åˆ‡çš„æ—¶é—´å¹¶ä¸é‡è¦ï¼šå¦‚æœä¸¤ä¸ªæ“ä½œéƒ½æ„è¯†ä¸åˆ°å¯¹æ–¹çš„å­˜åœ¨ï¼Œå°±ç§°è¿™ä¸¤ä¸ªæ“ä½œ<strong>å¹¶å‘</strong></p>
<h1>ç¬¬6ç« -åˆ†åŒº</h1>
<p><strong>åˆ†åŒº<sup class="footnote-ref"><a href="#fn10" id="fnref10">[10]</a></sup>æ˜¯ä¸€ç§åˆ‡åˆ†å¤§æ•°æ®é›†çš„æ–¹æ³•ï¼Œå³ä¸€ä»½æ•°æ®åˆ‡æˆå¤šå—</strong>ï¼Œåˆ†åŒºçš„ç›®çš„æ˜¯ä¸ºäº†å¯æ‰©å±•æ€§ï¼Œä»è€Œæé«˜ååé‡ã€‚åœ¨å®è·µä¸­ï¼Œåˆ†åŒºé€šå¸¸å’Œå¤åˆ¶ç»“åˆä½¿ç”¨ï¼Œæ¯ä¸ªåˆ†åŒºçš„å‰¯æœ¬å°†å¤„åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œä»¥æ­¤è·å¾—å®¹é”™èƒ½åŠ›ã€‚ä¸‹å›¾æ˜¯ä¸»ä»å¤åˆ¶æ¨¡å‹ä¸‹ï¼Œåˆ†åŒºå’Œå¤åˆ¶ç›¸ç»“åˆçš„ç¤ºæ„å›¾ï¼š</p>
<blockquote></blockquote>
<p align="center">
  <img src="/2023/09/21/ddia/47.jpg" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> åˆ†åŒºå’Œå¤åˆ¶çš„å®ä¾‹ </span>
</p>
<h2 id="é”®å€¼æ•°æ®çš„åˆ†åŒºæ–¹å¼">é”®å€¼æ•°æ®çš„åˆ†åŒºæ–¹å¼</h2>
<p>åˆ†åŒºæœ€æ ¸å¿ƒçš„é—®é¢˜æ˜¯</p>
<p>ğŸ…°ï¸ é¿å…å€¾æ–œ(skew)ï¼Œå³çƒ­ç‚¹æ•°æ®å¤„ç†ï¼Œæ”¾çš„è§’åº¦</p>
<p>ğŸ…±ï¸ å¤„ç†è®¿é—®è·¯ç”±é—®é¢˜ï¼Œå³æŸ¥è¯¢æ€§èƒ½çš„ä¿è¯ï¼Œå–çš„è§’åº¦</p>
<p>ä¸‹é¢æˆ‘ä»¬ä»‹ç»å‡ ç§å¸¸è§çš„åˆ†åŒºæ–¹å¼ï¼š</p>
<p>1ï¸âƒ£ æŒ‰ç…§keyçš„èŒƒå›´åˆ†åŒºï¼Œè¿™ç§æ–¹å¼å¤©ç”Ÿå¯ä»¥è§£å†³è®¿é—®è·¯ç”±çš„é—®é¢˜ï¼Œå¯¹äºçƒ­ç‚¹æ•°æ®ï¼Œå¯æ ¹æ®æ•°æ®çŠ¶å†µè¿›è¡Œæ‹†åˆ†ï¼ŒHbase,BigTableä½¿ç”¨è¿™ç§ç­–ç•¥ã€‚åœ¨å¤„ç†æ—¶é—´èŒƒå›´åˆ†åŒºæ—¶ï¼Œä¸ºé¿å…ä¸€ç›´å†™å½“å‰æ—¶é—´å¯¹åº”åˆ†åŒºçš„ <strong>å†™å…¥è¿‡è½½</strong> é—®é¢˜ï¼Œå¯å¼•å…¥å…¶ä»–åˆ—å€¼+æ—¶é—´åšåˆ†åŒº</p>
<p align="center">
  <img src="/2023/09/21/ddia/48.jpg" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> æŒ‰ç…§èŒƒå›´åˆ†åŒºï¼Œå¯ä»¥æ‰‹åŠ¨è°ƒæ•´åˆ†åŒºèŒƒå›´ï¼Œä½¿å¾—åˆ†åŒºå°½é‡å‡è¡¡</span>
</p>
<p>2ï¸âƒ£ æ•£åˆ—<sup class="footnote-ref"><a href="#fn11" id="fnref11">[11]</a></sup>åˆ†åŒºã€‚æ•£åˆ—åˆ†åŒºå¯ä»¥å¾ˆå¥½çš„å¤„ç†çƒ­ç‚¹é—®é¢˜ï¼Œå¼Šç«¯æ˜¯æŸ¥è¯¢èƒ½åŠ›æ— æ³•ä¿è¯ï¼Œå› ä¸ºæ›¾ç»ç›¸é‚»çš„å¯†é’¥åˆ†æ•£åœ¨æ‰€æœ‰åˆ†åŒºä¸­ï¼Œè¿™æ„å‘³ç€å¦‚æœæ‰§è¡ŒèŒƒå›´æŸ¥è¯¢ï¼Œåˆ™è¯¥æŸ¥è¯¢å°†è¢«å‘é€åˆ°æ‰€æœ‰åˆ†åŒºä¸­</p>
<p align="center">
  <img src="/2023/09/21/ddia/49.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> å“ˆå¸Œçš„æ–¹å¼å¤„ç†çƒ­ç‚¹é—®é¢˜ </span>
</p>
æ”¹è¿›çš„åŠæ³•æ˜¯å¤šä¸ªåˆ—ç»„æˆçš„å¤åˆä¸»é”®ï¼Œé”®ä¸­åªæœ‰ç¬¬ä¸€åˆ—ä¼šä½œä¸ºæ•£åˆ—çš„ä¾æ®ï¼Œè€Œå…¶ä»–åˆ—åˆ™è¢«ç”¨ä½œSSTablesä¸­æ’åºæ•°æ®çš„ç´¢å¼•ï¼Œæ­¤æ—¶å¦‚æœç¬¬ä¸€åˆ—ï¼ˆå¦‚`user_id`ï¼‰å·²ç»æŒ‡å®šäº†å›ºå®šå€¼ï¼Œåˆ™å¯ä»¥å¯¹è¯¥é”®çš„å…¶ä»–åˆ—ï¼ˆ`timestamp`ï¼‰æ‰§è¡Œæœ‰æ•ˆçš„èŒƒå›´æ‰«æã€‚ä¾‹å¦‚ï¼Œåœ¨ç¤¾äº¤åª’ä½“ç½‘ç«™ä¸Šï¼Œä¸€ä¸ªç”¨æˆ·å¯èƒ½ä¼šå‘å¸ƒå¾ˆå¤šæ›´æ–°ã€‚è‹¥æ›´æ–°çš„ä¸»é”®è¢«é€‰æ‹©ä¸º`(user_id, update_timestamp)`ï¼Œé‚£ä¹ˆå¯ä»¥æœ‰æ•ˆåœ°æ£€ç´¢ï¼Œç‰¹å®šç”¨æˆ·åœ¨æŸä¸ªæ—¶é—´é—´éš”å†…æŒ‰æ—¶é—´æˆ³æ’åºçš„æ‰€æœ‰æ›´æ–°ã€‚Casssandraä½¿ç”¨äº†è¿™ç§ä¼˜åŒ–æ–¹å¼
<blockquote></blockquote>
<h2 id="åˆ†åŒºå’ŒäºŒçº§ç´¢å¼•">åˆ†åŒºå’ŒäºŒçº§ç´¢å¼•</h2>
<p>ä¸Šæ–‡ä¸­æˆ‘ä»¬è®¨è®ºäº† &lt;é”®å€¼æ•°æ®æ¨¡å‹&gt; çš„åˆ†åŒºæ–¹æ¡ˆï¼Œæ¬¡çº§ç´¢å¼•æ˜¯å…³ç³»å‹æ•°æ®åº“/æ–‡æ¡£å‹æ•°æ®åº“çš„åŸºç¡€ï¼Œä¹Ÿæ˜¯<code>Solr</code>å’Œ<code>ElasticSearch</code>ç­‰æœç´¢æœåŠ¡å™¨çš„åŸºçŸ³ï¼Œæ¬¡çº§ç´¢å¼•ç”±äºä¸å…·å¤‡ä¸»é”®å”¯ä¸€çš„ç‰¹æ€§ï¼Œå¯¼è‡´æˆ‘ä»¬å¹¶ä¸èƒ½æ•´é½çš„æ˜ å°„åˆ°å„è‡ªçš„åˆ†åŒºï¼Œæœ‰2ç§ç”¨äºŒçº§ç´¢å¼•å¯¹æ•°æ®è¿›è¡Œåˆ†åŒºçš„æ–¹æ³•ï¼š</p>
<p>ğŸ…°ï¸ åŸºäºæ–‡æ¡£çš„åˆ†åŒº(docment-based)ï¼Œå¦‚ä¸‹å›¾åœ¨æ±½è½¦è¡¨/æ–‡æ¡£ä¸Šå»ºç«‹é¢œè‰²å’Œå‚å•†çš„æ¬¡çº§ç´¢å¼•ï¼Œè¿™ç§ç´¢å¼•æ–¹æ³•ä¸­ï¼Œ<strong>æ¯ä¸ªåˆ†åŒºæ˜¯å®Œå…¨ç‹¬ç«‹ï¼Œæ¯ä¸ªåˆ†åŒºç»´æŠ¤è‡ªå·±çš„æ¬¡çº§ç´¢å¼•</strong>ï¼Œå› æ­¤ï¼Œæ–‡æ¡£åˆ†åŒºç´¢å¼•ä¹Ÿå«åšæœ¬åœ°ç´¢å¼•(local index)ã€‚åœ¨æ‰§è¡Œç‰¹å®šçš„é¢œè‰²çš„æœç´¢(look for red)çš„æ—¶å€™ï¼Œéœ€è¦å°†æŸ¥è¯¢å‘é€åˆ°æ‰€æœ‰åˆ†åŒºï¼Œå¹¶åˆå¹¶æ‰€æœ‰è¿”å›çš„ç»“æœã€‚æ•…ï¼Œè¿™ç§åˆ†åŒºæŸ¥è¯¢æ•°æ®åº“çš„æ–¹å¼æœ‰æ—¶è¢«ç§°ä¸º<strong>åˆ†æ•£/èšé›†(scatter/gather)</strong>ï¼Œè¿™ç§åŸºäºäºŒçº§ç´¢å¼•ä¸Šçš„æŸ¥è¯¢å¯èƒ½ä¼šç›¸å½“æ˜‚è´µ</p>
<p align="center">
  <img src="/2023/09/21/ddia/50.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> åŸºäºæ–‡æ¡£çš„äºŒçº§ç´¢å¼•åˆ†åŒº </span>
</p>
<p>ğŸ…±ï¸ åŸºäºå…³é”®è¯(term-based)çš„åˆ†åŒºï¼Œå¯¹æ‰€æœ‰åˆ†åŒºçš„æ•°æ®æ„å»ºå…¨å±€ç´¢å¼•çš„åŒæ—¶ï¼Œå¯¹å…¨å±€ç´¢å¼•è¿›è¡Œåˆ†åŒºã€‚è¿™ç§ç´¢å¼•ç§°ä¸º<strong>å…³é”®è¯åˆ†åŒº(term-partitioned)</strong> <sup class="footnote-ref"><a href="#fn12" id="fnref12">[12]</a></sup>ï¼Œå…³é”®è¯åˆ†åŒºçš„å…¨å±€ç´¢å¼•çš„ä¼˜åŠ¿åœ¨äºä¸éœ€è¦<strong>åˆ†æ•£/æ”¶é›†</strong>æ‰€æœ‰åˆ†åŒºï¼Œå®¢æˆ·ç«¯åªéœ€è¦å‘åŒ…å«å…³é”®è¯çš„åˆ†åŒºå‘å‡ºè¯·æ±‚ã€‚å…¨å±€ç´¢å¼•çš„ç¼ºç‚¹åœ¨äºå†™å…¥é€Ÿåº¦è¾ƒæ…¢ä¸”è¾ƒä¸ºå¤æ‚ï¼Œå› ä¸ºå†™å…¥å•ä¸ªæ–‡æ¡£ç°åœ¨å¯èƒ½ä¼šå½±å“ç´¢å¼•çš„å¤šä¸ªåˆ†åŒºã€‚åœ¨å®è·µä¸­ï¼Œå…¨å±€äºŒçº§ç´¢å¼•çš„æ›´æ–°é€šå¸¸æ˜¯<strong>å¼‚æ­¥</strong>çš„</p>
<blockquote>
<p>(åœ¨ä»»ä½•æ—¶å€™)ä½¿ç”¨å…³é”®è¯æœ¬èº«è¿›è¡Œåˆ†åŒºé€‚ç”¨äºèŒƒå›´æ‰«æï¼Œè€Œå¯¹å…³é”®è¯çš„å“ˆå¸Œåˆ†åŒºæä¾›æ›´å¥½çš„è´Ÿè½½å‡è¡¡èƒ½åŠ›</p>
</blockquote>
<p align="center">
  <img src="/2023/09/21/ddia/51.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> åŸºäºå…³é”®è¯çš„äºŒçº§ç´¢å¼•åˆ†åŒº </span>
</p>
<blockquote></blockquote>
<h2 id="åˆ†åŒºå†å¹³è¡¡">åˆ†åŒºå†å¹³è¡¡</h2>
<p>å°†è´Ÿè½½(æ•°æ®å­˜å‚¨å’Œè¯»å†™è¯·æ±‚)ä»é›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå‘å¦ä¸€ä¸ªèŠ‚ç‚¹ç§»åŠ¨çš„è¿‡ç¨‹ç§°ä¸º<strong>å†å¹³è¡¡(reblancing)</strong>ï¼Œå†å¹³è¡¡åº”è¯¥æ»¡è¶³ä¸€ä¸‹å‡ ä¸ªè¦æ±‚ï¼š</p>
<ol>
<li class="lvl-3">
<p>å†å¹³è¡¡ä¹‹åï¼Œè´Ÿè½½(æ•°æ®å­˜å‚¨ï¼Œè¯»å–å’Œå†™å…¥è¯·æ±‚)åº”è¯¥ï¼Œåœ¨é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¹‹é—´å…¬å¹³åœ°å…±äº«</p>
</li>
<li class="lvl-3">
<p>å†å¹³è¡¡å‘ç”Ÿæ—¶ï¼Œæ•°æ®åº“åº”è¯¥ç»§ç»­æ¥å—è¯»å–å’Œå†™å…¥</p>
</li>
<li class="lvl-3">
<p>èŠ‚ç‚¹ä¹‹é—´åªç§»åŠ¨å¿…é¡»çš„æ•°æ®<sup class="footnote-ref"><a href="#fn13" id="fnref13">[13]</a></sup>ï¼Œä»¥ä¾¿å¿«é€Ÿå†å¹³è¡¡ï¼Œå¹¶å‡å°‘ç½‘ç»œå’Œç£ç›˜I/Oè´Ÿè½½</p>
</li>
</ol>
<blockquote></blockquote>
<p>ç›¸åº”çš„ï¼Œæˆ‘ä»¬æœ‰ä¸‰ç§åˆ†åŒºæ–¹å¼ï¼Œæ¥è¿›è¡Œå¤„ç†</p>
<p>1ï¸âƒ£ å›ºå®šæ•°é‡çš„åˆ†åŒºï¼Œåˆ›å»ºæ¯”èŠ‚ç‚¹æ›´å¤šçš„åˆ†åŒºï¼Œå¹¶ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…å¤šä¸ªåˆ†åŒºï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹è¢«æ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼Œæ–°èŠ‚ç‚¹å¯ä»¥ä»å½“å‰æ¯ä¸ªèŠ‚ç‚¹ä¸­<strong>çªƒå–</strong>ä¸€äº›åˆ†åŒºï¼Œç›´åˆ°åˆ†åŒºå†æ¬¡å…¬å¹³åˆ†é…ï¼Œå¦‚ä¸‹å›¾ã€‚Riakï¼ŒElasticsearchä½¿ç”¨äº†è¿™ç§å†å¹³è¡¡çš„åˆ†åŒºæ–¹å¼</p>
<p align="center">
  <img src="/2023/09/21/ddia/52.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> æ–°èŠ‚ç‚¹ä»æ—§èŠ‚ç‚¹ä¸­çªƒå–ä¸€äº›åˆ†åŒº </span>
</p>
<p>2ï¸âƒ£ åŠ¨æ€åˆ†åŒºï¼Œå½“åˆ†åŒºå¢é•¿åˆ°è¶…è¿‡é…ç½®çš„å¤§å°æ—¶(åœ¨HBaseä¸Šï¼Œé»˜è®¤å€¼æ˜¯10GB)ï¼Œä¼šè¢«åˆ†æˆä¸¤ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºçº¦å ä¸€åŠçš„æ•°æ®ï¼Œåä¹‹è¿›è¡Œåˆå¹¶ï¼Œç±»ä¼¼Bæ ‘çš„é¡µåˆ†è£‚/åˆå¹¶çš„è¿‡ç¨‹</p>
<p>3ï¸âƒ£ åˆ†åŒºæ•°ä¸èŠ‚ç‚¹æ•°æˆæ­£æ¯”ï¼ŒèŠ‚ç‚¹æ•°é‡ä¸å˜æ—¶ï¼Œæ¯ä¸ªåˆ†åŒºçš„å¤§å°ä¸æ•°æ®é›†å¤§å°æˆæ¯”ä¾‹åœ°å¢é•¿ï¼ŒèŠ‚ç‚¹æ•°å¢åŠ æ—¶ï¼Œåˆ†åŒºæ•°ä¹Ÿå¢åŠ ï¼Œåˆ†åŒºæ•°æ®å˜å°‘</p>
<h2 id="è¯·æ±‚è·¯ç”±">è¯·æ±‚è·¯ç”±</h2>
<p>æ•°æ®é›†å·²ç»åˆ†å‰²åˆ°å¤šä¸ªæœºå™¨ä¸Šè¿è¡Œçš„å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆå½“å®¢æˆ·æƒ³è¦å‘å‡ºè¯·æ±‚æ—¶ï¼Œå¦‚ä½•çŸ¥é“è¦è¿æ¥å“ªä¸ªèŠ‚ç‚¹å‘¢ï¼Ÿå³è¯·æ±‚åº”è¯¥è·¯ç”±ç»™è°ï¼Ÿè¿™ä¸ªé—®é¢˜ä¹Ÿå¯ä»¥æ¦‚æ‹¬ä¸º<strong>æœåŠ¡å‘ç°(service discovery)</strong>ï¼Œæœ‰ç›®å‰ä»¥ä¸‹ä¸‰ç§æ–¹æ¡ˆï¼š</p>
<p>1ï¸âƒ£ å…è®¸å®¢æˆ·è”ç³»ä»»ä½•èŠ‚ç‚¹(ä¾‹å¦‚ï¼Œé€šè¿‡<strong>å¾ªç¯ç­–ç•¥çš„è´Ÿè½½å‡è¡¡(Round-Robin Load Balancer)</strong>)ã€‚å¦‚æœè¯¥èŠ‚ç‚¹æ°å·§æ‹¥æœ‰è¯·æ±‚çš„åˆ†åŒºï¼Œåˆ™å®ƒå¯ä»¥ç›´æ¥å¤„ç†è¯¥è¯·æ±‚ï¼Œå¦åˆ™ï¼Œå®ƒå°†è¯·æ±‚è½¬å‘åˆ°é€‚å½“çš„èŠ‚ç‚¹ï¼Œæ¥æ”¶å›å¤å¹¶ä¼ é€’ç»™å®¢æˆ·ç«¯</p>
<p>2ï¸âƒ£ é¦–å…ˆå°†æ‰€æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚å‘é€åˆ°è·¯ç”±å±‚ï¼Œå®ƒå†³å®šäº†åº”è¯¥å¤„ç†è¯·æ±‚çš„èŠ‚ç‚¹ï¼Œå¹¶ç›¸åº”åœ°è½¬å‘ã€‚æ­¤è·¯ç”±å±‚æœ¬èº«ä¸å¤„ç†ä»»ä½•è¯·æ±‚ï¼Œå®ƒä»…è´Ÿè´£åˆ†åŒºçš„è´Ÿè½½å‡è¡¡</p>
<p>3ï¸âƒ£ è¦æ±‚å®¢æˆ·ç«¯çŸ¥é“åˆ†åŒºå’ŒèŠ‚ç‚¹çš„åˆ†é…ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç›´æ¥è¿æ¥åˆ°é€‚å½“çš„èŠ‚ç‚¹ï¼Œè€Œä¸éœ€è¦ä»»ä½•ä¸­ä»‹</p>
<p align="center">
  <img src="/2023/09/21/ddia/53.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> å®¢æˆ·ç«¯è¿æ¥åˆ°åˆ†åŒºçš„3ç§æ–¹å¼ </span>
</p>
<p>ä»¥ä¸Šä¸‰ç§æ–¹å¼éƒ½ä¼šé¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼šä½œå‡ºè·¯ç”±å†³ç­–çš„ç»„ä»¶(èŠ‚ç‚¹ä¹‹ä¸€/è·¯ç”±å±‚/å®¢æˆ·ç«¯)ï¼Œå¦‚ä½•äº†è§£åˆ†åŒº-èŠ‚ç‚¹ä¹‹é—´çš„åˆ†é…å…³ç³»å˜åŒ–ï¼Ÿè®¸å¤šåˆ†å¸ƒå¼æ•°æ®ç³»ç»Ÿéƒ½ä¾èµ–äºä¸€ä¸ªç‹¬ç«‹çš„åè°ƒæœåŠ¡(å¦‚ZooKeeper)æ¥è·Ÿè¸ªé›†ç¾¤å…ƒæ•°æ®ï¼Œæ¯ä¸ªèŠ‚ç‚¹åœ¨ZooKeeperä¸­æ³¨å†Œè‡ªå·±ï¼ŒZooKeeperç»´æŠ¤åˆ†åŒºåˆ°èŠ‚ç‚¹çš„å¯é æ˜ å°„</p>
<p>å…¶ä»–å‚ä¸è€…(å¦‚è·¯ç”±å±‚æˆ–åˆ†åŒºæ„ŸçŸ¥å®¢æˆ·ç«¯)å¯ä»¥åœ¨ZooKeeperä¸­è®¢é˜…æ­¤ä¿¡æ¯ã€‚ åªè¦åˆ†åŒºåˆ†é…å‘ç”Ÿçš„æ”¹å˜ï¼Œæˆ–è€…é›†ç¾¤ä¸­æ·»åŠ æˆ–åˆ é™¤äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒZooKeeperå°±ä¼šé€šçŸ¥è·¯ç”±å±‚ä½¿è·¯ç”±ä¿¡æ¯ä¿æŒæœ€æ–°çŠ¶æ€ã€‚HBaseï¼ŒSolrCloudå’ŒKafkaï¼Œä½¿ç”¨ZooKeeperæ¥è·Ÿè¸ªåˆ†åŒºåˆ†é…</p>
<p>MongoDBå…·æœ‰ç±»ä¼¼çš„ä½“ç³»ç»“æ„ï¼Œä½†å®ƒä¾èµ–äºè‡ªå·±çš„<strong>é…ç½®æœåŠ¡å™¨ï¼ˆconfig serverï¼‰</strong> å®ç°å’Œmongoså®ˆæŠ¤è¿›ç¨‹ä½œä¸ºè·¯ç”±å±‚</p>
<p align="center">
  <img src="/2023/09/21/ddia/56.jpg" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> è·¯ç”±å±‚å¦‚ä½•æ„ŸçŸ¥åˆ†åŒºå’ŒèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³» </span>
</p>
<h1>ç¬¬7ç« èŠ‚-äº‹åŠ¡</h1>
<h2 id="äº‹åŠ¡çš„èµ·æº">äº‹åŠ¡çš„èµ·æº</h2>
<p>å¾ˆæ—©å°±æ¥è§¦äº‹åŠ¡è¿™ä¸ªæ¦‚å¿µï¼Œå…³äºäº‹åŠ¡ç½‘ä¸Šçš„æ–‡ç« åŠ¨ä¸åŠ¨å°±æŠŠè½¬è´¦çš„çš„ä¾‹å­æ‹¿å‡ºæ¥è®²ï¼Œå‘çš„æ—¶å€™æœ‰çš„å‹æ ¹å°±æ²¡æœ‰è®²æ˜ç™½ï¼Œäº‹åŠ¡çš„æ¦‚å¿µ<strong>äº‹åŠ¡è¦ä¸å°±æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¸æ‰§è¡Œå¤±è´¥ï¼Œåªæœ‰è¿™2ç§çŠ¶æ€</strong>ä¹ŸèƒŒçš„çƒ‚ç†Ÿï¼Œä¹ŸçŸ¥é“äº‹åŠ¡çš„4å¤§ç‰¹æ€§ACID (åŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§)ï¼Œä½†æ˜¯è¿™ä¹ˆäº›å¹´ä»æ¥æ²¡æœ‰æ€è€ƒè¿‡ï¼šä¸ºä»€ä¹ˆè¦æœ‰äº‹åŠ¡ï¼Ÿä»–è§£å†³äº†ä»€ä¹ˆæ ·å­çš„é—®é¢˜/ç—›ç‚¹ï¼Ÿé‚£ä¹ˆæˆ‘ä»¬å¸¦ç€è¿™ä¸ªé—®é¢˜æ¥å›é¡¾ä¸€ä¸‹äº‹åŠ¡èµ·æºï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/36.jpg" width="90%" alt="Your image description">
    <br>
  <span style="color:gray"> äº‹åŠ¡çš„èµ·æº </span>
</p>
<p>ä¸Šå›¾ä¸­æœ‰ä¸€ä¸ªåä¸ºçŒªå°æ˜çš„ç¨‹åºå‘˜ï¼ŒæŠ±ç€ç”µè„‘æ­£åœ¨ç–¯ç‹‚çš„å†™ä»£ç (å¼€å‘åº”ç”¨ç¨‹åº)ï¼Œå…¶ä¸­åº”ç”¨ç¨‹åºéœ€è¦é€è¿‡ç½‘ç»œåœ¨æ•°æ®åº“ä¸­å­˜æ”¾æ•°æ®/è·å–æ•°æ®ï¼Œæ•°æ®åº“è½¯ä»¶ä¾æ‰˜äºæ˜¯æ“ä½œç³»ç»Ÿï¼Œæ“ä½œç³»ç»Ÿçš„åº•å±‚æ˜¯ä¸€äº›è®¡ç®—æœºç¡¬ä»¶(å­˜å‚¨ä»‹è´¨/ç£ç›˜/ç¼“å­˜/Cache/RAM /ROM/CPU/ä¸»æ¿ç­‰)ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå„ä¸ªç¯èŠ‚éƒ½æœ‰å¯èƒ½å‡ºé”™ï¼Œæ¯”å¦‚ï¼š</p>
<p>1ï¸âƒ£ ç½‘ç»œä¸­æ–­ï¼Œå®¢æˆ·ç«¯å’Œåº”ç”¨ç¨‹åºæœåŠ¡ä¹‹é—´ï¼ŒæœåŠ¡å’Œæ•°æ®åº“ä¹‹é—´</p>
<p>2ï¸âƒ£ æ•°æ®åº“è½¯ä»¶æœ¬èº«æŒ‚æ‰äº†ï¼Œç¡¬ä»¶å‘ç”Ÿæ•…éšœ<sup class="footnote-ref"><a href="#fn14" id="fnref14">[14]</a></sup></p>
<blockquote></blockquote>
<p>3ï¸âƒ£ åº”ç”¨ç¨‹åºåœ¨è¿›è¡Œå†™å…¥çš„æ—¶å€™ï¼Œå†™åˆ°ä¸€åŠï¼Œè‡ªå·±å´©æºƒäº†</p>
<p>4ï¸âƒ£ å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶æ“ä½œæ•°æ®åº“ï¼Œè¦†ç›–å½¼æ­¤çš„æ›´æ–°</p>
<p>5ï¸âƒ£ å®¢æˆ·å†™åˆ°ä¸€åŠçš„æ•°æ®ï¼Œè¢«å¦å¤–ä¸€ä¸ªå®¢æˆ·è¯»å–åˆ°</p>
<p>6ï¸âƒ£ å®¢æˆ·ä¹‹é—´çš„ç«äº‰å¯¼è‡´çš„ä»¤äººæƒŠè®¶çš„é”™è¯¯</p>
<p>æ‰€æœ‰çš„è¿™ä¸€äº›éƒ½éœ€è¦åº”ç”¨ç¨‹åºçš„å¼€å‘è€…ï¼ŒçŒªå°æ˜å»è§£å†³ï¼Œä½†æ˜¯è¿™ä¸ªå·¥ä½œé‡æ˜¯å·¨å¤§çš„ï¼Œåº”ç”¨å¼€å‘åº”è¯¥ä¸“æ³¨äºä¸šåŠ¡ï¼Œè€Œä¸æ˜¯é€šç”¨é—®é¢˜çš„å¤„ç†ï¼Œè¿™äº›é—®é¢˜åº”è¯¥ç•™ç»™ä¸‹å±‚çš„æ•°æ®åº“å»å¤„ç†ã€‚æ‰€ä»¥ä¸ºäº†<strong>ç®€åŒ–åº”ç”¨ç¼–ç¨‹æ¨¡å‹</strong> ï¼Œäº‹åŠ¡è¯ç”Ÿäº†ã€‚é€šè¿‡ä½¿ç”¨äº‹åŠ¡ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è‡ªç”±åœ°å¿½ç•¥æŸäº›æ½œåœ¨çš„é”™è¯¯æƒ…å†µå’Œå¹¶å‘é—®é¢˜ï¼Œå› ä¸ºæ•°æ®åº“ä¼šæ›¿åº”ç”¨å¤„ç†å¥½è¿™äº›é—®é¢˜</p>
<p>1974å¹´çš„æ—¶å€™ï¼ŒIBMçš„åœ£è·è¥¿ç ”ç©¶ä¸­å¿ƒå‘å¸ƒäº†ï¼Œç¬¬ä¸€æ¬¾æä¾›ä¼˜ç§€çš„äº‹åŠ¡å¤„ç†èƒ½åŠ›çš„å…³ç³»å‹æ•°æ®åº“R[seminal-project]ã€‚æ—¶è‡³ä»Šæ—¥å¼€å‘è€…å·²ç»ä¹ æƒ¯äº†äº‹åŠ¡ï¼Œä»–ä»¬è§‰å¾—äº‹åŠ¡æ˜¯ç†æ‰€å½“ç„¶çš„ï¼Œæ˜¯å¤©ç„¶å°±å­˜åœ¨çš„ï¼Œç„¶è€Œå¹¶ä¸æ˜¯ï¼Œäº†è§£äº‹åŠ¡å‡ºç°çš„å†å²ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°äº‹åŠ¡æ˜¯æˆ‘ä»¬çš„è®¡ç®—æœºå…ˆé©±ä»¬ä¸ºäº†è§£å†³ä¸€æ½å­é—®é¢˜ï¼Œæä¾›çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ</p>
<h2 id="ACID">ACID</h2>
<p>è°ˆåŠäº‹åŠ¡ï¼Œå¿…è°ˆäº‹åŠ¡çš„4å¤§ç‰¹æ€§ACIDï¼›é‚£ä¹ˆACID åˆ†åˆ«æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p><em><strong>A</strong>tomicity</em> ï¼š åŸå­æ€§ã€‚<strong>èƒ½å¤Ÿåœ¨é”™è¯¯æ—¶ä¸­æ­¢äº‹åŠ¡ï¼Œä¸¢å¼ƒè¯¥äº‹åŠ¡è¿›è¡Œçš„æ‰€æœ‰å†™å…¥å˜æ›´çš„èƒ½åŠ›</strong>ï¼Œå¯ä»¥ç†è§£ä¸º<strong>å¯ç»ˆæ­¢æ€§</strong>ã€‚å‡è®¾æ²¡æœ‰åŸå­æ€§ï¼Œå¦‚æœæœ‰å¤šæ¬¡æ›´æ”¹ï¼Œä½†æ˜¯æ›´æ”¹å‘ç”Ÿè¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œåº”ç”¨ç¨‹åºå¾ˆéš¾åˆ¤æ–­å“ªäº›æ›´æ”¹ç”Ÿæ•ˆäº†ï¼Œå“ªäº›æ²¡æœ‰ç”Ÿæ•ˆã€‚å¦‚æœæœ‰äº†åŸå­æ€§ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ç¡®å®šçš„çŸ¥é“åœ¨å‘ç”Ÿé”™è¯¯æ—¶ï¼Œæ‰€æœ‰æ›´æ”¹æ²¡æœ‰ç”Ÿæ•ˆã€‚<strong>æ²¡æœ‰åŸå­æ€§ï¼Œé”™è¯¯å¤„ç†å°±ä¼šå˜çš„å¾ˆå¤æ‚</strong></p>
<blockquote>
<p>åŒºåˆ«äºçº¿ç¨‹çš„åŸå­æ“ä½œï¼šå¤šçº¿ç¨‹ä¸­çš„åŸå­æ“ä½œæè¿°çš„æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸€ä¸ªåŸå­æ“ä½œï¼Œæ„å‘³ç€å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ— æ³•çœ‹åˆ°è¯¥åŸå­æ“ä½œçš„ä¸­é—´ç»“æœã€‚è€Œè¿™ä¸ªç‰¹æ€§åœ¨ACIDä¸­æ˜¯ <em>I(isolation)</em> æ¥æè¿°çš„</p>
</blockquote>
<p><em><strong>C</strong>onsistency</em>ï¼šä¸€è‡´æ€§ã€‚åœ¨äº‹åŠ¡ä¸­ï¼Œä¸€è‡´æ€§æ˜¯æŒ‡ï¼š<strong>å¯¹æ•°æ®çš„ä¸€ç»„ç‰¹å®šé™ˆè¿°å¿…é¡»å§‹ç»ˆæˆç«‹</strong>ï¼Œå³ä¸º<em>ä¸å˜é‡</em>ï¼Œå¦‚åœ¨ä¼šè®¡ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰è´¦æˆ·æ•´ä½“ä¸Šå¿…é¡»å€Ÿè´·ç›¸æŠµï¼Œè½¬è´¦è¿‡ç¨‹ä¸­ï¼ŒåŠ é’±å’Œå‡é’±æ˜¯ç›¸ç­‰çš„ã€‚åŸå­æ€§ï¼Œéš”ç¦»æ€§å’ŒæŒä¹…æ€§æ˜¯æ•°æ®åº“çš„å±æ€§ï¼Œè€Œä¸€è‡´æ€§(åœ¨ACIDæ„ä¹‰ä¸Š)æ˜¯åº”ç”¨ç¨‹åºçš„å±æ€§</p>
<blockquote>
<p>è¿™æ˜¯ä¸€ä¸ªä¸€è¯å¤šæ„çš„è¯ï¼Œç”¨è¡Œè¯æ¥è¯´ï¼Œè¿™ä¸ªè¯è¢«é‡è½½äº†</p>
<ul class="lvl-1">
<li class="lvl-2">
<p>æœ‰åˆ«äºå‰¯æœ¬ä¸€è‡´æ€§ï¼Œæ¯”å¦‚åœ¨å•ä¸»å¤åˆ¶çš„æ¨¡å¼ä¸‹ï¼Œé‡‡ç”¨å¼‚æ­¥å¤åˆ¶çš„æ–¹å¼ï¼Œæ”¶æ•›æœ€ç»ˆä¸€è‡´</p>
</li>
<li class="lvl-2">
<p>è¿˜æœ‰å¤§å®¶æœ‰å¯èƒ½ä¼šå¬è¿‡ä¸€è‡´æ€§hash(ä¸€è‡´æ€§æ•£åˆ—)é‚£æ˜¯ä¸€ç§ä¸ºäº†é¿å…é‡æ–°åˆ†åŒºå¸¦æ¥çš„å¤æ‚åº¦æé«˜çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ</p>
</li>
<li class="lvl-2">
<p>CAPå®šç†ä¸­ï¼ŒCæŒ‡çš„æ˜¯çº¿æ€§ä¸€è‡´æ€§</p>
</li>
</ul>
</blockquote>
<p><em><strong>I</strong>solation</em>ï¼šéš”ç¦»æ€§ã€‚<strong>ç«äº‰æ¡ä»¶ä¸‹ï¼ŒåŒæ—¶æ‰§è¡Œçš„äº‹åŠ¡æ˜¯ç›¸äº’éš”ç¦»çš„</strong>ï¼Œä¸‹å›¾æ˜¯ä¸¤ä¸ªå®¢æˆ·ä¹‹é—´çš„ç«äº‰çŠ¶æ€åŒæ—¶é€’å¢è®¡æ•°å™¨çš„å›¾è¿°ã€‚<strong>ç¼ºä¹éš”ç¦»æ€§ï¼Œå°±ä¼šå¯¼è‡´å¹¶å‘é—®é¢˜</strong></p>
<p align="center">
  <img src="/2023/09/21/ddia/02.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> ä¸¤ä¸ªå®¢æˆ·ä¹‹é—´çš„ç«äº‰çŠ¶æ€åŒæ—¶é€’å¢è®¡æ•°å™¨ </span>
</p>
<p><em><strong>D</strong>urability</em> ï¼šæŒä¹…æ€§ã€‚æŒä¹…æ€§æ˜¯äº‹åŠ¡çš„ä¸€ä¸ªæ‰¿è¯ºï¼Œä¹Ÿå³äº‹åŠ¡å®Œæˆåï¼Œå³ä¾¿å‘ç”Ÿç¡¬ä»¶æ•…éšœæˆ–è€…æ•°æ®åº“å´©æºƒï¼Œå†™å…¥çš„ä»»åŠ¡æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚æŒä¹…æ€§è¿‡å»ä¸€èˆ¬è¢«è®¤ä¸ºå†™å…¥äº†éæ˜“å¤±æ€§å­˜å‚¨ä»‹è´¨</p>
<h2 id="å•å¯¹è±¡æ“ä½œå’Œå¤šå¯¹è±¡æ“ä½œ">å•å¯¹è±¡æ“ä½œå’Œå¤šå¯¹è±¡æ“ä½œ</h2>
<p><strong>å•ä¸€å¯¹è±¡æ“ä½œ</strong>ï¼Œæ‰€è°“å•å¯¹è±¡æ“ä½œä¸­çš„å¯¹è±¡ï¼ŒæŒ‡çš„æ˜¯æ•°æ®åº“ä¸­è¢«ä¿®æ”¹çš„å¯¹è±¡ï¼Œæ¯”å¦‚ä½ æ­£åœ¨å‘æ•°æ®åº“å†™å…¥ä¸€ä¸ª20KBçš„Jsonæ–‡æ¡£ï¼Œä»¥ä¸‹åœºæ™¯å¯èƒ½ä¼šå‘ç”Ÿï¼š</p>
<p>1ï¸âƒ£ åœ¨å‘é€ç¬¬ä¸€ä¸ª10KBä¹‹åï¼Œç½‘ç»œè¿æ¥ä¸­æ–­ï¼Œæ•°æ®åº“æ˜¯å¦å­˜å‚¨äº†ä¸å¯è§£æçš„10KBJSONç‰‡æ®µï¼Ÿ</p>
<p>2ï¸âƒ£ åœ¨æ•°æ®åº“æ­£åœ¨è¦†ç›–çš„ç£ç›˜ä¸Šå‰ä¸€ä¸ªå€¼çš„è¿‡ç¨‹ä¸­ç”µæºå‘ç”Ÿæ•…éšœï¼Œæ˜¯å¦æœ€ç»ˆå°†æ–°æ—§å€¼æ‹¼æ¥åœ¨ä¸€èµ·ï¼Ÿ</p>
<p>3ï¸âƒ£ å¦‚æœå¦ä¸€ä¸ªå®¢æˆ·ç«¯åœ¨å†™å…¥è¿‡ç¨‹ä¸­è¯»å–è¯¥æ–‡æ¡£ï¼Œæ˜¯å¦ä¼šçœ‹åˆ°éƒ¨åˆ†æ›´æ–°ï¼Ÿ</p>
<p>è¿™é‡Œçš„ JSONå¯¹è±¡ï¼Œå°±æ˜¯å•ä¸€å¯¹è±¡ï¼Œå•ä¸€å¯¹è±¡æ˜¯ç›¸å¯¹äºå¤šå¯¹è±¡è€Œè¨€çš„ï¼Œå¾…ä¼šæˆ‘ä»¬ä¼šè°ˆåŠåˆ°å¤šå¯¹è±¡ã€‚ä¸ºäº†é’ˆå¯¹ä»¥ä¸Šçš„é—®é¢˜ï¼Œå­˜å‚¨å¼•æ“ä¼šåœ¨å•ä¸ªå¯¹è±¡ä¸Šæä¾›åŸå­æ€§å’Œéš”ç¦»æ€§ï¼Œå¦‚æ­¤ä¸€æ¥ï¼š</p>
<p>ğŸ…°ï¸ åŸå­æ€§é€šè¿‡WAL(å³redo-log)æ—¥å¿—æ¥å®ç°å´©æºƒæ¢å¤</p>
<p>ğŸ…±ï¸ ä½¿ç”¨æ¯ä¸ªå¯¹è±¡çš„é”æ¥å®ç°éš”ç¦»(æ¯æ¬¡ä»…ä»…å…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¯¹è±¡)</p>
<p>é™¤äº†å•å¯¹è±¡æ“ä½œï¼Œè¿˜æœ‰å°±æ˜¯CAS(Compare-and-set)ï¼Œé˜²æ­¢å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶å†™å…¥åŒä¸€ä¸ªå¯¹è±¡æ—¶çš„æ›´æ–°ä¸¢å¤±ï¼Œå³å½“å€¼æ²¡æœ‰å¹¶å‘è¢«å…¶ä»–äººä¿®æ”¹çš„æ—¶å€™ï¼Œæ‰å…è®¸æ‰§è¡Œå†™å…¥æ“ä½œã€‚CASæ“ä½œå’Œå•å¯¹è±¡æ“ä½œï¼Œè¢«ç§°ä½œæ˜¯è½»é‡çº§äº‹åŠ¡ã€‚<strong>äº‹åŠ¡é€šå¸¸æ›´å¤šçš„å¼ºè°ƒ ï¼š å°†å¤šä¸ªå¯¹è±¡çš„å¤šä¸ªæ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªæ‰§è¡Œçš„å•å…ƒçš„æœºåˆ¶</strong></p>
<p><strong>ä½•ä¸ºå¤šå¯¹è±¡ï¼Ÿ</strong> åœ¨æ“ä½œæ•°æ®åº“æ—¶ï¼Œéœ€è¦åè°ƒå†™å…¥å‡ ä¸ªä¸åŒçš„å¯¹è±¡ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å…³ç³»æ¨¡å‹ä¸­ï¼Œä¸€ä¸ªè¡¨ä¸­çš„è¡Œå¯¹å¦å¤–ä¸€ä¸ªè¡¨çš„å¤–é”®å¼•ç”¨ã€‚ä½ å¾—ç¡®ä¿å¤–é”®æ˜¯æœ€æ–°çš„ï¼Œå¯ç”¨çš„</p>
</li>
<li class="lvl-2">
<p>åœ¨å­—æ®µå†—ä½™çš„åœºæ™¯ä¸­ï¼Œå•ä¸ªå­—æ®µåœ¨å¤šå¤„è¢«å­˜å‚¨ï¼Œä½ å¾—ä¿è¯è¿™å‡ å¤„æ˜¯åŒæ­¥çš„</p>
</li>
<li class="lvl-2">
<p>äºŒçº§ç´¢å¼•çš„æ•°æ®åº“ä¸­ï¼Œæ•°æ®æ›´æ–°çš„æ—¶å€™ï¼ŒäºŒçº§ç´¢å¼•ä¹Ÿéœ€è¦æ›´æ–°</p>
</li>
</ul>
<p>åœ¨è¿™ç§æƒ…å½¢ä¸‹ï¼Œéœ€è¦ä½¿ç”¨äº‹åŠ¡æ¥è¿›è¡Œå¤„ç†</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šè®²è¿°éš”ç¦»çº§åˆ«ï¼Œåœ¨è®²è¿°éš”ç¦»çº§åˆ«ä¹‹å‰ï¼Œæ˜ç¡®ä¸¤ç‚¹ï¼š</p>
<p>ğŸ…°ï¸ éš”ç¦»çº§åˆ«æ˜¯å¯¹äº‹åŠ¡çš„4å¤§ç‰¹æ€§ä¹‹ä¸€éš”ç¦»æ€§ä¸Šè¿›è¡Œäº†ä¸€ä¸ªç­‰çº§åˆ’åˆ†ï¼Œæ•°æ®åº“æ ‡å‡†çš„äº‹åŠ¡éš”ç¦»çº§åˆ«åŒ…æ‹¬ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>è¯»æœªæäº¤(read uncommitted)</p>
</li>
<li class="lvl-2">
<p>è¯»å·²æäº¤(read committed)</p>
</li>
<li class="lvl-2">
<p>å¯é‡å¤è¯»/å¿«ç…§éš”ç¦»(repeatable read)</p>
</li>
<li class="lvl-2">
<p>ä¸²è¡ŒåŒ–(serializable)</p>
</li>
</ul>
<p>ğŸ…±ï¸ éš”ç¦»çº§åˆ«æœ€é«˜æ˜¯å¯åºåˆ—åŒ–ï¼Œè¡¨ç¤ºåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªäº‹åŠ¡ã€‚éš”ç¦»çº§åˆ«å’Œæ€§èƒ½ä¹‹é—´æ˜¯ä¸€ä¸ªè´Ÿç›¸å…³çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´éš”ç¦»çº§åˆ«è¶Šé«˜ï¼Œæ•°æ®ä¸€è‡´æ€§çš„ä¿è¯è¶Šå¥½ï¼Œä½†æ˜¯æ€§èƒ½è¶Šå·®ã€‚éš”ç¦»çº§åˆ«æ˜¯æ•°æ®ä¸€è‡´æ€§å’ŒæœåŠ¡æ€§èƒ½çš„ä¸€åœºåšå¼ˆã€‚ä¸ºäº†å®ç°æ›´ä¼˜çš„æ€§èƒ½ï¼Œæˆ‘ä»¬éœ€è¦è¾ƒå¼±çš„éš”ç¦»çº§åˆ«</p>
<p>ä¸‹é¢ä»‹ç»è¿™äº›å¼±éš”ç¦»çº§åˆ«</p>
<h2 id="è¯»å·²æäº¤">è¯»å·²æäº¤</h2>
<p>æœ€åŸºæœ¬çš„å¼±éš”ç¦»çº§åˆ«æ˜¯ï¼Œè¯»å·²æäº¤ï¼Œå®ƒæä¾›äº†ä¸¤ä¸ªä¿è¯ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>æ²¡æœ‰<strong>è„è¯»(dirty reads)</strong>ï¼Œä»æ•°æ®åº“è¯»æ—¶ï¼Œåªèƒ½çœ‹åˆ°å·²æäº¤çš„æ•°æ®</p>
</li>
<li class="lvl-2">
<p>æ²¡æœ‰<strong>è„å†™(dirty writes)</strong>ï¼Œå†™å…¥æ•°æ®åº“æ—¶ï¼Œåªä¼šè¦†ç›–å·²ç»å†™å…¥çš„æ•°æ®</p>
</li>
</ul>
<p>å¦å¤–è¯»æœªæäº¤ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å¯ä»¥é˜²æ­¢è„å†™</p>
</li>
<li class="lvl-2">
<p>ä½†æ˜¯ä¸èƒ½å¤Ÿé˜²æ­¢è„è¯»</p>
</li>
</ul>
<p>ä¸‹å›¾æ˜¯ä¸€ä¸ªæ²¡æœ‰è„è¯»çš„ä¾‹å­ï¼šå¯ä»¥çœ‹åˆ°<em>ç›´åˆ°ç”¨æˆ·1æäº¤äº†ä¹‹å</em>ï¼Œç”¨æˆ·2æ‰çœ‹åˆ°æäº¤ä¹‹åçš„å€¼x=3,è€Œåœ¨è¿™ä¹‹å‰ç”¨æˆ·1åªèƒ½çœ‹åˆ°x=2</p>
<p align="center">
  <img src="/2023/09/21/ddia/03.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> ç”¨æˆ·2åªæœ‰åœ¨ç”¨æˆ·1çš„äº‹åŠ¡å·²ç»æäº¤åæ‰èƒ½çœ‹åˆ°xçš„æ–°å€¼ </span>
</p>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦é˜²æ­¢è„è¯»å‘¢ï¼Ÿä¸»è¦æ˜¯ä¸‹é¢ä¸¤ä¸ªåŸå› ï¼š</p>
<p>1ï¸âƒ£ å¦‚æœäº‹åŠ¡éœ€è¦æ›´æ–°å¤šä¸ªå¯¹è±¡ï¼Œè„è¯»å–æ„å‘³ç€å¦ä¸€ä¸ªäº‹åŠ¡å¯èƒ½ä¼šåªçœ‹åˆ°ä¸€éƒ¨åˆ†æ›´æ–°ã€‚æ¯”å¦‚è¯´ä¸‹é¢è¿™ä¸ªç”µå­é‚®ä»¶çš„ä¾‹å­ã€‚äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯ç”¨æˆ·2çœ‹åˆ°äº†æœªè¯»é‚®ä»¶ï¼Œå¯æ˜¯æœªè¯»é‚®ä»¶çš„æ•°é‡å´è¿˜æ˜¯æ—§å€¼</p>
<p align="center">
  <img src="/2023/09/21/ddia/04.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> ä¸€ä¸ªäº‹åŠ¡è¯»å–å¦ä¸€ä¸ªäº‹åŠ¡çš„æœªè¢«æ‰§è¡Œçš„å†™å…¥ï¼ˆâ€œè„è¯»â€ï¼‰ </span>
</p>
<p>2ï¸âƒ£ è‹¥æ•°æ®åº“å…è®¸è„è¯»ï¼Œæ„å‘³ç€ä¸€ä¸ªäº‹åŠ¡å¯èƒ½ä¼šçœ‹åˆ°ç¨åéœ€è¦å›æ»šçš„æ•°æ®ï¼Œå³ä»æœªå®é™…æäº¤ç»™æ•°æ®åº“çš„æ•°æ®ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­è¯»åˆ°äº†æœªæäº¤çš„æ•°æ®ï¼Œä½†æ˜¯åé¢äº‹åŠ¡å›æ»šäº†</p>
<p align="center">
  <img src="/2023/09/21/ddia/05.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> åŸå­æ€§ç¡®ä¿å‘ç”Ÿé”™è¯¯æ—¶ï¼Œäº‹åŠ¡å…ˆå‰çš„ä»»ä½•å†™å…¥éƒ½ä¼šè¢«æ’¤æ¶ˆï¼Œä»¥é¿å…çŠ¶æ€ä¸ä¸€è‡´ </span>
</p>
<p>ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶æ›´æ–°æ•°æ®åº“ä¸­çš„å¯¹è±¡ï¼Œå…ˆå‰çš„å†™å…¥æ²¡æœ‰æäº¤ï¼Œåé¢çš„å†™å…¥è¦†ç›–è¿™ä¸ªå°šæœªæäº¤çš„å€¼ï¼Œè¿™å°±æ˜¯è„å†™ã€‚æ²¡æœ‰è„å†™ï¼Œæ„å‘³ç€åœ¨å†™å…¥æ•°æ®åº“æ—¶ï¼Œåªä¼šè¦†ç›–å·²ç»å†™å…¥çš„æ•°æ®ã€‚åœ¨<strong>è¯»å·²æäº¤</strong>çš„éš”ç¦»çº§åˆ«ä¸Šè¿è¡Œçš„äº‹åŠ¡å¿…é¡»é˜²æ­¢è„å†™ï¼Œé€šå¸¸æ˜¯å»¶è¿Ÿç¬¬äºŒæ¬¡å†™å…¥ï¼Œç›´åˆ°ç¬¬ä¸€æ¬¡å†™å…¥äº‹åŠ¡æäº¤æˆ–ä¸­æ­¢ä¸ºæ­¢ã€‚ä¸‹å›¾æ˜¯è„å†™å‘ç”Ÿçš„ç¤ºä¾‹ï¼Œå‘ç¥¨å±äºAlice; é”€å”®å±äºBobâ€™</p>
<p align="center">
  <img src="/2023/09/21/ddia/06.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> å¦‚æœå­˜åœ¨è„å†™ï¼Œæ¥è‡ªä¸åŒäº‹åŠ¡çš„å†²çªå†™å…¥å¯èƒ½ä¼šæ··æ·†åœ¨ä¸€èµ· </span>
</p>
<h2 id="å®ç°è¯»å·²æäº¤">å®ç°è¯»å·²æäº¤</h2>
<p>è¯»å·²æäº¤æ˜¯ä¸€ç§éå¸¸Fashionçš„ä¸€ä¸ªéš”ç¦»çº§åˆ«ï¼Œæœ‰å¾ˆå¤šæ•°æ®åº“è½¯ä»¶å°†è¯»å·²æäº¤è®¾ç½®ä¸ºé»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼Œæ¯”å¦‚Oracle 11ã€PostgreSQLã€SQLServer 2012 ï¼Œé‚£ä¹ˆå¦‚ä½•å®ç°</p>
<p>1ï¸âƒ£ æ— è„å†™ä¿è¯ï¼šæ•°æ®åº“é€šè¿‡ä½¿ç”¨ <strong>è¡Œé”(row-level lock)<sup class="footnote-ref"><a href="#fn15" id="fnref15">[15]</a></sup></strong> æ¥é˜²æ­¢è„å†™ï¼›å³å½“äº‹åŠ¡æƒ³è¦ä¿®æ”¹ç‰¹å®šå¯¹è±¡æ—¶ï¼Œå¿…é¡»è·å–è¯¥å¯¹è±¡çš„é”ï¼Œç„¶åå¿…é¡»æŒæœ‰è¯¥é”ï¼Œç›´åˆ°äº‹åŠ¡è¢«æäº¤æˆ–ç»ˆæ­¢ã€‚è¿™ç§é”å®šæ˜¯è¯»å·²æäº¤æ¨¡å¼ï¼ˆæˆ–æ›´å¼ºçš„éš”ç¦»çº§åˆ«ï¼‰çš„æ•°æ®åº“è‡ªåŠ¨å®Œæˆçš„</p>
<blockquote></blockquote>
<p>2ï¸âƒ£ æ— è„è¯»ä¿è¯ï¼šMVCC<sup class="footnote-ref"><a href="#fn16" id="fnref16">[16]</a></sup> ï¼Œæ•°æ®åº“éƒ½ä¼šè®°ä½æ—§çš„å·²æäº¤å€¼ï¼Œå’Œå½“å‰æŒæœ‰å†™å…¥é”çš„äº‹åŠ¡è®¾ç½®çš„æ–°å€¼ã€‚ å½“äº‹åŠ¡æ­£åœ¨è¿›è¡Œæ—¶ï¼Œä»»ä½•å…¶ä»–è¯»å–å¯¹è±¡çš„äº‹åŠ¡éƒ½ä¼šæ‹¿åˆ°æ—§å€¼ã€‚ åªæœ‰å½“æ–°å€¼æäº¤åï¼Œäº‹åŠ¡æ‰ä¼šåˆ‡æ¢åˆ°è¯»å–æ–°å€¼</p>
<blockquote>
<p align="center">
  <img src="/2023/09/21/ddia/07.png" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> ä¸€ä¸ªå€¼ä»1æŒ‰é¡ºåºä¿®æ”¹ä¸º4çš„è¿‡ç¨‹ã€‚åœ¨è¯»å·²æäº¤çš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œä»…ä»…ä¿ç•™ä¸ºæäº¤ç‰ˆæœ¬å’Œæäº¤å‰ç‰ˆæœ¬2ä¸ªç‰ˆæœ¬ </span>
</p>
</blockquote>
<p>è¯»å·²æäº¤çš„éš”ç¦»çº§åˆ«æ— æ³•é¿å…<em>ä¸å¯é‡å¤è¯»</em>çš„æƒ…å†µï¼Œä¸‹é¢çš„ä¾‹å­ï¼šçˆ±ä¸½ä¸åœ¨é“¶è¡Œæœ‰1000ç¾å…ƒçš„å‚¨è“„ï¼Œä¸¤ä¸ªè´¦æˆ·ï¼Œæ¯ä¸ª500ç¾å…ƒï¼›ç°åœ¨ä¸€ä¸ªäº‹åŠ¡ä»å¥¹çš„ä¸€ä¸ªè´¦æˆ·ä¸­ï¼Œè½¬ç§»äº†100ç¾å…ƒåˆ°å¦ä¸€ä¸ªè´¦æˆ·</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>Aliceåœ¨è½¬è´¦äº‹åŠ¡ä¹‹å‰æŸ¥è¯¢äº†è´¦æˆ·1çš„é‡‘é¢ä¸º500å…ƒ</p>
</li>
<li class="lvl-2">
<p>Aliceåœ¨è½¬è´¦ä¹‹åå®Œæˆä¹‹åï¼ŒæŸ¥è¯¢äº†è´¦æˆ·2çš„é‡‘é¢ä¸º400å…ƒ</p>
</li>
<li class="lvl-2">
<p>æ­¤æ—¶è´¦æˆ·çš„æ€»é¢ä¸º900å…ƒï¼ŒAliceå°±å¾ˆç–‘æƒ‘ä¸ºä»€ä¹ˆè‡ªå·±çš„é’±å°‘äº†ï¼Ÿ</p>
</li>
</ul>
<p align="center">
  <img src="/2023/09/21/ddia/07.jpg" width="75%" alt="Your image description">
    <br>
  <span style="color:gray">è¯»å–åå·®ï¼šAliceè§‚å¯Ÿæ•°æ®åº“å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ </span>
</p> 
<p>è¿™ç§ï¼Œè¿™ç§å¼‚å¸¸è¢«ç§°ä¸º<strong>ä¸å¯é‡å¤è¯»(nonrepeatable read)</strong>ï¼Œå¦‚æœAliceåœ¨äº‹åŠ¡ç»“æŸæ—¶å†æ¬¡è¯»å–è´¦æˆ·1çš„ä½™é¢ï¼Œå¥¹å°†çœ‹åˆ°ä¸å¥¹ä¹‹å‰çš„æŸ¥è¯¢ä¸­çœ‹åˆ°çš„ä¸åŒçš„å€¼(600ç¾å…ƒ)ã€‚åœ¨è¯»å·²æäº¤çš„éš”ç¦»æ¡ä»¶ä¸‹ï¼Œ<strong>ä¸å¯é‡å¤è¯»</strong>å¯èƒ½ä¼šå‘ç”Ÿ</p>
<h2 id="å®ç°å¿«ç…§éš”ç¦»">å®ç°å¿«ç…§éš”ç¦»</h2>
<p>å¿«ç…§éš”ç¦»çš„å¦å¤–ä¸€ä¸ªå«æ³•æ˜¯å¯é‡å¤è¯»ï¼Œå¿«ç…§éš”ç¦»å’Œè¯»å·²æäº¤ä¸€è‡´ï¼Œä½¿ç”¨å†™é”æ¥é˜²æ­¢è„å†™ï¼Œä¹Ÿå°±æ˜¯æ­£åœ¨è¿›è¡Œå†™å…¥çš„äº‹åŠ¡ä¼šé˜»æ­¢å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹åŒä¸€ä¸ªå¯¹è±¡ã€‚è¯»å–æ²¡æœ‰ä»»ä½•çš„é”å®šï¼Œ<strong>å†™ä¸é˜»å¡è¯»ï¼Œè¯»ä¸é˜»å¡å†™</strong>ï¼ŒRCä¸‹ä¹Ÿæ˜¯ï¼Œæ•°æ®åº“ä½¿ç”¨<strong>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC, multi-version concurrentcy control)</strong> æ•°æ®åº“ä¿ç•™ä¸€ä¸ªå¯¹è±¡çš„å‡ ä¸ªä¸åŒçš„æäº¤ç‰ˆæœ¬ã€‚å¦å¤–ä½¿ç”¨MVCCå®ç°å¿«ç…§éš”ç¦»çš„å­˜å‚¨å¼•æ“é€šå¸¸ä¹Ÿä¼šä½¿ç”¨MVCCæ¥å®ç°è¯»å·²æäº¤(ä¸€ä¸ªå¯¹è±¡çš„ä¸¤ä¸ªç‰ˆæœ¬ï¼šæäº¤çš„ç‰ˆæœ¬å’Œè¢«è¦†ç›–ä½†å°šæœªæäº¤çš„ç‰ˆæœ¬)</p>
<p align="center">
  <img src="/2023/09/21/ddia/08.jpg" width="75%" alt="Your image description">
    <br>
  <span style="color:gray">  ä½¿ç”¨å¤šç‰ˆæœ¬å¯¹è±¡å®ç°å¿«ç…§éš”ç¦» </span>
</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹<em>ä¸€è‡´æ€§å¿«ç…§çš„å¯è§æ€§è§„åˆ™</em>ï¼šä¹Ÿå°±æ˜¯è¯´å½“ä¸€ä¸ªäº‹åŠ¡ä»æ•°æ®åº“ä¸­è¯»å–æ—¶ï¼Œäº‹åŠ¡IDç”¨äºå†³å®šå®ƒå¯ä»¥çœ‹è§å“ªäº›å¯¹è±¡ï¼Œçœ‹ä¸è§å“ªäº›å¯¹è±¡ã€‚è§„åˆ™å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ åœ¨æ¯æ¬¡äº‹åŠ¡å¼€å§‹æ—¶ï¼Œæ•°æ®åº“åˆ—å‡ºå½“æ—¶æ‰€æœ‰å…¶ä»–(å°šæœªæäº¤æˆ–ä¸­æ­¢)çš„äº‹åŠ¡æ¸…å•ï¼Œå³ä½¿ä¹‹åæäº¤äº†ï¼Œè¿™äº›äº‹åŠ¡çš„å†™å…¥ä¹Ÿéƒ½ä¼šè¢«å¿½ç•¥</p>
<p>2ï¸âƒ£ è¢«ä¸­æ­¢äº‹åŠ¡æ‰€æ‰§è¡Œçš„ä»»ä½•å†™å…¥éƒ½å°†è¢«å¿½ç•¥</p>
<p>3ï¸âƒ£ ç”±å…·æœ‰è¾ƒæ™šäº‹åŠ¡ID(å³ï¼Œåœ¨å½“å‰äº‹åŠ¡å¼€å§‹ä¹‹åå¼€å§‹çš„)çš„äº‹åŠ¡æ‰€åšçš„ä»»ä½•å†™å…¥éƒ½è¢«å¿½ç•¥ï¼Œè€Œä¸ç®¡è¿™äº›äº‹åŠ¡æ˜¯å¦å·²ç»æäº¤</p>
<p>4ï¸âƒ£ æ‰€æœ‰å…¶ä»–å†™å…¥ï¼Œå¯¹åº”ç”¨éƒ½æ˜¯å¯è§çš„</p>
<p>æ›´ç®€å•çš„è®²ï¼Œå¯¹äºéš”ç¦»çº§åˆ«çš„å®ç°æ•°æ®åº“é‡Œé¢ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œè®¿é—®çš„æ—¶å€™ä»¥è§†å›¾çš„é€»è¾‘ç»“æœä¸ºå‡†</p>
<p>1ï¸âƒ£ â€œè¯»æœªæäº¤â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥è¿”å›è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œæ²¡æœ‰è§†å›¾æ¦‚å¿µ</p>
<p>2ï¸âƒ£ åœ¨â€œè¯»æäº¤â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨æ¯ä¸ª SQL è¯­å¥å¼€å§‹æ‰§è¡Œçš„æ—¶å€™åˆ›å»ºçš„</p>
<p>3ï¸âƒ£ åœ¨â€œå¯é‡å¤è¯»â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œæ•´ä¸ªäº‹åŠ¡å­˜åœ¨æœŸé—´éƒ½ç”¨è¿™ä¸ªè§†å›¾</p>
<p>4ï¸âƒ£ â€œä¸²è¡ŒåŒ–â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥ç”¨åŠ é”çš„æ–¹å¼æ¥é¿å…å¹¶è¡Œè®¿é—®</p>
<h2 id="ä¸¢å¤±æ›´æ–°">ä¸¢å¤±æ›´æ–°</h2>
<p>å‰é¢æè¿°çš„æ˜¯è¯»-å†™å¹¶å‘åœºæ™¯ä¸‹ï¼Œåªè¯»äº‹åŠ¡åœ¨å¹¶å‘å†™å…¥æ—¶å€™èƒ½çœ‹åˆ°ä»€ä¹ˆï¼Œå¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯ä¸¤ä¸ªäº‹åŠ¡å¹¶å‘å†™å…¥çš„é—®é¢˜ï¼Œå³å†™-å†™å†²çªã€‚å¦‚ä¸‹å›¾å°±æ˜¯<strong>ä¸¢å¤±æ›´æ–°</strong>çš„ä¾‹å­</p>
<p align="center">
  <img src="/2023/09/21/ddia/02.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> ä¸¢å¤±æ›´æ–°ï¼šä¸¤ä¸ªå®¢æˆ·ä¹‹é—´çš„ç«äº‰çŠ¶æ€åŒæ—¶é€’å¢è®¡æ•°å™¨ </span>
</p>
<p>è§£å†³å†™-å†™å†²çªæœ‰å¾ˆå¤šæ–¹å¼ï¼Œæ¯”å¦‚åŸå­å†™ï¼ˆæ•°æ®åº“æä¾›ï¼‰ï¼Œæ˜¾ç¤ºé”å®šï¼Œæ¯”è¾ƒå¹¶è®¾ç½®(CAS)</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- æ•°æ®åº“æä¾›åŸå­æ›´æ–°æ“ä½œï¼Œæ¶ˆé™¤åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­æ‰§è¡Œè¯»å–-ä¿®æ”¹-å†™å…¥åºåˆ—çš„éœ€è¦</span></span><br><span class="line"><span class="keyword">update</span> counters <span class="keyword">set</span> <span class="keyword">value</span> <span class="operator">=</span> <span class="keyword">value</span> <span class="operator">+</span> <span class="number">1</span> <span class="keyword">where</span> key <span class="operator">=</span> <span class="string">'foo'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ˜¾ç¤ºé”å®š</span></span><br><span class="line"><span class="keyword">begin</span> transaction;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> figures</span><br><span class="line">    <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">'robot'</span> <span class="keyword">and</span> game_id <span class="operator">=</span> <span class="number">222</span></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">update</span>; <span class="comment">-- `for update` å­å¥å‘Šè¯‰æ•°æ®åº“åº”è¯¥å¯¹è¯¥æŸ¥è¯¢è¿”å›çš„æ‰€æœ‰è¡ŒåŠ é”</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ£€æŸ¥ç©å®¶çš„æ“ä½œæ˜¯å¦æœ‰æ•ˆï¼Œç„¶åæ›´æ–°å…ˆå‰selectè¿”å›æ£‹å­çš„ä½ç½®</span></span><br><span class="line"><span class="keyword">update</span> figures <span class="keyword">set</span> position <span class="operator">=</span> <span class="string">'c4'</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1234</span>;</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è®¾ç½®(CAS)</span></span><br><span class="line"><span class="keyword">update</span> wiki_pages <span class="keyword">set</span> content <span class="operator">=</span> <span class="string">'æ–°å†…å®¹'</span></span><br><span class="line">  <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1234</span> <span class="keyword">and</span> content <span class="operator">=</span> <span class="string">'æ—§å†…å®¹'</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨MySQLä¸­ï¼Œä½¿ç”¨å½“å‰è¯»<sup class="footnote-ref"><a href="#fn17" id="fnref17">[17]</a></sup>çš„æ–¹å¼æ¥å¤„ç†å†™-å†™å†²çªï¼Œä¸‹å›¾ä¸ºRRéš”ç¦»çº§åˆ«ä¸‹ï¼Œå†™-å†™å†²çªçš„ä¾‹å­</p>
<blockquote></blockquote>
<p align="center">
  <img src="/2023/09/21/ddia/10.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray">  </span>
</p>
<h2 id="å†™åå·®">å†™åå·®</h2>
<p>å¦‚æœä¸¤ä¸ªäº‹åŠ¡è¯»å–ç›¸åŒçš„å¯¹è±¡ï¼Œç„¶åä¸åŒçš„äº‹åŠ¡å¯èƒ½æ›´æ–°ä¸åŒçš„å¯¹è±¡ï¼Œåˆ™å¯èƒ½å‘ç”Ÿå†™åå·®(å†™åå·®åŒ…å«ä¸¢å¤±æ›´æ–°)</p>
<p>ä¸‹é¢æ˜¯å†™åå·®çš„ä¾‹å­ï¼Œæè¿°çš„æ˜¯ä¸€ä¸ªåŒ»ç”Ÿè½®ç­ç®¡ç†ç¨‹åºï¼ŒåŒ»é™¢æœ‰ä»¥ä¸‹çš„è¦æ±‚ï¼šè‡³å°‘æœ‰ä¸€ä½åŒ»ç”Ÿåœ¨å¾…å‘½ï¼Œç°åœ¨Alice å’Œ Bob ä¸¤ä½å€¼ç­åŒ»ç”Ÿéƒ½æ„Ÿè§‰åˆ°ä¸é€‚ï¼Œå†³å®šè¯·å‡ï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/09.jpg" width="75%" alt="Your image description">
    <br>
  <span style="color:gray"> å†™å…¥åå·®å¯¼è‡´åº”ç”¨ç¨‹åºé”™è¯¯çš„ç¤ºä¾‹ </span>
</p>
<p>åœ¨å¤šä¸ªäº‹åŠ¡æ›´æ–°åŒä¸€ä¸ªå¯¹è±¡çš„ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå°±ä¼šå‘ç”Ÿè„å†™æˆ–ä¸¢å¤±æ›´æ–°(å–å†³äºæ—¶æœº) <strong>é˜²æ­¢å†™åå·®ï¼Œéœ€è¦ä½¿ç”¨åºåˆ—åŒ–éš”ç¦»çº§åˆ«</strong></p>
<h2 id="å¹»è¯»">å¹»è¯»</h2>
<p><strong>ä¸€ä¸ªäº‹åŠ¡ä¸­çš„å†™å…¥æ”¹å˜å¦ä¸€ä¸ªäº‹åŠ¡çš„æœç´¢æŸ¥è¯¢çš„ç»“æœï¼Œç§°ä¸ºå¹»è¯»</strong></p>
<p>ä¸‹å›¾æ˜¯ä¸€ä¸ªå¹»è¯»çš„ä¾‹å­ï¼š</p>
<blockquote>
<p>å¹»è¯»ä¼šå¯¼è‡´å†™åå·®ã€‚å¿«ç…§éš”ç¦»é¿å…äº†åªè¯»äº‹åŠ¡ä¸­çš„å¹»è¯»ï¼Œä½†æ˜¯æ— æ³•é¿å…è¯»å†™äº‹åŠ¡ä¸­çš„å¹»è¯»ã€‚ä»ä¸Šé¢çš„ä¾‹å­æ¥çœ‹ï¼Œå¹»è¯»çš„é—®é¢˜è²Œä¼¼æ˜¯æ²¡æœ‰å¯¹è±¡å¯ä»¥åŠ é”ã€‚äººä¸ºçš„å¼•å…¥é”å¯¹è±¡çš„æ–¹å¼è¢«ç§°ä¹‹ä¸º<em>ç‰©åŒ–å†²çª</em></p>
</blockquote>
<p align="center">
  <img src="/2023/09/21/ddia/11.jpg" width="75%" alt="Your image description">
    <br>
  <span style="color:gray"> å¹²æ‰°äº‹åŠ¡ å¹²æ‰° ä¸»äº‹åŠ¡çš„æ‰§è¡Œ </span>
</p>
<p>ğŸ…°ï¸ ä¸»äº‹åŠ¡ï¼Œæ£€æµ‹è¡¨ä¸­æ˜¯å¦æœ‰<code>id=1</code>çš„è®°å½•ï¼Œæ²¡æœ‰åˆ™æ’å…¥ï¼ˆ<code>for update</code> æ²¡æœ‰ç”¨ï¼Œå› ä¸ºæ²¡æœ‰åŠ é”å¯¹è±¡ï¼‰ï¼Œè¿™æ˜¯æˆ‘ä»¬æœŸæœ›çš„æ­£å¸¸ä¸šåŠ¡é€»è¾‘</p>
<p>ğŸ…±ï¸ å¹²æ‰°äº‹åŠ¡ï¼Œç›®çš„åœ¨äºæ‰°ä¹±ï¼Œä¸»äº‹åŠ¡çš„æ­£å¸¸çš„äº‹åŠ¡æ‰§è¡Œ</p>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œå¹²æ‰°äº‹åŠ¡ç‡å…ˆæ‰§è¡Œäº†ï¼Œä¸»äº‹åŠ¡å‘ç”Ÿäº†å¹»è¯»ï¼Œå› ä¸ºä¸»äº‹åŠ¡è¯»å–çš„çŠ¶æ€å¹¶ä¸èƒ½æ”¯æŒå®ƒçš„ä¸‹ä¸€æ­¥é€»è¾‘ï¼Œæ„Ÿè§‰çœ‹åˆ°äº†å¹»å½±ã€‚ä¸Šä¾‹ä¸­æ˜¯å¹²æ‰°äº‹åŠ¡å¦¨ç¢äº†ä¸»äº‹åŠ¡æœç´¢ç»“æœã€‚åœ¨MySQLä¸­ï¼Œä½¿ç”¨é—´éš™é”ï¼ˆä¸‹æ–‡ä¼šæ¶‰åŠåˆ°ï¼‰æ¥å¤„ç†å¹»è¯»é—®é¢˜ã€‚<em>ä¸å¯é‡å¤è¯»ä¾§é‡è¡¨è¾¾è¯»-è¯»ï¼Œå¹»è¯»åˆ™æ˜¯è¯´è¯»-å†™ï¼Œç”¨å†™æ¥è¯å®è¯»çš„æ˜¯é¬¼å½±</em></p>
<h2 id="åºåˆ—åŒ–-ä¸²è¡ŒåŒ–">åºåˆ—åŒ–/ä¸²è¡ŒåŒ–</h2>
<p>å¯¹ä¸²è¡ŒåŒ–çš„ç†è§£åº”å½“æ˜¯è¿™æ ·çš„ï¼šä¸€æ¬¡åªæ‰§è¡Œä¸€ä¸ªäº‹åŠ¡ã€‚è®¾è®¡å•çº¿ç¨‹çš„ç³»ç»Ÿæœ‰æ—¶å€™æ¯”æ”¯æŒå¹¶å‘çš„ç³»ç»Ÿæ›´å¥½ï¼Œå› ä¸ºå®ƒå¯ä»¥é¿å…åè°ƒé”çš„å¼€é”€ã€‚æ•°æ®åº“çš„æ—©æœŸï¼Œæ•°æ®åº“æ„å›¾åŒ…å«æ•´ä¸ªç”¨æˆ·çš„æ´»åŠ¨æµç¨‹ï¼Œä½†æ˜¯å¦‚ä»Šçš„webåº”ç”¨ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸ä¼šè·¨è¶Šå¤šä¸ªè¯·æ±‚ï¼Œäº‹åŠ¡ä¼šåœ¨åŒä¸€ä¸ªHTTPè¯·æ±‚è¢«æäº¤</p>
<h3 id="ä¸¤é˜¶æ®µé”å®š-2PL">ä¸¤é˜¶æ®µé”å®š-2PL</h3>
<p>30å¹´ä»¥æ¥ï¼Œæ•°æ®åº“ä¸­åªæœ‰ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„åºåˆ—åŒ–ç®—æ³•ï¼š<strong>ä¸¤é˜¶æ®µé”å®š(2PLï¼Œtwo-phase locking)</strong>ã€‚ä¸¤é˜¶æ®µè¿™ä¸ªåå­—çš„æ¥æºï¼šç¬¬1é˜¶æ®µï¼ˆå½“äº‹åŠ¡æ­£åœ¨æ‰§è¡Œæ—¶ï¼‰è·å–é”ï¼Œç¬¬2é˜¶æ®µ(åœ¨äº‹åŠ¡ç»“æŸæ—¶)é‡Šæ”¾æ‰€æœ‰çš„é”</p>
<p>2PLè¦æ±‚åªè¦æ²¡æœ‰å†™å…¥ï¼Œå°±å…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è¯»å–åŒä¸€ä¸ªå¯¹è±¡ã€‚ä½†å¯¹è±¡åªè¦æœ‰å†™å…¥(ä¿®æ”¹æˆ–åˆ é™¤)ï¼Œå°±éœ€è¦<strong>ç‹¬å è®¿é—®(exclusive access)</strong> æƒé™ã€‚é”å¯ä»¥å¤„äº<em>å…±äº«æ¨¡å¼</em>ï¼Œå¯ä»¥å¤„äº<em>ç‹¬å æ¨¡å¼</em>ï¼š</p>
<p>1ï¸âƒ£ è‹¥äº‹åŠ¡è¦è¯»å–å¯¹è±¡ï¼Œåˆ™é¡»å…ˆä»¥å…±äº«æ¨¡å¼è·å–é”ã€‚å…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶æŒæœ‰å…±äº«é”ã€‚ä½†å¦‚æœå¦ä¸€ä¸ªäº‹åŠ¡å·²ç»åœ¨å¯¹è±¡ä¸ŠæŒæœ‰æ’å®ƒé”ï¼Œåˆ™è¿™äº›äº‹åŠ¡å¿…é¡»ç­‰å¾…</p>
<p>2ï¸âƒ£ è‹¥äº‹åŠ¡è¦å†™å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå¿…é¡»é¦–å…ˆä»¥ç‹¬å æ¨¡å¼è·å–è¯¥é”ã€‚æ²¡æœ‰å…¶ä»–äº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰é”(æ— è®ºæ˜¯å…±äº«æ¨¡å¼è¿˜æ˜¯ç‹¬å æ¨¡å¼)ï¼Œæ‰€ä»¥å¦‚æœå¯¹è±¡ä¸Šå­˜åœ¨ä»»ä½•é”ï¼Œè¯¥äº‹åŠ¡å¿…é¡»ç­‰å¾…</p>
<p>3ï¸âƒ£ å¦‚æœäº‹åŠ¡å…ˆè¯»å–å†å†™å…¥å¯¹è±¡ï¼Œåˆ™å®ƒå¯èƒ½ä¼šå°†å…¶å…±äº«é”å‡çº§ä¸ºç‹¬å é”ã€‚å‡çº§é”çš„å·¥ä½œä¸ç›´æ¥è·å¾—æ’ä»–é”ç›¸åŒ</p>
<p>4ï¸âƒ£ äº‹åŠ¡è·å¾—é”ä¹‹åï¼Œå¿…é¡»ç»§ç»­æŒæœ‰é”ç›´åˆ°äº‹åŠ¡ç»“æŸï¼ˆæäº¤æˆ–ä¸­æ­¢ï¼‰</p>
<p>ç”±äºåŠ äº†è¿™ä¹ˆå¤šçš„é”ï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ­»é”æƒ…å†µï¼Œæ­»é”åŠæ­»é”æ£€æµ‹çš„å†…å®¹å¯ä»¥çœ‹çœ‹MySQLçš„ç¬”è®°</p>
<p>åœ¨Javaä¸­æœ‰è¿™ä¹ˆä¸€ä¸ªå®šå¾‹ï¼šå¯¹è±¡ï¼ˆObjectï¼‰å°±æ˜¯é”ï¼Œå‰é¢å†…å®¹æ¶‰åŠåˆ°çš„é”éƒ½æ˜¯é’ˆå¯¹ç‰¹å®šå¯¹è±¡çš„(å¦‚è¡¨ä¸­çš„ä¸€è¡Œ)ï¼Œå¯¹äºæŸäº›æ›´æ”¹æ²¡æœ‰ç‰¹å®šå¯¹è±¡ï¼Œæœ‰æ²¡æœ‰ä¸€ç§é”é’ˆå¯¹è¿™ç§åœºæ™¯å‘¢ï¼Ÿ</p>
<h3 id="è°“è¯é”">è°“è¯é”</h3>
<p>è°“è¯é”ç±»ä¼¼äºå…±äº«/æ’å®ƒé”ï¼Œä½†ä¸å±äºç‰¹å®šçš„å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œè¡¨ä¸­çš„ä¸€è¡Œï¼‰ï¼Œå®ƒå±äºæ‰€æœ‰ç¬¦åˆæŸäº›æœç´¢æ¡ä»¶çš„å¯¹è±¡ï¼Œå¦‚ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> bookings</span><br><span class="line"><span class="keyword">where</span> room_id <span class="operator">=</span> <span class="number">123</span> <span class="keyword">and</span></span><br><span class="line">      end_time <span class="operator">&gt;</span> <span class="string">'2018-01-01 12:00'</span> <span class="keyword">and</span> </span><br><span class="line">      start_time <span class="operator">&lt;</span> <span class="string">'2018-01-01 13:00'</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>è°“è¯é”é™åˆ¶è®¿é—®ï¼š</p>
<p>ğŸ…°ï¸ å¦‚æœäº‹åŠ¡Aæƒ³è¦ï¼Œ<strong>è¯»å–</strong>åŒ¹é…æŸäº›æ¡ä»¶çš„å¯¹è±¡ï¼Œå°±åƒåœ¨è¿™ä¸ª <code>select</code> æŸ¥è¯¢ä¸­é‚£æ ·ï¼Œå®ƒå¿…é¡»è·å–æŸ¥è¯¢æ¡ä»¶ä¸Šçš„<strong>å…±äº«è°“è¯é”(shared-mode predicate lock)</strong>ã€‚å¦‚æœå¦ä¸€ä¸ªäº‹åŠ¡Bï¼ŒæŒæœ‰ä»»ä½•æ»¡è¶³è¿™ä¸€æŸ¥è¯¢æ¡ä»¶å¯¹è±¡çš„æ’å®ƒé”ï¼Œäº‹åŠ¡Aå¿…é¡»ç­‰åˆ°Bé‡Šæ”¾å®ƒçš„é”ä¹‹åæ‰å…è®¸è¿›è¡ŒæŸ¥è¯¢</p>
<p>ğŸ…±ï¸ å¦‚æœäº‹åŠ¡Aæƒ³è¦ï¼Œ<strong>æ’å…¥ï¼Œæ›´æ–°æˆ–åˆ é™¤</strong>ä»»ä½•å¯¹è±¡ï¼Œåˆ™å¿…é¡»é¦–å…ˆæ£€æŸ¥æ—§å€¼æˆ–æ–°å€¼ï¼Œæ˜¯å¦ä¸ä»»ä½•ç°æœ‰çš„è°“è¯é”åŒ¹é…ã€‚å¦‚æœäº‹åŠ¡BæŒæœ‰åŒ¹é…çš„è°“è¯é”ï¼Œé‚£ä¹ˆAå¿…é¡»ç­‰åˆ°Bå·²ç»æäº¤æˆ–ä¸­æ­¢åæ‰èƒ½ç»§ç»­</p>
<p>è°“è¯é”çš„å…³é”®æ€æƒ³æ˜¯ï¼Œ<strong>è°“è¯é”ç”šè‡³é€‚ç”¨äºæ•°æ®åº“ä¸­å°šä¸å­˜åœ¨ï¼Œä½†å°†æ¥å¯èƒ½ä¼šæ·»åŠ çš„å¯¹è±¡ï¼ˆå¹»è±¡ï¼‰</strong>ã€‚å’Œå¿«ç…§éš”ç¦»çš„åŒºåˆ«åœ¨æ˜¯ï¼šå¿«ç…§éš”ç¦»ä¸­è¯»ä¸é˜»å¡å†™ï¼Œå†™ä¸é˜»å¡è¯»ï¼›2PLä¸­ï¼Œå†™é˜»å¡è¯»ï¼Œè¯»é˜»å¡å†™</p>
<h3 id="ç´¢å¼•èŒƒå›´é”">ç´¢å¼•èŒƒå›´é”</h3>
<p>ç´¢å¼•èŒƒå›´é”ï¼Œä¹Ÿç§°ä¸º<strong>é—´éš™é”(next-key locking)</strong></p>
<p>è°“è¯é”çš„å¼Šç«¯æ˜¯æ€§èƒ½ä¸ä½³ï¼š<strong>å¦‚æœæ´»è·ƒäº‹åŠ¡æŒæœ‰å¾ˆå¤šé”ï¼Œæ£€æŸ¥åŒ¹é…çš„é”ä¼šéå¸¸è€—æ—¶</strong>ã€‚å› æ­¤ï¼Œå¤§å¤šæ•°ä½¿ç”¨2PLçš„æ•°æ®åº“å®é™…ä¸Šå®ç°äº†ç´¢å¼•èŒƒå›´é”ï¼Œé—´éš™é”æ˜¯ä¸€ç§ç®€åŒ–çš„è¿‘ä¼¼ç‰ˆè°“è¯é”</p>
<p>æ¯”å¦‚åœ¨æˆ¿é—´é¢„è®¢æ•°æ®åº“ä¸­ï¼Œæ‚¨å¯èƒ½ä¼šåœ¨<code>room_id</code>åˆ—ä¸Šæœ‰ä¸€ä¸ªç´¢å¼•ï¼Œå¹¶ä¸”/æˆ–è€…åœ¨<code>start_time</code> å’Œ <code>end_time</code>ä¸Šæœ‰ç´¢å¼•ï¼ˆå¦åˆ™å‰é¢çš„æŸ¥è¯¢åœ¨å¤§å‹æ•°æ®åº“ä¸Šçš„é€Ÿåº¦ä¼šéå¸¸æ…¢</p>
<p>ğŸ…°ï¸ å‡è®¾æ‚¨çš„ç´¢å¼•ä½äº<code>room_id</code>ä¸Šï¼Œå¹¶ä¸”æ•°æ®åº“ä½¿ç”¨æ­¤ç´¢å¼•æŸ¥æ‰¾<code>123</code>å·æˆ¿é—´çš„ç°æœ‰é¢„è®¢ã€‚ç°åœ¨æ•°æ®åº“å¯ä»¥ç®€å•åœ°å°†å…±äº«é”é™„åŠ åˆ°è¿™ä¸ªç´¢å¼•é¡¹ä¸Šï¼ŒæŒ‡ç¤ºäº‹åŠ¡å·²æœç´¢<code>123</code>å·æˆ¿é—´ç”¨äºé¢„è®¢</p>
<p>ğŸ…±ï¸ æˆ–è€…ï¼Œå¦‚æœæ•°æ®åº“ä½¿ç”¨åŸºäºæ—¶é—´çš„ç´¢å¼•æ¥æŸ¥æ‰¾ç°æœ‰é¢„è®¢ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥å°†å…±äº«é”é™„åŠ åˆ°è¯¥ç´¢å¼•ä¸­çš„ä¸€ç³»åˆ—å€¼ï¼ŒæŒ‡ç¤ºäº‹åŠ¡å·²ç»å°†<code>12:00~13:00</code> æ—¶é—´æ®µæ ‡è®°ä¸ºç”¨äºé¢„å®š</p>
<p>æ— è®ºå“ªç§æ–¹å¼ï¼Œæœç´¢æ¡ä»¶çš„è¿‘ä¼¼å€¼éƒ½é™„åŠ åˆ°å…¶ä¸­ä¸€ä¸ªç´¢å¼•ä¸Šã€‚ç°åœ¨ï¼Œå¦‚æœå¦ä¸€ä¸ªäº‹åŠ¡æƒ³è¦æ’å…¥ï¼Œæ›´æ–°æˆ–åˆ é™¤åŒä¸€ä¸ªæˆ¿é—´å’Œ/æˆ–é‡å æ—¶é—´æ®µçš„é¢„è®¢ï¼Œåˆ™å®ƒå°†ä¸å¾—ä¸æ›´æ–°ç´¢å¼•çš„ç›¸åŒéƒ¨åˆ†ã€‚åœ¨è¿™æ ·åšçš„è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šé‡åˆ°å…±äº«é”ï¼Œå®ƒå°†è¢«è¿«ç­‰åˆ°é”è¢«é‡Šæ”¾ã€‚è¿™ç§æ–¹æ³•èƒ½å¤Ÿæœ‰æ•ˆé˜²æ­¢å¹»è¯»å’Œå†™å…¥åå·®</p>
<h2 id="åºåˆ—åŒ–å¿«ç…§éš”ç¦»ï¼ˆSSIï¼‰">åºåˆ—åŒ–å¿«ç…§éš”ç¦»ï¼ˆSSIï¼‰</h2>
<p><strong>å¯åºåˆ—åŒ–å¿«ç…§éš”ç¦»(SSI, serializable snapshot isolation)</strong> å®ƒæä¾›äº†å®Œæ•´çš„å¯åºåˆ—åŒ–éš”ç¦»çº§åˆ«ï¼Œä½†ä¸å¿«ç…§éš”ç¦»ç›¸æ¯”åªæœ‰åªæœ‰å¾ˆå°çš„æ€§èƒ½æŸå¤±ï¼Œæ˜¯ä¸€ç§æ–°çš„éš”ç¦»æŠ€æœ¯</p>
<h2 id="æ€»ç»“-2">æ€»ç»“</h2>
<p>1ï¸âƒ£ è„è¯»: ä¸€ä¸ªå®¢æˆ·ç«¯è¯»å–åˆ°å¦ä¸€ä¸ªå®¢æˆ·ç«¯å°šæœªæäº¤çš„å†™å…¥ã€‚<strong>è¯»å·²æäº¤</strong>æˆ–æ›´å¼ºçš„éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»</p>
<p>2ï¸âƒ£ è„å†™: ä¸€ä¸ªå®¢æˆ·ç«¯è¦†ç›–å†™å…¥äº†å¦ä¸€ä¸ªå®¢æˆ·ç«¯å°šæœªæäº¤çš„å†™å…¥ã€‚å‡ ä¹æ‰€æœ‰çš„äº‹åŠ¡å®ç°éƒ½å¯ä»¥é˜²æ­¢è„å†™</p>
<p>3ï¸âƒ£ è¯»å–åå·®(ä¸å¯é‡å¤è¯»): åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå®¢æˆ·ç«¯åœ¨ä¸åŒçš„æ—¶é—´ç‚¹ä¼šçœ‹è§æ•°æ®åº“çš„ä¸åŒçŠ¶æ€ã€‚<strong>å¿«ç…§éš”ç¦»</strong>ç»å¸¸ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå…è®¸äº‹åŠ¡ï¼Œä»ä¸€ä¸ªç‰¹å®šæ—¶é—´ç‚¹çš„ä¸€è‡´æ€§å¿«ç…§ä¸­è¯»å–æ•°æ®ã€‚å¿«ç…§éš”ç¦»é€šå¸¸ä½¿ç”¨<strong>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC)</strong> æ¥å®ç°</p>
<p>4ï¸âƒ£ æ›´æ–°ä¸¢å¤±: ä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶æ‰§è¡Œ<strong>è¯»å–-ä¿®æ”¹-å†™å…¥åºåˆ—</strong>ã€‚å…¶ä¸­ä¸€ä¸ªå†™æ“ä½œï¼Œåœ¨æ²¡æœ‰åˆå¹¶å¦ä¸€ä¸ªå†™å…¥å˜æ›´æƒ…å†µä¸‹ï¼Œç›´æ¥è¦†ç›–äº†å¦ä¸€ä¸ªå†™æ“ä½œçš„ç»“æœã€‚æ‰€ä»¥å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚å¿«ç…§éš”ç¦»çš„ä¸€äº›å®ç°å¯ä»¥è‡ªåŠ¨é˜²æ­¢è¿™ç§å¼‚å¸¸ï¼Œè€Œå¦ä¸€äº›å®ç°åˆ™éœ€è¦æ‰‹åŠ¨é”å®š(<code>select for update</code>)</p>
<blockquote>
<p>å’Œè„å†™çš„åŒºåˆ«åœ¨äºï¼šè„å†™æ˜¯è¦†ç›–å°šæœªæäº¤çš„å†™å…¥ï¼Œæ›´æ–°ä¸¢å¤±æ˜¯è¦†ç›–äº†ä¸€ä¸ªå·²æäº¤çš„å†™å…¥</p>
</blockquote>
<p>5ï¸âƒ£ å†™åå·®: ä¸€ä¸ªäº‹åŠ¡è¯»å–ä¸€äº›ä¸œè¥¿ï¼Œæ ¹æ®å®ƒæ‰€çœ‹åˆ°çš„å€¼ä½œå‡ºå†³å®šï¼Œå¹¶å°†å†³å®šå†™å…¥æ•°æ®åº“ã€‚ä½†æ˜¯ï¼Œå†™çš„æ—¶å€™ï¼Œå†³å®šçš„å‰æä¸å†æ˜¯çœŸå®çš„ã€‚åªæœ‰å¯åºåˆ—åŒ–çš„éš”ç¦»æ‰èƒ½é˜²æ­¢è¿™ç§å¼‚å¸¸</p>
<p>6ï¸âƒ£ å¹»è¯» : äº‹åŠ¡è¯»å–ç¬¦åˆæŸäº›æœç´¢æ¡ä»¶çš„å¯¹è±¡ï¼Œå¦ä¸€ä¸ªå®¢æˆ·ç«¯è¿›è¡Œå†™å…¥ï¼Œå½±å“æœç´¢ç»“æœã€‚å¿«ç…§éš”ç¦»å¯ä»¥é˜²æ­¢ç›´æ¥çš„å¹»åƒè¯»å–ï¼Œä½†æ˜¯å†™å…¥æ­ªæ–œç¯å¢ƒä¸­çš„å¹»è¯»éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä¾‹å¦‚ç´¢å¼•èŒƒå›´é”å®šã€‚åªæœ‰å¯åºåˆ—åŒ–çš„éš”ç¦»æ‰èƒ½é˜²èŒƒæ‰€æœ‰è¿™äº›é—®é¢˜ã€‚æˆ‘ä»¬è®¨è®ºäº†å®ç°å¯åºåˆ—åŒ–äº‹åŠ¡çš„ä¸‰ç§ä¸åŒæ–¹æ³•ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å­—é¢æ„ä¹‰ä¸Šçš„ä¸²è¡Œæ‰§è¡Œ: å¦‚æœæ¯ä¸ªäº‹åŠ¡çš„æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œå¹¶ä¸”äº‹åŠ¡ååé‡è¶³å¤Ÿä½ï¼Œè¶³ä»¥åœ¨å•ä¸ªCPUæ ¸ä¸Šå¤„ç†ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•è€Œæœ‰æ•ˆçš„é€‰æ‹©</p>
</li>
<li class="lvl-2">
<p>ä¸¤é˜¶æ®µé”å®š: æ•°åå¹´æ¥ï¼Œä¸¤é˜¶æ®µé”å®šä¸€ç›´æ˜¯å®ç°å¯åºåˆ—åŒ–çš„æ ‡å‡†æ–¹å¼ï¼Œä½†æ˜¯è®¸å¤šåº”ç”¨å‡ºäºæ€§èƒ½é—®é¢˜çš„è€ƒè™‘é¿å…ä½¿ç”¨å®ƒ</p>
</li>
<li class="lvl-2">
<p><strong>å¯ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»(SSI)</strong></p>
</li>
</ul>
<h1>ç¬¬9ç« èŠ‚-ä¸€è‡´æ€§ä¸å…±è¯†</h1>
<p>æ„å»ºå®¹é”™ç³»ç»Ÿçš„æœ€å¥½æ–¹æ³•ï¼Œæ˜¯æ‰¾åˆ°ä¸€äº›å¸¦æœ‰å®ç”¨ä¿è¯çš„é€šç”¨æŠ½è±¡ï¼Œå®ç°ä¸€æ¬¡ï¼Œç„¶åè®©åº”ç”¨ä¾èµ–è¿™äº›ä¿è¯ã€‚æ¯”å¦‚é€šè¿‡ä½¿ç”¨<strong>äº‹åŠ¡</strong>è¿™ä¸ªæŠ½è±¡ï¼Œåº”ç”¨å¯ä»¥å‡è£…æ²¡æœ‰å´©æºƒ(åŸå­æ€§)ï¼Œæ²¡æœ‰å…¶ä»–äººåŒæ—¶è®¿é—®æ•°æ®åº“(éš”ç¦»æ€§)ï¼Œå­˜å‚¨è®¾å¤‡æ˜¯å®Œå…¨å¯é çš„(æŒä¹…æ€§)ã€‚å³ä½¿å‘ç”Ÿå´©æºƒï¼Œç«æ€æ¡ä»¶å’Œç£ç›˜æ•…éšœï¼Œäº‹åŠ¡æŠ½è±¡éšè—äº†è¿™äº›é—®é¢˜ï¼Œå› æ­¤åº”ç”¨ä¸å¿…æ‹…å¿ƒå®ƒä»¬</p>
<p>åŒæ ·çš„åˆ†å¸ƒå¼ç³»ç»Ÿæœ€é‡è¦çš„æŠ½è±¡ä¹‹ä¸€å°±æ˜¯<strong>å…±è¯†(consensus)</strong>ï¼š<strong>å…¶éæ­£å¼å®šä¹‰æ˜¯è®©æ‰€æœ‰çš„èŠ‚ç‚¹å¯¹æŸä»¶äº‹è¾¾æˆä¸€è‡´</strong></p>
<blockquote>
<p>åˆ†å¸ƒå¼ä¸€è‡´æ€§æ¨¡å‹å’Œäº‹åŠ¡çš„ç‰¹æ€§ACIDä¸­çš„ä¸€è‡´æ€§ ï¼Œéš”ç¦»çº§åˆ«çš„åŒºåˆ«â“</p>
<p>ACIDä¸€è‡´æ€§çš„æ¦‚å¿µæ˜¯ï¼Œ<strong>å¯¹æ•°æ®çš„ä¸€ç»„ç‰¹å®šé™ˆè¿°å¿…é¡»å§‹ç»ˆæˆç«‹</strong>ã€‚å³<strong>ä¸å˜é‡(invariants)</strong></p>
<p>åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¸»è¦æ˜¯å…³äºï¼šé¢å¯¹å»¶è¿Ÿå’Œæ•…éšœæ—¶ï¼Œå¦‚ä½•åè°ƒå‰¯æœ¬é—´çš„çŠ¶æ€</p>
<p>äº‹åŠ¡éš”ç¦»çš„ç›®çš„æ˜¯ä¸ºäº†ï¼Œé¿å…ç”±äºåŒæ—¶æ‰§è¡Œäº‹åŠ¡è€Œå¯¼è‡´çš„ç«äº‰çŠ¶æ€</p>
</blockquote>
<h2 id="çº¿æ€§ä¸€è‡´æ€§">çº¿æ€§ä¸€è‡´æ€§</h2>
<p>å¤šæ•°çš„æ•°æ®åº“æä¾›äº†æœ€ç»ˆä¸€è‡´æ€§çš„ä¿è¯(æ•°æ®æ˜¯æœ€ç»ˆæ”¶æ•›çš„)ã€‚æœ€ç»ˆä¸€è‡´æ€§çš„é—®é¢˜æ˜¯ï¼šå¦‚æœä½ åœ¨åŒä¸€ä¸ªæ—¶åˆ»é—®2ä¸ªå‰¯æœ¬åŒæ ·ä¸€ä¸ªé—®é¢˜ï¼Œå¯èƒ½å¾—åˆ°ä¸åŒçš„ç­”æ¡ˆï¼Œ<strong>çº¿æ€§ä¸€è‡´æ€§</strong>å°è¯•æä¾›åªæœ‰ä¸€ä¸ªå‰¯æœ¬çš„å‡è±¡ï¼Œå³æä¾›æ–°é²œåº¦ä¿è¯(ä¸€ä¸ªå®¢æˆ·ç«¯å®Œæˆå†™æ“ä½œï¼Œæ‰€æœ‰clientå¯ä»¥å¿…é¡»èƒ½çœ‹åˆ°æœ€æ–°çš„ç­”æ¡ˆ)</p>
<blockquote>
<p>çº¿æ€§ä¸€è‡´æ€§å’Œå¯åºåˆ—åŒ–çš„åŒºåˆ«â“</p>
<p>å¯åºåˆ—åŒ–æ˜¯äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œå®ƒç¡®ä¿äº‹åŠ¡çš„æ‰§è¡Œæ˜¯ç‰¹å®šçš„é¡ºåº</p>
<p>çº¿æ€§ä¸€è‡´æ€§æ˜¯è¯»å–å’Œå†™å…¥å¯„å­˜å™¨(å•ä¸ªå¯¹è±¡)çš„æ–°é²œåº¦ä¿è¯ï¼Œå®ƒä¸ä¼šå°†å¤šä¸ªæ“ä½œç»„åˆä¸ºäº‹åŠ¡</p>
<p>ä¸€ä¸ªæ•°æ®åº“å¯ä»¥æä¾›å¯ä¸²è¡Œæ€§å’Œçº¿æ€§ä¸€è‡´æ€§ï¼Œè¿™ç§ç»„åˆç§°ä¹‹ä¸ºï¼Œå•å‰¯æœ¬å¼ºå¯ä¸²è¡Œæ€§(strong-1SR)ï¼ŒåŸºäº2é˜¶æ®µé”çš„å¯ä¸²è¡ŒåŒ–å®ç°ï¼Œé€šå¸¸æ˜¯çº¿æ€§ä¸€è‡´çš„ï¼Œå¯é‡å¤è¯»ä¸æ˜¯çº¿æ€§ä¸€è‡´çš„</p>
</blockquote>
<h3 id="çº¿æ€§ä¸€è‡´æ€§çš„ä½œç”¨">çº¿æ€§ä¸€è‡´æ€§çš„ä½œç”¨</h3>
<p>ğŸ…°ï¸ å•ä¸»å¤åˆ¶çš„ç³»ç»Ÿä¸­ï¼Œé¢†å¯¼é€‰å–(åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹æŒæœ‰é”)</p>
<p>ğŸ…±ï¸ å”¯ä¸€æ€§çº¦æŸ(åªæœ‰ä¸€ä¸ªå¯¹è±¡æŒæœ‰è¯¥id)</p>
<h3 id="å®ç°çº¿æ€§ä¸€è‡´çš„ç³»ç»Ÿ">å®ç°çº¿æ€§ä¸€è‡´çš„ç³»ç»Ÿ</h3>
<p>1ï¸âƒ£ å•ä¸»å¤åˆ¶ï¼šå¯èƒ½çº¿æ€§ä¸€è‡´</p>
<p>2ï¸âƒ£ å…±è¯†ç®—æ³•ï¼šçº¿æ€§ä¸€è‡´</p>
<p>3ï¸âƒ£ å¤šä¸»å¤åˆ¶ï¼šéçº¿æ€§ä¸€è‡´</p>
<h2 id="CAP">CAP</h2>
<p>æœ‰ä¸€ç§è¯´æ³•æ˜¯ï¼š ä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹é”™æ€§ï¼Œä¸‰è€…åªèƒ½é€‰æ‹©å…¶äºŒï¼Œè¿™ç§è¯´æ³•æœ‰ä¸€å®šçš„è¯¯å¯¼æ€§ã€‚è¿™é‡Œçš„<em>P</em>æŒ‡çš„æ˜¯ç½‘ç»œåˆ†åŒº<sup class="footnote-ref"><a href="#fn18" id="fnref18">[18]</a></sup>ï¼Œç½‘ç»œåˆ†åŒºæ˜¯ä¸€ç§æ•…éšœï¼Œæ˜¯ä¸€å®šä¼š(æ¦‚ç‡äº‹ä»¶)å­˜åœ¨çš„ï¼ŒPä¸æ˜¯ä¸€ä¸ªå¯é€‰é¡¹è€Œæ˜¯ä¸€ä¸ªå¿…é€‰é¡¹ï¼Œé‚£ä¹ˆå°±æœ‰äº†</p>
<p>ğŸ…°ï¸ CP : åœ¨ç½‘ç»œåˆ†åŒºä¸‹ä¸€è‡´ä½†ä¸å¯ç”¨ ã€‚è‹¥åº”ç”¨éœ€è¦çº¿æ€§ä¸€è‡´æ€§ï¼ŒæŸäº›å‰¯æœ¬å’Œå…¶ä»–å‰¯æœ¬æ–­å¼€è¿æ¥ï¼Œé‚£ä¹ˆè¿™äº›å‰¯æœ¬æ‰çº¿æ—¶ä¸èƒ½å¤„ç†è¯·æ±‚(å•ä¸»å¤åˆ¶+åŒæ­¥)ï¼Œè¯·æ±‚å¿…é¡»ç­‰åˆ°ç½‘ç»œé—®é¢˜è§£å†³ï¼Œæˆ–ç›´æ¥è¿”å›é”™è¯¯ã€‚æ— è®ºå“ªç§æ–¹å¼ï¼ŒæœåŠ¡éƒ½<strong>ä¸å¯ç”¨(unavailable)</strong></p>
<p>ğŸ…±ï¸ AP : åœ¨ç½‘ç»œåˆ†åŒºä¸‹å¯ç”¨ä½†ä¸ä¸€è‡´ ã€‚åº”ç”¨ä¸éœ€è¦çº¿æ€§ä¸€è‡´æ€§ï¼Œé‚£ä¹ˆæŸä¸ªå‰¯æœ¬å³ä½¿ä¸å…¶ä»–å‰¯æœ¬æ–­å¼€è¿æ¥ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹å¤„ç†è¯·æ±‚ï¼ˆä¾‹å¦‚å¤šä¸»å¤åˆ¶ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº”ç”¨å¯ä»¥åœ¨ç½‘ç»œé—®é¢˜å‰ä¿æŒå¯ç”¨ï¼Œä½†å…¶è¡Œä¸ºä¸æ˜¯çº¿æ€§ä¸€è‡´çš„</p>
<blockquote></blockquote>
<h2 id="å…¨åº-vs-ååº">å…¨åº vs ååº</h2>
<h3 id="å› æœé¡ºåºä¸æ˜¯å…¨åºçš„">å› æœé¡ºåºä¸æ˜¯å…¨åºçš„</h3>
<p>è‡ªç„¶æ•°é›†æ˜¯å…¨åºçš„ï¼Œå¦‚1,2,3ï¼›æ•°å­¦é›†åˆæ˜¯ååºçš„ï¼Œæ¯”å¦‚<code>{a,b}</code>  å’Œ <code>{b,c}</code> æ˜¯æ²¡æœ‰åŠæ³•æ¯”è¾ƒå¤§å°çš„ã€‚çº¿æ€§ä¸€è‡´æ˜¯å…¨åºçš„ï¼Œä¸å­˜åœ¨ä»»ä½•å¹¶å‘ï¼Œæ‰€æœ‰çš„æ“ä½œåœ¨ä¸€æ¡æ—¶é—´çº¿ä¸Šã€‚è€Œå› æœå…³ç³»æ˜¯ååºçš„ï¼Œå­˜åœ¨ç€å¹¶å‘ï¼Œçº¿æ€§ä¸€è‡´æ€§å¼ºäºå› æœä¸€è‡´æ€§ï¼Œä½†æ˜¯æ€§èƒ½ä¸å¦‚å› æœä¸€è‡´æ€§</p>
<h3 id="åºåˆ—å·é¡ºåº">åºåˆ—å·é¡ºåº</h3>
<p>æ˜¾ç¤ºè·Ÿè¸ªæ‰€æœ‰å·²è¯»æ•°æ®ç¡®ä¿å› æœå…³ç³»æ„å‘³ç€å·¨å¤§çš„é¢å¤–å¼€é”€ï¼Œå¯ä»¥ä½¿ç”¨åºåˆ—å·æˆ–æ—¶é—´æˆ³æ¥æ’åºäº‹ä»¶ï¼Œæ—¶é—´æˆ³å¹¶ä¸ä¸€å®šæ¥è‡ªæ—¶é’Ÿï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªé€»è¾‘æ—¶é’Ÿ(è‡ªå¢è®¡æ•°å™¨)ï¼Œå•ä¸»å¤åˆ¶çš„æ•°æ®åº“ä¸­ï¼Œä¸»åº“ä¸ºæ¯ä¸ªæ“ä½œè‡ªå¢ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä»åº“æŒ‰ç…§å¤åˆ¶æ—¥å¿—çš„é¡ºåºæ¥åº”ç”¨å†™æ“ä½œï¼Œé‚£ä¹ˆä»åº“çš„çŠ¶æ€å§‹ç»ˆæ˜¯å› æœä¸€è‡´çš„</p>
<h3 id="éå› æœåºåˆ—å·ç”Ÿæˆå™¨">éå› æœåºåˆ—å·ç”Ÿæˆå™¨</h3>
<p>å¯¹äºæ— ä¸»å¤åˆ¶æˆ–è€…å¤šä¸»å¤åˆ¶ï¼Œå¦‚ä½•ç”Ÿæˆåºåˆ—å·å‘¢ï¼Ÿæœ‰ä¸‹é¢ä¸‰ç§æ–¹å¼ï¼š</p>
<p>1ï¸âƒ£ æ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆè‡ªå·±ç‹¬ç«‹çš„ä¸€ç»„åºåˆ—å·ï¼Œå¦‚æœ‰2ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªå¥‡æ•°ä¸€ä¸ªå¶æ•°</p>
<p>2ï¸âƒ£ å°†ç‰©ç†æ—¶é’Ÿé™„åŠ åˆ°æ¯ä¸ªæ“ä½œä¸Šï¼Œä¹Ÿè®¸å¯ä»¥æä¾›ä¸€ä¸ªå…¨åºå…³ç³»</p>
<p>3ï¸âƒ£ é¢„å…ˆåˆ†é…åºåˆ—åŒºå—å·ï¼Œå¦‚èŠ‚ç‚¹Aæ˜¯1-1000åŒºå—çš„æ‰€æœ‰æƒï¼›èŠ‚ç‚¹Bæ˜¯1001-2000åŒºå—çš„æ‰€æœ‰æƒ</p>
<p>ä¸‰ç§å…±åŒçš„é—®é¢˜æ˜¯ï¼šç”Ÿæˆçš„åºåˆ—å·ä¸å› æœå…³ç³»ä¸ä¸€è‡´ã€‚å…°ä¼¯ç‰¹æ—¶é—´æˆ³å¯ä»¥äº§ç”Ÿä¸å› æœå…³ç³»ä¸€è‡´çš„æ—¶é—´æˆ³</p>
<h3 id="å…°ä¼¯ç‰¹æ—¶é—´æˆ³">å…°ä¼¯ç‰¹æ—¶é—´æˆ³</h3>
<p>(è®¡æ•°å™¨ï¼ŒèŠ‚ç‚¹ID)$(counter, node ID)$ ç»„æˆ<em>å…°ä¼¯ç‰¹</em>æ—¶é—´æˆ³ï¼Œæ¯ä¸ªèŠ‚ç‚¹å’Œæ¯ä¸ªå®¢æˆ·ç«¯è·Ÿè¸ªè¿„ä»Šä¸ºæ­¢æ‰€è§åˆ°çš„æœ€å¤§<strong>è®¡æ•°å™¨</strong>å€¼ï¼Œå¹¶åœ¨æ¯ä¸ªè¯·æ±‚ä¸­åŒ…å«è¿™ä¸ªæœ€å¤§è®¡æ•°å™¨å€¼ã€‚å½“ä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°æœ€å¤§è®¡æ•°å™¨å€¼å¤§äºè‡ªèº«è®¡æ•°å™¨å€¼çš„è¯·æ±‚æˆ–å“åº”æ—¶ï¼Œå®ƒç«‹å³å°†è‡ªå·±çš„è®¡æ•°å™¨è®¾ç½®ä¸ºè¿™ä¸ªæœ€å¤§å€¼ã€‚ä¸‹é¢2æ¡è§„åˆ™å»åˆ¤æ–­ï¼š</p>
<p>ğŸ…°ï¸ å¦‚æœä½ æœ‰ä¸¤ä¸ªæ—¶é—´æˆ³ï¼Œåˆ™<strong>è®¡æ•°å™¨</strong>å€¼å¤§è€…æ˜¯æ›´å¤§çš„æ—¶é—´æˆ³</p>
<p>ğŸ…±ï¸  å¦‚æœè®¡æ•°å™¨å€¼ç›¸åŒï¼Œåˆ™èŠ‚ç‚¹IDè¶Šå¤§çš„ï¼Œæ—¶é—´æˆ³è¶Šå¤§</p>
<p align="center">
  <img src="/2023/09/21/ddia/12.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
<p>å…¶ä¸­å®¢æˆ·ç«¯ A ä»èŠ‚ç‚¹2 æ¥æ”¶è®¡æ•°å™¨å€¼ <code>5</code> ï¼Œç„¶åå°†æœ€å¤§å€¼ <code>5</code> å‘é€åˆ°èŠ‚ç‚¹1 ã€‚æ­¤æ—¶ï¼ŒèŠ‚ç‚¹1 çš„è®¡æ•°å™¨ä»…ä¸º <code>1</code> ï¼Œä½†æ˜¯å®ƒç«‹å³å‰ç§»è‡³ <code>5</code> ï¼Œæ‰€ä»¥ä¸‹ä¸€ä¸ªæ“ä½œçš„è®¡æ•°å™¨çš„å€¼ä¸º <code>6</code> ã€‚è™½ç„¶å…°ä¼¯ç‰¹æ—¶é—´æˆ³å®šä¹‰äº†ä¸€ä¸ªä¸å› æœä¸€è‡´çš„å…¨åºï¼Œä½†å®ƒè¿˜ä¸è¶³ä»¥è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„è®¸å¤šå¸¸è§é—®é¢˜ï¼Œæ¯”å¦‚ç¡®ä¿ç”¨æˆ·åèƒ½å”¯ä¸€æ ‡è¯†ç”¨æˆ·å¸æˆ·çš„ç³»ç»Ÿï¼Œä½ å¾—æœé›†æ‰€æœ‰ç›¸åŒç”¨æˆ·åçš„å…°ä¼¯ç‰¹æ—¶é—´æˆ³ï¼Œæ‰èƒ½æ¯”è¾ƒä»–ä»¬çš„æ—¶é—´æˆ³ï¼ŒèŠ‚ç‚¹æ— æ³•é©¬ä¸Šå†³å®šå½“å‰è¯·æ±‚å¤±è´¥è¿˜æ˜¯æˆåŠŸã€‚æ‰€ä»¥ä»…çŸ¥é“å…¨åºæ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦çŸ¥é“å…¨åºä½•æ—¶ç»“æŸ</p>
<h2 id="å…¨åºå¹¿æ’­-åŸå­å¹¿æ’­">å…¨åºå¹¿æ’­(åŸå­å¹¿æ’­)</h2>
<p>å…¨åºå¹¿æ’­é€šå¸¸è¢«æè¿°ä¸ºåœ¨èŠ‚ç‚¹é—´äº¤æ¢æ¶ˆæ¯çš„åè®®ã€‚ éæ­£å¼åœ°è®²ï¼Œå®ƒè¦æ»¡è¶³ä¸¤ä¸ªå®‰å…¨å±æ€§ï¼š</p>
<p>1ï¸âƒ£ å¯é äº¤ä»˜ï¼ˆreliable deliveryï¼‰:  æ²¡æœ‰æ¶ˆæ¯ä¸¢å¤±ï¼šå¦‚æœæ¶ˆæ¯è¢«ä¼ é€’åˆ°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒå°†è¢«ä¼ é€’åˆ°æ‰€æœ‰èŠ‚ç‚¹</p>
<p>2ï¸âƒ£ å…¨åºäº¤ä»˜ï¼ˆtotally ordered deliveryï¼‰:  æ¶ˆæ¯ä»¥ç›¸åŒçš„é¡ºåºä¼ é€’ç»™æ¯ä¸ªèŠ‚ç‚¹</p>
<p>æ­£ç¡®çš„å…¨åºå¹¿æ’­ç®—æ³•å¿…é¡»å§‹ç»ˆä¿è¯å¯é æ€§å’Œæœ‰åºæ€§ï¼Œå³ä½¿èŠ‚ç‚¹æˆ–ç½‘ç»œå‡ºç°æ•…éšœã€‚å½“ç„¶åœ¨ç½‘ç»œä¸­æ–­çš„æ—¶å€™ï¼Œæ¶ˆæ¯æ˜¯ä¼ ä¸å‡ºå»çš„ï¼Œä½†æ˜¯ç®—æ³•å¯ä»¥ä¸æ–­é‡è¯•ï¼Œä»¥ä¾¿åœ¨ç½‘ç»œæœ€ç»ˆä¿®å¤æ—¶ï¼Œæ¶ˆæ¯èƒ½åŠæ—¶é€šè¿‡å¹¶é€è¾¾</p>
<p>å¯ä»¥ä½¿ç”¨å…¨åºå¹¿æ’­æ¥å®ç°å¯åºåˆ—åŒ–çš„äº‹åŠ¡ï¼Œç”±äºå…·å¤‡ä¸Šè¿°2ä¸ªå®‰å…¨å±æ€§ï¼Œæ•°æ®åº“çš„åˆ†åŒºå’Œå‰¯æœ¬å°±å¯ä»¥ç›¸äº’ä¿æŒä¸€è‡´ã€‚<em>èŠ‚ç‚¹å¾—åˆ°äº†å…±è¯†</em></p>
<blockquote>
<p>ğŸ…°ï¸ <strong>å…¨åºå¹¿æ’­ç­‰äºå…±è¯†</strong></p>
<p>ğŸ…±ï¸ <strong>çº¿æ€§ä¸€è‡´çš„CASç­‰äºå…±è¯†</strong></p>
</blockquote>
<h2 id="åˆ†å¸ƒå¼äº‹åŠ¡ä¸å…±è¯†">åˆ†å¸ƒå¼äº‹åŠ¡ä¸å…±è¯†</h2>
<p>å…±è¯†çš„ç›®æ ‡åªæ˜¯<strong>è®©å‡ ä¸ªèŠ‚ç‚¹è¾¾æˆä¸€è‡´(get serveral nodes to agree on something)</strong>ã€‚èŠ‚ç‚¹è¾¾æˆä¸€è‡´(å…±è¯†)çš„åº”ç”¨åœºæ™¯ï¼š</p>
<p>ğŸ…°ï¸ é¢†å¯¼é€‰å–ï¼šå¦‚åœ¨å•ä¸»å¤åˆ¶ä¸­ï¼Œå¦‚æœæœ‰2ä¸ªä»¥ä¸Šé¢†å¯¼å°±ä¼šæœ‰å‘ç”Ÿè„‘è£‚æƒ…å†µï¼Œè„‘è£‚æ—¶2ä¸»éƒ½ä¼šæ¥æ”¶å†™å…¥ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´æˆ–æ•°æ®ä¸¢å¤±</p>
<p>ğŸ…±ï¸ åŸå­æäº¤ï¼šåœ¨è·¨å¤šèŠ‚ç‚¹æˆ–è·¨å¤šåˆ†åŒºäº‹åŠ¡çš„æ•°æ®åº“ä¸­ï¼Œæ‰€æœ‰èŠ‚ç‚¹å¿…é¡»å°±ï¼š<em>ä¸€ä¸ªäº‹åŠ¡æ˜¯å¦æˆåŠŸ</em>è¿™ä»¶äº‹è¾¾æˆä¸€è‡´(è¦ä¸éƒ½æˆåŠŸï¼›è¦ä¸éƒ½å¤±è´¥)</p>
<p>2PCæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„å…±è¯†ç®—æ³•ï¼Œæ›´å¥½çš„ä¸€è‡´æ€§ç®—æ³•æ¯”å¦‚ZooKeeper(Zab)å’Œetcd(Raft)ä¸­ä½¿ç”¨çš„ç®—æ³•</p>
<blockquote>
<p>åŒºåˆ†æ™®é€šäº‹åŠ¡å’Œä¸¤ç§çš„ä¸åŒçš„åˆ†å¸ƒå¼äº‹åŠ¡</p>
<p>0ï¸âƒ£ æ™®é€šäº‹åŠ¡æ˜¯ç›¸å¯¹å•ä¸ªèŠ‚ç‚¹è€Œè¨€çš„å¤šå¯¹è±¡æ“ä½œï¼›è€Œåˆ†å¸ƒå¼äº‹åŠ¡æ¶‰åŠå¤šä¸ªèŠ‚ç‚¹</p>
<p>1ï¸âƒ£ æ•°æ®åº“å†…éƒ¨çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œ ä¸€äº›åˆ†å¸ƒå¼æ•°æ®åº“(å³åœ¨å…¶æ ‡å‡†é…ç½®ä¸­ä½¿ç”¨å¤åˆ¶å’Œåˆ†åŒºçš„æ•°æ®åº“)æ”¯æŒæ•°æ®åº“èŠ‚ç‚¹ä¹‹é—´çš„å†…éƒ¨äº‹åŠ¡ï¼Œæ¯”å¦‚MySQL Clusterçš„NDBå­˜å‚¨å¼•æ“å°±æœ‰è¿™æ ·çš„å†…éƒ¨äº‹åŠ¡æ”¯æŒã€‚æ­¤æƒ…å½¢ä¸‹ï¼Œæ‰€æœ‰å‚ä¸äº‹åŠ¡çš„èŠ‚ç‚¹éƒ½è¿è¡Œç›¸åŒçš„è½¯ä»¶</p>
<p>2ï¸âƒ£ å¼‚æ„åˆ†å¸ƒå¼äº‹åŠ¡ï¼šåœ¨å¼‚æ„äº‹åŠ¡ä¸­ï¼Œå‚ä¸è€…æ˜¯2è€…æˆ–è€…ä»¥ä¸Šçš„æŠ€æœ¯ï¼Œæ¯”å¦‚æ¥è‡ªä¸åŒä¾›åº”å•†çš„2ä¸ªæ•°æ®åº“/æ¶ˆæ¯ä»£ç†ï¼Œè·¨ç³»ç»Ÿçš„åˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦ä¿è¯åŸå­æäº¤</p>
</blockquote>
<h2 id="åŸå­æäº¤å’Œ2PC">åŸå­æäº¤å’Œ2PC</h2>
<p>å¯¹äºå¤šå¯¹è±¡äº‹åŠ¡åŠç»´æŠ¤æ¬¡çº§ç´¢å¼•çš„æ•°æ®åº“ï¼ŒåŸå­æäº¤å¯ä»¥é˜²æ­¢å¤±è´¥çš„äº‹åŠ¡æ…ä¹±æ•°æ®åº“ï¼Œé¿å…æ•°æ®åº“é™·å…¥åŠæˆå“ç»“æœå’ŒåŠæ›´æ–°çŠ¶æ€ï¼›å¯¹äºå•å¯¹è±¡çš„åŸå­æ€§ä¸€èˆ¬æ—¶éƒ½ç”±æ•°æ®åº“(å­˜å‚¨å¼•æ“)æœ¬èº«ä¿è¯ã€‚ <strong>ä¸¤é˜¶æ®µæäº¤(two-phase commit)</strong> æ˜¯ä¸€ç§ç”¨äºå®ç°è·¨å¤šä¸ªèŠ‚ç‚¹çš„åŸå­äº‹åŠ¡æäº¤çš„ç®—æ³•ï¼Œå³ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹æäº¤æˆ–æ‰€æœ‰èŠ‚ç‚¹ä¸­æ­¢</p>
<p align="center">
  <img src="/2023/09/21/ddia/13.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
<p>2PCä½¿ç”¨ä¸€ä¸ªé€šå¸¸ä¸ä¼šå‡ºç°åœ¨å•èŠ‚ç‚¹äº‹åŠ¡ä¸­çš„æ–°ç»„ä»¶ï¼š<strong>åè°ƒè€…(coordinator)</strong>ï¼ˆä¹Ÿç§°ä¸º<strong>äº‹åŠ¡ç®¡ç†å™¨(transaction manager)</strong>ï¼‰ã€‚2PCäº‹åŠ¡ä»¥åº”ç”¨åœ¨å¤šä¸ªæ•°æ®åº“èŠ‚ç‚¹(<strong>å‚ä¸è€…(participants)</strong>)ä¸Šè¯»å†™æ•°æ®å¼€å§‹ã€‚å½“åº”ç”¨å‡†å¤‡æäº¤æ—¶ï¼Œåè°ƒè€…å¼€å§‹é˜¶æ®µ1ï¼šå®ƒå‘é€ä¸€ä¸ª <strong>å‡†å¤‡(prepare)</strong> è¯·æ±‚åˆ°æ¯ä¸ªèŠ‚ç‚¹ï¼Œè¯¢é—®å®ƒä»¬æ˜¯å¦èƒ½å¤Ÿæäº¤ï¼Œç„¶ååè°ƒè€…ä¼šè·Ÿè¸ªå‚ä¸è€…çš„å“åº”ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½å›ç­”â€œæ˜¯â€ï¼Œè¡¨ç¤ºå®ƒä»¬å·²ç»å‡†å¤‡å¥½æäº¤ï¼Œé‚£ä¹ˆåè°ƒè€…åœ¨é˜¶æ®µ2å‘å‡º <strong>æäº¤(commit)</strong> è¯·æ±‚ï¼Œç„¶åæäº¤çœŸæ­£å‘ç”Ÿ</p>
</li>
<li class="lvl-2">
<p>å¦‚æœä»»æ„ä¸€ä¸ªå‚ä¸è€…å›å¤äº†â€œå¦â€ï¼Œåˆ™åè°ƒè€…åœ¨é˜¶æ®µ2 ä¸­å‘æ‰€æœ‰èŠ‚ç‚¹å‘é€ <strong>ä¸­æ­¢(abort)</strong> è¯·æ±‚</p>
</li>
</ul>
<p>2PCå…·ä½“çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ å½“åº”ç”¨æƒ³è¦å¯åŠ¨ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œå®ƒå‘åè°ƒè€…è¯·æ±‚ä¸€ä¸ªäº‹åŠ¡IDã€‚æ­¤äº‹åŠ¡IDæ˜¯å…¨å±€å”¯ä¸€çš„</p>
<p>2ï¸âƒ£ åº”ç”¨åœ¨æ¯ä¸ªå‚ä¸è€…ä¸Šå¯åŠ¨å•èŠ‚ç‚¹äº‹åŠ¡ï¼Œå¹¶åœ¨å•èŠ‚ç‚¹äº‹åŠ¡ä¸Šæå¸¦ä¸Šè¿™ä¸ªå…¨å±€äº‹åŠ¡ID</p>
<p>3ï¸âƒ£ å½“åº”ç”¨å‡†å¤‡æäº¤æ—¶ï¼Œåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ä¸€ä¸ª<strong>å‡†å¤‡</strong>è¯·æ±‚ï¼Œå¹¶æ‰“ä¸Šå…¨å±€äº‹åŠ¡IDçš„æ ‡è®°ã€‚å¦‚æœä»»æ„ä¸€ä¸ªè¯·æ±‚å¤±è´¥æˆ–è¶…æ—¶ï¼Œåˆ™åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€é’ˆå¯¹è¯¥äº‹åŠ¡IDçš„ä¸­æ­¢è¯·æ±‚</p>
<p>4ï¸âƒ£ å‚ä¸è€…æ”¶åˆ°å‡†å¤‡è¯·æ±‚æ—¶ï¼Œéœ€è¦ç¡®ä¿åœ¨ä»»æ„æƒ…å†µä¸‹éƒ½å¯ä»¥æäº¤äº‹åŠ¡ã€‚è¿™åŒ…æ‹¬å°†æ‰€æœ‰äº‹åŠ¡æ•°æ®å†™å…¥ç£ç›˜(å‡ºç°æ•…éšœï¼Œç”µæºæ•…éšœï¼Œæˆ–ç¡¬ç›˜ç©ºé—´ä¸è¶³éƒ½ä¸èƒ½æ˜¯ç¨åæ‹’ç»æäº¤çš„ç†ç”±)ä»¥åŠæ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»»ä½•å†²çªæˆ–è¿åçº¦æŸã€‚é€šè¿‡å‘åè°ƒè€…å›ç­”â€œæ˜¯â€ï¼ŒèŠ‚ç‚¹æ‰¿è¯ºï¼Œåªè¦è¯·æ±‚ï¼Œè¿™ä¸ªäº‹åŠ¡ä¸€å®šå¯ä»¥ä¸å‡ºå·®é”™åœ°æäº¤ã€‚æ¢å¥è¯è¯´ï¼Œ<em>å‚ä¸è€…æ”¾å¼ƒäº†ä¸­æ­¢äº‹åŠ¡çš„æƒåˆ©ï¼Œä½†æ²¡æœ‰å®é™…æäº¤</em></p>
<p>5ï¸âƒ£ å½“åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‡†å¤‡è¯·æ±‚çš„ç­”å¤æ—¶ï¼Œä¼šå°±æäº¤æˆ–ä¸­æ­¢äº‹åŠ¡ä½œå‡ºæ˜ç¡®çš„å†³å®š(åªæœ‰åœ¨æ‰€æœ‰å‚ä¸è€…æŠ•èµæˆç¥¨çš„æƒ…å†µä¸‹æ‰ä¼šæäº¤)ã€‚åè°ƒè€…å¿…é¡»æŠŠè¿™ä¸ªå†³å®šå†™åˆ°ç£ç›˜ä¸Šçš„äº‹åŠ¡æ—¥å¿—ä¸­ï¼Œå¦‚æœå®ƒéšåå°±å´©æºƒï¼Œæ¢å¤åä¹Ÿèƒ½çŸ¥é“è‡ªå·±æ‰€åšçš„å†³å®šã€‚è¿™è¢«ç§°ä¸º<strong>æäº¤ç‚¹(commit point)</strong></p>
<p>6ï¸âƒ£ä¸€æ—¦åè°ƒè€…çš„å†³å®šè½ç›˜ï¼Œæäº¤æˆ–æ”¾å¼ƒè¯·æ±‚ä¼šå‘é€ç»™æ‰€æœ‰å‚ä¸è€…ã€‚å¦‚æœè¿™ä¸ªè¯·æ±‚å¤±è´¥æˆ–è¶…æ—¶ï¼Œåè°ƒè€…å¿…é¡»æ°¸è¿œä¿æŒé‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚æ²¡æœ‰å›å¤´è·¯ï¼šå¦‚æœå·²ç»åšå‡ºå†³å®šï¼Œä¸ç®¡éœ€è¦å¤šå°‘æ¬¡é‡è¯•å®ƒéƒ½å¿…é¡»è¢«æ‰§è¡Œã€‚å¦‚æœå‚ä¸è€…åœ¨æ­¤æœŸé—´å´©æºƒï¼Œäº‹åŠ¡å°†åœ¨å…¶æ¢å¤åæäº¤â€”â€”ç”±äºå‚ä¸è€…æŠ•äº†èµæˆï¼Œå› æ­¤æ¢å¤åå®ƒä¸èƒ½æ‹’ç»æäº¤</p>
<p>ä¸‹å›¾æ˜¯MySQLçš„ä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹ä¿è¯bin-logå’Œredo-logä¸€è‡´</p>
<p align="center">
  <img src="/2023/09/21/ddia/03.png" width="55%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
<h2 id="åè°ƒè€…å¤±æ•ˆ">åè°ƒè€…å¤±æ•ˆ</h2>
<p>ä¸Šè¿°ç¬¬3ï¸âƒ£æ­¥ä¸­å¾ˆåè°ƒè€…å‘é€â€œå‡†å¤‡â€è¯·æ±‚ä¹‹å‰å¤±è´¥ï¼Œå‚ä¸è€…å¯ä»¥å®‰å…¨çš„ç»ˆæ­¢äº‹åŠ¡ï¼›åœ¨ç¬¬5ï¸âƒ£ æ­¥ä¸­å¦‚æœä»»ä½•æäº¤å’Œç»ˆæ­¢è¯·æ±‚å¤±è´¥ï¼Œåè°ƒè€…å°†æ— æ¡ä»¶é‡è¯•ï¼Œä½†æ˜¯åè°ƒè€…å´©æºƒï¼Œå‚ä¸è€…å°±ä»€ä¹ˆä¹Ÿåšä¸äº†åªèƒ½ç­‰å¾…ã€‚å‚ä¸è€…çš„è¿™è¿™ç§äº‹åŠ¡çŠ¶æ€ç§°ä¸ºï¼š<strong>å­˜ç–‘æˆ–è€…ä¸ç¡®å®š</strong></p>
<p align="center">
  <img src="/2023/09/21/ddia/14.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
<p>ä¸Šå›¾ä¸­ï¼šåè°ƒè€…å®é™…ä¸Šå†³å®šæäº¤ï¼Œæ•°æ®åº“2æ”¶åˆ°æäº¤è¯·æ±‚ï¼Œä½†æ˜¯åè°ƒè€…åœ¨å°†æäº¤è¯·æ±‚å‘é€åˆ°æ•°æ®åº“1ä¹‹å‰å‘ç”Ÿå´©æºƒï¼Œå› æ­¤æ•°æ®åº“1ä¸çŸ¥é“æ˜¯å¦æäº¤æˆ–ä¸­æ­¢ã€‚è¿™é‡Œå³ä¾¿<strong>è¶…æ—¶</strong>ï¼Œ ä¹Ÿæ˜¯æ²¡ç”¨çš„ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å¦‚æœæ•°æ®åº“1 åœ¨è¶…æ—¶åå•æ–¹é¢ä¸­æ­¢ï¼Œå®ƒå°†æœ€ç»ˆä¸æ‰§è¡Œæäº¤çš„æ•°æ®åº“2 ä¸ä¸€è‡´</p>
</li>
<li class="lvl-2">
<p>å•æ–¹é¢æäº¤ä¹Ÿæ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºå¦ä¸€ä¸ªå‚ä¸è€…å¯èƒ½å·²ç»ä¸­æ­¢äº†</p>
</li>
</ul>
<p>æ­¤æ—¶å®Œæˆ2PCçš„å”¯ä¸€æ–¹æ³•æ˜¯ç­‰å¾…åè°ƒè€…æ¢å¤ï¼Œå› æ­¤ï¼Œåè°ƒè€…å¿…é¡»åœ¨<em>å‘</em>å‚ä¸è€…å‘é€æäº¤/ä¸­æ­¢è¯·æ±‚ä¹‹å‰ï¼Œå°†å…¶æäº¤/ä¸­æ­¢å†³å®šå†™å…¥ç£ç›˜ä¸Šçš„äº‹åŠ¡æ—¥å¿—ï¼Œåè°ƒè€…æ¢å¤åï¼Œé€šè¿‡è¯»å–å…¶äº‹åŠ¡æ—¥å¿—æ¥ç¡®å®šæ‰€æœ‰å­˜ç–‘äº‹åŠ¡çš„çŠ¶æ€ï¼Œä»»ä½•åœ¨åè°ƒè€…æ—¥å¿—ä¸­æ²¡æœ‰æäº¤è®°å½•çš„äº‹åŠ¡éƒ½ä¼šä¸­æ­¢</p>
<h2 id="æ°å¥½ä¸€æ¬¡çš„æ¶ˆæ¯å¤„ç†">æ°å¥½ä¸€æ¬¡çš„æ¶ˆæ¯å¤„ç†</h2>
<p>å¼‚æ„çš„åˆ†å¸ƒå¼äº‹åŠ¡èƒ½å¤Ÿé›†æˆä¸¤ç§ä¸åŒçš„ç³»ç»Ÿï¼Œæ¯”å¦‚å½“ç”¨äºå¤„ç†æ¶ˆæ¯çš„æ•°æ®åº“äº‹åŠ¡æˆåŠŸæäº¤åï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä¸€æ¡æ¶ˆæ¯å¯ä»¥è¢«è®¤ä¸ºå·²å¤„ç†ã€‚å¦‚æœæ¶ˆæ¯æˆ–è€…æ•°æ®åº“äº‹åŠ¡ä»»æ„ä¸€ä¸ªå¤±è´¥ï¼Œ2è€…éƒ½ä¼šç»ˆæ­¢ï¼Œè€Œæ¶ˆæ¯ä»£ç†å¯èƒ½ä¼šåœ¨ç¨åå®‰å…¨çš„é‡ä¼ æ¶ˆæ¯ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ç¡®ä¿æ¶ˆæ¯è¢«æœ‰æ•ˆåœ°æ°å¥½å¤„ç†ä¸€æ¬¡</p>
<h2 id="XAäº‹åŠ¡">XAäº‹åŠ¡</h2>
<p>æ‰©å±•æ¶æ„(eXtended Architecture)æ˜¯è·¨å¼‚æ„æŠ€æœ¯å®ç°ä¸¤é˜¶æ®µæäº¤çš„æ ‡å‡†ã€‚è®¸å¤šå…³ç³»å‹æ•°æ®åº“(PostgresSQLã€MySQLã€SQL Serverã€Oracle))å’Œæ¶ˆæ¯ä»£ç†(ActiveMQï¼ŒHornetQï¼ŒMSMQå’ŒIBM MQ)éƒ½æ”¯æŒXA</p>
<h2 id="å®¹é”™å…±è¯†">å®¹é”™å…±è¯†</h2>
<blockquote>
<p>å…±è¯†çš„å®šä¹‰ï¼šä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹å¯ä»¥**æè®®(propose)<strong>æŸäº›å€¼ï¼Œè€Œå…±è¯†ç®—æ³•</strong>å†³å®š(decides)**é‡‡ç”¨å…¶ä¸­çš„æŸä¸ªå€¼</p>
<p>å…±è¯†ç®—æ³•éœ€è¦æ»¡è¶³ä»¥ä¸‹æ€§è´¨ï¼š</p>
<p>1ï¸âƒ£ ä¸€è‡´åŒæ„ï¼šæ²¡æœ‰2ä¸ªèŠ‚ç‚¹çš„å†³å®šä¸åŒ</p>
<p>2ï¸âƒ£ å®Œæ•´æ€§ï¼šæ²¡æœ‰èŠ‚ç‚¹å†³å®š2æ¬¡</p>
<p>3ï¸âƒ£ æœ‰æ•ˆæ€§ï¼šå¦‚æœä¸€ä¸ªèŠ‚ç‚¹å†³å®šäº†å€¼<code>v</code>,åˆ™<code>v</code>ç”±æŸä¸ªèŠ‚ç‚¹æ‰€æè®®</p>
<p>4ï¸âƒ£ ç»ˆæ­¢ ï¼š ç”±æ‰€æœ‰æœªå´©æºƒçš„èŠ‚ç‚¹æ¥æœ€ç»ˆå†³å®šå€¼</p>
</blockquote>
<p>ç»ˆæ­¢å±æ€§å½¢æˆäº†å®¹é”™çš„æ€æƒ³ï¼Œè¯¥å±æ€§æ˜¯ä¸€ä¸ªæ´»æ€§å±æ€§ï¼Œè€Œå¦å¤–ä¸‰ä¸ªæ˜¯å®‰å…¨å±æ€§ã€‚å¦‚æœä¸å…³å¿ƒå®¹é”™ï¼Œä»…ä»…æ»¡è¶³å‰ä¸‰ä¸ªå±æ€§å°±OKï¼Œå› ä¸ºä½ å¯ä»¥å°†å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ç¡¬ç¼–ç ä¸ºleaderï¼Œè®©è¯¥èŠ‚ç‚¹åšå‡ºæ‰€æœ‰çš„å†³å®šï¼Œä½†æ˜¯èŠ‚ç‚¹ä¸€æ—¦å¤±æ•ˆï¼Œç³»ç»Ÿæ— æ³•å°±æ— æ³•åšå‡ºå†³å®šäº†ã€‚æ¯”å¦‚2PCå°±èƒ½å¤Ÿæ»¡è¶³ï¼Œä½†æ˜¯2PCçš„é—®é¢˜æ˜¯ï¼Œåè°ƒè€…å¤±æ•ˆï¼Œå­˜ç–‘çš„å‚ä¸è€…æ— æ³•å†³å®šæ˜¯æäº¤è¿˜æ˜¯ç»ˆæ­¢ï¼Œæ•…2PCä¸æ»¡è¶³ç»ˆæ­¢å±æ€§çš„è¦æ±‚</p>
<p>ç»å¤§å¤šæ•°å…±è¯†ç®—æ³•å®é™…ä¸Šå¹¶ä¸ç›´æ¥ä½¿ç”¨1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£4ï¸âƒ£å½¢å¼åŒ–æ¨¡å‹ï¼Œè€Œæ˜¯ä½¿ç”¨å…¨åºå¹¿æ’­ä»£ä¸ºå®ç°</p>
<h2 id="å…±è¯†ç®—æ³•å’Œå…¨åºå¹¿æ’­">å…±è¯†ç®—æ³•å’Œå…¨åºå¹¿æ’­</h2>
<p>æœ€è‘—åçš„å®¹é”™å…±è¯†ç®—æ³•æ˜¯<strong>è§†å›¾æˆ³å¤åˆ¶(VSR, viewstamped replication)</strong>ï¼ŒPaxosï¼ŒRaft ä»¥åŠ Zabã€‚è§†å›¾æˆ³å¤åˆ¶ï¼ŒRaftå’ŒZabç›´æ¥å®ç°äº†å…¨åºå¹¿æ’­ï¼Œå› ä¸ºè¿™æ ·åšæ¯”é‡å¤ <strong>ä¸€æ¬¡ä¸€å€¼(one value a time)</strong> çš„å…±è¯†æ›´é«˜æ•ˆï¼Œå› ä¸ºå…¨åºå¹¿æ’­çš„è¦æ±‚æ˜¯ï¼š</p>
<blockquote>
<p>1ï¸âƒ£ å¯é äº¤ä»˜ï¼ˆreliable deliveryï¼‰:  æ²¡æœ‰æ¶ˆæ¯ä¸¢å¤±ï¼šå¦‚æœæ¶ˆæ¯è¢«ä¼ é€’åˆ°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒå°†è¢«ä¼ é€’åˆ°æ‰€æœ‰èŠ‚ç‚¹</p>
<p>2ï¸âƒ£ å…¨åºäº¤ä»˜ï¼ˆtotally ordered deliveryï¼‰:  æ¶ˆæ¯ä»¥ç›¸åŒçš„é¡ºåºä¼ é€’ç»™æ¯ä¸ªèŠ‚ç‚¹</p>
</blockquote>
<p>å¯ä»¥å‘ç°ï¼Œ<strong>å…¨åºå¹¿æ’­ç­‰äºè¿›è¡Œäº†é‡å¤å¤šè½®å…±è¯†</strong></p>
<p>åœ¨å•ä¸»å¤åˆ¶ä¸­ï¼Œå°†æ‰€æœ‰çš„å†™å…¥æ“ä½œéƒ½äº¤ç»™ä¸»åº“ï¼Œå¹¶ä»¥ç›¸åŒçš„é¡ºåºå°†ä»–ä»¬åº”ç”¨åˆ°ä»åº“ï¼Œä»è€Œä½¿å‰¯æœ¬ä¿æŒåœ¨æœ€æ–°çŠ¶æ€ï¼Œè¿™é‡Œå…¶å®æ˜¯ä¸€ç§ <strong>â€œç‹¬è£ç±»å‹â€</strong> çš„å…±è¯†ç®—æ³•ï¼Œé¢†å¯¼è€…æ˜¯è¿ç»´æŒ‡å®šçš„ï¼Œä¸€æ—¦æ•…éšœå¿…é¡»äººä¸ºå¹²é¢„ï¼Œå®ƒæ— æ³•æ»¡è¶³å…±è¯†ç®—æ³•çš„ç»ˆæ­¢å±æ€§</p>
<h2 id="æ—¶ä»£ç¼–å·å’Œæ³•å®šäººæ•°">æ—¶ä»£ç¼–å·å’Œæ³•å®šäººæ•°</h2>
<p>å…±è¯†åè®®ä¸€èˆ¬ä¼šå®šä¹‰1ä¸ª<strong>æ—¶ä»£ç¼–å·(epoch number)</strong>ï¼Œåœ¨Paxosä¸­ç§°ä¸º<strong>æŠ•ç¥¨ç¼–å·(ballot number)</strong>ï¼Œè§†å›¾æˆ³å¤åˆ¶ä¸­çš„<strong>è§†å›¾ç¼–å·(view number)</strong>ï¼Œä»¥åŠRaftä¸­çš„<strong>ä»»æœŸå·ç (term number)</strong>ï¼Œå¹¶ç¡®ä¿åœ¨æ¯ä¸ªæ—¶ä»£ä¸­ï¼Œé¢†å¯¼è€…éƒ½æ˜¯å”¯ä¸€çš„ã€‚æ¯æ¬¡é¢†å¯¼è€…è¢«è®¤ä¸ºæŒ‚æ‰çš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿå…¨åºä¸”å•è°ƒé€’å¢çš„æ–°çš„æ—¶ä»£ç¼–å·ï¼Œæ›´é«˜æ—¶ä»£ç¼–å·çš„é¢†å¯¼æ‰çœŸçš„é¢†å¯¼ã€‚èŠ‚ç‚¹åœ¨åšå‡ºå†³å®šä¹‹å‰å¯¹æè®®è¿›è¡ŒæŠ•ç¥¨çš„è¿‡ç¨‹æ˜¯ä¸€ç§åŒæ­¥å¤åˆ¶ï¼Œè¿™æ˜¯å…±è¯†çš„å±€é™æ€§</p>
<h2 id="æ€»ç»“ï¼š">æ€»ç»“ï¼š</h2>
<p>å¾ˆå¤šé—®é¢˜éƒ½å¯ä»¥å½’ç»“ä¸ºå…±è¯†é—®é¢˜ï¼Œå¹¶ä¸”å½¼æ­¤ç­‰ä»·(ä»è¿™ä¸ªæ„ä¹‰ä¸Šæ¥è®²ï¼Œå¦‚æœä½ æœ‰å…¶ä¸­ä¹‹ä¸€çš„è§£å†³æ–¹æ¡ˆï¼Œå°±å¯ä»¥è½»æ˜“å°†å®ƒè½¬æ¢ä¸ºå…¶ä»–é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ)ã€‚è¿™äº›ç­‰ä»·çš„é—®é¢˜åŒ…æ‹¬ï¼š</p>
<p>1ï¸âƒ£ <strong>çº¿æ€§ä¸€è‡´æ€§çš„CASå¯„å­˜å™¨</strong>:  å¯„å­˜å™¨éœ€è¦åŸºäºå½“å‰å€¼æ˜¯å¦ç­‰äºæ“ä½œç»™å‡ºçš„å‚æ•°ï¼ŒåŸå­åœ°<strong>å†³å®š</strong>æ˜¯å¦è®¾ç½®æ–°å€¼</p>
<p>2ï¸âƒ£ <strong>åŸå­äº‹åŠ¡æäº¤</strong> :  æ•°æ®åº“å¿…é¡»<strong>å†³å®š</strong>æ˜¯å¦æäº¤æˆ–ä¸­æ­¢åˆ†å¸ƒå¼äº‹åŠ¡</p>
<p>3ï¸âƒ£  <strong>å…¨åºå¹¿æ’­</strong>:  æ¶ˆæ¯ç³»ç»Ÿå¿…é¡»<strong>å†³å®š</strong>ä¼ é€’æ¶ˆæ¯çš„é¡ºåº</p>
<p>4ï¸âƒ£ <strong>é”å’Œç§Ÿçº¦</strong>:  å½“å‡ ä¸ªå®¢æˆ·ç«¯äº‰æŠ¢é”æˆ–ç§Ÿçº¦æ—¶ï¼Œç”±é”æ¥<strong>å†³å®š</strong>å“ªä¸ªå®¢æˆ·ç«¯æˆåŠŸè·å¾—é”</p>
<p>5ï¸âƒ£ <strong>æˆå‘˜/åè°ƒæœåŠ¡</strong>: ç»™å®šæŸç§æ•…éšœæ£€æµ‹å™¨(ä¾‹å¦‚è¶…æ—¶)ï¼Œç³»ç»Ÿå¿…é¡»<strong>å†³å®š</strong>å“ªäº›èŠ‚ç‚¹æ´»ç€ï¼Œå“ªäº›èŠ‚ç‚¹å› ä¸ºä¼šè¯è¶…æ—¶éœ€è¦è¢«å®£å‘Šæ­»äº¡</p>
<p>6ï¸âƒ£ <strong>å”¯ä¸€æ€§çº¦æŸ</strong>: å½“å¤šä¸ªäº‹åŠ¡åŒæ—¶å°è¯•ä½¿ç”¨ç›¸åŒçš„é”®åˆ›å»ºå†²çªè®°å½•æ—¶ï¼Œçº¦æŸå¿…é¡»<strong>å†³å®š</strong>å“ªä¸€ä¸ªè¢«å…è®¸ï¼Œå“ªäº›å› ä¸ºè¿åçº¦æŸè€Œå¤±è´¥</p>
<p>å¦‚æœä½ åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…ä½ æ„¿æ„å°†å†³ç­–æƒåˆ†é…ç»™å•ä¸ªèŠ‚ç‚¹ï¼Œæ‰€æœ‰è¿™äº›äº‹éƒ½å¾ˆç®€å•ã€‚è¿™å°±æ˜¯åœ¨å•é¢†å¯¼è€…æ•°æ®åº“ä¸­å‘ç”Ÿçš„äº‹æƒ…ï¼šæ‰€æœ‰å†³ç­–æƒå½’å±äºé¢†å¯¼è€…ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™æ ·çš„æ•°æ®åº“èƒ½å¤Ÿæä¾›çº¿æ€§ä¸€è‡´çš„æ“ä½œï¼Œå”¯ä¸€æ€§çº¦æŸï¼Œå®Œå…¨æœ‰åºçš„å¤åˆ¶æ—¥å¿—ç­‰ã€‚ä½†å¦‚æœè¯¥é¢†å¯¼è€…å¤±æ•ˆï¼Œæˆ–è€…å¦‚æœç½‘ç»œä¸­æ–­å¯¼è‡´é¢†å¯¼è€…ä¸å¯è¾¾ï¼Œè¿™æ ·çš„ç³»ç»Ÿå°±æ— æ³•å–å¾—ä»»ä½•è¿›å±•ã€‚åº”å¯¹è¿™ç§æƒ…å†µå¯ä»¥æœ‰ä¸‰ç§æ–¹æ³•ï¼š</p>
<blockquote>
<p>1ï¸âƒ£ç­‰å¾…é¢†å¯¼è€…æ¢å¤ï¼Œæ¥å—ç³»ç»Ÿå°†åœ¨è¿™æ®µæ—¶é—´é˜»å¡çš„äº‹å®ã€‚è®¸å¤šXA/JTAäº‹åŠ¡åè°ƒè€…é€‰æ‹©è¿™ä¸ªé€‰é¡¹ã€‚è¿™ç§æ–¹æ³•å¹¶ä¸èƒ½å®Œå…¨è¾¾æˆå…±è¯†ï¼Œå› ä¸ºå®ƒä¸èƒ½æ»¡è¶³<strong>ç»ˆæ­¢</strong>å±æ€§çš„è¦æ±‚ï¼šå¦‚æœé¢†å¯¼è€…ç»­å‘½å¤±è´¥ï¼Œç³»ç»Ÿå¯èƒ½ä¼šæ°¸ä¹…é˜»å¡</p>
<p>2ï¸âƒ£ äººå·¥æ•…éšœåˆ‡æ¢ï¼Œè®©äººç±»é€‰æ‹©ä¸€ä¸ªæ–°çš„é¢†å¯¼è€…èŠ‚ç‚¹ï¼Œå¹¶é‡æ–°é…ç½®ç³»ç»Ÿä½¿ä¹‹ç”Ÿæ•ˆï¼Œè®¸å¤šå…³ç³»å‹æ•°æ®åº“éƒ½é‡‡ç”¨è¿™ç§æ–¹æ–¹å¼ã€‚è¿™æ˜¯ä¸€ç§æ¥è‡ªâ€œå¤©æ„â€çš„å…±è¯† â€”â€” ç”±è®¡ç®—æœºç³»ç»Ÿä¹‹å¤–çš„è¿ç»´äººå‘˜åšå‡ºå†³å®šã€‚æ•…éšœåˆ‡æ¢çš„é€Ÿåº¦å—åˆ°äººç±»è¡ŒåŠ¨é€Ÿåº¦çš„é™åˆ¶ï¼Œé€šå¸¸è¦æ¯”è®¡ç®—æœºæ…¢å¾—å¤š</p>
<p>3ï¸âƒ£ ä½¿ç”¨ç®—æ³•è‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªæ–°çš„é¢†å¯¼è€…ã€‚è¿™ç§æ–¹æ³•éœ€è¦ä¸€ç§å…±è¯†ç®—æ³•ï¼Œä½¿ç”¨æˆç†Ÿçš„ç®—æ³•æ¥æ­£ç¡®å¤„ç†æ¶åŠ£çš„ç½‘ç»œæ¡ä»¶æ˜¯æ˜æ™ºä¹‹ä¸¾</p>
</blockquote>
<h1>æ‰¹å¤„ç†</h1>
<h2 id="å…³äºè¡ç”Ÿæ•°æ®">å…³äºè¡ç”Ÿæ•°æ®</h2>
<p>ç¬¬ä¸‰éƒ¨åˆ†çš„å†…å®¹ï¼Œä¸»è¦è®¨è®ºå°†å¤šä¸ªä¸åŒæ•°æ®ç³»ç»Ÿ(æœ‰ç€ä¸åŒçš„æ•°æ®æ¨¡å‹ï¼Œå¹¶é’ˆå¯¹ä¸åŒçš„è®¿é—®æ¨¡å¼è¿›è¡Œä¼˜åŒ–)é›†æˆä¸ºä¸€ä¸ªåè°ƒä¸€è‡´çš„åº”ç”¨æ¶æ„æ—¶ï¼Œä¼šé‡åˆ°çš„é—®é¢˜ã€‚ä»é«˜å±‚æ¬¡çœ‹ï¼Œå­˜å‚¨å’Œè®°å½•æ•°æ®ç³»ç»Ÿåˆ†ä¸º2å¤§ç±»ï¼š</p>
<p>ğŸ…°ï¸ è®°å½•ç³»ç»Ÿ(System of record) ï¼šæ•°æ®çš„æƒå¨ç‰ˆæœ¬(å¦‚æœå…¶ä»–ç³»ç»Ÿå’Œ<strong>è®°å½•ç³»ç»Ÿ</strong>ä¹‹é—´å­˜åœ¨ä»»ä½•å·®å¼‚ï¼Œé‚£ä¹ˆè®°å½•ç³»ç»Ÿä¸­çš„å€¼æ˜¯æ­£ç¡®çš„)</p>
<p>ğŸ…±ï¸ è¡ç”Ÿæ•°æ®ç³»ç»Ÿ(Derived data systems) ï¼šé€šå¸¸æ˜¯å¦ä¸€ä¸ªç³»ç»Ÿä¸­çš„ç°æœ‰æ•°æ®è¿›è¡Œè½¬æ¢æˆ–å¤„ç†çš„ç»“æœï¼Œå¦‚ç¼“å­˜ã€ç´¢å¼•ã€ç‰©åŒ–è§†å›¾ç­‰ï¼Œæ¨èç³»ç»Ÿä¸­ï¼Œé¢„æµ‹æ±‡æ€»æ•°æ®é€šå¸¸è¡ç”Ÿè‡ªç”¨æˆ·æ—¥å¿—</p>
<p>ä¸‰ç§ä¸åŒçš„æ•°æ®å¤„ç†ç³»ç»Ÿï¼š</p>
<p>1ï¸âƒ£ æœåŠ¡(åœ¨çº¿ç³»ç»Ÿ)</p>
<p>2ï¸âƒ£ æ‰¹å¤„ç†ç³»ç»Ÿ(ç¦»çº¿ç³»ç»Ÿ)</p>
<p>3ï¸âƒ£ æµå¤„ç†ç³»ç»Ÿ(å‡†å®æ—¶ç³»ç»Ÿ)</p>
<p>æµå¤„ç†å’Œæ‰¹å¤„ç†æœ€å…³é”®çš„åŒºåˆ«æ˜¯å¤„ç†æ— ç•Œæ•°æ®å’Œæœ‰ç•Œæ•°æ®</p>
<blockquote>
<p>MPPæ•°æ®åº“(å¤§è§„æ¨¡å¹¶è¡Œå¤„ç†(MPPï¼Œ massively parallel processing)ä¸“æ³¨äºåœ¨ä¸€ç»„æœºå™¨ä¸Šå¹¶è¡Œæ‰§è¡Œåˆ†æSQLæŸ¥è¯¢ï¼Œè€ŒMapReduceå’Œåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„ç»„åˆåˆ™æ›´åƒæ˜¯ä¸€ä¸ªå¯ä»¥è¿è¡Œä»»æ„ç¨‹åºçš„é€šç”¨æ“ä½œç³»ç»Ÿï¼Œæ‰¹å¤„ç†æ¡†æ¶çœ‹èµ·æ¥è¶Šæ¥è¶ŠåƒMPPæ•°æ®åº“äº†</p>
</blockquote>
<h2 id="UNIX">UNIX</h2>
<p>åŸºäºUnixçš„awkï¼Œsedï¼Œgrepï¼Œsortï¼Œuniqå’Œxargsç­‰å·¥å…·çš„ç»„åˆï¼Œå¯ä»¥è½»æ¾çš„å¸®åŠ©æˆ‘ä»¬å®Œæˆä¸€äº›æ•°æ®åˆ†æçš„å·¥ä½œï¼Œè€Œä¸”æ€§èƒ½ç›¸å½“çš„å¥½ã€‚è€Œä¸”ï¼Œè¿™äº›å·¥å…·ä½¿ç”¨ç›¸åŒçš„æ¥å£ï¼Œåœ¨Unixä¸­ï¼Œè¿™ç§æ¥å£æ˜¯ä¸€ä¸ªfile(å‡†ç¡®çš„è¯´æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦)</p>
<blockquote>
<p>æ–‡ä»¶æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œå¦‚æœæˆ‘ä»¬çš„ç¨‹åºçš„è¾“å…¥å’Œè¾“å‡ºéƒ½æ˜¯æ–‡ä»¶ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„ç¨‹åºç¼åˆèµ·æ¥ï¼Œåƒæ¥åŠ›ä¸€æ ·å®Œæˆå¤æ‚çš„å·¥ä½œï¼›ç»Ÿä¸€çš„æ¥å£è¿˜åŒ…æ‹¬URLå’ŒHTTP(æˆ‘ä»¬å¯ä»¥åœ¨ç½‘ç«™å’Œç½‘ç«™ä¹‹é—´æ— ç¼è·³è½¬)ã€‚è¿™å’Œå‡½æ•°å¼ç¼–ç¨‹çš„ç†å¿µéå¸¸ç±»ä¼¼</p>
</blockquote>
<p>Unixå·¥å…·å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯å…¶å±€é™æ€§å°±æ˜¯åªèƒ½åœ¨ä¸€å°æœºå™¨ä¸Šè¿è¡Œï¼Œæ‰€ä»¥Hadoopè¿™æ ·çš„å·¥å…·åº”è¿è€Œç”Ÿ</p>
<h2 id="MapReduce">MapReduce</h2>
<p>Unixå’ŒMapReduceæ¯”å¯¹</p>
<table>
<thead>
<tr>
<th>MR</th>
<th>é™¤äº†ç”Ÿæˆè¾“å‡ºæ²¡æœ‰å‰¯ä½œç”¨</th>
<th>ç®€å•ç²—æš´å´æœ‰æ•ˆ</th>
<th>åˆ†å¸ƒå¼</th>
<th>åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿä¸Šè¯»å†™æ–‡ä»¶</th>
<th>ä½¿ç”¨æ— å…±äº«æ¶æ„</th>
<th>é€šè¿‡å·¥ä½œæµ(workflow)å°†å¤šä¸ªMRä½œä¸šè¿æ¥åœ¨ä¸€èµ·ï¼Œæ–‡ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unix</td>
<td>é™¤äº†ç”Ÿæˆè¾“å‡ºæ²¡æœ‰å‰¯ä½œç”¨</td>
<td>ç®€å•ç²—æš´å´æœ‰æ•ˆ</td>
<td>å•æœº</td>
<td>ä½¿ç”¨<code>stdin</code>å’Œ<code>stdout</code>ä½œä¸ºè¾“å…¥è¾“å‡º</td>
<td>å…±äº«æ¶æ„</td>
<td>ç®¡é“ç¬¦ï¼Œå†…å­˜ç¼“å­˜åŒº<sup class="footnote-ref"><a href="#fn19" id="fnref19">[19]</a></sup></td>
</tr>
</tbody>
</table>
<blockquote></blockquote>
<p>MapReduceæ˜¯ä¸€ä¸ªç¼–ç¨‹æ¡†æ¶ï¼Œå¯ä»¥ä½¿ç”¨å®ƒç¼–å†™ä»£ç å¤„ç†HDFSç­‰åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿä¸­çš„å¤§å‹æ•°æ®é›†ï¼Œå¹¶ä¸”éµå¾ª<em>ç§»åŠ¨è®¡ç®—å¤§äºç§»åŠ¨æ•°æ®çš„åŸåˆ™</em>ã€‚MapReduceçš„æ•°æ®å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ï¸âƒ£ è¯»å–ä¸€ç»„è¾“å…¥æ–‡ä»¶ï¼Œå¹¶å°†å…¶åˆ†è§£æˆè®°å½•(records)</p>
<p>2ï¸âƒ£ è°ƒç”¨Mapperå‡½æ•°ï¼Œä»æ¯æ¡è¾“å…¥è®°å½•ä¸­æå–ä¸€å¯¹é”®å€¼ï¼›mapçš„ä»»åŠ¡æ•°ç”±è¾“å…¥æ–‡ä»¶å—çš„æ•°é‡å†³å®š</p>
<p>3ï¸âƒ£ æŒ‰é”®æ’åºæ‰€æœ‰çš„é”®å€¼å¯¹</p>
<p>4ï¸âƒ£ è°ƒç”¨Reducerå‡½æ•°éå†æ’åºåçš„é”®å€¼å¯¹ï¼Œç›¸åŒçš„keyï¼Œå°†ä¼šåœ¨reducerä¸­ç›¸é‚»ï¼›reduceçš„ä»»åŠ¡æ•°é‡æ˜¯å¯é…ç½®çš„</p>
<p>å…¶ä¸­ç¬¬2ï¸âƒ£4ï¸âƒ£æ­¥æ˜¯è‡ªå®šä¹‰æ•°æ®å¤„ç†ä»£ç çš„åœ°æ–¹ï¼Œç¬¬3ï¸âƒ£æ­¥Mapperçš„è¾“å‡ºå§‹ç»ˆåœ¨é€å¾€Reducerä¹‹å‰è¿›è¡Œæ’åºï¼Œæ— é¡»ç¼–å†™ã€‚ä¸‹å›¾æ˜¯ä¸ªä¸‰ä¸ªMapperå’Œä¸‰ä¸ªReducerçš„MRä»»åŠ¡ï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/42.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
<p>Mapperä¸­çš„æ•°æ®å»å¾€Reducerçš„è¿‡ç¨‹å¯ä»¥çœ‹åšæ˜¯Mapperå°†æ¶ˆæ¯å‘é€ç»™Reducerï¼Œæ¯å½“Mapperå‘å‡ºä¸€ä¸ªé”®å€¼å¯¹ï¼Œè¿™ä¸ªé”®çš„ä½œç”¨å°±å¥½åƒæ˜¯å»å¾€åˆ°ç›®æ ‡åœ°å€(IPåœ°å€)</p>
<h2 id="Reducerç«¯è”æ¥ï¼š">Reducerç«¯è”æ¥ï¼š</h2>
<p>å¦‚ä¸‹å›¾ï¼Œå·¦ä¾§æ˜¯äº‹ä»¶æ—¥å¿—ï¼Œå³ä¾§æ˜¯ç”¨æˆ·æ•°æ®åº“ï¼Œä»»åŠ¡éœ€è¦å°†ç”¨æˆ·æ´»åŠ¨å’Œç”¨æˆ·æ¡£æ¡ˆç›¸å…³è”ï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/43.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
æ•´ä¸ªè¿æ¥çš„MapReduceè¿‡ç¨‹å¦‚ä¸‹:
<p align="center">
  <img src="/2023/09/21/ddia/44.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
MapReduceæ¡†æ¶é€šè¿‡é”®å¯¹Mapperè¾“å‡ºè¿›è¡Œåˆ†åŒºï¼Œç„¶åå¯¹é”®å€¼å¯¹è¿›è¡Œæ’åºï¼Œä½¿å¾—å…·æœ‰ç›¸åŒIDçš„æ‰€æœ‰æ´»åŠ¨äº‹ä»¶å’Œç”¨æˆ·è®°å½•åœ¨Reducerè¾“å…¥ä¸­å½¼æ­¤ç›¸é‚»ã€‚ Map-Reduceä½œä¸šå¯ä»¥è¿›ä¸€æ­¥è®©è¿™äº›è®°å½•æ’åºï¼Œä½¿Reduceræ€»èƒ½å…ˆçœ‹åˆ°æ¥è‡ªç”¨æˆ·æ•°æ®åº“çš„è®°å½•ï¼Œç´§æ¥ç€æ˜¯æŒ‰æ—¶é—´æˆ³é¡ºåºæ’åºçš„æ´»åŠ¨äº‹ä»¶(äºŒæ¬¡æ’åº/secondary sort)
<p>ç„¶åReducerå¯ä»¥æ‰§è¡Œå®é™…çš„è¿æ¥é€»è¾‘ï¼šæ¯ä¸ªç”¨æˆ·IDéƒ½ä¼šè¢«è°ƒç”¨ä¸€æ¬¡Reducerå‡½æ•°ï¼Œä¸”å› ä¸ºäºŒæ¬¡æ’åºï¼Œç¬¬ä¸€ä¸ªå€¼åº”è¯¥æ˜¯æ¥è‡ªç”¨æˆ·æ•°æ®åº“çš„å‡ºç”Ÿæ—¥æœŸè®°å½•ã€‚ Reducerå°†å‡ºç”Ÿæ—¥æœŸå­˜å‚¨åœ¨å±€éƒ¨å˜é‡ä¸­ï¼Œç„¶åä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·IDéå†æ´»åŠ¨äº‹ä»¶ï¼Œè¾“å‡ºå·²è§‚çœ‹ç½‘å€å’Œè§‚çœ‹è€…å¹´é¾„çš„ç»“æœå¯¹ã€‚éšåçš„Map-Reduceä½œä¸šå¯ä»¥è®¡ç®—æ¯ä¸ªURLçš„æŸ¥çœ‹è€…å¹´é¾„åˆ†å¸ƒï¼Œå¹¶æŒ‰å¹´é¾„æ®µè¿›è¡Œèšé›†</p>
<p>å› ä¸ºMapperçš„è¾“å‡ºæ˜¯æŒ‰é”®æ’åºçš„ï¼Œç„¶åReducerå°†æ¥è‡ªè¿æ¥ä¸¤ä¾§çš„æœ‰åºè®°å½•åˆ—è¡¨åˆå¹¶åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥è¿™ä¸ªç®—æ³•è¢«ç§°ä¸ºæ’åºåˆå¹¶è¿æ¥(sort-merge join)</p>
<p>MapReduceå®ç°è¿™åˆ†ç»„æ“ä½œçš„æ–¹æ³•æ˜¯è®¾ç½®Mapperï¼Œä½¿å¾—Mapperç”Ÿæˆçš„é”®å€¼å¯¹ä½¿ç”¨æ‰€éœ€çš„åˆ†ç»„é”®</p>
<blockquote>
<p>çƒ­é”®(hot pot)å’Œå€¾æ–œè¿æ¥(skewed join) ï¼š çƒ­é”®æ˜¯æŒ‡è®°å½•ä¸­æŸä¸ªé”®è®°å½•æ•°æ˜¾è‘—é«˜äºå…¶ä»–çš„é”®ï¼Œçƒ­é”®å…³è”æ˜¯ä¼šäº§ç”Ÿå€¾æ–œå…³è”(1ä¸ªReducerä¼šå¤„ç†æ¯”å…¶ä»–Reduceræ›´å¤šçš„è®°å½•)ï¼›ä¸€èˆ¬å¤„ç†å€¾æ–œè¿æ¥æ–¹å¼æ˜¯åˆ†2æ¬¡MR</p>
</blockquote>
<h2 id="Mapç«¯è”æ¥ï¼š">Mapç«¯è”æ¥<sup class="footnote-ref"><a href="#fn20" id="fnref20">[20]</a></sup>ï¼š</h2>
<p>åœ¨Reducerç«¯è¿æ¥ä¸­ï¼Œæ’åºï¼Œå¤åˆ¶è‡³Reducerï¼Œä»¥åŠåˆå¹¶Reducerè¾“å…¥ï¼Œæ‰€æœ‰è¿™äº›æ“ä½œå¯èƒ½å¼€é”€å·¨å¤§ï¼Œå¦‚æœæ•°æ®å…·å¤‡æŸäº›ç‰¹æ€§ï¼Œæˆ–è®¸å¯ä»¥ä½¿ç”¨ä¸€äº›æ€§èƒ½æ›´ä¼˜çš„è¿æ¥æ–¹å¼ï¼Œå¦‚ï¼š</p>
<p>1ï¸âƒ£å¹¿æ’­æ•£åˆ—è¿æ¥ï¼šåœ¨å°è¡¨è¶³å¤Ÿå°çš„æƒ…å†µä¸‹ï¼Œå°†å°è¡¨è¯»å–åˆ°å†…å­˜æ•£åˆ—è¡¨ä¸­ï¼Œç„¶åMapperæ‰«æå¤§è¡¨åœ¨æ•£åˆ—è¡¨ä¸­æŸ¥æ‰¾æ¯ä¸ªäº‹ä»¶</p>
<p>2ï¸âƒ£ åˆ†åŒºæ•£åˆ—è¿æ¥ï¼šæœ¬è´¨æ˜¯GRACE Hash Joinï¼Œåœ¨Hiveä¸­å«åšï¼šMap ç«¯æ¡¶è¿æ¥</p>
<p>3ï¸âƒ£ Mapç«¯åˆå¹¶è¿æ¥ï¼šæœ¬è´¨æ˜¯ sort-merge-join</p>
<blockquote></blockquote>
<p>æ‰¹å¤„ç†çš„å¸¸è§ç”¨é€”æ˜¯ï¼šæ„å»ºæœºå™¨å­¦ä¹ ç³»ç»Ÿ(åˆ†ç±»å™¨/æ¨èç³»ç»Ÿç­‰)ï¼Œå»ºç«‹æœç´¢ç´¢å¼•(googleæœ€åˆä½¿ç”¨MRå°±æ˜¯ä¸ºå…¶æœç´¢ç´¢å¼•å»ºç«‹ç´¢å¼•)ï¼Œæ‰¹å¤„ç†çš„è¾“å‡ºå“²å­¦å’ŒUnixä¸€è‡´ï¼Œé™¤äº†äº§ç”Ÿè¾“å‡ºä¸ä¼šäº§ç”Ÿä»»ä½•å‰¯ä½œç”¨ï¼Œå³å®¹é”™èƒ½åŠ›é«˜</p>
<h2 id="Hadoopä¸åˆ†å¸ƒå¼æ•°æ®åº“æ¯”å¯¹">Hadoopä¸åˆ†å¸ƒå¼æ•°æ®åº“æ¯”å¯¹</h2>
<p>Hadoopå¾ˆåƒUnixçš„åˆ†å¸ƒå¼ç‰ˆæœ¬ï¼Œå…¶ä¸­HDFSæ˜¯åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼ŒMapReduceæ˜¯Unixè¿›ç¨‹çš„å˜ç§å®ç°ï¼Œæˆ‘ä»¬ä¸€ç›´è®¨è®ºçš„å¹¶è¡Œè¿æ¥ç®—æ³•åœ¨MPPæ•°æ®åº“ä¸­å·²æœ‰å®ç°ï¼ŒåŒºåˆ«åœ¨äºMPPæ•°æ®åº“ä¸“æ³¨äºåœ¨ä¸€ç»„æœºå™¨ä¸Šå¹¶è¡Œæ‰§è¡Œåˆ†æSQLï¼Œè€ŒMapReduceå’Œåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„ç»„åˆæ›´åƒæ˜¯å¯ä»¥è¿è¡Œä»»æ„é€šç”¨ç¨‹åºçš„æ“ä½œç³»ç»Ÿ</p>
<table>
<thead>
<tr>
<th></th>
<th>å­˜å‚¨å¤šæ ·æ€§</th>
<th>å¤„ç†æ¨¡å‹</th>
<th>æ•…éšœå¤„ç†</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hadoop</td>
<td>å­—èŠ‚åºåˆ—</td>
<td>MapReduceæ¨¡å‹ï¼ŒSQLæ¨¡å‹ç­‰<br>å¤„ç†æ¨¡å‹å¤šæ ·æ€§<sup class="footnote-ref"><a href="#fn21" id="fnref21">[21]</a></sup></td>
<td>é’ˆå¯¹æ•…éšœé¢‘ç¹è€Œè®¾è®¡<sup class="footnote-ref"><a href="#fn22" id="fnref22">[22]</a></sup></td>
</tr>
<tr>
<td>åˆ†å¸ƒå¼æ•°æ®åº“</td>
<td>è¦æ±‚ç‰¹å®šçš„æ¨¡å‹(å…³ç³»/æ–‡æ¡£)</td>
<td>SQLæ¨¡å‹<sup class="footnote-ref"><a href="#fn23" id="fnref23">[23]</a></sup></td>
<td>æŸ¥è¯¢å¤±æ•ˆæ—¶ï¼Œå¤šæ•°MPPä¼šç»ˆæ­¢æŸ¥è¯¢</td>
</tr>
</tbody>
</table>
<blockquote></blockquote>
<p>ğŸ’”ï¼šä½¿ç”¨åŸå§‹çš„<code>MapReduce API</code>æ¥å®ç°å¤æ‚çš„å¤„ç†å·¥ä½œå®é™…ä¸Šæ˜¯éå¸¸å›°éš¾ï¼Œæ‰€ä»¥åœ¨MapReduceä¸Šæœ‰å¾ˆå¤šé«˜çº§ç¼–ç¨‹æ¨¡å‹(Pigï¼ŒHiveï¼ŒCascadingï¼ŒCrunch)è¢«åˆ›é€ å‡ºæ¥ã€‚ğŸ…°ï¸æ–¹é¢ï¼ŒMapReduceéå¸¸ç¨³å¥ï¼›ğŸ…±ï¸æ–¹é¢ï¼Œå¯¹äºæŸäº›ç±»å‹çš„å¤„ç†è€Œè¨€ï¼Œå…¶ä»–å·¥å…·æœ‰æ—¶ä¼šå¿«ä¸Šå‡ ä¸ªæ•°é‡çº§ã€‚æµå¤„ç†ç»„ä»¶(stormã€sparkã€flink)å¯ä»¥è®¤ä¸ºæ˜¯è§£å†³"æ…¢"è¿™ä¸ªé—®é¢˜è€Œè¢«å‘å±•å‡ºæ¥çš„ï¼Œç‰©åŒ–ä¸­é—´çŠ¶æ€ä¹Ÿæ˜¯ä¸€ç§åŠ é€Ÿæ–¹å¼</p>
<h2 id="ç‰©åŒ–ä¸­é—´çŠ¶æ€">ç‰©åŒ–ä¸­é—´çŠ¶æ€</h2>
<p>å°†æ•°æ®å‘å¸ƒåˆ°åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿä¸­ä¼—æ‰€å‘¨çŸ¥çš„ä½ç½®èƒ½å¤Ÿå¸¦æ¥<strong>æ¾è€¦åˆ</strong>ï¼Œè¿™æ ·ä½œä¸šå°±ä¸éœ€è¦çŸ¥é“æ˜¯è°åœ¨æä¾›è¾“å…¥æˆ–è°åœ¨æ¶ˆè´¹è¾“å‡ºï¼Œä¸€ä¸ªä½œä¸šçš„è¾“å‡ºåªèƒ½ç”¨ä½œå¦ä¸€ä¸ªä½œä¸šçš„è¾“å…¥çš„æƒ…å†µä¸‹ï¼Œåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶åªæ˜¯ç®€å•çš„<strong>ä¸­é—´çŠ¶æ€(intermediate state)</strong>ï¼šä¸€ç§å°†æ•°æ®ä»ä¸€ä¸ªä½œä¸šä¼ é€’åˆ°ä¸‹ä¸€ä¸ªä½œä¸šçš„æ–¹å¼ã€‚å°†è¿™ä¸ªä¸­é—´çŠ¶æ€å†™å…¥æ–‡ä»¶çš„è¿‡ç¨‹ç§°ä¸º<strong>ç‰©åŒ–(materialization)</strong>[<sup>22][</sup>23]</p>
<blockquote>
<p>link: <a href="https://en.wikipedia.org/wiki/Materialized_view">https://en.wikipedia.org/wiki/Materialized_view</a> + <a href="https://stackoverflow.com/questions/93539/what-is-the-difference-between-views-and-materialized-views-in-oracle">https://stackoverflow.com/questions/93539/what-is-the-difference-between-views-and-materialized-views-in-oracle</a> + <a href="https://en.wikipedia.org/wiki/Materialized_view">https://en.wikipedia.org/wiki/Materialized_view</a></p>
</blockquote>
<p>ğŸ’”ï¼šUnixç®¡é“å°†ä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºä¸å¦ä¸€ä¸ªå‘½ä»¤çš„è¾“å…¥è¿æ¥èµ·æ¥ã€‚ç®¡é“å¹¶æ²¡æœ‰å®Œå…¨ç‰©åŒ–ä¸­é—´çŠ¶æ€ï¼Œè€Œæ˜¯åªä½¿ç”¨ä¸€ä¸ªå°çš„å†…å­˜ç¼“å†²åŒºï¼Œå°†è¾“å‡ºå¢é‡åœ°**æµ(stream)**å‘è¾“å…¥ï¼Œä¸Unixç®¡é“ç›¸æ¯”ï¼ŒMapReduceå®Œå…¨ç‰©åŒ–ä¸­é—´çŠ¶æ€çš„æ–¹æ³•çš„ä¸è¶³ä¹‹å¤„åœ¨äºï¼š</p>
<p>1ï¸âƒ£MapReduceä½œä¸šåªæœ‰åœ¨å‰é©±ä½œä¸š(ç”Ÿæˆå…¶è¾“å…¥)ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆæ—¶æ‰èƒ½å¯åŠ¨ï¼Œè€Œç”±Unixç®¡é“è¿æ¥çš„è¿›ç¨‹ä¼šåŒæ—¶å¯åŠ¨ï¼Œè¾“å‡ºä¸€æ—¦ç”Ÿæˆå°±ä¼šè¢«æ¶ˆè´¹</p>
<p>2ï¸âƒ£ Mapperé€šå¸¸æ˜¯å¤šä½™çš„ï¼Œå¦‚æœReducerå’ŒMapperçš„è¾“å‡ºæœ‰ç€ç›¸åŒçš„åˆ†åŒºä¸æ’åºæ–¹å¼ï¼Œé‚£ä¹ˆReducerå°±å¯ä»¥ç›´æ¥ä¸²åœ¨ä¸€èµ·ï¼Œè€Œä¸ç”¨ä¸Mapperç›¸äº’äº¤ç»‡</p>
<p>3ï¸âƒ£ å°†ä¸­é—´çŠ¶æ€å­˜å‚¨åœ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿä¸­æ„å‘³ç€è¿™äº›æ–‡ä»¶è¢«å¤åˆ¶åˆ°å¤šä¸ªèŠ‚ç‚¹</p>
<h2 id="æ•°æ®æµå¼•æ“">æ•°æ®æµå¼•æ“</h2>
<p>ä¸ºäº†è§£å†³MapReduceçš„è¿™äº›é—®é¢˜ï¼Œå‡ ç§ç”¨äºåˆ†å¸ƒå¼æ‰¹å¤„ç†çš„æ–°æ‰§è¡Œå¼•æ“(Sparkã€Tezã€Flink)è¢«å¼€å‘å‡ºæ¥ï¼Œå®ƒä»¬çš„è®¾è®¡æ–¹å¼æœ‰å¾ˆå¤šåŒºåˆ«ï¼Œä½†æœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼šæŠŠæ•´ä¸ªå·¥ä½œæµä½œä¸ºå•ä¸ªä½œä¸šæ¥å¤„ç†ï¼Œè€Œä¸æ˜¯æŠŠå®ƒåˆ†è§£ä¸ºç‹¬ç«‹çš„å­ä½œä¸šã€‚ç”±äºå®ƒä»¬å°†å·¥ä½œæµæ˜¾å¼å»ºæ¨¡ä¸ºæ•°æ®ä»å‡ ä¸ªå¤„ç†é˜¶æ®µç©¿è¿‡ï¼Œæ‰€ä»¥è¿™äº›ç³»ç»Ÿè¢«ç§°ä¸º<strong>æ•°æ®æµå¼•æ“(dataflow engines)</strong>ï¼ŒåƒMapReduceä¸€æ ·ï¼Œå®ƒä»¬åœ¨ä¸€æ¡çº¿ä¸Šé€šè¿‡åå¤è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„å‡½æ•°æ¥ä¸€æ¬¡å¤„ç†ä¸€æ¡è®°å½•ï¼Œè¿™äº›å‡½æ•°ä¸º<strong>ç®—å­(operators)</strong>ï¼Œæ•°æ®æµå¼•æ“æä¾›äº†å‡ ç§ä¸åŒçš„é€‰é¡¹æ¥å°†ä¸€ä¸ªç®—å­çš„è¾“å‡ºè¿æ¥åˆ°å¦ä¸€ä¸ªç®—å­çš„è¾“å…¥ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>ä¸€ç§é€‰é¡¹æ˜¯å¯¹è®°å½•æŒ‰é”®é‡æ–°åˆ†åŒºå¹¶æ’åºï¼Œå°±åƒåœ¨MapReduceçš„æ··æ´—é˜¶æ®µä¸€æ ·ã€‚è¿™ç§åŠŸèƒ½å¯ä»¥ç”¨äºå®ç°æ’åºåˆå¹¶è¿æ¥å’Œåˆ†ç»„</p>
</li>
<li class="lvl-2">
<p>å¦ä¸€ç§å¯èƒ½æ˜¯æ¥å—å¤šä¸ªè¾“å…¥ï¼Œå¹¶ä»¥ç›¸åŒçš„æ–¹å¼è¿›è¡Œåˆ†åŒºï¼Œä½†è·³è¿‡æ’åºã€‚å½“è®°å½•çš„åˆ†åŒºé‡è¦ä½†é¡ºåºæ— å…³ç´§è¦æ—¶ï¼Œè¿™çœå»äº†åˆ†åŒºæ•£åˆ—è¿æ¥çš„å·¥ä½œï¼Œå› ä¸ºæ„å»ºæ•£åˆ—è¡¨è¿˜æ˜¯ä¼šæŠŠé¡ºåºéšæœºæ‰“ä¹±</p>
</li>
<li class="lvl-2">
<p>å¯¹äºå¹¿æ’­æ•£åˆ—è¿æ¥ï¼Œå¯ä»¥å°†ä¸€ä¸ªç®—å­çš„è¾“å‡ºï¼Œå‘é€åˆ°è¿æ¥ç®—å­çš„æ‰€æœ‰åˆ†åŒº</p>
</li>
</ul>
<p>ä¸MapReduceæ¨¡å‹ç›¸æ¯”ï¼Œå®ƒæœ‰å‡ ä¸ªä¼˜ç‚¹ï¼š</p>
<p>1ï¸âƒ£æ’åºç­‰æ˜‚è´µçš„å·¥ä½œåªéœ€è¦åœ¨å®é™…éœ€è¦çš„åœ°æ–¹æ‰§è¡Œï¼Œè€Œä¸æ˜¯é»˜è®¤åœ°åœ¨æ¯ä¸ªMapå’ŒReduceé˜¶æ®µä¹‹é—´å‡ºç°</p>
<p>2ï¸âƒ£æ²¡æœ‰ä¸å¿…è¦çš„Mapä»»åŠ¡ï¼Œå› ä¸ºMapperæ‰€åšçš„å·¥ä½œé€šå¸¸å¯ä»¥åˆå¹¶åˆ°å‰é¢çš„Reduceç®—å­ä¸­(å› ä¸ºMapperä¸ä¼šæ›´æ”¹æ•°æ®é›†çš„åˆ†åŒº)</p>
<p>3ï¸âƒ£ç”±äºå·¥ä½œæµä¸­çš„æ‰€æœ‰è¿æ¥å’Œæ•°æ®ä¾èµ–éƒ½æ˜¯æ˜¾å¼å£°æ˜çš„ï¼Œå› æ­¤è°ƒåº¦ç¨‹åºèƒ½å¤Ÿæ€»è§ˆå…¨å±€ï¼ŒçŸ¥é“å“ªé‡Œéœ€è¦å“ªäº›æ•°æ®ï¼Œå› è€Œèƒ½å¤Ÿåˆ©ç”¨å±€éƒ¨æ€§è¿›è¡Œä¼˜åŒ–ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥å°è¯•å°†æ¶ˆè´¹æŸäº›æ•°æ®çš„ä»»åŠ¡æ”¾åœ¨ä¸ç”Ÿæˆè¿™äº›æ•°æ®çš„ä»»åŠ¡ç›¸åŒçš„æœºå™¨ä¸Šï¼Œä»è€Œæ•°æ®å¯ä»¥é€šè¿‡å…±äº«å†…å­˜ç¼“å†²åŒºä¼ è¾“ï¼Œè€Œä¸å¿…é€šè¿‡ç½‘ç»œå¤åˆ¶</p>
<p>4ï¸âƒ£é€šå¸¸ï¼Œç®—å­é—´çš„ä¸­é—´çŠ¶æ€è¶³ä»¥ä¿å­˜åœ¨å†…å­˜ä¸­æˆ–å†™å…¥æœ¬åœ°ç£ç›˜ï¼Œè¿™æ¯”å†™å…¥HDFSéœ€è¦æ›´å°‘çš„I/O(å¿…é¡»å°†å…¶å¤åˆ¶åˆ°å¤šå°æœºå™¨ï¼Œå¹¶å°†æ¯ä¸ªå‰¯æœ¬å†™å…¥ç£ç›˜)ã€‚ MapReduceå·²ç»å¯¹Mapperçš„è¾“å‡ºåšäº†è¿™ç§ä¼˜åŒ–ï¼Œä½†æ•°æ®æµå¼•æ“å°†è¿™ç§æ€æƒ³æ¨å¹¿è‡³æ‰€æœ‰çš„ä¸­é—´çŠ¶æ€</p>
<p>5ï¸âƒ£ ç®—å­å¯ä»¥åœ¨è¾“å…¥å°±ç»ªåç«‹å³å¼€å§‹æ‰§è¡Œï¼›åç»­é˜¶æ®µæ— éœ€ç­‰å¾…å‰é©±é˜¶æ®µæ•´ä¸ªå®Œæˆåå†å¼€å§‹</p>
<p>6ï¸âƒ£ ä¸MapReduce(ä¸ºæ¯ä¸ªä»»åŠ¡å¯åŠ¨ä¸€ä¸ªæ–°çš„JVM)ç›¸æ¯”ï¼Œç°æœ‰Javaè™šæ‹Ÿæœº(JVM)è¿›ç¨‹å¯ä»¥é‡ç”¨æ¥è¿è¡Œæ–°ç®—å­ï¼Œä»è€Œå‡å°‘å¯åŠ¨å¼€é”€</p>
<p>ä½ å¯ä»¥ä½¿ç”¨æ•°æ®æµå¼•æ“æ‰§è¡Œä¸MapReduceå·¥ä½œæµåŒæ ·çš„è®¡ç®—ï¼Œè€Œä¸”ç”±äºæ­¤å¤„æ‰€è¿°çš„ä¼˜åŒ–ï¼Œé€šå¸¸æ‰§è¡Œé€Ÿåº¦è¦æ˜æ˜¾å¿«å¾—å¤šã€‚ç›¸åŒçš„å¤„ç†é€»è¾‘ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®åˆ‡æ¢åº•å±‚è®¡ç®—å¼•æ“ï¼Œç®€å•åœ°ä»MapReduceåˆ‡æ¢åˆ°Tezæˆ–Spark<sup class="footnote-ref"><a href="#fn24" id="fnref24">[24]</a></sup></p>
<blockquote></blockquote>
<h2 id="æ€»ç»“-3">æ€»ç»“</h2>
<p>æœ¬ç« ä¸»è¦è®²è¿°äº†Unixçš„ç®¡é“æ€æƒ³ï¼ŒMapReduceä¸å…¶æ¥å£HDFSï¼Œæœ€åæ˜¯æ•°æ®æµå¼•æ“æ„å»ºè‡ªå·±çš„ç®¡é“å¼çš„æ•°æ®ä¼ è¾“æœºåˆ¶ã€‚å¹¶ä¸”è¿˜è®¨è®ºäº†åˆ†å¸ƒå¼æ‰¹å¤„ç†æ¡†æ¶è¦è§£å†³çš„2ä¸ªä¸»è¦é—®é¢˜ï¼š</p>
<p>ğŸ…°ï¸ åˆ†åŒºï¼šè¿™ä¸€è¿‡ç¨‹çš„ç›®çš„æ˜¯æŠŠæ‰€æœ‰çš„<strong>ç›¸å…³</strong>æ•°æ®(ä¾‹å¦‚å¸¦æœ‰ç›¸åŒé”®çš„æ‰€æœ‰è®°å½•)éƒ½æ”¾åœ¨åŒä¸€ä¸ªåœ°æ–¹</p>
<p>ğŸ…±ï¸å®¹é”™ï¼šMapReduceç»å¸¸å†™å…¥ç£ç›˜ï¼Œè¿™ä½¿å¾—ä»å•ä¸ªå¤±è´¥çš„ä»»åŠ¡æ¢å¤å¾ˆè½»æ¾ï¼Œæ— éœ€é‡æ–°å¯åŠ¨æ•´ä¸ªä½œä¸šï¼Œä½†åœ¨æ— æ•…éšœçš„æƒ…å†µä¸‹å‡æ…¢äº†æ‰§è¡Œé€Ÿåº¦ã€‚æ•°æ®æµå¼•æ“æ›´å¤šåœ°å°†ä¸­é—´çŠ¶æ€ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ›´å°‘åœ°ç‰©åŒ–ä¸­é—´çŠ¶æ€ï¼Œè¿™æ„å‘³ç€å¦‚æœèŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œåˆ™éœ€è¦é‡ç®—æ›´å¤šçš„æ•°æ®ã€‚ç¡®å®šæ€§ç®—å­å‡å°‘äº†éœ€è¦é‡ç®—çš„æ•°æ®é‡</p>
<h1>æµå¤„ç†</h1>
<p>æµå¤„ç†å’Œæ‰¹å¤„ç†æœ€åŸå§‹çš„åŒºåˆ«åœ¨äºï¼Œæµå¤„ç†å¤„ç†æ— ç•Œæ•°æ®ï¼Œè€Œæ‰¹å¤„ç†é’ˆå¯¹æœ‰ç•Œæ•°æ®ã€‚åœ¨æµå¤„ç†ä¸­çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè®°å½•é€šå¸¸è¢«å«åš<strong>äº‹ä»¶</strong>ï¼Œä¸€ä¸ªäº‹ä»¶ç”±ç”Ÿäº§è€…(producer)/å‘å¸ƒè€…(publisher)/å‘é€è€…(sender)ç”Ÿæˆä¸€æ¬¡ï¼Œç„¶åå¯èƒ½ç”±å¤šä¸ªæ¶ˆè´¹è€…(consumer)/è®¢é˜…è€…(subscribers)/æ¥æ”¶è€…(recipients)è¿›è¡Œå¤„ç†ã€‚æµå¤„ç†çš„ç›®æ ‡æ˜¯<strong>äº‹ä»¶å‘ç”Ÿåï¼Œç«‹åˆ»å¾—åˆ°å¤„ç†</strong>ã€‚æµå¤„ç†ä¸­ç›¸å…³çš„äº‹ä»¶é€šå¸¸è¢«èšåˆä¸ºä¸€ä¸ªä¸»é¢˜(topic)æˆ–æµ(stream)</p>
<p>æœ¬è´¨ä¸Šæ¥è¯´ï¼Œæ–‡ä»¶æˆ–è€…æ˜¯æ•°æ®åº“å¯ä»¥è¿æ¥ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ä¸‹æ¶ˆè´¹è€…éœ€è¦ä¸æ–­é™ä½è½®è¯¢æ–‡ä»¶/æ•°æ®åº“çš„é—´éš”ï¼Œæ‰èƒ½é™ä½äº‹ä»¶å¤„ç†çš„å»¶è¿Ÿï¼Œè€Œè½®è¯¢ä¼šå¢åŠ æ•°æ®åº“çš„é¢å¤–å¼€é”€ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æœ‰æ–°çš„äº‹ä»¶äº§ç”Ÿçš„æ—¶å€™ï¼Œèƒ½å¤Ÿé€šçŸ¥åˆ°æ¶ˆè´¹è€…ï¼Œæ•°æ®åº“çš„è§¦å‘å™¨æˆ–è®¸æ˜¯ä¸€ä¸ªå¯é€‰é¡¹ï¼Œä½†æ˜¯è§¦å‘å™¨åŠŸèƒ½æœ‰é™ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¶ˆæ¯ç³»ç»Ÿåº”è¿è€Œç”Ÿ</p>
<blockquote>
<p>2ä¸ªè¿›ç¨‹ä¹‹é—´è¿›è¡Œæ¶ˆæ¯ä¼ é€’(é€šä¿¡)ï¼Œå¯ä»¥é€šè¿‡æ¥å£è°ƒç”¨ï¼Œè¿˜å¯ä»¥ä½¿ç”¨æ¶ˆæ¯æœåŠ¡</p>
</blockquote>
<h2 id="æ¶ˆæ¯ç³»ç»Ÿ">æ¶ˆæ¯ç³»ç»Ÿ</h2>
<p>æ¶ˆæ¯ç³»ç»Ÿä¸€å®šè¦è€ƒè™‘2ä¸ªé—®é¢˜ï¼š</p>
<p>ğŸ…°ï¸ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„é€Ÿåº¦æ¯”æ¶ˆè´¹è€…èƒ½å¤Ÿå¤„ç†çš„é€Ÿåº¦å¿«è¯¥å¦‚ä½•åº”å¯¹ï¼Ÿæœ‰ä¸‰ç§æ–¹å¼å¤„ç†ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>1ï¸âƒ£ä¸¢æ‰æ¶ˆæ¯</p>
</li>
<li class="lvl-2">
<p>2ï¸âƒ£å°†æ¶ˆæ¯æ”¾å…¥ç¼“å†²é˜Ÿåˆ—</p>
</li>
<li class="lvl-2">
<p>3ï¸âƒ£ èƒŒå‹æœºåˆ¶(backpressure)/æµé‡æ§åˆ¶(flow control)ï¼šå³ä¸ºé˜»å¡ç”Ÿäº§è€…ï¼Œé¿å…å…¶å‘é€æ›´å¤šçš„æ¶ˆæ¯<sup class="footnote-ref"><a href="#fn25" id="fnref25">[25]</a></sup></p>
</li>
</ul>
<blockquote></blockquote>
<p>ğŸ…±ï¸ å¦‚æœèŠ‚ç‚¹å´©æºƒæˆ–çŸ­æš‚è„±æœºï¼Œæ˜¯å¦ä¼šæœ‰æ¶ˆæ¯ä¸¢å¤±ï¼Ÿä¹Ÿå³<strong>æŒä¹…æ€§</strong>è¦æ±‚</p>
<p>æ‰¹å¤„ç†çš„ä¸€ä¸ªä¼˜è‰¯çš„ç‰¹æ€§æ˜¯ï¼Œå®ƒæä¾›äº†å¼ºå¤§çš„å¯é æ€§ä¿è¯ï¼šå¤±è´¥çš„ä»»åŠ¡ä¼šè‡ªåŠ¨é‡è¯•ï¼Œä¸”å¤±è´¥ä»»åŠ¡çš„è¾“å‡ºä¼šè‡ªåŠ¨ä¸¢å¼ƒã€‚è¿™æ„å‘³ç€å¥½åƒæ•…éšœæ²¡æœ‰å‘ç”Ÿä¸€æ ·ï¼Œæˆ‘ä»¬å°è¯•âš ï¸<em>åœ¨æµå¤„ç†ä¸­è¾¾åˆ°ç±»ä¼¼çš„ä¿è¯</em>ã€‚æœ‰äº›æ¶ˆæ¯ç³»ç»Ÿæ˜¯ç›´è¿ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œæ¯”å¦‚ä½¿ç”¨UDPè¿æ¥çš„åº”ç”¨ï¼Œè¿™ç§æ–¹å¼çš„ç¡®latencyå¾ˆä½ï¼Œä½†æ­¤ç±»åº”ç”¨æœ‰ä¸€ä¸ªå‰æå‡è®¾ï¼šæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…å§‹ç»ˆåœ¨çº¿ï¼Œæµå¤„ç†å¦‚æœæ˜¯ç”¨è¿™ç§æ–¹å¼ï¼Œæ¶ˆè´¹è€…ä¸€æ—¦è„±æœºï¼Œå¯èƒ½ä¼šä¸¢å¤±æœŸé—´çš„æ¶ˆæ¯</p>
<p><strong>æ¶ˆæ¯ä»£ç†/æ¶ˆæ¯é˜Ÿåˆ—</strong></p>
<p>æœ¬è´¨ä¸Šæ¶ˆæ¯ä»£ç†æ˜¯<strong>é’ˆå¯¹å¤„ç†æ¶ˆæ¯æµ</strong>çš„æ•°æ®åº“ã€‚æ¶ˆæ¯ä»£ç†è§£å†³äº†ä¸Šæ–‡æåŠçš„2ä¸ªé—®é¢˜ï¼š</p>
<p>ğŸ…°ï¸ (æ¶ˆè´¹è€…)æ¶ˆè´¹èƒ½åŠ›ä¸è¶³æ—¶ï¼Œæš‚å­˜æ¶ˆæ¯ï¼›ä¸éœ€è¦ä¸¢å¼ƒæ¶ˆæ¯æˆ–è€…èƒŒå‹</p>
<p>ğŸ…±ï¸ æŒä¹…æ€§ä¿è¯ï¼šè½ç›˜</p>
<table>
<thead>
<tr>
<th>æ¶ˆæ¯ä»£ç†</th>
<th>æ¶ˆæ¯<em>æˆåŠŸ</em>ä¼ é€’ç»™æ¶ˆè´¹è€…åï¼Œè‡ªåŠ¨åˆ é™¤</th>
<th>åŸºäºä¸»é¢˜çš„æ¨¡å¼åŒ¹é…</th>
<th>ä¸æ”¯æŒä»»æ„æŸ¥è¯¢ï¼Œæ•°æ®å˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ¶ˆè´¹è€…</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ•°æ®åº“</td>
<td>æ•°æ®åº“ä¿ç•™æ•°æ®ç›´åˆ°æ˜¾ç¤ºåˆ é™¤</td>
<td>æ•°æ®åº“æ”¯æŒäºŒçº§ç´¢å¼•</td>
<td>æŸ¥è¯¢æ—¶ï¼Œå¾€å¾€æ˜¯åŸºäºæŸä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§</td>
</tr>
</tbody>
</table>
<p>å¦‚ä¸Šæè¿°çš„ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å’Œå¸¸è§„çš„æ•°æ®çš„å·®åˆ«ï¼Œå…¶ä¸­è¡Œ1æ˜¯å…³äºæ¶ˆæ¯ä»£ç†çš„ä¼ ç»Ÿè§‚ç‚¹ï¼Œè¢«å°è£…åœ¨JMS/AMQP<sup class="footnote-ref"><a href="#fn26" id="fnref26">[26]</a></sup>æ ‡å‡†ä¸­ï¼Œå…¶å®ç°æœ‰RabbitMQï¼ŒActiveMQç­‰</p>
<blockquote>
<p>AMQP: Advanced Message Queuing Protocol é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼šé¢å‘æ¶ˆæ¯ä¸­é—´ä»¶æä¾›çš„å¼€æ”¾çš„åº”ç”¨å±‚åå®š</p>
</blockquote>
<p>æ¶ˆæ¯ä»£ç†ä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ªæ¶ˆè´¹è€…è¯»å–åŒä¸€ä¸ªä¸»é¢˜çš„æ¶ˆæ¯æ—¶ï¼Œä½¿ç”¨2ç§ä¸»è¦çš„æ¶ˆæ¯ä¼ é€’æ¨¡å¼:</p>
<p>ğŸ…°ï¸ è´Ÿè½½å‡è¡¡(load balance) : åœ¨æ¶ˆè´¹è€…é—´å…±äº«æ¶ˆè´¹ä¸»é¢˜</p>
<p>ğŸ…±ï¸ æ‰‡å‡º(fan-out) ï¼š å°†æ¯æ¡æ¶ˆæ¯ä¼ é€’ç»™å¤šä¸ªæ¶ˆè´¹è€…</p>
<p>ä¸¤ç§æ¨¡å¼å¯ä»¥ç»„åˆä½¿ç”¨ï¼šä¸¤ä¸ªç‹¬ç«‹çš„æ¶ˆè´¹è€…ç»„å¯ä»¥æ¯ç»„å„è®¢é˜…ä¸€ä¸ªä¸»é¢˜ï¼Œæ¯ä¸€ç»„éƒ½å…±åŒæ”¶åˆ°æ‰€æœ‰æ¶ˆæ¯ï¼Œä½†åœ¨æ¯ä¸€ç»„å†…éƒ¨ï¼Œæ¯æ¡æ¶ˆæ¯ä»…ç”±å•ä¸ªèŠ‚ç‚¹å¤„ç†</p>
<p align="center">
  <img src="/2023/09/21/ddia/38.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
<p>æ¶ˆæ¯ä»£ç†ä½¿ç”¨ç¡®è®¤(acknowledgment)<sup class="footnote-ref"><a href="#fn27" id="fnref27">[27]</a></sup>æœºåˆ¶ï¼Œæ¥ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œä½†ä¸€ç§å¯èƒ½çš„æƒ…å†µæ˜¯ï¼šä»£ç†å‘æ¶ˆè´¹è€…ä¼ é€’æ¶ˆæ¯åæ¶ˆè´¹è€…å´©æºƒæˆ–å¤„ç†äº†éƒ¨åˆ†å´©æºƒäº†ï¼Œä»£ç†ç”±äºè¶…å‡ºä¸€æ®µæ—¶é—´æ²¡æœ‰æ”¶åˆ°ç¡®è®¤(ä¹Ÿå¯èƒ½æ˜¯ç¡®è®¤åœ¨ç½‘ç»œä¸­ä¸¢å¤±äº†)ï¼Œä¾¿å°†æ¶ˆæ¯ä¼ é€’ç»™å¦å¤–ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå½“æ¶ˆè´¹è€…çš„æ¶ˆè´¹æ¨¡å¼æ˜¯è´Ÿè½½å‡è¡¡æ—¶ï¼Œä¸‹é¢çš„æƒ…å†µå¯èƒ½ä¼šå‘ç”Ÿï¼šå¤„ç†m3æ—¶æ¶ˆè´¹è€…2å´©æºƒï¼Œå› æ­¤ç¨åé‡ä¼ è‡³æ¶ˆè´¹è€…1</p>
<p align="center">
  <img src="/2023/09/21/ddia/39.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
<blockquote></blockquote>
<p>æ‰¹å¤„ç†çš„å…³é”®ç‰¹æ€§æ˜¯ï¼šé‡è¯•å¤±è´¥ä»»åŠ¡ä¸ä¼šå‘ç”Ÿä»»ä½•å‰¯ä½œç”¨ï¼Œè€ŒAMQP/JMSé£æ ¼çš„æ¶ˆæ¯ä¼ é€’æ”¶åˆ°æ¶ˆæ¯æ˜¯å…·æœ‰ç ´åæ€§çš„ï¼Œå› ä¸ºç¡®è®¤å¯èƒ½å¯¼è‡´æ¶ˆæ¯ä»ä»£ç†ä¸­è¢«åˆ é™¤ï¼Œå› æ­¤å†æ¬¡è¿è¡ŒåŒä¸€ä¸ªæ¶ˆè´¹è€…å¯èƒ½ä¼šå¾—åˆ°ä¸åŒçš„ç»“æœã€‚å³ä¾¿æ˜¯æ³¨å†Œæ–°çš„æ¶ˆè´¹è€…åˆ°æ¶ˆæ¯ç³»ç»Ÿï¼Œé€šå¸¸åªèƒ½æ¥æ”¶åˆ°æ¶ˆè´¹è€…æ³¨å†Œä¹‹åå¼€å§‹å‘é€çš„æ¶ˆæ¯ï¼Œè€Œæ–‡ä»¶ç³»ç»Ÿ/æ•°æ®åº“ç³»ç»Ÿæ–°å¢çš„å®¢æˆ·ç«¯èƒ½å¤Ÿè¯»å–åˆ°ä»»æ„ä¹…è¿œçš„æ•°æ®</p>
<p><strong>åŸºäºæ—¥å¿—çš„æ¶ˆæ¯ä»£ç†(log-based message brokers)</strong> å°è¯•å®ç° ğŸ…°ï¸æ—¢æœ‰æ•°æ®åº“çš„æŒä¹…å­˜å‚¨æ–¹å¼ï¼›ğŸ…±ï¸åˆæœ‰æ¶ˆæ¯ä¼ é€’çš„ä½å»¶è¿Ÿé€šçŸ¥</p>
<h2 id="åŸºäºæ—¥å¿—çš„æ¶ˆæ¯ä»£ç†">åŸºäºæ—¥å¿—çš„æ¶ˆæ¯ä»£ç†</h2>
<p>åœ¨åŸºäºæ—¥å¿—(append only mode)çš„æ¶ˆæ¯ä»£ç†ä¸­ï¼Œç”Ÿäº§è€…é€šè¿‡å°†æ¶ˆæ¯è¿½åŠ åˆ°æ—¥å¿—æœ«å°¾æ¥å‘é€æ¶ˆæ¯ï¼Œè€Œæ¶ˆè´¹è€…é€šè¿‡ä¾æ¬¡è¯»å–æ—¥å¿—æ¥æ¥æ”¶æ¶ˆæ¯ï¼Œè‹¥æ¶ˆè´¹è€…è¯»åˆ°æ—¥å¿—æœ«å°¾ï¼Œåˆ™ä¼šç­‰å¾…æ–°æ¶ˆæ¯è¿½åŠ çš„é€šçŸ¥(å¦‚Unixçš„ <code>tail -f</code>)ã€‚åŒæ—¶ä¸ºäº†æå‡ååé‡ï¼ŒåŸºäºæ—¥å¿—çš„æ¶ˆæ¯ä»£ç†å¯ä»¥å¯¹æ—¥å¿—è¿›è¡Œåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå†…ï¼Œä»£ç†ä¸ºæ¯ä¸ªæ¶ˆæ¯åˆ†é…ä¸€ä¸ª<em>å•è°ƒé€’å¢</em>çš„åºåˆ—å·/åç§»é‡(offset)ã€‚å¹¶ä¸”<em>åˆ†åŒºå†…æ¶ˆæ¯å®Œå…¨æœ‰åº(è·¨åˆ†åŒºæ— é¡ºåºä¿è¯</em>)</p>
<p align="center">
  <img src="/2023/09/21/ddia/40.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
<p>Apache Kafkaã€Amazon Kinesis Streamsã€Twitterçš„DistributedLogéƒ½æ˜¯åŸºäºæ—¥å¿—çš„æ¶ˆæ¯ä»£ç†ã€‚å…¶ä¸­ä¸‹é¢å‡ ç‚¹è¦æ³¨æ„ï¼š</p>
<p>1ï¸âƒ£æ¶ˆè´¹è€…ç»„ï¼šæ”¯æŒå¤šä¸ªæ¶ˆè´¹è€…ç»„æˆä¸€ä¸ªæ¶ˆè´¹è€…ä¸»è®¢é˜…ä¸€ä¸ªä¸»é¢˜ï¼Œå•ä¸ªèŠ‚ç‚¹æ¶ˆè´¹ç‰¹å®šçš„åˆ†åŒºï¼Œä¸€èˆ¬è€Œè¨€å•çº¿ç¨‹å¤„ç†å•åˆ†åŒºæ˜¯æ›´é€‚åˆçš„é€‰æ‹©ï¼Œé€šè¿‡å¢åŠ åˆ†åŒºçš„æ–¹å¼æé«˜å¹¶è¡Œåº¦</p>
<p>2ï¸âƒ£ æ¶ˆè´¹è€…åç§»é‡ï¼šæ‰€æœ‰åç§»é‡å°äºæ¶ˆè´¹è€…çš„å½“å‰åç§»é‡çš„æ¶ˆæ¯å·²ç»è¢«å¤„ç†(ç±»ä¼¼å•ä¸»å¤åˆ¶ä¸­çš„æ—¥å¿—åºåˆ—å·)<sup class="footnote-ref"><a href="#fn28" id="fnref28">[28]</a></sup></p>
<blockquote></blockquote>
<p>3ï¸âƒ£é‡æ’­æ—§æ¶ˆæ¯ï¼šæ¶ˆè´¹è€…çš„æ¶ˆè´¹å”¯ä¸€çš„å‰¯ä½œç”¨å°±æ˜¯å¯¼è‡´åç§»é‡çš„å‰è¿›ï¼Œä½†æ˜¯æ¶ˆè´¹è€…å¯ä»¥æ“çºµåç§»é‡(ç±»ä¼¼äºæ‰¹å¤„ç†)</p>
<h2 id="æµå’Œæ•°æ®åº“">æµå’Œæ•°æ®åº“</h2>
<p>æ­¤é—´çš„è®¨è®ºï¼Œæˆ‘ä»¬å‘ç°åŸºäºæ—¥å¿—çš„æ¶ˆæ¯ä»£ç†ä»æ•°æ®åº“ä¸­è·å¾—çµæ„Ÿå¹¶å°†å…¶åº”ç”¨äºæ¶ˆæ¯ä¼ é€’ï¼Œå…¶å®ä¹Ÿå¯ä»¥åè¿‡æ¥ï¼Œä»æ¶ˆæ¯ä¼ é€’å’Œæµä¸­è·å¾—çµæ„Ÿï¼Œå¹¶å°†ä»–ä»¬åº”ç”¨äºæ•°æ®åº“ã€‚åœ¨å•ä¸»å¤åˆ¶ä¸­ï¼Œä¸»åº“çš„å†™å…¥äº‹ä»¶æ„æˆå†™å…¥æµï¼Œå°†å†™å…¥æµåº”ç”¨åˆ°ä»åº“ï¼Œæœ€ç»ˆå¾—åˆ°æ•°æ®çš„ç²¾ç¡®å‰¯æœ¬ã€‚åœ¨å¼‚æ„æ•°æ®ç³»ç»Ÿä¸­ï¼Œç”±äºç›¸åŒæˆ–ç›¸å…³çš„æ•°æ®å‡ºç°åœ¨äº†ä¸åŒçš„åœ°æ–¹ï¼Œå› æ­¤ç›¸äº’é—´éœ€è¦ä¿æŒåŒæ­¥ï¼šå¦‚æœæŸä¸ªé¡¹ç›®åœ¨æ•°æ®åº“ä¸­è¢«æ›´æ–°ï¼Œå®ƒä¹Ÿåº”å½“åœ¨ç¼“å­˜ï¼Œæœç´¢ç´¢å¼•å’Œæ•°æ®ä»“åº“(ä½¿ç”¨ETL)ä¸­è¢«æ›´æ–°ï¼Œæˆ‘ä»¬åœ¨æ‰¹å¤„ç†å°†æè¿°äº†å¦‚ä½•ä½¿ç”¨æ‰¹å¤„ç†å»æ›´æ–°å…¶ä»–è¡ç”Ÿæ•°æ®ç³»ç»Ÿã€‚ä½¿ç”¨çš„æ‰¹å¤„ç†çš„å¼Šç«¯æ˜¯æ—¶å»¶ï¼Œå¦‚ä½•ä¿è¯è¡ç”Ÿæ•°æ®ç³»ç»Ÿä½å»¶è¿Ÿè·å–è®°å½•ç³»ç»Ÿçš„å˜æ›´æ•°æ®ï¼Ÿ</p>
<p>è¿™å°±æ¶‰åŠåˆ°<strong>å˜æ›´æ•°æ®æ•è·(change data capture, CDC)</strong>,è¿™æ˜¯ä¸€ç§è§‚å¯Ÿå†™å…¥æ•°æ®åº“çš„æ‰€æœ‰æ•°æ®å˜æ›´ï¼Œå¹¶å°†å…¶æå–å¹¶è½¬æ¢ä¸ºå¯ä»¥å¤åˆ¶åˆ°å…¶ä»–ç³»ç»Ÿä¸­çš„å½¢å¼çš„è¿‡ç¨‹ã€‚å¦‚ä¸‹å›¾ï¼šæ•è·æ•°æ®åº“ä¸­çš„å˜æ›´ï¼Œå¹¶ä¸æ–­å°†ç›¸åŒçš„å˜æ›´åº”ç”¨è‡³æœç´¢ç´¢å¼•</p>
<p align="center">
  <img src="/2023/09/21/ddia/45.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
ä»æœ¬è´¨ä¸Šè¯´ï¼Œå˜æ›´æ•°æ®æ•è·ä½¿å¾—ä¸€ä¸ªæ•°æ®åº“æˆä¸ºé¢†å¯¼è€…(è¢«æ•è·å˜åŒ–çš„æ•°æ®åº“)ï¼Œå¹¶å°†å…¶ä»–ç»„ä»¶å˜ä¸ºè¿½éšè€…ã€‚åŸºäºæ—¥å¿—çš„æ¶ˆæ¯ä»£ç†éå¸¸é€‚åˆä»æºæ•°æ®åº“ä¼ è¾“å˜æ›´äº‹ä»¶ï¼Œå› ä¸ºå®ƒä¿ç•™äº†æ¶ˆæ¯çš„é¡ºåºã€‚ LinkedInçš„Databusï¼ŒFacebookçš„Wormholeå’ŒYahoo!çš„Sherpaå¤§è§„æ¨¡åœ°åº”ç”¨è¿™ä¸ªæ€è·¯ã€‚ Bottled Waterä½¿ç”¨è§£ç WALçš„APIå®ç°äº†PostgreSQLçš„CDCï¼ŒMaxwellå’ŒDebeziumé€šè¿‡è§£æbinlogå¯¹MySQLåšäº†ç±»ä¼¼çš„äº‹æƒ…
<p>é‡æ”¾<strong>æ‰€æœ‰</strong>å¯¹æ•°æ®åº“è¿›è¡Œå˜æ›´çš„æ—¥å¿—ï¼Œè¿‡äºè€—æ—¶ï¼Œå› æ­¤ä¸€èˆ¬ä¼šä¿ç•™æ•°æ®åº“çš„å¿«ç…§ï¼Œå¿«ç…§+å¿«ç…§æ—¶åˆ»å¯¹åº”çš„åç§»é‡å¯ä»¥åŠ å¿«é‡å»ºæ•°æ®åº“çš„å®Œæ•´çŠ¶æ€ã€‚å¦å¤–ä¸€ä¸ªåŠ é€Ÿé‡å»ºæ•°æ®åº“å®Œæ•´çŠ¶æ€çš„æ–¹å¼æ˜¯æ—¥å¿—å‹ç¼©<sup class="footnote-ref"><a href="#fn29" id="fnref29">[29]</a></sup>ï¼ŒApache Kafkaæ”¯æŒè¿™ç§æ—¥å¿—å‹ç¼©åŠŸèƒ½</p>
<blockquote></blockquote>
<h2 id="äº‹ä»¶æº¯æº-Event-Sourcing">äº‹ä»¶æº¯æº(Event Sourcing)</h2>
<p>äº‹ä»¶æº¯æºèµ·æºäºé¢†å–é©±åŠ¨è®¾è®¡(domain-driven design,DDD)ï¼Œå’ŒCDCç±»ä¼¼ï¼Œäº‹ä»¶æº¯æºå°†<strong>æ‰€æœ‰æ¶‰åŠå¯¹åº”ç”¨çŠ¶æ€çš„å˜æ›´å­˜å‚¨ä¸ºå˜æ›´äº‹ä»¶æ—¥å¿—</strong>ï¼Œå…¶æ ¸å¿ƒåœ¨äºå°†ç”¨æˆ·çš„è¡Œä¸ºè®°å½•ä¸ºä¸å¯å˜çš„äº‹ä»¶ï¼Œè€Œä¸æ˜¯åœ¨å¯å˜æ•°æ®åº“ä¸­è®°å½•è¿™äº›è¡Œä¸ºçš„å½±å“ã€‚äº‹ä»¶å­˜å‚¨æ˜¯ä»…è¿½åŠ çš„ï¼ŒåŸåœ°åˆ é™¤å’Œæ›´æ–°æ˜¯ä¸è¢«é¼“åŠ±çš„ã€‚äº‹ä»¶æ—¥å¿—å’Œæ˜Ÿå‹æ¨¡å¼ä¸­çš„äº‹å®è¡¨æœ‰ç›¸ä¼¼ä¹‹å¤„</p>
<p>ä½¿ç”¨äº‹ä»¶æº¯æºçš„åº”ç”¨éœ€è¦æ‹‰å–äº‹ä»¶æ—¥å¿—(è¡¨ç¤ºå†™å…¥ç³»ç»Ÿçš„æ•°æ®)ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºé€‚åˆå‘ç”¨æˆ·æ˜¾ç¤ºçš„åº”ç”¨çŠ¶æ€ï¼Œå’ŒCDCä¸€æ ·ï¼Œé‡æ”¾äº‹ä»¶æ—¥å¿—å¯ä»¥é‡æ–°æ„å»ºç³»ç»Ÿçš„å½“å‰çŠ¶æ€ã€‚ äº‹ä»¶æº¯æºçš„å“²å­¦æ˜¯ä»”ç»†åŒºåˆ†<strong>äº‹ä»¶(event)<strong>å’Œ</strong>å‘½ä»¤(command)</strong>ï¼Œç”¨æˆ·çš„è¯·æ±‚åˆšåˆ°è¾¾æ—¶ï¼Œå®ƒä¸€å¼€å§‹æ˜¯ä¸€ä¸ªå‘½ä»¤(åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šå®ƒä»ç„¶å¯èƒ½å¯èƒ½å¤±è´¥ï¼Œæ¯”å¦‚è¿åäº†ä¸€äº›å®Œæ•´æ€§æ¡ä»¶)åº”ç”¨å¿…é¡»é¦–å…ˆéªŒè¯å®ƒæ˜¯å¦å¯ä»¥æ‰§è¡Œè¯¥å‘½ä»¤ã€‚å¦‚æœéªŒè¯æˆåŠŸå¹¶ä¸”å‘½ä»¤è¢«æ¥å—ï¼Œåˆ™å®ƒå˜ä¸ºä¸€ä¸ªæŒä¹…åŒ–ä¸”ä¸å¯å˜çš„äº‹ä»¶ã€‚ä»æ•°å­¦è§’åº¦æ¥çœ‹ï¼Œåº”ç”¨çŠ¶æ€æ˜¯äº‹ä»¶æµå¯¹æ—¶é—´æ±‚ç§¯åˆ†çš„ç»“æœ $state(now) = \int_{t=0}^{now}{stream(t) \ dt}$ï¼Œå˜æ›´æµæ˜¯åº”ç”¨çŠ¶æ€å¯¹æ—¶é—´æ±‚å¾®åˆ†çš„ç»“æœ $stream(t) = \frac{d\ state(t)}{dt}$</p>
<p>æ—¥å¿—å‹ç¼©æ˜¯è¿æ¥äº‹ä»¶æ—¥å¿—ä¸æ•°æ®åº“çŠ¶æ€ä¹‹é—´çš„æ¡¥æ¢ï¼šå®ƒåªä¿ç•™æ¯æ¡è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶ä¸¢å¼ƒè¢«è¦†ç›–çš„ç‰ˆæœ¬ã€‚æˆ‘ä»¬å¯ä»¥åŸºäºäº‹ä»¶æº¯æºä¸­çš„è®°å½•çš„äº‹ä»¶æ—¥å¿—æ´¾ç”Ÿå‡ºå¤šä¸ªè§†å›¾ï¼Œé€šè¿‡å°†æ•°æ®å†™å…¥çš„å½¢å¼ä¸è¯»å–å½¢å¼ç›¸åˆ†ç¦»<sup class="footnote-ref"><a href="#fn30" id="fnref30">[30]</a></sup>ï¼Œå¹¶å…è®¸å‡ ä¸ªä¸åŒçš„è¯»å–è§†å›¾ï¼Œè¿™æ ·æå¤§çš„æé«˜äº†çµæ´»æ€§</p>
<blockquote></blockquote>
<p>äº‹ä»¶æº¯æºå’Œå˜æ›´æ•°æ®æ•è·çš„æœ€å¤§ç¼ºç‚¹æ˜¯äº‹ä»¶æ—¥å¿—çš„æ¶ˆè´¹è€…é€šå¸¸æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥å¯èƒ½å‡ºç°çš„æƒ…å†µæ˜¯ï¼šç”¨æˆ·å†™å…¥æ—¥å¿—ï¼Œç„¶åä»æ—¥å¿—è¡ç”Ÿè§†å›¾ä¸­è¯»å–ï¼Œç»“æœå‘ç°ä»–çš„å†™å…¥è¿˜æ²¡æœ‰åæ˜ åœ¨è¯»å–è§†å›¾ä¸­ï¼Œä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯å°†äº‹ä»¶é™„åŠ åˆ°æ—¥å¿—æ—¶åŒæ­¥æ‰§è¡Œè¯»å–è§†å›¾çš„æ›´æ–°ï¼Œå¦‚æœæ˜¯äº‹ä»¶æ—¥å¿—å’Œè¯»å–è§†å›¾ä¿å­˜åœ¨åŒä¸€ä¸ªå­˜å‚¨ç³»ç»Ÿä¸­ï¼Œéœ€è¦ä½¿ç”¨äº‹åŠ¡ï¼Œå¦‚æœæ˜¯å¼‚æ„æ•°æ®åº“åˆ™æ¶‰åŠåˆ†å¸ƒå¼äº‹åŠ¡</p>
<p>ğŸˆè‡³æ­¤ï¼Œæˆ‘ä»¬è°ˆåŠåˆ°äº†æµçš„æ¥æº1ï¸âƒ£ç”¨æˆ·æ´»åŠ¨äº‹ä»¶ï¼Œ2ï¸âƒ£ä¼ æ„Ÿå™¨ï¼Œ3ï¸âƒ£å†™å…¥æ•°æ®åº“ï¼›æµå¦‚ä½•ä¼ è¾“1ï¸âƒ£ç›´æ¥é€šè¿‡æ¶ˆæ¯ä¼ é€ 2ï¸âƒ£æ¶ˆæ¯ä»£ç† 3ï¸âƒ£ äº‹ä»¶æ—¥å¿—ã€‚é‚£ä¹ˆæˆ‘ä»¬ç”¨æµå¹²ä»€ä¹ˆï¼Ÿ</p>
<h2 id="æµå¤„ç†">æµå¤„ç†</h2>
<p>æµä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸‰ç§ç”¨é€”</p>
<p>1ï¸âƒ£ ä½ å¯ä»¥å°†äº‹ä»¶ä¸­çš„æ•°æ®å†™å…¥æ•°æ®åº“ï¼Œç¼“å­˜ï¼Œæœç´¢ç´¢å¼•æˆ–ç±»ä¼¼çš„å­˜å‚¨ç³»ç»Ÿï¼Œç„¶åèƒ½è¢«å…¶ä»–å®¢æˆ·ç«¯æŸ¥è¯¢</p>
<p>2ï¸âƒ£ ä»¥æŸç§æ–¹å¼å°†äº‹ä»¶æ¨é€ç»™ç”¨æˆ·ï¼Œå¦‚å‘é€æŠ¥è­¦é‚®ä»¶æˆ–æ¨é€é€šçŸ¥ï¼Œæˆ–å°†äº‹ä»¶æµå¼ä¼ è¾“åˆ°å¯å®æ—¶æ˜¾ç¤ºçš„ä»ªè¡¨æ¿ä¸Šã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œäººæ˜¯æµçš„æœ€ç»ˆæ¶ˆè´¹è€…</p>
<p>3ï¸âƒ£ ä½ å¯ä»¥å¤„ç†ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥æµï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªæˆ–å¤šä¸ªè¾“å‡ºæµã€‚æµå¯èƒ½ä¼šç»è¿‡ç”±å‡ ä¸ªè¿™æ ·çš„å¤„ç†é˜¶æ®µç»„æˆçš„æµæ°´çº¿ï¼Œæœ€åå†è¾“å‡º1ï¸âƒ£æˆ–2ï¸âƒ£</p>
<p>æˆ‘ä»¬å°†é‡ç‚¹è®¨è®º3ï¸âƒ£å¤„ç†æµäº§ç”Ÿå…¶ä»–è¡ç”Ÿæµï¼Œå¤„ç†è¿™æ ·çš„æµçš„ä»£ç ç‰‡æ®µï¼Œç§°ä¹‹ä¸ºç®—å­(operator)æˆ–è€…ä½œä¸š(job)ï¼›æµå¤„ç†å’Œæ‰¹å¤„ç†æœ€å¤§çš„åŒºåˆ«æ˜¯æµå¤„ç†å¤„ç†æ— ç•Œæ•°æ®ï¼Œç”±äºæ˜¯æ— ç•Œå¯¼è‡´æ’åºæ²¡æœ‰æ„ä¹‰ï¼Œä¹Ÿå°±æ— æ³•ä½¿ç”¨æ’åºåˆå¹¶è¿æ¥ï¼ˆsort merge joinï¼‰ï¼Œå®¹é”™æœºåˆ¶ä¹Ÿä¸èƒ½åƒæ‰¹å¤„ç†é‚£æ ·é€šè¿‡ä»å¤´æ‰§è¡Œçš„æ–¹å¼</p>
<h2 id="æµå¤„ç†åº”ç”¨">æµå¤„ç†åº”ç”¨</h2>
<p>1ï¸âƒ£ å¤åˆäº‹ä»¶å¤„ç†(complex,event processing CEP)ï¼ŒCEPé€šå¸¸ä½¿ç”¨é«˜å±‚æ¬¡çš„å£°æ˜å¼æŸ¥è¯¢è¯­å¥å¦‚SQLï¼Œåœ¨æµä¸­æœç´¢æŸäº›äº‹ä»¶ï¼ˆå°±åƒæ­£åˆ™è¡¨è¾¾å¼ä¸€æ ·ï¼‰ï¼Œå½“å‘ç°åŒ¹é…æ—¶ï¼Œå¼•æ“å‘å‡ºä¸€ä¸ª<strong>å¤åˆäº‹ä»¶(complex event)</strong>ï¼ˆå› æ­¤å¾—åï¼‰ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œæ•°æ®åº“ä¼šæŒä¹…å­˜å‚¨æ•°æ®ï¼Œå¹¶å°†æŸ¥è¯¢è§†ä¸ºä¸´æ—¶çš„ï¼Œå½“æŸ¥è¯¢è¿›å…¥æ—¶ï¼Œæ•°æ®åº“æœç´¢ä¸æŸ¥è¯¢åŒ¹é…çš„æ•°æ®ï¼Œç„¶ååœ¨æŸ¥è¯¢å®Œæˆæ—¶ä¸¢æ‰æŸ¥è¯¢ã€‚ CEPå¼•æ“åè½¬äº†è§’è‰²ï¼šæŸ¥è¯¢æ˜¯é•¿æœŸå­˜å‚¨çš„ï¼Œæ¥è‡ªè¾“å…¥æµçš„äº‹ä»¶ä¸æ–­æµè¿‡å®ƒä»¬ã€‚CEPçš„å®ç°åŒ…æ‹¬ Esperã€IBM InfoSphere Streams</p>
<p>2ï¸âƒ£æµåˆ†æï¼Œæµåˆ†æå…³æ³¨å¤§é‡äº‹ä»¶ä¸Šçš„èšåˆä¸ç»Ÿè®¡æŒ‡æ ‡ï¼Œç»Ÿè®¡æŒ‡æ ‡é€šå¸¸æ˜¯åœ¨å›ºå®šæ—¶é—´åŒºï¼ˆçª—å£[window]ï¼‰é—´å†…è¿›è¡Œè®¡ç®—çš„ã€‚è®¸å¤šå¼€æºåˆ†å¸ƒå¼æµå¤„ç†æ¡†æ¶çš„è®¾è®¡éƒ½æ˜¯é’ˆå¯¹åˆ†æè®¾è®¡çš„ï¼šä¾‹å¦‚Apache Stormï¼ŒSpark Streamingï¼ŒFlink</p>
<p>3ï¸âƒ£ ç»´æŠ¤ç‰©åŒ–è§†å›¾ã€‚æ•°æ®åº“çš„å˜æ›´æµï¼ˆCDCæˆ–æ˜¯äº‹ä»¶æ—¥å¿—ï¼‰å¯ä»¥ç”¨äºç»´æŠ¤è¡ç”Ÿæ•°æ®ç³»ç»Ÿï¼Œä½¿å…¶ä¸æºæ•°æ®åº“ä¿æŒæœ€æ–°ï¼ŒåŸºäºè¡ç”ŸæŸ¥è¯¢ï¼ˆå†™å…¥å’ŒæŸ¥è¯¢ç›¸åˆ†ç¦»ï¼‰ã€‚ä¹Ÿæ˜¯æµçš„ä¸€ä¸ªåº”ç”¨ï¼Œä½†æ˜¯è¦æ±‚ä»»æ„æ—¶é—´æ®µå†…çš„æ‰€æœ‰äº‹ä»¶ï¼Œå’Œæµåˆ†æåœºæ™¯æœ‰å¾ˆå¤§çš„ä¸åŒã€‚ç±»ä¼¼Spark Streaming ä¸æ”¯æŒ</p>
<h3 id="å…³äºäº‹ä»¶æ—¶é—´å’Œå¤„ç†æ—¶é—´">å…³äºäº‹ä»¶æ—¶é—´å’Œå¤„ç†æ—¶é—´</h3>
<p>ğŸ…°ï¸ å¤„ç†æ—¶é—´ï¼šäº‹ä»¶åˆ°è¾¾å¤„ç†èŠ‚ç‚¹çš„æ—¶é’Ÿã€‚ä½¿ç”¨å¤„ç†æ—¶é—´å®šä¹‰çª—å£ï¼Œä¼šå› ä¸ºå¤„ç†é€Ÿç‡çš„å˜åŠ¨å¼•å…¥äººä¸ºå› ç´ ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p align="center">
  <img src="/2023/09/21/ddia/46.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
<p>ğŸ…±ï¸ äº‹ä»¶æ—¶é—´ï¼šäº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ã€‚å»¶è¿Ÿå…ˆå‘ç”Ÿçš„äº‹ä»¶å…ˆåˆ°è¾¾å¤„ç†èŠ‚ç‚¹ï¼Œæ— æ³•ç¡®å®šæ˜¯å¦å·²ç»æ”¶åˆ°äº†ç‰¹å®šçª—å£çš„æ‰€æœ‰äº‹ä»¶ï¼Œå¦‚ä½•å¤„ç†è¿™ç§åœ¨çª—å£å®£å‘Šå®Œæˆä¹‹ååˆ°è¾¾çš„æ»ç•™ï¼ˆstragglerï¼‰äº‹ä»¶ï¼Ÿ</p>
<h3 id="çª—å£">çª—å£</h3>
<p>1ï¸âƒ£ æ»šåŠ¨çª—å£(Tumbling Window)ï¼šçª—å£æœ‰å›ºå®šçš„é•¿åº¦ï¼Œè€Œä¸”æ¯ä¸ªäº‹ä»¶éƒ½åªå±äºä¸€ä¸ªçª—å£</p>
<p>2ï¸âƒ£è·³åŠ¨çª—å£(Hopping Window) ï¼šçª—å£æœ‰å›ºå®šçš„é•¿åº¦ï¼Œå¦‚1åˆ†é’Ÿè·³è·ƒæ­¥é•¿çš„5åˆ†é’Ÿçª—å£</p>
<p>3ï¸âƒ£æ»‘åŠ¨çª—å£(Sliding Window)ï¼šæ»‘åŠ¨çª—å£åŒ…å«äº†å½¼æ­¤é—´è·åœ¨ç‰¹å®šæ—¶é•¿å†…çš„æ‰€æœ‰äº‹ä»¶ï¼Œé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‰æ—¶é—´æ’åºçš„äº‹ä»¶ç¼“å†²åŒºï¼Œå¹¶ä¸æ–­ä»çª—å£ä¸­ç§»é™¤è¿‡æœŸçš„æ—§äº‹ä»¶ï¼Œå¯ä»¥å®ç°æ»‘åŠ¨çª—å£</p>
<p>4ï¸âƒ£ä¼šè¯çª—å£(Session window) å°†åŒä¸€ç”¨æˆ·å‡ºç°æ—¶é—´ç›¸è¿‘çš„æ‰€æœ‰äº‹ä»¶åˆ†ç»„åœ¨ä¸€èµ·ï¼Œè€Œå½“ç”¨æˆ·ä¸€æ®µæ—¶é—´æ²¡æœ‰æ´»åŠ¨æ—¶ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœ30åˆ†é’Ÿå†…æ²¡æœ‰äº‹ä»¶ï¼‰çª—å£ç»“æŸ</p>
<h2 id="æµå¼è¿æ¥">æµå¼è¿æ¥</h2>
<p>æ¶‰åŠ<strong>æµ-æµ</strong>è¿æ¥ï¼Œ<strong>æµ-è¡¨</strong>è¿æ¥ï¼Œä¸<strong>è¡¨-è¡¨</strong>è¿æ¥</p>
<p>1ï¸âƒ£ æµæµè¿æ¥ï¼Œå®é™…æ˜¯çª—å£çš„è¿æ¥ï¼ŒWindow join ä½œç”¨åœ¨ä¸¤ä¸ªæµä¸­æœ‰<em>ç›¸åŒ key</em> ä¸”å¤„äº<em>ç›¸åŒçª—å£</em>çš„å…ƒç´ ä¸Šã€‚æ¯”å¦‚Flinkå°†æµæµè¿æ¥ç»†åˆ†ä¸ºæ»šåŠ¨Window Joinï¼Œæ»‘åŠ¨Window Joinï¼Œä¼šè¯Window Joinã€‚<a href="https://nightlies.apache.org/flink/flink-docs-master/zh/docs/dev/datastream/operators/joining/">Flinkçš„åŒæµJoin</a>ã€‚æ¯”å¦‚ä¸‹å›¾æ˜¯Spark Streamingä¸­ä¸€ä¸ªå¹¿å‘Šæµå’Œä¸€ä¸ªç‚¹å‡»æµçš„è¿æ¥</p>
<p align="center">
  <img src="/2023/09/21/ddia/55.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
<span class="github-emoji" style="display:inline;vertical-align:middle"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>æµè¡¨è¿æ¥ï¼Œå®é™…æ˜¯æµæ‰©å±•ã€‚å¦‚ä¸‹å›¾çš„ç‚¹å‡»æµå’Œç”¨æˆ·æ¡£æ¡ˆçš„è¿æ¥ï¼Œé¦–å…ˆå°†æ•°æ®åº“å‰¯æœ¬åŠ è½½åˆ°æµå¤„ç†å™¨ä¸­ï¼Œç„¶åæµå¤„ç†å™¨éœ€è¦ä¸€æ¬¡å¤„ç†ä¸€ä¸ªæ´»åŠ¨äº‹ä»¶ã€‚ æµè¡¨è¿æ¥å®é™…ä¸Šéå¸¸ç±»ä¼¼äºæµæµè¿æ¥ï¼›æœ€å¤§çš„åŒºåˆ«åœ¨äºå¯¹äºè¡¨çš„å˜æ›´æ—¥å¿—æµï¼Œè¿æ¥ä½¿ç”¨äº†ä¸€ä¸ªå¯ä»¥å›æº¯åˆ°â€œæ—¶é—´èµ·ç‚¹â€çš„çª—å£
<p align="center">
  <img src="/2023/09/21/ddia/43.jpg" width="85%" alt="Your image description">
    <br>
  <span style="color:gray"> todo </span>
</p>
<span class="github-emoji" style="display:inline;vertical-align:middle"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¡¨è¡¨è¿æ¥ã€‚åœ¨æ¨ç‰¹æ—¶é—´çº¿çš„ä¾‹å­ä¸­ï¼Œç”¨æˆ·æŸ¥çœ‹è‡ªèº«ä¸»é¡µæ—¶é—´çº¿æ—¶ï¼Œè¿­ä»£ç”¨æˆ·æ‰€å…³æ³¨äººç¾¤çš„æ¨æ–‡å¹¶åˆå¹¶å®ƒä»¬éœ€è¦ä¸€ä¸ªæ—¶é—´çº¿ç¼“å­˜ï¼Œåœ¨æµå¤„ç†å™¨ä¸­å®ç°è¿™ç§ç¼“å­˜ç»´æŠ¤ï¼Œéœ€è¦æ¨æ–‡äº‹ä»¶æµ(å‘é€ä¸åˆ é™¤)å’Œå…³æ³¨å…³ç³»äº‹ä»¶æµ(å…³æ³¨ä¸å–æ¶ˆå…³æ³¨)ï¼Œå³è¯¥æµå¤„ç†çš„è¿‡ç¨‹æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªè¿æ¥äº†ä¸¤ä¸ªè¡¨(æ¨æ–‡ä¸å…³æ³¨)çš„ç‰©åŒ–è§†å›¾ï¼Œå¦‚ä¸‹æ—¶é—´çº¿å®é™…ä¸Šæ˜¯è¿™ä¸ªæŸ¥è¯¢ç»“æœçš„ç¼“å­˜ï¼Œæ¯å½“åŸºç¡€è¡¨å‘ç”Ÿå˜åŒ–æ—¶éƒ½ä¼šæ›´æ–°
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> follows.follower_id <span class="keyword">as</span> timeline_id, </span><br><span class="line">    <span class="built_in">array_agg</span>(tweets.<span class="operator">*</span> <span class="keyword">order</span> <span class="keyword">by</span> tweets.timestamp <span class="keyword">desc</span>)</span><br><span class="line"><span class="keyword">from</span> tweets</span><br><span class="line"><span class="keyword">join</span> follows <span class="keyword">on</span>  tweets.sender_id <span class="operator">=</span> follows.followee_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> follows.follower_id</span><br></pre></td></tr></tbody></table></figure>
<h2 id="è¿æ¥çš„æ—¶é—´ä¾èµ–æ€§">è¿æ¥çš„æ—¶é—´ä¾èµ–æ€§</h2>
<p>æµæµã€æµè¡¨ã€è¡¨è¡¨è¿æ¥æœ‰å¾ˆå¤šå…±åŒç‚¹ï¼Œ<strong>ä»–ä»¬éƒ½éœ€æµå¤„ç†å™¨ç»´æŠ¤è¿æ¥ä¸€ä¾§çš„ä¸€äº›çŠ¶æ€(å¹¿å‘Šæµå’Œç‚¹å‡»æµï¼Œç”¨æˆ·æ¡£æ¡ˆï¼Œå…³æ³¨åˆ—è¡¨)ï¼Œç„¶åå½“è¿æ¥å¦å¤–ä¸€ä¾§çš„æ¶ˆæ¯åˆ°è¾¾æ—¶æŸ¥è¯¢è¯¥çŠ¶æ€</strong>ã€‚è¿™é‡Œä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚åœ¨æµè¡¨è¿æ¥çš„ä¾‹å­ä¸­ï¼Œå¦‚æœç”¨æˆ·æ›´æ–°äº†æ¡£æ¡ˆï¼Œå“ªäº›æ´»åŠ¨äº‹ä»¶ä¸æ—§æ¡£æ¡ˆè¿æ¥(åœ¨æ¡£æ¡ˆæ›´æ–°å‰)ï¼Ÿï¼Œå“ªäº›åˆä¸æ–°æ¡£æ¡ˆè¿æ¥(åœ¨æ¡£æ¡ˆæ›´æ–°å)ï¼Ÿå³è¿æ¥å­˜åœ¨<em>æ—¶åºä¾èµ–</em>ï¼Œæ¯”å¦‚å¤„ç†å‘ç¥¨å’Œç¨ç‡é—®é¢˜æ—¶ï¼Œå½“è¿æ¥é”€å”®é¢ä¸ç¨ç‡è¡¨æ—¶ï¼Œä½ å¯èƒ½æœŸæœ›çš„æ˜¯ä½¿ç”¨é”€å”®æ—¶çš„ç¨ç‡å‚ä¸è¿æ¥ï¼Œå¦‚æœä½ æ­£åœ¨é‡æ–°å¤„ç†å†å²æ•°æ®ï¼Œé”€å”®æ—¶çš„ç¨ç‡å¯èƒ½å’Œç°åœ¨çš„ç¨ç‡æœ‰æ‰€ä¸åŒ</p>
<p>å³å¦‚æœè·¨æµäº‹ä»¶çš„é¡ºåºæ˜¯æœªå®šçš„ï¼Œåˆ™è¿æ¥ä¼šå˜æˆä¸ç¡®å®šæ€§çš„ï¼Œé‚£ä¹ˆåœ¨åŒæ ·è¾“å…¥ä¸Šé‡è·‘å¯èƒ½ä¼šå¾—åˆ°ä¸åŒçš„ç»“æœã€‚è¿™ä¸ªé—®é¢˜åœ¨æ•°ä»“ä¸­å«<em>ç¼“æ…¢å˜åŒ–çš„ç»´åº¦(slowly changing dimension,SCD)<sup class="footnote-ref"><a href="#fn31" id="fnref31">[31]</a></sup></em>ï¼Œé€šå¸¸é€šè¿‡å¯¹ç‰¹å®šç‰ˆæœ¬çš„è®°å½•ä½¿ç”¨å”¯ä¸€çš„æ ‡è¯†ç¬¦æ¥è§£å†³ï¼šä¾‹å¦‚ï¼Œæ¯å½“ç¨ç‡æ”¹å˜æ—¶éƒ½ä¼šè·å¾—ä¸€ä¸ªæ–°çš„æ ‡è¯†ç¬¦ï¼Œè€Œå‘ç¥¨åœ¨é”€å”®æ—¶ä¼šå¸¦æœ‰ç¨ç‡çš„æ ‡è¯†ç¬¦ã€‚è¿™ç§å˜åŒ–ä½¿è¿æ¥å˜ä¸ºç¡®å®šæ€§çš„ï¼Œä½†ä¹Ÿä¼šå¯¼è‡´æ—¥å¿—å‹ç¼©æ— æ³•è¿›è¡Œï¼šè¡¨ä¸­æ‰€æœ‰çš„è®°å½•ç‰ˆæœ¬éƒ½éœ€è¦ä¿ç•™</p>
<blockquote></blockquote>
<h2 id="æµå¤„ç†å¦‚ä½•å¤„ç†å®¹é”™">æµå¤„ç†å¦‚ä½•å¤„ç†å®¹é”™</h2>
<p>åœ¨æ‰¹å¤„ç†ä¸­ï¼Œå®¹é”™çš„æ–¹å¼å°±æ˜¯é‡è·‘ï¼Œè€Œä¸”å…¶è¾“å‡ºçš„æ•ˆæœå°±åƒåªå¤„ç†äº†ä¸€æ¬¡ä¸€æ ·ï¼Œè¿™ä¸ªåŸåˆ™å«åš<strong>æ°å¥½/ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰(exactly-once semantics)</strong>ï¼Œæµå¤„ç†ä¸ºäº†å®ç°æ°å¥½ä¸€æ¬¡è¯­ä¹‰ï¼Œæœ‰ä»¥ä¸‹2ç§æ–¹å¼</p>
<p>ğŸ…°ï¸ å¾®æ‰¹ï¼Œå³å°†æµåˆ†è§£æˆå°å—ï¼Œå¹¶åƒå¾®å‹æ‰¹å¤„ç†ä¸€æ ·å¤„ç†æ¯ä¸ªå—ï¼Œå¾®æ‰¹æ¬¡(é€šå¸¸ä¸º1S)ä¹Ÿéšå¼æä¾›äº†ä¸€ä¸ªä¸æ‰¹æ¬¡å¤§å°ç›¸ç­‰çš„æ»šåŠ¨çª—å£(<em>æŒ‰å¤„ç†æ—¶é—´è€Œä¸æ˜¯äº‹ä»¶æ—¶é—´æˆ³åˆ†çª—</em>)ï¼Œä»£è¡¨åº”ç”¨ä¸ºSpark Streaming</p>
<p>ğŸ…±ï¸å­˜æ¡£ç‚¹ï¼Œ Apache Flinkä¼šå®šæœŸç”ŸæˆçŠ¶æ€çš„æ»šåŠ¨å­˜æ¡£ç‚¹å¹¶å°†å…¶å†™å…¥æŒä¹…å­˜å‚¨ã€‚å¦‚æœæµç®—å­å´©æºƒï¼Œå®ƒå¯ä»¥ä»æœ€è¿‘çš„å­˜æ¡£ç‚¹é‡å¯ï¼Œå¹¶ä¸¢å¼ƒä»æœ€è¿‘æ£€æŸ¥ç‚¹åˆ°å´©æºƒä¹‹é—´çš„æ‰€æœ‰è¾“å‡º</p>
<p>åœ¨æµå¤„ç†æ¡†æ¶çš„èŒƒå›´å†…ï¼Œå¾®æ‰¹æ¬¡ä¸å­˜æ¡£ç‚¹æ–¹æ³•æä¾›äº†ä¸æ‰¹å¤„ç†ä¸€æ ·çš„<strong>æ°å¥½ä¸€æ¬¡è¯­ä¹‰</strong>ã€‚ä½†æ˜¯ï¼Œåªè¦è¾“å‡ºç¦»å¼€æµå¤„ç†å™¨(ä¾‹å¦‚ï¼Œå†™å…¥æ•°æ®åº“ï¼Œå‘å¤–éƒ¨æ¶ˆæ¯ä»£ç†å‘é€æ¶ˆæ¯ï¼Œæˆ–å‘é€ç”µå­é‚®ä»¶)ï¼Œæ¡†æ¶å°±æ— æ³•æŠ›å¼ƒå¤±è´¥æ‰¹æ¬¡çš„è¾“å‡ºäº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé‡å¯å¤±è´¥ä»»åŠ¡ä¼šå¯¼è‡´å¤–éƒ¨å‰¯ä½œç”¨å‘ç”Ÿä¸¤æ¬¡ï¼Œåªæœ‰å¾®æ‰¹æ¬¡æˆ–å­˜æ¡£ç‚¹ä¸è¶³ä»¥é˜»æ­¢è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿äº‹ä»¶å¤„ç†çš„æ‰€æœ‰è¾“å‡ºå’Œå‰¯ä½œç”¨<strong>å½“ä¸”ä»…å½“</strong>å¤„ç†æˆåŠŸæ—¶æ‰ä¼šç”Ÿæ•ˆã€‚åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå¦å¤–ä¸€ç§æ–¹å¼æ˜¯<strong>å¹‚ç­‰æ€§</strong>(idempotence)</p>
<p>å¹‚ç­‰æ“ä½œæ˜¯å¤šæ¬¡é‡å¤æ‰§è¡Œä¸å•æ¬¡æ‰§è¡Œæ•ˆæœç›¸åŒçš„æ“ä½œï¼Œä¾‹å¦‚ï¼Œå°†é”®å€¼å­˜å‚¨ä¸­çš„æŸä¸ªé”®è®¾ç½®ä¸ºæŸä¸ªç‰¹å®šå€¼æ˜¯å¹‚ç­‰çš„ï¼ˆå†æ¬¡å†™å…¥è¯¥å€¼ï¼Œåªæ˜¯ç”¨åŒæ ·çš„å€¼æ›¿ä»£ï¼‰ï¼Œè€Œé€’å¢ä¸€ä¸ªè®¡æ•°å™¨ä¸æ˜¯å¹‚ç­‰çš„(å†æ¬¡æ‰§è¡Œé€’å¢æ„å‘³ç€è¯¥å€¼é€’å¢ä¸¤æ¬¡)ã€‚åœ¨ä½¿ç”¨æ¥è‡ªKafkaçš„æ¶ˆæ¯æ—¶ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªæŒä¹…çš„ï¼Œå•è°ƒé€’å¢çš„åç§»é‡ã€‚å°†å€¼å†™å…¥å¤–éƒ¨æ•°æ®åº“æ—¶å¯ä»¥å°†è¿™ä¸ªåç§»é‡å¸¦ä¸Šï¼Œè¿™æ ·ä½ å°±å¯ä»¥åˆ¤æ–­ä¸€æ¡æ›´æ–°æ˜¯ä¸æ˜¯å·²ç»æ‰§è¡Œè¿‡äº†ï¼Œå› è€Œé¿å…é‡å¤æ‰§è¡Œ</p>
<p>&lt;å®Œ&gt;</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>æ„å‘³ç€å³ä½¿å‘ç”Ÿæ•…éšœï¼Œç³»ç»Ÿä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn2" class="footnote-item"><p>æ„å‘³ç€å³ä½¿åœ¨è´Ÿè½½å¢åŠ çš„æƒ…å†µä¸‹ä¹Ÿæœ‰ä¿æŒæ€§èƒ½çš„ç­–ç•¥ <a href="#fnref2" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn3" class="footnote-item"><p>æœ‰è®¸å¤šæ–¹é¢ï¼Œä½†å®è´¨ä¸Šæ˜¯å…³äºå·¥ç¨‹å¸ˆå’Œè¿ç»´å›¢é˜Ÿçš„ç”Ÿæ´»è´¨é‡çš„ <a href="#fnref3" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn4" class="footnote-item"><p>SSTable : Sort String Table ï¼Œæ’åºå­—ç¬¦ä¸²è¡¨ï¼Œå¯¹æ¯ä¸ªæ®µæ–‡ä»¶ä¸­çš„é”®è¿›è¡Œæ’åº <a href="#fnref4" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn5" class="footnote-item"><p>å¡æ¡‘å¾·æ‹‰ï¼ŒApache Cassandraæ˜¯ä¸€å¥—å¼€æºåˆ†å¸ƒå¼NoSQLæ•°æ®åº“ç³»ç»Ÿã€‚å®ƒæœ€åˆç”±Facebookå¼€å‘ï¼Œç”¨äºæ”¹å–„ç”µå­é‚®ä»¶ç³»ç»Ÿçš„æœç´¢æ€§èƒ½çš„ç®€å•æ ¼å¼æ•°æ®ï¼Œé›†Google BigTableçš„æ•°æ®æ¨¡å‹ä¸Amazon Dynamoçš„å®Œå…¨åˆ†å¸ƒå¼æ¶æ„äºä¸€èº« <a href="#fnref5" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn6" class="footnote-item"><p>å’ŒESä¸€æ ·æ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„æœç´¢ç´¢å¼• <a href="#fnref6" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn7" class="footnote-item"><p>Hologreså­˜å‚¨å¼•æ“ï¼š <a href="https://developer.aliyun.com/article/779284?spm=a2c4g.11186623.0.0.11cf49fc9XL2Nw&amp;groupCode=hologres">https://developer.aliyun.com/article/779284?spm=a2c4g.11186623.0.0.11cf49fc9XL2Nw&amp;groupCode=hologres</a> <a href="#fnref7" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn8" class="footnote-item"><p>å›ºå®šå¤§å°çš„å—æˆ–è€…é¡µé¢ï¼šå¦‚æœè¯»è€…æ³¨æ„åˆ°è¿‡SQLå¼•æ“çš„æ‰§è¡Œè®¡åˆ’çš„è¯ï¼Œä¸€èˆ¬ä¼šæœ‰ä¸€ä¸ªç±»ä¼¼seq_page_costï¼ˆpostgresqlå«è¿™ä¸ªï¼‰çš„å‚æ•°æè¿°çš„å°±æ˜¯æ¯æ¬¡PlanneræŠ“å–ä¸€ä¸ªæ•°æ®é¡µçš„æˆæœ¬ï¼ˆcostï¼‰ï¼Œ the plannerâ€™s estimate of the cost of a disk page fetch that is part of a series of sequential fetches <a href="#fnref8" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn9" class="footnote-item"><p>æ•°æ®æ¹–ï¼šæ˜¯æŒ‡ä½¿ç”¨<a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E9%80%B2%E4%BD%8D%E5%A4%A7%E5%9E%8B%E7%89%A9%E4%BB%B6">å¤§å‹äºŒè¿›åˆ¶å¯¹è±¡</a>æˆ–æ–‡ä»¶è¿™æ ·çš„è‡ªç„¶æ ¼å¼å‚¨å­˜æ•°æ®çš„ç³»ç»Ÿ[<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E6%B9%96#cite_note-1">1]</a>  ï¼Œæ•°æ®æ¹–å¯ä»¥åŒ…æ‹¬<a href="https://zh.wikipedia.org/wiki/%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93">å…³ç³»æ•°æ®åº“</a>çš„<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B">ç»“æ„åŒ–æ•°æ®</a>(è¡Œä¸åˆ—)ã€åŠç»“æ„åŒ–çš„æ•°æ®(<a href="https://zh.wikipedia.org/wiki/%E9%80%97%E5%8F%B7%E5%88%86%E9%9A%94%E5%80%BC">CSV</a>ï¼Œæ—¥å¿—ï¼Œ<a href="https://zh.wikipedia.org/wiki/XML">XML</a>, <a href="https://zh.wikipedia.org/wiki/JSON">JSON</a>)ï¼Œéç»“æ„åŒ–æ•°æ® (ç”µå­é‚®ä»¶ã€æ–‡ä»¶ã€PDF)å’Œ äºŒè¿›åˆ¶æ•°æ®(å›¾åƒã€<a href="https://zh.wikipedia.org/wiki/%E6%95%B8%E4%BD%8D%E9%9F%B3%E8%A8%8A">éŸ³é¢‘</a>ã€è§†é¢‘) <a href="#fnref9" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn10" class="footnote-item"><p>åˆ†åŒºæœ‰å¾ˆå¤šä¸­å«æ³•ï¼Œæ¯”å¦‚Solr Cloudä¸­è¢«ç§°ä¸ºåˆ†ç‰‡(shard),åœ¨HBaseä¸­ç§°ä¹‹ä¸ºåŒºåŸŸ(Region)ï¼ŒBigtable/Kuduä¸­åˆ™æ˜¯è¡¨å—(tabletï¼ŒCassandraå’ŒRiakä¸­æ˜¯è™šèŠ‚ç‚¹(vnode), Couchbaseä¸­å«åšè™šæ¡¶(vBucket)ï¼Œä½†æ˜¯åˆ†åŒº(partition)æ˜¯çº¦å®šä¿—æˆçš„å«æ³• <a href="#fnref10" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn11" class="footnote-item"><p>è¯¥åˆ†åŒºæ–¹å¼ä¾èµ–äºæ•£åˆ—å‡½æ•°ï¼Œä¸€ä¸ª $32$ ä½æ•£åˆ—å‡½æ•°,æ— è®ºä½•æ—¶ç»™å®šä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²è¾“å…¥ï¼Œå®ƒå°†è¿”å›ä¸€ä¸ª $0$ åˆ° $2^{32} -1$ ä¹‹é—´çš„"éšæœº"æ•° <a href="#fnref11" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn12" class="footnote-item"><p>æˆ‘ä»¬æœç´¢çš„å…³é”®è¯å†³å®šäº†æ¬¡çº§ç´¢å¼•çš„åˆ†åŒºæ–¹å¼ï¼Œå› æ­¤ç§°ä¹‹ä¸ºå…³é”®è¯ç´¢å¼•ï¼Œå…³é”®è¯(term)ä¸€è¯æ¥æºäºå…¨æ–‡æœç´¢ç´¢å¼•(ä¸€ç§ç‰¹æ®Šçš„æ¬¡çº§ç´¢å¼•)ã€‚ <a href="#fnref12" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn13" class="footnote-item"><p>å³ä¸€è‡´æ€§å“ˆå¸Œè§£å†³çš„é—®é¢˜ï¼Œä¸€è‡´æ€§å“ˆå¸Œçš„ä¸»è¦åº”ç”¨å°±æ˜¯é™ä½è·¯ç”±æˆæœ¬ <a href="#fnref13" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn14" class="footnote-item"><p>å…³äºç¡¬ä»¶æ•…éšœï¼šç¡¬ä»¶æ•…éšœç‡æ˜¯å¾ˆé«˜çš„ï¼Œç£ç›˜åœ¨è¿›è¡Œå¤§é‡çš„è¯»å†™ä¹‹åå¤±æ•ˆçš„æ¦‚ç‡æ˜¯å¾ˆé«˜çš„ï¼ŒIDCæ•°æ®ä¸­å¿ƒå¯¹ç‰©ç†ç¯å¢ƒçš„è¦æ±‚æ˜¯å¾ˆè‹›åˆ»çš„ï¼Œä¸ºäº†é™ä½æ¸©åº¦ç©ºè°ƒä¸å¤Ÿç”¨ï¼Œç”šè‡³æŠŠæ•°æ®ä¸­å¿ƒæ¬åˆ°å±±æ´é‡Œï¼Œæ¯”å¦‚é˜¿é‡Œåœ¨è´µå·äº‘å—çš„IDCï¼Œåœ°æ¿ä½¿ç”¨é™ç”µåœ°æ¿ï¼Œæ¯ä¸ªæœºæˆ¿å…¥å£çš„æŒ¡é¼ æ¿æ¯”è†ç›–è¿˜é«˜ï¼Œä¾›ç”µéƒ½æ˜¯åŒè·¯ä¾›ç”µç­‰ã€‚ <a href="#fnref14" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn15" class="footnote-item"><p>è¡Œé”æ»¡è¶³ä¸¤é˜¶æ®µé”åè®®ï¼Œä¸¤é˜¶æ®µé”åè®®æ˜¯è¯´ï¼šé”éœ€è¦çš„æ—¶å€™æ‰åŠ ä¸Šçš„ï¼Œåœ¨äº‹åŠ¡ç»“æŸçš„æ—¶å€™æ‰é‡Šæ”¾ï¼›åŒæ—¶è¡Œé”ä¹Ÿæ˜¯2PLï¼ˆ2é˜¶æ®µé”å®šï¼‰ï¼Œåœ¨å½“å‰äº‹åŠ¡å†™å…¥æ—¶å¿…é¡»æŒæœ‰æ’å®ƒé”ï¼Œç›´åˆ°äº‹åŠ¡æäº¤æ‰é‡Šæ”¾æ’å®ƒé”ã€‚ <strong>ä¸¤é˜¶æ®µé”åè®®å’Œ2plè¯´çš„æ˜¯ä¸€ä¸ªäº‹æƒ…</strong> <a href="#fnref15" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn16" class="footnote-item"><p>åŒä¸€æ¡è®°å½•åœ¨ç³»ç»Ÿä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªç‰ˆæœ¬ï¼Œè¿™å°±æ˜¯æ•°æ®åº“çš„å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼› <a href="#fnref16" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn17" class="footnote-item"><p>æ›´æ–°æ•°æ®æ˜¯å…ˆè¯»åå†™çš„ï¼Œè¯»åªèƒ½è¯»å½“å‰<strong>å·²æäº¤</strong>çš„æœ€æ–°å€¼ï¼Œè¿™å°±æ˜¯å½“å‰è¯» <a href="#fnref17" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn18" class="footnote-item"><p>ç½‘ç»œåˆ†åŒºåŒºåˆ«äºåˆ†åŒºï¼Œåˆ†åŒºæ˜¯ä¸€ç§ä¸­å°†æ•°æ®é›†åˆ’åˆ†ä¸ºå¤šå—ï¼Œä»¥æ­¤æ¥æå‡å¹¶å‘è¯»å†™èƒ½åŠ›ï¼› è€Œç½‘ç»œåˆ†åŒºæ˜¯æŒ‡èŠ‚ç‚¹<em>å½¼æ­¤æ–­å¼€</em>ä½†æ˜¯ä»ç„¶æ´»è·ƒã€‚ <a href="#fnref18" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn19" class="footnote-item"><p>å¤šä¸ªMRä»»åŠ¡è¿æ¥çš„æ–¹å¼æ˜¯å°†åä¸€ä¸ªMRä»»åŠ¡çš„è¾“å…¥é…ç½®ä¸ºå‰ä¸€ä¸ªMRä»»åŠ¡çš„è¾“å‡ºï¼›è€ŒUnixå‘½ä»¤ç®¡é“æ˜¯ç›´æ¥å°†ä¸€ä¸ªè¿›ç¨‹çš„è¾“å‡ºä½œä¸ºå¦å¤–ä¸€ä¸ªè¿›ç¨‹çš„è¾“å…¥ï¼Œä»…ç”¨ä¸€ä¸ªå¾ˆå°çš„å†…å­˜ç¼“å†²åŒº <a href="#fnref19" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn20" class="footnote-item"><p>å…³äºä¸Šè¿°ä¸‰ç§è¿æ¥æ–¹å¼è¯·å‚é˜…ï¼š<a href="https://mp.weixin.qq.com/s/lulNpgxillQ0s5fb_rgvdw">https://mp.weixin.qq.com/s/lulNpgxillQ0s5fb_rgvdw</a> <a href="#fnref20" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn21" class="footnote-item"><p>å¹¶éæ‰€æœ‰æ•°æ®ç±»å‹çš„å¤„ç†éƒ½å¯ä»¥åˆç†çš„ç”¨SQLè¡¨è¾¾(æ¨è¿›ç³»ç»Ÿã€ç‰¹å¾å·¥ç¨‹ç­‰)ï¼Œæ‰€ä»¥ç¼–å†™ä»£ç æ˜¯å¿…é¡»çš„ï¼Œè€ŒMRèƒ½ä½¿å¾—å·¥ç¨‹å¸ˆå¯ä»¥è½»æ¾çš„åœ¨å¤§å‹æ•°æ®é›†ä¸Šæ‰§è¡Œè‡ªå·±çš„ä»£ç ï¼Œç”šè‡³è¿˜å¯ä»¥åŸºäºMapReduce+HDFS å»ºç«‹SQLæŸ¥è¯¢æ‰§è¡Œå¼•æ“ï¼Œæ¯”å¦‚Hiveå°±æ˜¯è¿™ä¹ˆåšçš„ï¼›é™¤äº†SQLå’ŒMapReduceä¹‹å¤–ï¼Œç”±äºHadoopå¹³å°çš„å¼€æ”¾æ€§ï¼Œè¿˜å¯ä»¥æ„å»ºæ›´å¤šçš„æ¨¡å‹ã€‚ç”±äºä¸éœ€è¦å°†æ•°æ®å¯¼å…¥åˆ°ä¸“é—¨çš„ç³»ç»Ÿè¿›è¡Œä¸åŒç±»å‹çš„å¤„ç†ï¼Œé‡‡ç”¨æ–°çš„å¤„ç†æ¨¡å‹ä¹Ÿæ›´å®¹æ˜“ã€‚å¦‚MPPé£æ ¼çš„åˆ†æå‹æ•°æ®åº“impalaï¼Œéšæœºè®¿é—®é£æ ¼çš„OLTPæ•°æ®åº“HBase(LSM) <a href="#fnref21" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn22" class="footnote-item"><p>è½ç›˜ä¸€æ–¹é¢æ˜¯å®¹é”™ï¼Œä¸€æ–¹é¢æ˜¯å‡è®¾æ•°æ®é›†å¤ªå¤§ä¸èƒ½é€‚åº”å†…å­˜ã€‚å¹¶ä¸”æ”¯æŒæ”¯æŒèµ„æºçš„è¿‡åº¦ä½¿ç”¨ <a href="#fnref22" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn23" class="footnote-item"><p>MPP æ˜¯å•ä½“çš„ç´§å¯†é›†æˆçš„è½¯ä»¶ï¼Œè´Ÿè´£ç£ç›˜ä¸Šçš„å­˜å‚¨å¸ƒå±€ï¼ŒæŸ¥è¯¢è®¡åˆ’ï¼Œè°ƒåº¦å’Œæ‰§è¡Œï¼Œè¿™äº›ç»„ä»¶é’ˆå¯¹æ•°æ®åº“çš„ç‰¹å®šéœ€æ±‚åšäº†ä¼˜åŒ–ï¼Œå› æ­¤å¯ä»¥å¯¹ç‰¹å®šæŸ¥è¯¢æœ‰å¾ˆå¥½çš„æ€§èƒ½ï¼Œä½†åªæ”¯æŒSQLæ¨¡å‹ <a href="#fnref23" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn24" class="footnote-item"><p>Tezæ˜¯ä¸€ä¸ªç›¸å½“è–„çš„åº“ï¼Œå®ƒä¾èµ–äºYARN shuffleæœåŠ¡æ¥å®ç°èŠ‚ç‚¹é—´æ•°æ®çš„å®é™…å¤åˆ¶ï¼Œè€ŒSparkå’ŒFlinkåˆ™æ˜¯åŒ…å«äº†ç‹¬ç«‹ç½‘ç»œé€šä¿¡å±‚ï¼Œè°ƒåº¦å™¨ï¼ŒåŠç”¨æˆ·å‘APIçš„å¤§å‹æ¡†æ¶ <a href="#fnref24" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn25" class="footnote-item"><p>æ¯”å¦‚èƒ½å¤Ÿæ°å¥½è¿æ¥1ä¸ªç”Ÿäº§è€…å’Œä¸€ä¸ªæ¶ˆè´¹è€…Unixç®¡é“å’ŒTCPè¿æ¥ï¼Œä»–ä»¬åœ¨åº”å¯¹è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ä½¿ç”¨èƒŒå‹æœºåˆ¶ï¼Œå®ƒä»¬æœ‰ä¸€ä¸ªå›ºå®šå¤§å°çš„ç¼“å†²åŒºï¼Œä¸€æ—¦å¡«æ»¡å‘é€è€…å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ¥å—è€…ä»ç¼“å†²åŒºå–å‡ºæ•°æ® <a href="#fnref25" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn26" class="footnote-item"><p>JMS: Java Message Serviceï¼Œæ˜¯å…³äºJavaæ¶ˆæ¯ä¸­é—´çš„ä¸€ç»„æ¥å£æ ‡å‡†ï¼Œæ‰€æœ‰æ¶ˆæ¯ä¸­é—´ä»¶(MOM)éœ€è¦å®ç°è¿™ç»„æ¥å£ï¼Œå¯ç±»æ¯”JDBC <a href="#fnref26" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn27" class="footnote-item"><p>ç¡®è®¤æœºåˆ¶ï¼šæ¶ˆè´¹è€…å¿…é¡»æ˜¾ç¤ºçš„å‘ŠçŸ¥ä»£ç†å¤„ç†å®Œæ¯•çš„æ—¶é—´ï¼Œä»¥ä¾¿ä»£ç†å°†æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­ç§»é™¤ <a href="#fnref27" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn28" class="footnote-item"><p>â“æ¶ˆè´¹è€…èŠ‚ç‚¹å¤±æ•ˆï¼Œåˆ™å¤±æ•ˆæ¶ˆè´¹è€…çš„åˆ†åŒºå°†æŒ‡æ´¾ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå¹¶ä»æœ€åè®°å½•çš„åç§»é‡å¼€å§‹æ¶ˆè´¹æ¶ˆæ¯ã€‚å¦‚æœæ¶ˆè´¹è€…å·²ç»å¤„ç†äº†åç»­çš„æ¶ˆæ¯ï¼Œä½†è¿˜æ²¡æœ‰è®°å½•å®ƒä»¬çš„åç§»é‡ï¼Œé‚£ä¹ˆé‡å¯åè¿™äº›æ¶ˆæ¯å°†è¢«å¤„ç†ä¸¤æ¬¡ï¼Œè¿™ä¸ªé—®é¢˜å¦‚ä½•è§£å†³å‘¢? <a href="#fnref28" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn29" class="footnote-item"><p>æ—¥å¿—å‹ç¼©ï¼šç±»ä¼¼åœ¨hashç´¢å¼•ä¸­è®¨è®ºçš„æ—¥å¿—å‹ç¼©ï¼Œå­˜å‚¨å¼•æ“å®šæœŸæŸ¥æ‰¾å…·æœ‰ç›¸åŒé”®çš„è®°å½•ï¼Œä¸¢å¼ƒåˆ°é‡å¤çš„å†…å®¹å¹¶ä¸”åªä¿ç•™æ¯ä¸ªé”®çš„æœ€æ–°å€¼ã€‚æ¯”å¦‚åœ¨CDCç³»ç»Ÿè¢«é…ç½®ä¸ºï¼Œæ¯ä¸ªå˜æ›´éƒ½åŒ…å«ä¸€ä¸ªä¸»é”®ï¼Œä¸”æ¯ä¸ªé”®çš„æ›´æ–°éƒ½æ›¿æ¢äº†è¯¥é”®ä»¥å‰çš„å€¼ï¼Œé‚£ä¹ˆåªéœ€è¦ä¿ç•™å¯¹é”®çš„æœ€æ–°å†™å…¥å°±è¶³å¤Ÿäº†ã€‚æ— è®ºä½•æ—¶éœ€è¦é‡å»ºè¡ç”Ÿæ•°æ®ç³»ç»Ÿ(å¦‚æœç´¢ç´¢å¼•)ï¼Œä½ å¯ä»¥ä»å‹ç¼©æ—¥å¿—ä¸»é¢˜0åç§»é‡å¤„å¯åŠ¨æ–°çš„æ¶ˆè´¹è€…ï¼Œç„¶åä¾æ¬¡æ‰«ææ—¥å¿—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ <a href="#fnref29" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn30" class="footnote-item"><p>å†™å…¥å’Œè¯»å–å½¢å¼ç›¸åˆ†ç¦»ï¼Œä¹Ÿå«å‘½ä»¤æŸ¥è¯¢è´£ä»»åˆ†ç¦»(command query responsibility segregation, CQRSï¼‰ <a href="#fnref30" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn31" class="footnote-item"><p>SCDï¼Œå¤„ç†SCDé—®é¢˜æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œä»SCD0åˆ°SCD6ï¼Œå…¶ä¸­æœ€æµè¡Œçš„æ˜¯ï¼šSCD1å’ŒSCD2ï¼›wikiï¼š<a href="https://en.wikipedia.org/wiki/Slowly_changing_dimension%EF%BC%9BYouTube">https://en.wikipedia.org/wiki/Slowly_changing_dimensionï¼›YouTube</a> tutorialï¼š<a href="https://www.youtube.com/watch?v=XqdZF0DJpUs">https://www.youtube.com/watch?v=XqdZF0DJpUs</a> <a href="#fnref31" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>è¯»ä¹¦ç¬”è®°</category>
      </categories>
      <tags>
        <tag>æŠ€æœ¯</tag>
      </tags>
  </entry>
</search>
